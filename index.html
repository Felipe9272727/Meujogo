<!doctype html
<html lang=en>
<meta charset=UTF-8>
<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name=viewport>
<title>SILENCE BETWEEN TREES</title>
<link href="https://fonts.googleapis.com/css2?family=Creepster&family=Nosifer&family=Special+Elite&display=swap" rel=stylesheet>
<link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
<script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary-color:#b0c4de;--secondary-color:#566d8b;--accent-color:#8faac8;--bg-dark:#05070a;--bg-panel:rgba(10, 15, 20, 0.95);--text-dim:rgba(150, 170, 190, 0.9);--border-subtle:rgba(86, 109, 139, 0.3);--safe-top:env(safe-area-inset-top, 0px);--safe-bottom:env(safe-area-inset-bottom, 0px);--safe-left:env(safe-area-inset-left, 0px);--safe-right:env(safe-area-inset-right, 0px)}
body,html{width:100%;height:100%;overflow:hidden;background:var(--bg-dark);touch-action:none;font-family:'Special Elite',cursive;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
#game-container{width:100%;height:100%}
#game-container canvas{width:100%!important;height:100%!important;image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges}
#fps-counter{position:absolute;top:calc(10px + var(--safe-top));left:calc(10px + var(--safe-left));color:var(--secondary-color);background:rgba(0,0,0,.7);padding:6px 12px;font-family:monospace;font-size:12px;font-weight:700;border-radius:6px;pointer-events:none;z-index:1000;border:1px solid #1a2f45;backdrop-filter:blur(4px)}
#quest-box{position:absolute;top:calc(20px + var(--safe-top));right:calc(20px + var(--safe-right));text-align:right;pointer-events:none;z-index:150;max-width:300px;background:rgba(5,10,15,.85);padding:12px 18px;border:1px solid var(--border-subtle);border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,.5);backdrop-filter:blur(4px);opacity:0;transform:translateX(20px);transition:opacity 0.5s cubic-bezier(0.4,0,0.2,1),transform 0.5s cubic-bezier(0.4,0,0.2,1)}#quest-box.visible{opacity:1;transform:translateX(0)}.quest-title{font-family:'Special Elite',cursive;color:var(--accent-color);font-size:clamp(12px,2.5vw,14px);letter-spacing:2px;margin-bottom:8px;border-bottom:1px solid rgba(143,170,200,.3);padding-bottom:4px;display:inline-block}.quest-objective{font-family:'Special Elite',cursive;color:#fff;font-size:clamp(14px,2.5vw,16px);text-shadow:0 0 5px rgba(255,255,255,.2);font-weight:700;transition:all 0.3s ease}
#crosshair{position:absolute;top:50%;left:50%;width:24px;height:24px;transform:translate(-50%,-50%);pointer-events:none;z-index:50}
#crosshair::after,#crosshair::before{content:'';position:absolute;background:rgba(200,220,255,.5);border-radius:1px}
#crosshair::before{top:11px;left:0;width:24px;height:2px}
#crosshair::after{top:0;left:11px;width:2px;height:24px}
#crosshair .dot{position:absolute;top:50%;left:50%;width:4px;height:4px;background:rgba(200,220,255,.8);border-radius:50%;transform:translate(-50%,-50%)}
#interaction-prompt{position:absolute;top:60%;left:50%;transform:translateX(-50%) translateY(10px);color:#fff;font-family:'Special Elite',cursive;font-size:clamp(16px,4vw,24px);text-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:auto;cursor:pointer;z-index:200;background:rgba(0,0,0,.75);padding:12px 24px;border-radius:8px;border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(8px);transition:all 0.4s cubic-bezier(0.4,0,0.2,1);white-space:nowrap;opacity:0;visibility:hidden}
#interaction-prompt.visible{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0)}
#interaction-prompt:hover{background:rgba(20,30,40,.9);border-color:rgba(255,255,255,.4);transform:translateX(-50%) translateY(0) scale(1.02)}
#interaction-prompt:active{transform:translateX(-50%) translateY(0) scale(.98)}
#locked-message{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%) scale(0.9);color:#e55;font-family:Nosifer,cursive;font-size:clamp(18px,5vw,32px);text-shadow:0 0 10px #500;pointer-events:none;z-index:70;opacity:0;transition:opacity 0.4s cubic-bezier(0.4,0,0.2,1),transform 0.4s cubic-bezier(0.4,0,0.2,1);text-align:center;width:100%}#locked-message.visible{opacity:1;transform:translate(-50%,-50%) scale(1)}
#dialogue-box{position:absolute;bottom:clamp(80px,15vh,120px);left:50%;transform:translateX(-50%) translateY(20px);width:calc(100% - 40px);max-width:700px;background:var(--bg-panel);border:2px solid var(--secondary-color);padding:clamp(16px,4vw,24px);display:none;align-items:center;z-index:80;font-family:'Special Elite',cursive;color:var(--primary-color);font-size:clamp(14px,3.5vw,20px);text-shadow:1px 1px 0 #000;min-height:80px;box-shadow:0 8px 32px rgba(0,0,0,.6);border-radius:8px;backdrop-filter:blur(12px);opacity:0;visibility:hidden;pointer-events:none;transition:opacity 0.5s cubic-bezier(0.4,0,0.2,1),transform 0.5s cubic-bezier(0.4,0,0.2,1)}#dialogue-box.visible{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0);pointer-events:auto}
#dialogue-text{line-height:1.6;flex-grow:1}
#portrait-container{width:64px;height:64px;min-width:64px;background:#000;border:2px solid var(--accent-color);border-radius:4px;overflow:hidden;display:none;margin-right:15px;box-shadow:0 0 10px rgba(0,0,0,.5)}
#portrait-container img{width:100%;height:100%;object-fit:cover;display:none}
.dialogue-cursor::after{content:'‚ñå';animation:blink .8s infinite;margin-left:2px;color:var(--accent-color)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
#instructions{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:none;flex-direction:column;justify-content:center;align-items:center;color:var(--accent-color);text-align:center;cursor:pointer;z-index:100;backdrop-filter:blur(8px)}
#instructions h1{font-size:clamp(28px,8vw,48px);margin-bottom:20px;font-family:Nosifer,cursive;text-shadow:0 0 20px rgba(100,150,200,.3)}
#instructions p{font-size:clamp(14px,4vw,18px);color:var(--text-dim);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
#sleep-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#000 0%,#0a0a15 50%,#000 100%);z-index:300;display:none;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity 1.5s cubic-bezier(0.4,0,0.2,1);pointer-events:none;overflow:hidden}
#sleep-screen::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at center,rgba(100,150,200,0.08) 0%,transparent 60%);animation:sleepGlow 4s ease-in-out infinite;pointer-events:none}
#sleep-screen::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.3)"/></svg>');background-size:50px 50px;animation:starsMove 20s linear infinite;opacity:0.3;pointer-events:none}
@keyframes sleepGlow{0%,100%{opacity:0.5;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
@keyframes starsMove{from{transform:translateY(0)}to{transform:translateY(-50px)}}
#sleep-screen.active{opacity:1;pointer-events:auto}
#sleep-screen h1{font-family:Nosifer,cursive;color:var(--accent-color);font-size:clamp(30px,8vw,60px);margin-bottom:20px;text-shadow:0 0 30px rgba(100,150,200,.6),0 0 60px rgba(100,150,200,.3);opacity:0;transform:translateY(30px) scale(0.9);animation:sleepTitleIn 1.5s ease-out 0.5s forwards;position:relative;z-index:1}
#sleep-screen p{font-family:'Special Elite',cursive;color:#aaa;font-size:clamp(14px,4vw,20px);margin-bottom:40px;opacity:0;transform:translateY(20px);animation:sleepTextIn 1.2s ease-out 1s forwards;position:relative;z-index:1;letter-spacing:2px}
#sleep-screen .sleep-particles{position:absolute;width:100%;height:100%;overflow:hidden;pointer-events:none}
#sleep-screen .sleep-particle{position:absolute;width:4px;height:4px;background:rgba(150,180,220,0.6);border-radius:50%;animation:floatUp 8s ease-in-out infinite;box-shadow:0 0 10px rgba(150,180,220,0.4)}
@keyframes sleepTitleIn{to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes sleepTextIn{to{opacity:1;transform:translateY(0)}}
@keyframes floatUp{0%{transform:translateY(100vh) translateX(0) scale(0);opacity:0}10%{opacity:1;transform:scale(1)}90%{opacity:1}100%{transform:translateY(-10vh) translateX(30px) scale(0.5);opacity:0}}
#sleep-screen .loading-dots{display:flex;gap:8px;margin-top:30px;opacity:0;animation:sleepTextIn 1s ease-out 1.5s forwards}
#sleep-screen .loading-dots span{width:10px;height:10px;background:var(--accent-color);border-radius:50%;animation:dotPulse 1.4s ease-in-out infinite;box-shadow:0 0 10px rgba(143,170,200,0.5)}
#sleep-screen .loading-dots span:nth-child(2){animation-delay:0.2s}
#sleep-screen .loading-dots span:nth-child(3){animation-delay:0.4s}
@keyframes dotPulse{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.3);opacity:1}}
#main-menu{position:absolute;top:0;left:0;width:100%;height:100%;background-image:url(https://raw.githubusercontent.com/Felipe9272727/Capa/main/file_00000000eeac71f5a5e6b09ae3c9e069.png);background-size:cover;background-position:center;background-repeat:no-repeat;z-index:190;display:flex;flex-direction:column;justify-content:center;align-items:center;overflow:hidden;padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left)}
#main-menu::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(5,10,20,.88) 0,rgba(5,15,30,.75) 30%,rgba(0,5,10,.65) 50%,rgba(5,10,20,.78) 70%,rgba(0,0,0,.95) 100%);z-index:0}
#main-menu::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at center,transparent 20%,rgba(0,0,0,.5) 60%,rgba(0,0,0,.9) 100%);z-index:0;pointer-events:none}
.scanlines{position:absolute;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,20,40,.08) 2px,rgba(0,20,40,.08) 4px);pointer-events:none;z-index:2;animation:scanlineFlicker .15s infinite}
@keyframes scanlineFlicker{0%,100%{opacity:.6}50%{opacity:.8}}
.fog{position:absolute;width:200%;height:100%;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.7" numOctaves="3" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.1"/></svg>');opacity:.25;animation:fogMove 60s linear infinite;z-index:1;pointer-events:none}
@keyframes fogMove{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.ash-container{position:absolute;top:0;left:0;right:0;bottom:0;overflow:hidden;z-index:2;pointer-events:none}
.ash{position:absolute;width:3px;height:3px;background:rgba(200,220,255,.35);border-radius:50%;animation:floatAsh 20s linear infinite}
@keyframes floatAsh{0%{transform:translateY(-10vh) translateX(0) rotate(0);opacity:0}10%{opacity:.5}50%{transform:translateY(50vh) translateX(30px) rotate(180deg)}90%{opacity:.5}100%{transform:translateY(110vh) translateX(-20px) rotate(360deg);opacity:0}}
.menu-content{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;padding:20px;max-width:100%;width:100%}
.game-logo{margin-bottom:clamp(10px,3vh,20px);text-align:center}
.game-title{font-family:Nosifer,cursive;font-size:clamp(22px,7vw,60px);color:var(--primary-color);text-shadow:0 0 15px rgba(176,196,222,.4),0 0 30px rgba(176,196,222,.15),4px 4px 0 #000;letter-spacing:clamp(2px,.5vw,6px);animation:titleFlicker 5s ease-in-out infinite;position:relative;line-height:1.15}
.game-title-line{display:block}
@keyframes titleFlicker{0%,100%,19%,21%,23%,25%,54%,56%{opacity:1;text-shadow:0 0 15px rgba(176,196,222,.4)}20%,24%,55%{opacity:.85;text-shadow:none}}
.game-subtitle{font-family:'Special Elite',cursive;font-size:clamp(10px,2.2vw,16px);color:var(--text-dim);letter-spacing:clamp(4px,1vw,8px);text-transform:uppercase;margin-top:clamp(8px,2vh,15px);text-shadow:0 0 10px rgba(0,0,0,.8);animation:subtitlePulse 4s ease-in-out infinite}
@keyframes subtitlePulse{0%,100%{opacity:.5}50%{opacity:.9}}
.deco-line{width:clamp(120px,40vw,280px);height:1px;background:linear-gradient(90deg,transparent,var(--secondary-color),transparent);margin:clamp(15px,3vh,25px) 0;position:relative}
.deco-line::before{content:'‚óÜ';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--secondary-color);font-size:8px;background:var(--bg-dark);padding:0 10px}
.menu-buttons{display:flex;flex-direction:column;gap:clamp(10px,2vh,16px);margin-top:clamp(10px,2vh,20px);width:100%;max-width:320px;padding:0 20px}
.menu-btn{position:relative;padding:clamp(14px,3.5vw,18px) clamp(35px,10vw,60px);font-family:'Special Elite',cursive;font-size:clamp(13px,3.2vw,16px);letter-spacing:2px;text-transform:uppercase;color:#9aa;background:linear-gradient(180deg,rgba(15,25,35,.85) 0,rgba(8,12,18,.95) 100%);border:1px solid var(--border-subtle);cursor:pointer;overflow:hidden;transition:all .25s ease;box-shadow:0 4px 16px rgba(0,0,0,.4);border-radius:6px;-webkit-tap-highlight-color:transparent}
.menu-btn:focus,.menu-btn:hover{color:#fff;border-color:#789;background:linear-gradient(180deg,rgba(30,45,60,.9) 0,rgba(15,22,30,.95) 100%);box-shadow:0 0 20px rgba(100,130,170,.2);transform:translateY(-2px);outline:0}
.menu-btn:active{transform:translateY(0);box-shadow:0 2px 8px rgba(0,0,0,.4)}
.menu-btn.primary{background:linear-gradient(180deg,rgba(40,65,90,.7) 0,rgba(20,35,50,.85) 100%);border:2px solid rgba(100,140,180,.5);color:#deb;font-size:clamp(15px,4vw,20px);padding:clamp(16px,4vw,22px) clamp(45px,12vw,80px)}
.menu-btn.primary:focus,.menu-btn.primary:hover{border-color:#acf;color:#fff;box-shadow:0 0 30px rgba(150,200,255,.25)}
#settings-panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.95);background:linear-gradient(180deg,rgba(12,18,25,.98) 0,rgba(6,10,15,.99) 100%);border:1px solid rgba(86,109,139,.5);padding:clamp(24px,5vw,36px);z-index:20;opacity:0;visibility:hidden;transition:all .3s cubic-bezier(.4,0,.2,1);width:calc(100% - 40px);max-width:360px;box-shadow:0 20px 60px rgba(0,0,0,.7);border-radius:12px;backdrop-filter:blur(12px)}
#settings-panel.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.settings-title{font-family:Nosifer,cursive;font-size:clamp(18px,5vw,24px);color:var(--accent-color);margin-bottom:clamp(20px,4vh,30px);text-align:center;letter-spacing:3px;text-shadow:0 0 15px rgba(100,150,200,.2)}
.setting-row{display:flex;justify-content:space-between;align-items:center;padding:clamp(14px,3vh,18px) 0;border-bottom:1px solid rgba(86,109,139,.15)}
.setting-row:last-of-type{border-bottom:none}
.setting-label{color:rgba(200,210,220,.85);font-size:clamp(13px,3.5vw,15px);letter-spacing:1px;font-family:'Special Elite',cursive}
.setting-toggle{position:relative;width:52px;height:28px;background:rgba(40,50,60,.6);border-radius:14px;cursor:pointer;transition:background .3s ease;border:1px solid var(--border-subtle);flex-shrink:0}
.setting-toggle.active{background:linear-gradient(90deg,#2c4a5e,#4a8aaf)}
.setting-toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;background:#bbb;border-radius:50%;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 2px 6px rgba(0,0,0,.4)}
.setting-toggle.active::after{left:27px;background:#fff}
.close-settings{margin-top:clamp(20px,4vh,30px);width:100%}
#main-menu.fade-out{opacity:0;pointer-events:none}
#game-intro-fade{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#000 0%,#050510 50%,#000 100%);z-index:185;opacity:0;pointer-events:none;transition:opacity 1.2s cubic-bezier(0.4,0,0.2,1)}
#game-intro-fade.active{opacity:1}
#game-intro-fade .intro-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;opacity:0;transition:opacity 1s ease-in-out 0.5s}
#game-intro-fade.active .intro-text{opacity:1}
#game-intro-fade .intro-text h2{font-family:Nosifer,cursive;color:var(--accent-color);font-size:clamp(16px,4vw,28px);margin-bottom:15px;text-shadow:0 0 20px rgba(100,150,200,0.5);letter-spacing:3px}
#game-intro-fade .intro-text p{font-family:'Special Elite',cursive;color:rgba(150,170,190,0.7);font-size:clamp(12px,3vw,16px);letter-spacing:2px}
#headphones-prompt{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:195;display:flex;justify-content:center;align-items:center;color:#fff;flex-direction:column;cursor:pointer;transition:opacity 1s ease;user-select:none;padding:20px}
#headphones-prompt .hp-content{text-align:center;animation:pulseText 3s infinite ease-in-out;max-width:400px}
#headphones-prompt .hp-icon{font-size:clamp(50px,15vw,100px);margin-bottom:clamp(20px,5vh,40px);opacity:.85;filter:drop-shadow(0 0 20px rgba(180, 50, 50, .3))}
#headphones-prompt h2{font-family:Nosifer,cursive;color:#c44;font-size:clamp(18px,5vw,32px);letter-spacing:clamp(2px,.5vw,5px);margin-bottom:12px;text-shadow:0 0 15px rgba(150,50,50,.5)}
#headphones-prompt p{font-family:'Special Elite',cursive;color:#777;font-size:clamp(12px,3vw,16px);margin-bottom:clamp(30px,6vh,50px);letter-spacing:1px;line-height:1.5}
#headphones-prompt .tap-text{font-family:'Special Elite',cursive;color:#ccc;font-size:clamp(14px,3.5vw,18px);border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);display:inline-block;padding:12px 28px;text-transform:uppercase;letter-spacing:3px;border-radius:6px;transition:all .2s ease}
#headphones-prompt:hover .tap-text{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.4)}
@keyframes pulseText{0%{opacity:.7;transform:scale(.98)}50%{opacity:1;transform:scale(1)}100%{opacity:.7;transform:scale(.98)}}
#mobile-controls{position:absolute;bottom:calc(20px + var(--safe-bottom));left:calc(20px + var(--safe-left));right:calc(20px + var(--safe-right));height:140px;pointer-events:none;display:none;z-index:100}
#mobile-talk-btn{position:absolute;bottom:30px;right:10px;width:80px;height:80px;background:rgba(143,170,200,.2);border:2px solid rgba(176,196,222,.5);border-radius:50%;pointer-events:auto;display:none;justify-content:center;align-items:center;color:#fff;font-family:'Special Elite',cursive;font-size:14px;font-weight:700;backdrop-filter:blur(4px);box-shadow:0 0 15px rgba(100,150,200,.2);z-index:101;text-transform:uppercase;user-select:none}
#mobile-talk-btn:active{background:rgba(176,196,222,.4);transform:scale(.95)}
.joystick-zone{position:absolute;bottom:10px;left:10px;width:clamp(100px,25vw,130px);height:clamp(100px,25vw,130px);background:rgba(100,150,200,.08);border-radius:50%;pointer-events:auto;touch-action:none;border:2px solid rgba(100,150,200,.25);backdrop-filter:blur(4px)}
.joystick-knob{position:absolute;top:50%;left:50%;width:clamp(45px,12vw,55px);height:clamp(45px,12vw,55px);background:rgba(100,150,200,.25);border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;border:2px solid rgba(150,180,220,.3);box-shadow:0 0 15px rgba(100,150,200,.15)}
#loading{position:fixed;inset:0;background:linear-gradient(180deg,#050510 0%,var(--bg-dark) 50%,#050510 100%);z-index:200;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff;transition:opacity 0.8s cubic-bezier(0.4,0,0.2,1);padding:20px}
#loading::before{content:'';position:absolute;top:50%;left:50%;width:300px;height:300px;background:radial-gradient(circle,rgba(100,150,200,0.1) 0%,transparent 70%);transform:translate(-50%,-50%);animation:loadingGlow 3s ease-in-out infinite}
@keyframes loadingGlow{0%,100%{opacity:0.5;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.2)}}
.loading-content{text-align:center;width:100%;max-width:400px;position:relative;z-index:1}
.loading-title{font-family:Nosifer,cursive;font-size:clamp(14px,4vw,24px);color:var(--accent-color);text-shadow:0 0 20px rgba(100,150,200,.5),0 0 40px rgba(100,150,200,.3);margin-bottom:clamp(30px,6vh,50px);letter-spacing:clamp(2px,.5vw,5px);animation:loadingTitlePulse 2s ease-in-out infinite}
@keyframes loadingTitlePulse{0%,100%{opacity:0.8;text-shadow:0 0 20px rgba(100,150,200,.5)}50%{opacity:1;text-shadow:0 0 30px rgba(100,150,200,.8),0 0 60px rgba(100,150,200,.4)}}
#loading-bar-container{width:100%;max-width:280px;height:3px;background:rgba(100,120,150,.15);overflow:hidden;position:relative;margin:0 auto;border-radius:2px}
#loading-bar{width:0%;height:100%;background:linear-gradient(90deg,#4b6cb7,#7b9ed4);transition:width .15s linear;box-shadow:0 0 15px rgba(100,150,255,.6);border-radius:2px}
#loading-text{margin-top:clamp(16px,3vh,24px);font-size:clamp(10px,2.5vw,13px);color:rgba(140,160,180,.5);font-family:'Special Elite',cursive;letter-spacing:2px}
#error-log{color:#fa4;margin-top:20px;font-family:monospace;padding:12px 16px;background:rgba(0,0,0,.5);max-width:90%;word-wrap:break-word;display:none;border-radius:6px;font-size:12px;border:1px solid rgba(255,170,68,.3)}
.version-tag{position:absolute;bottom:calc(16px + var(--safe-bottom));right:calc(20px + var(--safe-right));font-family:'Special Elite',cursive;font-size:11px;color:rgba(100,120,140,.35);letter-spacing:2px;z-index:10}
#white-flash{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s ease-out}
#black-fade{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#000 0%,#050510 50%,#000 100%);z-index:9998;opacity:0;pointer-events:none;transition:opacity 0.8s cubic-bezier(0.4,0,0.2,1)}
#black-fade::before{content:'';position:absolute;top:50%;left:50%;width:100px;height:100px;background:radial-gradient(circle,rgba(100,150,200,0.15) 0%,transparent 70%);transform:translate(-50%,-50%);animation:fadeGlow 2s ease-in-out infinite;opacity:0;transition:opacity 0.5s}
#black-fade.with-glow::before{opacity:1}
@keyframes fadeGlow{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.5}50%{transform:translate(-50%,-50%) scale(1.5);opacity:1}}
#mobile-exit-btn{position:absolute;bottom:25%;left:50%;transform:translateX(-50%);padding:12px 24px;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.2);color:#fff;font-family:'Special Elite',cursive;font-size:clamp(16px,4vw,24px);border-radius:8px;display:none;z-index:200;pointer-events:auto;backdrop-filter:blur(8px);white-space:nowrap;text-shadow:0 2px 8px rgba(0,0,0,.8);text-transform:none}
#mobile-exit-btn:active{transform:translateX(-50%) scale(.98);background:rgba(20,30,40,.9);border-color:rgba(255,255,255,.4)}
@media (orientation:landscape) and (max-height:500px){.menu-content{flex-direction:row;justify-content:center;align-items:center;gap:clamp(30px,8vw,80px);padding:15px 30px}.game-logo{margin-bottom:0;text-align:left}.game-title{font-size:clamp(20px,5vh,36px)}.game-subtitle{margin-top:8px;font-size:clamp(9px,1.8vh,12px)}.deco-line{display:none}.menu-buttons{margin-top:0;gap:10px;max-width:260px}.menu-btn{padding:12px 40px;font-size:clamp(11px,2.5vh,14px)}.menu-btn.primary{padding:14px 50px;font-size:clamp(13px,3vh,16px)}#settings-panel{max-width:450px;max-height:90vh;padding:20px 30px}.settings-title{margin-bottom:15px;font-size:clamp(16px,4vh,20px)}.setting-row{padding:10px 0}.close-settings{margin-top:15px}#dialogue-box{bottom:15px;max-width:60%;min-height:60px;padding:14px 20px;font-size:clamp(12px,2.5vh,16px)}#mobile-controls{height:110px}.joystick-zone{width:clamp(80px,18vh,110px);height:clamp(80px,18vh,110px)}.joystick-knob{width:clamp(35px,8vh,50px);height:clamp(35px,8vh,50px)}#headphones-prompt .hp-icon{font-size:clamp(40px,12vh,70px);margin-bottom:15px}#headphones-prompt h2{font-size:clamp(16px,4vh,24px)}#headphones-prompt p{font-size:clamp(11px,2.5vh,14px);margin-bottom:20px}#headphones-prompt .tap-text{font-size:clamp(12px,2.8vh,15px);padding:10px 22px}.version-tag{bottom:10px;right:15px;font-size:10px}}
@media (max-width:360px){.game-title{font-size:20px;letter-spacing:2px}.game-subtitle{font-size:9px;letter-spacing:3px}.menu-btn{padding:12px 30px;font-size:12px}.menu-btn.primary{padding:14px 40px;font-size:14px}}
@media (min-width:1200px){.menu-content{transform:scale(1.1)}#dialogue-box{max-width:800px;font-size:22px}}
</style>
<script type=importmap>
            {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/loaders/GLTFLoader.js": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js",
                "three/addons/controls/PointerLockControls.js": "https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js"
            }
        }
</script>
<script>window.addEventListener('error', function(e) {
            const errDiv = document.getElementById('error-log');
            if(errDiv) {
                errDiv.style.display = 'block';
                errDiv.innerText = "Error: " + e.message;
            }
            const el = document.getElementById('loading');
            if(el) {
                el.style.opacity = '0';
                setTimeout(() => el.style.display = 'none', 500);
            }
        });

        setTimeout(function() {
            const el = document.getElementById('loading');
            if(el && el.style.display !== 'none') {
                el.style.opacity = '0';
                setTimeout(() => el.style.display = 'none', 500);
            }
        }, 6000);
</script>
<div id=white-flash></div>
<div id=black-fade></div>
<div id=game-intro-fade><div class=intro-text><h2>CAP√çTULO 1</h2><p>O Fim de um Dia Comum</p></div></div>
<div id=fps-counter>FPS: 0</div>
<div id=quest-box><div class=quest-title>OBJETIVO ATUAL</div><div id=quest-text class=quest-objective></div></div>
<div id=interaction-prompt>Press E to Sit</div>
<div id=locked-message>Voc√™ precisa dormir.</div>
<div id=dialogue-box><div id=portrait-container><img id=player-portrait src=https://github.com/Felipe9272727/-conesjogador/raw/refs/heads/main/file_00000000054c71f6b288975521b3e083.png><img id=wife-portrait src=https://github.com/Felipe9272727/-conesjogador/raw/refs/heads/main/file_0000000014ac720eb51de09a869546dc%20(1).png></div><div id=dialogue-text></div></div>
<audio id=menu-music loop preload=auto><source src=https://raw.githubusercontent.com/Felipe9272727/M-sicas-e-efeitos-sonoros-/main/Crimson%20Title%20Screen.mp3 type=audio/mpeg></audio>
<audio id=game-ambience loop preload=auto><source src=https://raw.githubusercontent.com/Felipe9272727/M-sicas-e-efeitos-sonoros-/main/Quiet%20Desk%20at%20Midnight.mp3 type=audio/mpeg></audio>
<audio id=dawn-music loop preload=auto><source src=https://raw.githubusercontent.com/Felipe9272727/M-sicas-e-efeitos-sonoros-/main/Sunlit%20Omen.mp3 type=audio/mpeg></audio>
<div id=loading><div class=loading-content><div class=loading-title>ENTERING SILENCE...</div><div id=loading-bar-container><div id=loading-bar></div></div><div id=loading-text>Initializing...</div></div><div id=error-log></div></div>
<div id=headphones-prompt><div class=hp-content><div class=hp-icon>üéß</div><h2>HEADPHONES RECOMMENDED</h2><p>For the ultimate horror experience<div class=tap-text>Tap to Continue</div></div></div>
<div id=main-menu><div class=scanlines></div><div class=fog></div><div id=ash-container class=ash-container></div><div class=menu-content><div class=game-logo><h1 class=game-title><span class=game-title-line>SILENCE</span> <span class=game-title-line>BETWEEN TREES</span></h1><p class=game-subtitle>Moonlight Edition</div><div class=deco-line></div><div class=menu-buttons><button id=play-btn class="menu-btn primary">ENTER WOODS</button> <button id=car-shortcut-btn class=menu-btn>THE ROAD (SHORTCUT)</button> <button id=forest-shortcut-btn class=menu-btn>THE FOREST (SHORTCUT)</button> <button id=settings-btn class=menu-btn>SETTINGS</button></div></div><div id=settings-panel><h2 class=settings-title>SETTINGS</h2><div class=setting-row><span class=setting-label>Show FPS</span><div id=fps-toggle class="active setting-toggle"></div></div><button id=close-settings-btn class="menu-btn close-settings">APPLY</button></div><div class=version-tag>v2.5.0 Fixed</div></div>
<div id=game-container></div>
<div id=crosshair><div class=dot></div></div>
<div id=instructions><h1>PAUSED</h1><p>Click to Continue...</div>
<div id=mobile-controls><div id=joystick class=joystick-zone><div id=knob class=joystick-knob></div></div><button id=mobile-talk-btn>TALK</button></div>
<button id=mobile-exit-btn>SAIR DO CARRO</button>
<div id=sleep-screen><div class=sleep-particles></div><h1>SWEET DREAMS</h1><p>You drifted into a deep slumber...</p><div class=loading-dots><span></span><span></span><span></span></div></div>
<script>document.addEventListener('DOMContentLoaded', () => {
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const fpsCounter = document.getElementById('fps-counter');
            const ashContainer = document.getElementById('ash-container');
            const menuMusic = document.getElementById('menu-music');
            const headphonesPrompt = document.getElementById('headphones-prompt');
            const gameAmbience = document.getElementById('game-ambience');
            
            if(menuMusic) {
                menuMusic.volume = 0.3;
                menuMusic.currentTime = 0;
            }

            const safePlay = async (audio) => {
                if(!audio) return;
                try {
                    audio.volume = 0.3; 
                    await audio.play();
                } catch (e) {
                    audio.load(); 
                    try { await audio.play(); } catch (e2) {}
                }
            };

            headphonesPrompt.addEventListener('click', () => {
                if(menuMusic) safePlay(menuMusic);
                if(gameAmbience) gameAmbience.load();
                headphonesPrompt.style.opacity = '0';
                setTimeout(() => headphonesPrompt.style.display = 'none', 1000);
            });
            
            const playBtn = document.getElementById('play-btn');
            if(playBtn && menuMusic) {
                playBtn.addEventListener('click', () => {
                    if(gameAmbience) {
                        gameAmbience.volume = 0.7;
                        gameAmbience.currentTime = 0;
                        safePlay(gameAmbience);
                    }
                    const fadeInterval = setInterval(() => {
                        if(menuMusic.volume > 0.01) menuMusic.volume -= 0.01;
                        else {
                            menuMusic.volume = 0;
                            menuMusic.pause();
                            clearInterval(fadeInterval);
                        }
                    }, 50);
                });
            }

            if (ashContainer) {
                for (let i = 0; i < 35; i++) {
                    const ash = document.createElement('div');
                    ash.className = 'ash';
                    ash.style.left = Math.random() * 100 + '%';
                    ash.style.animationDelay = Math.random() * 20 + 's';
                    ash.style.animationDuration = (15 + Math.random() * 10) + 's';
                    ash.style.width = (2 + Math.random() * 2) + 'px';
                    ash.style.height = ash.style.width;
                    ash.style.opacity = 0.25 + Math.random() * 0.35;
                    ashContainer.appendChild(ash);
                }
            }

            settingsBtn?.addEventListener('click', () => settingsPanel.classList.add('active'));
            closeSettingsBtn?.addEventListener('click', () => settingsPanel.classList.remove('active'));

            document.querySelectorAll('.setting-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    toggle.classList.toggle('active');
                    if (toggle.id === 'fps-toggle') fpsCounter.style.display = toggle.classList.contains('active') ? 'block' : 'none';
                });
            });

            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => btn.style.transform = `translateY(-2px) translateX(${(Math.random() - 0.5) * 1.5}px)`);
                btn.addEventListener('mouseleave', () => btn.style.transform = '');
            });
        });
</script>
<script type=module>
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        const BASE_URL = "https://raw.githubusercontent.com/Felipe9272727/";

        const MODEL_URL = BASE_URL + "Socoroo/main/interior%20staircase%203d%20model.glb";
        const BED_MODEL_URL = BASE_URL + "Texturas-pro-jogo/main/beige+upholstered+bed+3d+model.glb";
        const DOOR_MODEL_URL = BASE_URL + "M-veis-hehe/main/Meshy_AI_Wooden_Portal_0124113239_texture.glb";
        const CABINET_TEXTURE_URL = BASE_URL + "Texturas-pro-jogo/main/file_00000000458471f6966fb707a43567ae.png";
        const CLOTHES_MODEL_URL = BASE_URL + "M-veis-hehe/main/Meshy_AI_Stack_of_Cozy_Essenti_0126033314_texture.glb";
        const SITTING_WIFE_URL = BASE_URL + "Animations/main/ImageToStl.com_Sitting%2BTalking(2).glb";
        const STEAK_PLATE_URL = BASE_URL + "M-veis-hehe/main/steak+plate+3d+model.glb";
        const ROAD_MODEL_URL = BASE_URL + "M-veis-hehe/main/road+scene+3d+model.glb";
        const DEER_MODEL_URL = BASE_URL + "M-veis-hehe/refs/heads/main/d6f3f9b7-cbd1-48ca-9af6-0503380f7145.glb";
        
        const TEXTURE_URL_1 = BASE_URL + "chatgpt-textures/main/file_00000000e124720ea0310ef306ea383b.png";
        const TEXTURE_URL_2 = BASE_URL + "Texturas-pro-jogo/main/file_00000000e8b8720e986fdec8ccd96327.png";
        const TEXTURE_URL_3 = BASE_URL + "Texturas-pro-jogo/main/file_00000000e8b8720e986fdec8ccd96327.png";
        const TEXTURE_URL_4 = BASE_URL + "Texturas-pro-jogo/main/file_00000000ff5071f599f97ab93703f3f5.png";
        const TEXTURE_URL_5 = BASE_URL + "Texturas-pro-jogo/main/file_000000004c44720e90700f40795661c8.png";
        const TEXTURE_URL_6 = BASE_URL + "Texturas-pro-jogo/main/Gemini_Generated_Image_vdsw6kvdsw6kvdsw.png";
        const TEXTURE_URL_7 = BASE_URL + "Texturas-pro-jogo/main/file_00000000b990720eb4df3445bbf185ed.png";
        
        const MODEL_SCALE = 3500;
        const PLAYER_HEIGHT = 160;
        const PLAYER_RADIUS = 50; 
        const PLAYER_SPEED = 6000;
        const PLAYER_JUMP = 350;
        const GRAVITY = 900;
        const STEP_HEIGHT = 60; 
        const CAR_SPEED = 3000;
        const RENDER_SCALE = 1.75; 

        // Data Structure: [x, y, z, sx, sy, sz, rx, ry, rz, config]
        // config can be a textureType (number) or a properties object
        // if config is -1, it means visible: false
        const WALL_DATA = [
            [191.96,-549.74,-545.68, 3968.06,10,11630.32, 0,0,0, -1],
            [304.98,-486.08,213.83, 273.39,533.11,438.54, 0,0,0, -1],
            [-593.94,-611.29,-364.18, 802.65,1014.39,3227.89, 0,0,0, -1],
            [0,251.34,1550.67, 3179.8,744.56,20, 0,0,0, -1],
            [-992.29,200,0, 24.98,805.99,6363.12, 0,0,0, -1],
            [329.75,-385.59,-64.46, 408.91,248.5,954.57, -0.47,0,0, -1],
            [494.32,-195.92,-89.89, 34.03,259.83,-1060.14, -0.59,-0.02,-0.06, -1],
            [147.77,-145.92,-89.89, 34.03,259.83,-1060.14, -0.59,-0.02,-0.06, -1],
            [675.78,-314.21,-1614.76, 1805.61,1862.22,27.12, 0,0,0, 2],
            [1566.22,-313.82,-716.02, 40.93,1870.64,1805.1, 0,0,0, 2],
            [-606.79,211.56,-1420.72, 824.64,768.77,10, 0,0,0, 6],
            [-1038.65,200,-129.97, 10,649.96,510.1, 0,0,0, 0],
            [1337.73,251.87,956.94, 10,709.27,1231.8, 0,0,0, 5],
            [941.28,250,350, 779.15,709.27,20, 0,0,0, 5],
            [-27.62,151.15,350, 356.51,978.74,20, 0,0,0, 5],
            [-250,150.98,-547.44, 10,833.3,1805.1, 0,0,0, 6],
            [-200.27,134.98,-1522.55, 10,919.69,207.38, 0,0,0, 0],
            [1535.67,-354.08,107.17, 400,1985.68,20, 0,0,0, 2],
            [1339.44,-707.22,230.86, 10,2660.02,244.2, 0,0,0, 2],
            [0,615.32,0, 3283.77,10,4338.35, 0,0,0, 7],
            [229.99,-521.73,906.78, 2260.03,854.11,1187.96, 0,0,0, 1],
            [134.76,203,1362.05, 10,841.03,516.79, 0,0,0, 5],
            [134.76,203,626.92, 10,841.03,568.1, 0,0,0, 5],
            [134.76,454.61,1007.31, 10,337.81,192.68, 0,0,0, 5],
            [-727.29,155.11,356.55, 442.97,954.94,10, 0,0,0, 5],
            [-198.54,155.11,356.55, 205.36,954.94,10, 0,0,0, 5],
            [-403.51,471.46,356.55, 204.58,322.25,10, 0,0,0, 5],
            [450.82,444.61,1525.82, 7034.89,1120.16,79.09, 0,0,0, 5],
            [-915.54,373.68,1062.91, 100,996.52,124950.21, 0,0,0, 5],
            [572.27,-357.51,327.79, -1567.42,-545.16,-4.73, 0,0,0, 1],
            [-179.36,-367.81,-346.13, 15.55,-569.5,-1376.61, 0,0,0, 1],
            [641.61,-149.99,1288.12, 8806.86,151.31,1841.97, 0,0,0, 4],
            [-182.18,-427.51,-1177.38, 23.39,-679.63,922.15, 0,0,0, 1],
            [273.79,-328.77,-1636.36, 5909.09,493.77,100, 0,0,0, 1],
            [1581.46,-357.22,-344.75, 85.84,562.56,10734.93, 0,0,0, 1],
            [1400,-350,350, 222.45,516.95,-603.09, 0,0,0, 1],
            [941.28,250,343.48, 779.15,709.27,20, 0,0,0, 2],
            [-27.62,151.15,344.75, 356.51,978.74,20, 0,0,0, 2],
            [-200,150.98,-547.44, 10,833.3,1805.1, 0,0,0, 3],
            [-550,500,350, 745.52,387.02,1.62, 0,0,0, 6],
            [-700,50,350, 394.78,514.92,6.4, 0,0,0, 6],
            [-250,227.15,350, -105.69,1335.46,-0.37, 0,0,0, 6],
            [-900,260.62,-750, 100,865.08,2186.03, 0,0,0, 6],
            [-900,66.81,1150, 100,1192.8,1616.02, 0,0,0, 5],
            [537.87,212.26,-102.81, 4.18,894.86,908.65, 0,0,0, 2],
            [704.05,72.58,-548.51, 333.34,2933.67,9.29, 0,0,0, 2],
            [1501.49,72.58,-548.51, 759.09,2933.67,9.29, 0,0,0, 2],
            [996.33,725.45,-548.51, 251.22,1627.92,9.29, 0,0,0, 2],
            [996.33,-994.58,-548.51, 251.22,799.36,9.29, 0,0,0, 2],
            [540.02,-350.65,-319.61, -7.05,369.62,463.55, 0,0,0, 2],
            [537.48,-281.59,-36.63, -0.8,100,100, 0,0,0, 2],
            [-656.45,157.62,-852.1, 728.34,932.08,100, 0,0,0, 6],
            [350,-550,-550, 363.15,74.34,100, 0,0,0, -1],
            [1250,-450,-1050, 305.17,301.86,288.24, 0,1.57,0, {isModel:true, modelUrl:"M-veis-hehe/main/retro+tv+on+stand+3d+model.glb"}],
            [-750,0,182.6, 139.28,137.76,119.13, 0,1.57,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Aqua_Throne_0124081109_texture.glb"}],
            [900,-452,250, 101.98,127.8,-106.43, 0,0.04,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_The_Digital_Stove_0124082557_texture.glb"}],
            [-650,0,950, 323.94,294.93,314.8, 0,1.57,0, {isModel:true, modelUrl:"Finalzinho-/main/wooden+bed+3d+model(2).glb", morningModelUrl:"M-veis-hehe/main/wooden+bed+3d+model%20(1).glb"}],
            [-641.97,10.91,709.6, 73.62,72.8,88.69, -3.14,0.01,-3.14, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Pixel_Armchair_0124090835_texture.glb"}],
            [-750,53.62,650, 167.13,162.7,168.59, 0,1.57,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_RGB_Setup_0124080551_texture.glb"}],
            [1238.04,-457.64,-1479.75, -567.94,481.68,501.48, -3.14,1.53,-3.14, {isModel:true, modelUrl:"M-veis-hehe/main/plaid+sofa+3d+model%20(1).glb"}],
            [507.05,-400.74,102.99, 242.8,485.07,433.08, 0,0,0, {isModel:true, modelUrl:"M-veis-hehe/main/kitchen+cabinets+3d+model.glb"}],
            [1231.06,-502.22,-1250, 101.73,93.28,118.47, 0,0,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Wooden_table_0124082042_texture.glb"}],
            [-759.71,15.2,-712.33, 139.22,167.43,168.39, 0,0,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Chuveiro_0124093010_texture.glb"}],
            [700,-450,250, 98.57,127.8,107.57, 3.11,-0.07,3.14, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Pia_0124081632_texture.glb"}],
            [1100.17,-393.76,200, 401.24,493.63,340.61, -3.14,1.55,-3.14, {isModel:true, modelUrl:"M-veis-hehe/main/kitchen+cabinets+3d+model.glb"}],
            [-316.33,42.83,-237.19, 168.22,167.19,200.38, -3.14,-1.54,-3.14, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Pia_banheiro_0124093607_texture.glb"}],
            [1050,-450,-200, 75.21,81.41,83.66, 0,1.57,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Wooden_Elegance_0124084145_texture.glb"}],
            [1200,-500,-200, 136.59,170.27,-79.53, 0,0,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Table_of_kitchen_0124083211_texture.glb"}],
            [1350,-450,-200, 75.21,81.41,83.66, 0,-1.57,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Wooden_Elegance_0124084145_texture.glb"}],
            [866.83,-331.26,-552.12, 274.28,-259.44,553.68, 0,0,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Wooden_Portal_0124113239_texture.glb"}],
            [146.8,90.38,914.4, 192.51,194.88,360.6, 0,-1.54,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Wooden_Portal_0124113239_texture.glb"}],
            [-508.06,116.02,343.11, 207.73,195.68,425.95, 0,0,0, {isModel:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Wooden_Portal_0124113239_texture.glb"}],
            [900,-550,150, 250,250,250, 0,0,0, {isModel:true, visible:false, modelUrl:"Animations/main/ImageToStl.com_Standing+Torch+Light+Torch(1).glb"}],
            [-648.88,-7.07,1448.96, 70.15,74.19,67.42, 0,3.14,0, {isModel:true, isSuitcase:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Suitcase_Elegance_0125035824_texture.glb"}],
            [-650,75,950, 70,70,70, 0,3.14,0, {isModel:true, visible:false, isPackedSuitcase:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Adventure_Essentials_0125034603_texture.glb"}],
            [-447.08,-72.65,1439.12, 1,1,1, 0,3.14,0, {isCustomCabinet:true}],
            [-447,-50,1439, 50,50,50, 0,0,0, {isModel:true, isClothes:true, modelUrl: CLOTHES_MODEL_URL}],
            [-650,75,950, 70,70,70, 0,3.14,0, {isModel:true, visible:false, isFinalSuitcase:true, modelUrl:"M-veis-hehe/main/Meshy_AI_Suitcase_Elegance_0125035824_texture.glb"}],
            [509.33,-282.06,-487.77, 39.85,773.11,114.39, 0,0,0, -1],
            [1350,-515,-200, 240,240,240, 0,-1.57,0, {isModel:true, visible:false, isWifeSitting:true, modelUrl: SITTING_WIFE_URL}],
            [0,600,200000, 3500,3500,3500, 0,1.57,0, {isModel:true, isRoad:true, modelUrl: ROAD_MODEL_URL}]
        ];

        let scene, camera, renderer;
        let controls;
        let colliders = [];
        let crashBoundaries = [];
        let levelObjects = [];
        let doors = [];
        let mixers = [];
        let morningTorch = null;
        let isCarryingSuitcase = false;
        let isCarryingClothes = false;
        let carriedObject = null;
        let currentQuest = ""; 
        let isTrapped = false;
        let carModel = null;
        let isDriving = false;
        let roadSegments = [];
        let roadLength = 0;
        
        let deerModel = null;
        let bloodPool = null;
        let isDeerCutscene = false;
        let cutsceneStartTime = 0;
        let hasExitedCar = false;
        let hasSeenDeer = false;
        let isCarStopped = false;
        let canExitCar = false;
        let hasResetHappened = false;
        let mobileExitBtn;
        let isCarryingDeer = false;
        let deerOriginalPosition = null;
        let deerDropZone = null;
        let canDropDeer = false;
        let hasDumpedDeer = false;
        
        let ambientLight, dirLight;
        
        let frameCount = 0;
        let lastTimeFPS = performance.now();
        const fpsElement = document.getElementById('fps-counter');

        const _moveDir = new THREE.Vector3();
        const _sideVec = new THREE.Vector3();
        const _forward = new THREE.Vector3();
        const _right = new THREE.Vector3();
        const _intendedMove = new THREE.Vector3();
        const _origin = new THREE.Vector3();
        
        let playerVelocity = new THREE.Vector3();
        let isGrounded = false;
        let prevTime = performance.now();
        
        let gameStarted = false;
        let isSitting = true;
        let hasStoodUp = false;
        let canInteract = false;
        let interactionTarget = null;
        let hasSlept = false;
        let hasTalkedToWife = false;
        let hasHadDinnerConversation = false;
        let hasTriggeredCarDialogue = false;
        let lastLockedMessageTime = 0;
        
        const rayDown = new THREE.Raycaster();
        const rayForward = new THREE.Raycaster();
        const interactionRay = new THREE.Raycaster();

        const materials = {};
        let matVisible, matInvisible, matHitbox;
        let wallTexture1, wallTexture2, wallTexture3, wallTexture4, wallTexture5, wallTexture6, wallTexture7;
        let cabinetTexture;

        const input = { forward: false, backward: false, left: false, right: false, jump: false };
        const joystick = { active: false, x: 0, y: 0 };
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        let frameCounter = 0;
        
        // Fun√ß√µes auxiliares para UI suave
        function showDialogue() {
            const box = document.getElementById('dialogue-box');
            box.style.display = 'flex';
            // For√ßa reflow para garantir que a transi√ß√£o funcione
            void box.offsetHeight;
            requestAnimationFrame(() => {
                box.classList.add('visible');
            });
        }
        
        function hideDialogue(callback) {
            const box = document.getElementById('dialogue-box');
            box.classList.remove('visible');
            setTimeout(() => {
                if (!box.classList.contains('visible')) {
                    box.style.display = 'none';
                }
                if (callback) callback();
            }, 500);
        }
        
        function showPrompt(text) {
            const p = document.getElementById('interaction-prompt');
            if (text) p.innerText = text;
            // For√ßa reflow
            void p.offsetHeight;
            requestAnimationFrame(() => p.classList.add('visible'));
        }
        
        function hidePrompt() {
            const p = document.getElementById('interaction-prompt');
            p.classList.remove('visible');
        }
        
        function playSuccessAnimation() {
            // Flash verde de sucesso
            const flash = document.getElementById('white-flash');
            flash.style.background = 'radial-gradient(circle, rgba(0,255,100,0.6) 0%, rgba(0,150,50,0.3) 50%, transparent 70%)';
            flash.style.transition = 'opacity 0.3s ease-out';
            flash.style.opacity = '1';
            
            // Shake suave de satisfa√ß√£o
            const body = document.body;
            let shakeCount = 0;
            const shakeInterval = setInterval(() => {
                if (shakeCount >= 6) {
                    clearInterval(shakeInterval);
                    body.style.transform = 'none';
                    return;
                }
                const x = (Math.random() - 0.5) * 4;
                const y = (Math.random() - 0.5) * 4;
                body.style.transform = `translate(${x}px, ${y}px)`;
                shakeCount++;
            }, 50);
            
            // Som de sucesso
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc1.connect(gain);
            osc2.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(523, audioCtx.currentTime); // C5
            osc1.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1); // E5
            osc1.frequency.setValueAtTime(784, audioCtx.currentTime + 0.2); // G5
            
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(659, audioCtx.currentTime + 0.15); // E5
            osc2.frequency.setValueAtTime(784, audioCtx.currentTime + 0.25); // G5
            osc2.frequency.setValueAtTime(1047, audioCtx.currentTime + 0.35); // C6
            
            gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            
            osc1.start();
            osc2.start(audioCtx.currentTime + 0.15);
            osc1.stop(audioCtx.currentTime + 0.5);
            osc2.stop(audioCtx.currentTime + 0.5);
            
            // Fade out do flash
            setTimeout(() => {
                flash.style.opacity = '0';
                setTimeout(() => {
                    flash.style.background = '#fff';
                }, 300);
            }, 200);
            
            // Criar part√≠culas de sucesso
            createSuccessParticles();
        }
        
        function createSuccessParticles() {
            const container = document.createElement('div');
            container.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9997;overflow:hidden;';
            document.body.appendChild(container);
            
            const colors = ['#00ff88', '#00ffaa', '#44ffaa', '#88ffcc', '#aaffdd'];
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                const size = 8 + Math.random() * 12;
                const startX = 40 + Math.random() * 20; // Centro da tela
                const startY = 50 + Math.random() * 10;
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 200;
                const endX = startX + Math.cos(angle) * distance / window.innerWidth * 100;
                const endY = startY + Math.sin(angle) * distance / window.innerHeight * 100;
                const duration = 0.5 + Math.random() * 0.5;
                const delay = Math.random() * 0.2;
                
                particle.style.cssText = `
                    position: absolute;
                    left: ${startX}%;
                    top: ${startY}%;
                    width: ${size}px;
                    height: ${size}px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    border-radius: 50%;
                    opacity: 1;
                    box-shadow: 0 0 ${size}px ${colors[Math.floor(Math.random() * colors.length)]};
                    animation: successParticle ${duration}s ease-out ${delay}s forwards;
                `;
                
                // Adiciona keyframes dinamicamente
                particle.style.setProperty('--endX', `${endX}%`);
                particle.style.setProperty('--endY', `${endY}%`);
                
                container.appendChild(particle);
            }
            
            // Adiciona o estilo de anima√ß√£o se n√£o existir
            if (!document.getElementById('success-particle-style')) {
                const style = document.createElement('style');
                style.id = 'success-particle-style';
                style.textContent = `
                    @keyframes successParticle {
                        0% { transform: scale(1); opacity: 1; }
                        100% { transform: scale(0) translateX(calc(var(--endX) - 50%)) translateY(calc(var(--endY) - 50%)); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remove o container depois da anima√ß√£o
            setTimeout(() => {
                container.remove();
            }, 1500);
        }
        
        function playSpeechSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'square';
            osc.frequency.value = 100 + Math.random() * 50; 
            
            gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.08);
        }
        
        function playLoudSpeechSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'sawtooth';
            osc.frequency.value = 120 + Math.random() * 50; 
            
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }
        
        function setPortrait(type) {
            const container = document.getElementById('portrait-container');
            const p = document.getElementById('player-portrait');
            const w = document.getElementById('wife-portrait');
            
            if(!type) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            p.style.display = 'none';
            w.style.display = 'none';
            
            if(type === 'player') p.style.display = 'block';
            if(type === 'wife') w.style.display = 'block';
        }

        async function typeWriter(text, elementId, speed = 50) {
            const el = document.getElementById(elementId);
            el.textContent = '';
            el.classList.add('dialogue-cursor');
            el.style.display = 'block';
            
            const chars = [...text];
            for (const char of chars) {
                el.textContent += char;
                if (char !== ' ') playSpeechSound();
                await new Promise(r => setTimeout(r, speed + Math.random() * 20));
            }
            el.classList.remove('dialogue-cursor');
        }

        async function runMonologue() {
            const lines = [
                "Uhhhh finalmente acabei de trabalhar....",
                "Amanh√£ come√ßam minhas f√©rias :).",
                "Por isso eu e minha esposa iremos viajar.",
                "Bom, chega de pensar, hora de dormir."
            ];

            showDialogue();
            setPortrait('player');
            
            await new Promise(r => setTimeout(r, 2000));

            for (const line of lines) {
                await typeWriter(line, 'dialogue-text', 60);
                await new Promise(r => setTimeout(r, 2000));
            }

            hideDialogue(() => {
                setPortrait(null);
                showPrompt(isMobile ? "Tap to Stand" : "Press E to Stand");
                updateQuest("V√° Dormir");
            });
        }
        
        function updateQuest(text) {
            currentQuest = text;
            const box = document.getElementById('quest-box');
            const txt = document.getElementById('quest-text');
            box.style.display = 'block';
            // Pequeno delay para trigger da anima√ß√£o
            requestAnimationFrame(() => {
                box.classList.add('visible');
            });
            txt.innerText = text;
            txt.style.animation = 'none';
            txt.offsetHeight;
            txt.style.animation = 'pulse 1s ease-in-out';
        }
        
        function showLockedMessage() {
            const msg = document.getElementById('locked-message');
            const now = performance.now();
            if (now - lastLockedMessageTime > 2500) {
                lastLockedMessageTime = now;
                msg.classList.add('visible');
                setTimeout(() => msg.classList.remove('visible'), 2000);
            }
        }

        function optimizeModelMaterial(model, modelName, isLevel = false) {
            const isTorch = modelName && (modelName.includes("Torch") || modelName.includes("torch"));
            const isRoad = modelName === "Road"; 

            model.traverse((child) => {
                if (child.isMesh) {
                    if (isLevel && !isRoad) child.frustumCulled = false;
                    else {
                        if (child.geometry) child.geometry.computeBoundingSphere();
                        child.frustumCulled = true; 
                    }
                    
                    child.castShadow = false;
                    child.receiveShadow = false;
                    
                    if (child.material) {
                        if (isTorch && (child.material.isMeshStandardMaterial || child.material.isMeshPhysicalMaterial)) {
                            const old = child.material;
                            const newMat = new THREE.MeshLambertMaterial({
                                map: old.map,
                                color: old.color,
                                opacity: old.opacity,
                                transparent: old.transparent,
                                alphaTest: old.alphaTest,
                                emissive: old.emissive,
                                emissiveMap: old.emissiveMap,
                                emissiveIntensity: old.emissiveIntensity || 1.0,
                                side: THREE.FrontSide
                            });
                            child.material = newMat;
                        }

                        const mats = Array.isArray(child.material) ? child.material : [child.material];
                        mats.forEach(mat => {
                            if (isTorch || isRoad) mat.side = THREE.FrontSide;
                            else mat.side = THREE.DoubleSide;
                            
                            if(mat.map) {
                                mat.map.minFilter = THREE.LinearMipmapLinearFilter;
                                mat.map.magFilter = THREE.LinearFilter;
                                mat.map.generateMipmaps = true;
                                mat.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                                mat.map.needsUpdate = true;
                            }
                            
                            if (isRoad) {
                                mat.polygonOffset = true;
                                mat.polygonOffsetFactor = 1;
                                mat.polygonOffsetUnits = 1;
                            }
                            
                            if(mat.transparent) mat.alphaTest = 0.5;
                        });
                    }
                }
            });
        }

        function addCollisionToModel(model) {
            const originalPos = model.position.clone();
            const originalRot = model.rotation.clone();
            const originalScale = model.scale.clone();

            model.position.set(0,0,0);
            model.rotation.set(0,0,0);
            model.scale.set(1,1,1);
            model.updateMatrix();
            model.updateMatrixWorld(true);

            const box = new THREE.Box3().setFromObject(model);
            const size = new THREE.Vector3();
            box.getSize(size);
            const center = new THREE.Vector3();
            box.getCenter(center);
            
            if (size.lengthSq() < 0.0001) size.set(100, 100, 100); 

            const geo = new THREE.BoxGeometry(size.x, size.y, size.z);
            const hitbox = new THREE.Mesh(geo, matHitbox);
            hitbox.position.copy(center);
            hitbox.userData.isHitbox = true; 

            model.add(hitbox);
            colliders.push(hitbox);

            model.position.copy(originalPos);
            model.rotation.copy(originalRot);
            model.scale.copy(originalScale);
            model.updateMatrix();
            model.updateMatrixWorld(true);
        }

        function removeCollisionFromModel(model) {
            if (!model) return;
            const hitbox = model.children.find(c => c.userData.isHitbox);
            if (hitbox) {
                model.remove(hitbox);
                const idx = colliders.indexOf(hitbox);
                if (idx > -1) colliders.splice(idx, 1);
            }
        }

        function getMaterial(type) {
            if (materials[type]) return materials[type];
            return matVisible;
        }

        function applySmartUVs(geometry, scaleArray) {
            const uv = geometry.attributes.uv;
            const sX = Math.abs(scaleArray[0]);
            const sY = Math.abs(scaleArray[1]);
            const sZ = Math.abs(scaleArray[2]);
            const maxDim = Math.max(sX, sZ);
            const repeatX = maxDim / 500;
            const repeatY = sY / 500;
            for(let i=0; i<uv.count; i++){
                uv.setXY(i, uv.getX(i) * repeatX, uv.getY(i) * repeatY);
            }
            uv.needsUpdate = true;
        }

        function init() {
            try {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x05070a);
                scene.fog = new THREE.Fog(0x05070a, 100, 20000);

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 15, 200000); 
                camera.position.set(-642, 121, 710);
                camera.lookAt(-750, 120, 650);

                ambientLight = new THREE.AmbientLight(0x405060, 1.2);
                scene.add(ambientLight);
                
                dirLight = new THREE.DirectionalLight(0xaaccff, 0.6);
                dirLight.position.set(500, 1000, 750);
                dirLight.castShadow = false;
                scene.add(dirLight);

                const isMobileDevice = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                renderer = new THREE.WebGLRenderer({ 
                    antialias: false, 
                    powerPreference: "high-performance",
                    precision: isMobileDevice ? 'mediump' : 'highp',
                    logarithmicDepthBuffer: true
                });
                
                renderer.setSize(window.innerWidth / RENDER_SCALE, window.innerHeight / RENDER_SCALE, false);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.0));
                
                renderer.setClearColor(0x05070a, 1);
                renderer.shadowMap.enabled = false; 
                document.getElementById('game-container').appendChild(renderer.domElement);

                const manager = new THREE.LoadingManager();
                manager.onProgress = function ( url, itemsLoaded, itemsTotal ) {
                    const bar = document.getElementById('loading-bar');
                    const text = document.getElementById('loading-text');
                    const percent = Math.floor((itemsLoaded / itemsTotal) * 100) + '%';
                    if(bar) bar.style.width = percent;
                    if(text) text.innerText = 'Loaded ' + itemsLoaded + ' of ' + itemsTotal;
                };
                manager.onLoad = function ( ) {
                    const text = document.getElementById('loading-text');
                    if(text) text.innerText = 'Preparing...';
                    setTimeout(() => {
                        const el = document.getElementById('loading');
                        if(el) {
                            el.style.opacity = '0';
                            setTimeout(() => el.style.display = 'none', 500);
                        }
                    }, 200); 
                };

                const textureLoader = new THREE.TextureLoader(manager);
                textureLoader.setCrossOrigin('anonymous');

                const loadTexture = (url, name) => {
                    const tex = textureLoader.load(url);
                    tex.wrapS = THREE.RepeatWrapping;
                    tex.wrapT = THREE.RepeatWrapping;
                    tex.colorSpace = THREE.SRGBColorSpace;
                    tex.generateMipmaps = true;
                    tex.minFilter = THREE.LinearMipmapLinearFilter; 
                    tex.anisotropy = renderer.capabilities.getMaxAnisotropy();
                    return tex;
                }

                wallTexture1 = loadTexture(TEXTURE_URL_1, "Texture 1");
                wallTexture2 = loadTexture(TEXTURE_URL_2, "Texture 2");
                wallTexture3 = loadTexture(TEXTURE_URL_3, "Texture 3");
                wallTexture4 = loadTexture(TEXTURE_URL_4, "Texture 4");
                wallTexture5 = loadTexture(TEXTURE_URL_5, "Texture 5");
                wallTexture6 = loadTexture(TEXTURE_URL_6, "Texture 6");
                wallTexture7 = loadTexture(TEXTURE_URL_7, "Texture 7");
                cabinetTexture = loadTexture(CABINET_TEXTURE_URL, "Cabinet Texture");
                
                matVisible = new THREE.MeshLambertMaterial({ color: 0xffffff });
                matVisible.userData.textureType = 0;
                materials[0] = matVisible;

                matInvisible = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000, 
                    transparent: true, 
                    opacity: 0, 
                    depthWrite: false,
                    colorWrite: false
                });
                
                matHitbox = new THREE.MeshBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0, depthWrite: false });

                const createMat = (tex, type) => {
                    const m = new THREE.MeshLambertMaterial({ map: tex, color: 0xffffff });
                    m.userData.textureType = type;
                    return m;
                }

                materials[1] = createMat(wallTexture1, 1);
                materials[2] = createMat(wallTexture2, 2);
                materials[3] = createMat(wallTexture3, 3);
                materials[4] = createMat(wallTexture4, 4);
                materials[5] = createMat(wallTexture5, 5);
                materials[6] = createMat(wallTexture6, 6);
                materials[7] = createMat(wallTexture7, 7);

                const loader = new GLTFLoader(manager);
                loader.load(MODEL_URL, (gltf) => {
                    const model = gltf.scene;
                    model.scale.setScalar(MODEL_SCALE);
                    optimizeModelMaterial(model, "Staircase", true);
                    scene.add(model);
                }, undefined, (err) => console.error(err));
                
                loader.load(DEER_MODEL_URL, (gltf) => {
                    deerModel = gltf.scene;
                    deerModel.scale.set(200, 200, 200); 
                    deerModel.visible = false;
                    deerModel.traverse((child) => {
                        if (child.isMesh) {
                            child.frustumCulled = false;
                            child.castShadow = false;
                            child.receiveShadow = false;
                        }
                    });
                    scene.add(deerModel);
                    levelObjects.push(deerModel);
                });

                buildWalls(manager); 
                setupControls();
                animate();
                
                window.addEventListener('resize', onWindowResize);
            } catch (e) {
                const errDiv = document.getElementById('error-log');
                if(errDiv) {
                    errDiv.style.display = 'block';
                    errDiv.innerText = "Error: " + e.message;
                }
            }
        }

        function createCrashSiteBoundaries(centerZ) {
            const floorY = 200; 
            const width = 2000; 
            const depth = 2000; 

            const floor = new THREE.Mesh(new THREE.BoxGeometry(width, 10, depth), matInvisible);
            floor.position.set(0, floorY - 5, centerZ); 
            floor.userData.isHitbox = true;
            scene.add(floor);
            colliders.push(floor);
            levelObjects.push(floor);
            crashBoundaries.push(floor);

            const wallL = new THREE.Mesh(new THREE.BoxGeometry(50, 1000, depth), matInvisible);
            wallL.position.set(-330, floorY + 500, centerZ); 
            wallL.userData.isHitbox = true;
            scene.add(wallL);
            colliders.push(wallL);
            levelObjects.push(wallL);
            crashBoundaries.push(wallL);

            const wallR = new THREE.Mesh(new THREE.BoxGeometry(50, 1000, depth), matInvisible);
            wallR.position.set(330, floorY + 500, centerZ); 
            wallR.userData.isHitbox = true;
            scene.add(wallR);
            colliders.push(wallR);
            levelObjects.push(wallR);
            crashBoundaries.push(wallR);

            const wallF = new THREE.Mesh(new THREE.BoxGeometry(width, 1000, 50), matInvisible);
            wallF.position.set(0, floorY + 500, centerZ - 800);
            wallF.userData.isHitbox = true;
            scene.add(wallF);
            colliders.push(wallF);
            levelObjects.push(wallF);
            crashBoundaries.push(wallF);

            const wallB = new THREE.Mesh(new THREE.BoxGeometry(width, 1000, 50), matInvisible);
            wallB.position.set(0, floorY + 500, centerZ + 800);
            wallB.userData.isHitbox = true;
            scene.add(wallB);
            colliders.push(wallB);
            levelObjects.push(wallB);
            crashBoundaries.push(wallB);
        }

        function removeCrashSiteBoundaries() {
            crashBoundaries.forEach(mesh => {
                scene.remove(mesh);
                const idx = colliders.indexOf(mesh);
                if(idx > -1) colliders.splice(idx, 1);
                const loIdx = levelObjects.indexOf(mesh);
                if(loIdx > -1) levelObjects.splice(loIdx, 1);
            });
            crashBoundaries = [];
        }
        
        function buildCustomCabinet(data) {
            const group = new THREE.Group();
            
            if (data) {
                group.position.fromArray(data.position);
                if (data.rotation) group.rotation.fromArray(data.rotation);
                if (data.scale) group.scale.fromArray(data.scale);
            } else {
                group.position.set(-850, 0, 1150);
                group.rotation.set(0, Math.PI, 0); 
            }
            
            const width = 250;
            const height = 300;
            const depth = 80;
            const thickness = 5;
            
            const mat = new THREE.MeshLambertMaterial({ map: cabinetTexture, side: THREE.DoubleSide });
            const knobMat = new THREE.MeshStandardMaterial({ 
                color: 0xFFFF00, 
                metalness: 0.6, 
                roughness: 0.2,
                emissive: 0x333300 
            });
            const knobGeo = new THREE.SphereGeometry(7, 32, 32);
            
            const back = new THREE.Mesh(new THREE.BoxGeometry(width, height, thickness), mat);
            back.position.set(0, height/2, -depth/2);
            group.add(back);
            
            const top = new THREE.Mesh(new THREE.BoxGeometry(width, thickness, depth), mat);
            top.position.set(0, height, 0);
            group.add(top);
            
            const bottom = new THREE.Mesh(new THREE.BoxGeometry(width, thickness, depth), mat);
            bottom.position.set(0, 0, 0);
            group.add(bottom);
            
            const left = new THREE.Mesh(new THREE.BoxGeometry(thickness, height, depth), mat);
            left.position.set(-width/2, height/2, 0);
            group.add(left);
            
            const right = new THREE.Mesh(new THREE.BoxGeometry(thickness, height, depth), mat);
            right.position.set(width/2, height/2, 0);
            group.add(right);
            
            const hitboxGeo = new THREE.BoxGeometry(width, height, depth);
            const hitbox = new THREE.Mesh(hitboxGeo, matHitbox);
            hitbox.position.set(0, height/2, 0);
            hitbox.userData.isHitbox = true;
            group.add(hitbox);
            colliders.push(hitbox);

            const rodGeo = new THREE.CylinderGeometry(3, 3, width - thickness * 4, 8);
            const rodMat = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const rod = new THREE.Mesh(rodGeo, rodMat);
            rod.rotation.z = Math.PI / 2;
            rod.position.set(0, height - 40, 0);
            group.add(rod);

            const clothesColors = [0x3a4b5c, 0x5c3a3a, 0x3a5c4b, 0x1a1a1a, 0x888888];
            const shirtGeo = new THREE.BoxGeometry(15, 180, 50);
            
            for (let i = 0; i < 5; i++) {
                const cMat = new THREE.MeshLambertMaterial({ color: clothesColors[i % clothesColors.length] });
                const shirt = new THREE.Mesh(shirtGeo, cMat);
                const xOffset = -70 + (i * 35);
                shirt.position.set(xOffset, height - 40 - 90, 0); 
                shirt.rotation.y = (Math.random() - 0.5) * 0.4;
                group.add(shirt);
            }
            
            const doorWidth = width / 2;
            
            const leftPivot = new THREE.Object3D();
            leftPivot.position.set(-width/2, 0, depth/2); 
            
            const leftDoor = new THREE.Mesh(new THREE.BoxGeometry(doorWidth, height, thickness), mat);
            leftDoor.position.set(doorWidth/2, height/2, 0); 
            
            const leftKnob = new THREE.Mesh(knobGeo, knobMat);
            leftKnob.position.set(doorWidth/2 - 15, 0, thickness/2 + 6);
            leftDoor.add(leftKnob);

            leftPivot.add(leftDoor);
            
            leftPivot.userData.canOpen = true;
            leftPivot.userData.isOpen = false;
            leftPivot.userData.baseRotation = 0;
            leftPivot.userData.openDir = -1; 
            
            group.add(leftPivot);
            levelObjects.push(leftPivot); 
            
            const rightPivot = new THREE.Object3D();
            rightPivot.position.set(width/2, 0, depth/2); 
            
            const rightDoor = new THREE.Mesh(new THREE.BoxGeometry(doorWidth, height, thickness), mat);
            rightDoor.position.set(-doorWidth/2, height/2, 0);
            
            const rightKnob = new THREE.Mesh(knobGeo, knobMat);
            rightKnob.position.set(-doorWidth/2 + 15, 0, thickness/2 + 6);
            rightDoor.add(rightKnob);

            rightPivot.add(rightDoor);
            
            rightPivot.userData.canOpen = true;
            rightPivot.userData.isOpen = false;
            rightPivot.userData.baseRotation = 0;
            rightPivot.userData.openDir = 1; 
            
            leftPivot.userData.sibling = rightPivot;
            rightPivot.userData.sibling = leftPivot;

            group.add(rightPivot);
            levelObjects.push(rightPivot);
            
            scene.add(group);
            levelObjects.push(group);
        }

        function spawnDinnerPlates() {
            const loader = new GLTFLoader();
            loader.load(STEAK_PLATE_URL, (gltf) => {
                const model = gltf.scene;
                optimizeModelMaterial(model, "SteakPlate", true);
                const plate1 = model.clone();
                plate1.scale.set(60, 60, 60);
                plate1.position.set(1120, -408, -200); 
                scene.add(plate1);
                levelObjects.push(plate1);
                const plate2 = model.clone();
                plate2.scale.set(60, 60, 60);
                plate2.position.set(1280, -408, -200); 
                scene.add(plate2);
                levelObjects.push(plate2);
            }, undefined, (err) => console.error("Plate load error", err));
        }

        function buildWalls(manager) {
            if (!WALL_DATA || !Array.isArray(WALL_DATA)) return;

            const loader = new GLTFLoader(manager);
            const createdWalls = new Set(); 

            WALL_DATA.forEach((dataArray) => {
                // UNPACKING DATA FROM COMPRESSED ARRAY
                const [x, y, z, sx, sy, sz, rx, ry, rz, config] = dataArray;

                // Reconstruct data object for compatibility with existing logic
                const data = {
                    position: [x, y, z],
                    scale: [sx, sy, sz],
                    rotation: [rx, ry, rz],
                    visible: true,
                    textureType: 0
                };

                // Handle Config (Texture Number or Props Object)
                if (typeof config === 'number') {
                    // It's a wall
                    if (config === -1) {
                        data.visible = false;
                        data.textureType = 0;
                    } else {
                        data.textureType = config;
                    }
                } else if (typeof config === 'object') {
                    // It's a complex object
                    Object.assign(data, config);
                    
                    // URL Handling: Append BASE_URL if relative path
                    if (data.modelUrl && !data.modelUrl.startsWith('http')) {
                        data.modelUrl = BASE_URL + data.modelUrl;
                    }
                    if (data.morningModelUrl && !data.morningModelUrl.startsWith('http')) {
                        data.morningModelUrl = BASE_URL + data.morningModelUrl;
                    }
                }

                const r = (v) => Math.round(v * 100) / 100;
                let key = `POS:${data.position.map(r).join(',')}_ROT:${data.rotation.map(r).join(',')}_SCL:${data.scale.map(r).join(',')}`;
                if (data.isModel) key += `_URL:${data.modelUrl}`;
                else key += `_TEX:${data.textureType}`;
                
                if (createdWalls.has(key)) return;
                createdWalls.add(key);

                if (data.isCustomCabinet) {
                    buildCustomCabinet(data);
                    return;
                }

                if (data.isModel) {
                     loader.load(data.modelUrl || BED_MODEL_URL, (gltf) => {
                         const model = gltf.scene;
                         model.scale.fromArray(data.scale);
                         let name = "Furniture";
                         if(data.modelUrl) {
                             const parts = data.modelUrl.split('/');
                             name = parts[parts.length-1];
                         }
                         optimizeModelMaterial(model, name, false);
                         if (data.modelUrl && data.modelUrl.includes("Torch")) {
                             model.userData.isTorch = true;
                             morningTorch = model;
                             model.visible = false; 
                         }
                         if (data.modelUrl && data.modelUrl.includes("Stove")) {
                             model.userData.isStove = true;
                             model.userData.canTalk = false; 
                         }
                         if(data.isSuitcase) {
                            model.userData.isSuitcase = true;
                            model.userData.canPickup = true;
                         }
                         if(data.isPackedSuitcase) model.userData.isPackedSuitcase = true;
                         if(data.isFinalSuitcase) model.userData.isFinalSuitcase = true;
                         if(data.isWifeSitting) {
                             model.userData.isWifeSitting = true;
                             model.visible = false; 
                         }
                         if(data.isClothes) {
                             model.userData.isClothes = true;
                             model.userData.canPickup = true; 
                             model.traverse((child) => {
                                if (child.isMesh) {
                                    if (Array.isArray(child.material)) child.material.forEach(m => { m.transparent = true; m.opacity = 0; });
                                    else if (child.material) { child.material.transparent = true; child.material.opacity = 0; }
                                }
                             });
                         }
                         if (data.isRoad) {
                            optimizeModelMaterial(model, "Road", true);
                            model.userData.isRoad = true;
                         }
                         if (gltf.animations && gltf.animations.length > 0) {
                             const mixer = new THREE.AnimationMixer(model);
                             gltf.animations.forEach((clip) => {
                                 const action = mixer.clipAction(clip);
                                 if (data.modelUrl === SITTING_WIFE_URL) {
                                     if (!model.userData.actions) model.userData.actions = [];
                                     model.userData.actions.push(action);
                                     action.play();
                                     action.paused = true; 
                                 } else action.play();
                             });
                             mixers.push(mixer);
                         }
                         if (data.modelUrl === DOOR_MODEL_URL) {
                             const box = new THREE.Box3().setFromObject(model);
                             const size = new THREE.Vector3();
                             box.getSize(size);
                             
                             const pivot = new THREE.Object3D();
                             pivot.position.fromArray(data.position);
                             if(data.rotation.length === 3) pivot.rotation.fromArray(data.rotation);
                             else if(data.rotation.length === 4) pivot.quaternion.fromArray(data.rotation);
                             if (data.scale) pivot.scale.fromArray(data.scale);

                             model.scale.set(1,1,1);
                             model.updateMatrix();
                             const naturalBox = new THREE.Box3().setFromObject(model);
                             const naturalSize = new THREE.Vector3();
                             naturalBox.getSize(naturalSize);

                             model.position.set(naturalSize.x / 2, 0, 0);
                             model.rotation.set(0,0,0);
                             
                             pivot.add(model);
                             scene.add(pivot);
                             
                             pivot.userData.isDoor = true;
                             pivot.userData.baseRotation = pivot.rotation.y;
                             doors.push(pivot);
                             
                             addCollisionToModel(model);
                             levelObjects.push(pivot);
                             return;
                         }

                         model.position.fromArray(data.position);
                         model.position.x += (Math.random() - 0.5) * 0.5;
                         model.position.y += (Math.random() - 0.5) * 0.5;
                         model.position.z += (Math.random() - 0.5) * 0.5;

                         if(data.rotation.length === 3) model.rotation.fromArray(data.rotation);
                         else if(data.rotation.length === 4) model.quaternion.fromArray(data.rotation);
                         
                         if (!model.userData.isTorch && !model.userData.isSuitcase && !model.userData.isClothes && !model.userData.isWifeSitting && !data.isRoad) {
                            addCollisionToModel(model);
                         }
                         if(model.userData.isSuitcase) addCollisionToModel(model);
                         
                         model.userData.isModel = true;
                         model.userData.modelUrl = data.modelUrl;
                         if (data.morningModelUrl) model.userData.morningModelUrl = data.morningModelUrl;
                         model.userData.isFurniture = true; 
                         model.userData.isInvisible = (data.visible === false);

                         if (data.modelUrl && data.modelUrl.includes("Armchair")) {
                             model.userData.canSit = false;
                             model.userData.sitPos = new THREE.Vector3(data.position[0], data.position[1] + 110, data.position[2]);
                         }
                         if (data.modelUrl && data.modelUrl.includes("Wooden_Elegance")) {
                             if (data.position[0] < 1200) { 
                                 model.userData.isKitchenChair = true;
                                 model.userData.canSit = false;
                                 model.userData.sitPos = new THREE.Vector3(data.position[0], -380, data.position[2] + 40); 
                             }
                         }
                         if (data.modelUrl && (data.modelUrl.toLowerCase().includes("bed"))) model.userData.canSleep = true;
                         if (data.canOpen) {
                             model.userData.canOpen = true;
                             model.userData.isOpen = false;
                             model.userData.baseRotation = model.rotation.y;
                         }
                         if (data.isRoad) {
                            optimizeModelMaterial(model, "Road", true);
                            model.userData.isRoad = true;
                            
                            const originalPos = model.position.clone();
                            const originalRot = model.rotation.clone();
                            const originalScale = model.scale.clone();
                            model.position.set(0,0,0);
                            model.rotation.set(0,0,0);
                            model.scale.set(1,1,1);
                            model.updateMatrix();
                            model.updateMatrixWorld(true);

                            const box = new THREE.Box3().setFromObject(model);
                            const size = new THREE.Vector3();
                            box.getSize(size);
                            const center = new THREE.Vector3();
                            box.getCenter(center);
                            
                            const groundGeo = new THREE.BoxGeometry(size.x, 0.02, size.z);
                            const groundHitbox = new THREE.Mesh(groundGeo, matHitbox);
                            
                            groundHitbox.position.set(center.x, box.min.y - 0.02, center.z);
                            groundHitbox.userData.isHitbox = true;
                            
                            model.add(groundHitbox);
                            colliders.push(groundHitbox);

                            model.position.copy(originalPos);
                            model.rotation.copy(originalRot);
                            model.scale.copy(originalScale);
                            model.updateMatrix();
                            model.updateMatrixWorld(true);
                         }
                         scene.add(model);
                         levelObjects.push(model);
                         if(data.visible === false) model.visible = false;
                     });
                     return;
                }

                if (data.visible === false) {
                    const wall = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), matInvisible);
                    wall.position.fromArray(data.position);
                    wall.scale.fromArray(data.scale);
                    wall.rotation.fromArray(data.rotation);
                    wall.userData.isInvisible = true;
                    wall.matrixAutoUpdate = false;
                    wall.updateMatrix();
                    scene.add(wall);
                    colliders.push(wall); 
                    levelObjects.push(wall);
                    return;
                }

                const pos = new THREE.Vector3().fromArray(data.position);
                const rot = new THREE.Euler().fromArray(data.rotation);
                const scale = new THREE.Vector3().fromArray(data.scale);
                const geo = new THREE.BoxGeometry(1, 1, 1);
                
                let texType = data.textureType;
                if (data.textured === true) texType = 1;
                
                const originalMat = getMaterial(texType || 0);
                const uniqueMat = originalMat.clone();
                
                uniqueMat.polygonOffset = true;
                uniqueMat.polygonOffsetFactor = (Math.random() - 0.5) * 4.0; 
                uniqueMat.polygonOffsetUnits = (Math.random() - 0.5) * 4.0;

                if (texType > 0) applySmartUVs(geo, [scale.x, scale.y, scale.z]);
                
                const wall = new THREE.Mesh(geo, uniqueMat);
                
                wall.position.copy(pos);
                wall.position.x += (Math.random() - 0.5) * 2.5; 
                wall.position.y += (Math.random() - 0.5) * 2.5;
                wall.position.z += (Math.random() - 0.5) * 2.5;

                wall.rotation.copy(rot);
                wall.scale.copy(scale);
                
                wall.userData.isInvisible = false;
                wall.userData.textureType = texType || 0;
                wall.matrixAutoUpdate = false;
                wall.updateMatrix();

                scene.add(wall);
                colliders.push(wall);
                levelObjects.push(wall);
            });
        }
        
        function createSleepParticles() {
            const container = document.querySelector('#sleep-screen .sleep-particles');
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'sleep-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                particle.style.width = (3 + Math.random() * 4) + 'px';
                particle.style.height = particle.style.width;
                container.appendChild(particle);
            }
        }
        
        function resetSleepScreenAnimations() {
            const screen = document.getElementById('sleep-screen');
            const h1 = screen.querySelector('h1');
            const p = screen.querySelector('p');
            const dots = screen.querySelector('.loading-dots');
            
            if (h1) {
                h1.style.animation = 'none';
                void h1.offsetHeight;
                h1.style.animation = 'sleepTitleIn 1.5s ease-out 0.5s forwards';
            }
            if (p) {
                p.style.animation = 'none';
                void p.offsetHeight;
                p.style.animation = 'sleepTextIn 1.2s ease-out 1s forwards';
            }
            if (dots) {
                dots.style.animation = 'none';
                void dots.offsetHeight;
                dots.style.animation = 'sleepTextIn 1s ease-out 1.5s forwards';
            }
        }
        
        function triggerSleep() {
            if (hasSlept) return; 
            hasSlept = true;
            
            const screen = document.getElementById('sleep-screen');
            if(!screen) return;
            
            createSleepParticles();
            resetSleepScreenAnimations();
            
            screen.style.display = 'flex';
            void screen.offsetWidth;
            screen.classList.add('active');
            
            const ambience = document.getElementById('game-ambience');
            if(ambience) {
                let vol = ambience.volume;
                const fade = setInterval(() => {
                    if(vol > 0.01) {
                        vol -= 0.01;
                        ambience.volume = vol;
                    } else {
                        ambience.pause();
                        clearInterval(fade);
                    }
                }, 50);
            }
            if(controls.isLocked) controls.unlock();
            gameStarted = false;
            document.getElementById('instructions').style.display = 'none'; 
            hidePrompt();
            document.getElementById('mobile-controls').style.display = 'none';
            setTimeout(wakeUp, 6000);
        }
        
        async function triggerDialogueWife() {
            if (hasTalkedToWife) return;
            hasTalkedToWife = true;
            canInteract = false;
            hidePrompt();
            document.getElementById('mobile-talk-btn').style.display = 'none';
            levelObjects.forEach(obj => { if(obj.userData.isStove) obj.userData.canTalk = false; });
            
            showDialogue();
            setPortrait('player');
            await typeWriter("Voc√™: Oi amor.", 'dialogue-text', 50);
            await new Promise(r => setTimeout(r, 1500));
            setPortrait('wife');
            await typeWriter("Esposa: Oi amor, j√° arrumou a mala?", 'dialogue-text', 50);
            await new Promise(r => setTimeout(r, 2000));
            setPortrait('player');
            await typeWriter("Voc√™: N√£o.", 'dialogue-text', 50);
            await new Promise(r => setTimeout(r, 1500));
            
            hideDialogue(() => {
                setPortrait(null);
                updateQuest("Arrume a mala");
            });
        }

        async function triggerWifeShout() {
            canInteract = false;
            hidePrompt();
            const textEl = document.getElementById('dialogue-text');
            
            showDialogue();
            setPortrait('wife');
            textEl.style.fontSize = '28px';
            textEl.style.color = '#ff6666';
            textEl.style.fontFamily = "'Nosifer', cursive"; 
            const shout = "AMOR, O ALMO√áO EST√Å PRONTO!";
            textEl.textContent = "";
            for(let char of shout) {
                textEl.textContent += char;
                if(char !== ' ') playLoudSpeechSound();
                const shake = 5;
                document.body.style.transform = `translate(${(Math.random()-0.5)*shake}px, ${(Math.random()-0.5)*shake}px)`;
                await new Promise(r => setTimeout(r, 60));
            }
            document.body.style.transform = "none";
            await new Promise(r => setTimeout(r, 2000));
            
            textEl.style.fontSize = '';
            textEl.style.color = '';
            textEl.style.fontFamily = '';
            
            hideDialogue(() => {
                setPortrait(null);
                if (morningTorch) morningTorch.visible = false;
                levelObjects.forEach(obj => {
                    if(obj.userData.isWifeSitting) obj.visible = true;
                    if(obj.userData.isKitchenChair) obj.userData.canSit = true;
                });
                spawnDinnerPlates();
                updateQuest("V√° para a cozinha");
            });
        }

        function triggerTeleportToRoad() {
            const screen = document.getElementById('sleep-screen');
            const title = screen.querySelector('h1');
            const sub = screen.querySelector('p');
            title.innerText = "A JORNADA";
            sub.innerText = "Deixando tudo para tr√°s...";
            
            createSleepParticles();
            resetSleepScreenAnimations();
            
            screen.style.display = 'flex';
            void screen.offsetWidth;
            screen.classList.add('active');
            
            const NIGHT_SKY_URL = BASE_URL + "Texturas-pro-jogo/main/file_00000000538871f59daa23bce4d2f59e.png";
            const texLoader = new THREE.TextureLoader();
            texLoader.load(NIGHT_SKY_URL, (texture) => {
                texture.colorSpace = THREE.SRGBColorSpace;
                texture.mapping = THREE.EquirectangularReflectionMapping;
                scene.background = texture;
                scene.environment = texture; 
            });
            scene.fog = new THREE.Fog(0x05070a, 200, 5000);
            if (dirLight) {
                dirLight.position.set(-1000, 2000, -1000);
                dirLight.color.set(0xaaccff);
                dirLight.intensity = 1.2; 
            }
            if (ambientLight) {
                ambientLight.color.set(0x404060);
                ambientLight.intensity = 0.8; 
            }
            const hemiLight = new THREE.HemisphereLight(0x444488, 0x222233, 0.6);
            hemiLight.position.set(0, 1000, 0);
            scene.add(hemiLight);
            levelObjects.push(hemiLight);

            let originalRoad = null;
            levelObjects.forEach(obj => { if(obj.userData.isRoad) originalRoad = obj; });
            if (originalRoad) {
                const box = new THREE.Box3().setFromObject(originalRoad);
                const size = new THREE.Vector3();
                box.getSize(size);
                roadLength = size.z; 
                originalRoad.position.set(0, 550, 200000);
                roadSegments.push(originalRoad);
                for(let i = 1; i <= 1; i++) {
                    const roadNext = originalRoad.clone();
                    roadNext.position.z = originalRoad.position.z - (roadLength * i);
                    scene.add(roadNext);
                    roadSegments.push(roadNext);
                    levelObjects.push(roadNext);
                }
                const roadBack = originalRoad.clone();
                roadBack.position.z = originalRoad.position.z + roadLength;
                scene.add(roadBack);
                roadSegments.push(roadBack);
                levelObjects.push(roadBack);
                roadSegments.sort((a,b) => a.position.z - b.position.z);
            }
            
            const roadFloor = new THREE.Mesh(new THREE.BoxGeometry(10000, 20, 200000), matInvisible);
            roadFloor.position.set(0, 0, 200000); 
            roadFloor.userData.isHitbox = true;
            scene.add(roadFloor);
            colliders.push(roadFloor);
            levelObjects.push(roadFloor);
            
            const bloodGeo = new THREE.CircleGeometry(120, 32);
            const bloodMat = new THREE.MeshBasicMaterial({ color: 0x8a0303, transparent: true, opacity: 0.8, depthWrite: false }); 
            bloodPool = new THREE.Mesh(bloodGeo, bloodMat);
            bloodPool.rotation.x = -Math.PI / 2;
            bloodPool.visible = false;
            scene.add(bloodPool);
            levelObjects.push(bloodPool);

            const headlightTarget = new THREE.Object3D();
            scene.add(headlightTarget);
            const createHeadlight = () => {
                const spot = new THREE.SpotLight(0xffffff, 0.0);
                spot.angle = 0.7;
                spot.penumbra = 0.3;
                spot.distance = 12000;
                spot.decay = 2;
                spot.castShadow = false;
                spot.target = headlightTarget;
                scene.add(spot);
                const spriteMat = new THREE.SpriteMaterial({ 
                    map: new THREE.CanvasTexture(generateFlareTexture()), 
                    color: 0xffffee, 
                    transparent: true, 
                    blending: THREE.AdditiveBlending,
                    opacity: 0 
                });
                const sprite = new THREE.Sprite(spriteMat);
                sprite.scale.set(120, 120, 1.0);
                scene.add(sprite);
                return { light: spot, flare: sprite };
            };
            
            const leftHL = createHeadlight();
            const rightHL = createHeadlight();
            const cabinLight = new THREE.PointLight(0xffaa55, 0.0, 500);
            scene.add(cabinLight);

            const loader = new GLTFLoader();
            loader.load(BASE_URL + "M-veis-hehe/main/black+suv+3d+model.glb", (gltf) => {
                carModel = gltf.scene;
                carModel.scale.set(340, 340, 340);
                carModel.userData.isCar = true;
                carModel.position.set(5, 300, 200000);
                carModel.rotation.y = Math.PI / 2; 
                carModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = false;
                        child.receiveShadow = false;
                        if (child.material) {
                            child.material.envMapIntensity = 2.5; 
                            child.material.roughness = 0.1;
                            child.material.metalness = 0.7;
                            child.material.needsUpdate = true;
                        }
                    }
                });
                carModel.userData.headlights = {
                    left: leftHL.light,
                    fLeft: leftHL.flare,
                    right: rightHL.light,
                    fRight: rightHL.flare,
                    target: headlightTarget
                };
                carModel.userData.cabinLight = cabinLight;
                scene.add(carModel);
                levelObjects.push(carModel);
            });
            
            loader.load(SITTING_WIFE_URL, (gltf) => {
                const wife = gltf.scene;
                wife.position.set(40, 250, 200000);
                wife.rotation.set(0, Math.PI, 0); 
                wife.userData.isWifeInCar = true;
                wife.scale.set(125, 125, 125); 
                optimizeModelMaterial(wife, "WifeInCar", true);
                if (gltf.animations && gltf.animations.length > 0) {
                     const mixer = new THREE.AnimationMixer(wife);
                     const action = mixer.clipAction(gltf.animations[0]);
                     action.play();
                     action.paused = true;
                     mixers.push(mixer);
                }
                scene.add(wife);
                levelObjects.push(wife);
                if (carModel) carModel.userData.wife = wife;
                else {
                    const checkCar = setInterval(() => {
                        if(carModel) {
                            carModel.userData.wife = wife;
                            clearInterval(checkCar);
                        }
                    }, 100);
                }
            });
            
            setTimeout(() => {
                 isSitting = false;
                 isTrapped = false;
                 hasStoodUp = true;
                 isCarryingSuitcase = false;
                 isCarryingClothes = false;
                 isDriving = true; 
                 if(carriedObject) {
                     scene.remove(carriedObject);
                     carriedObject = null;
                 }
                 levelObjects.forEach(obj => {
                     let keepVisible = false;
                     if (obj.userData.isCar) keepVisible = true;
                     if (obj.userData.isWifeInCar) keepVisible = true;
                     if (obj.userData.isRoad) keepVisible = true;
                     if (obj === deerModel) keepVisible = true; 
                     if (obj === bloodPool) keepVisible = true;
                     if (obj instanceof THREE.Light) keepVisible = true;
                     if (obj instanceof THREE.Points) keepVisible = true;
                     if (obj.userData.isHitbox && obj === roadFloor) keepVisible = true;
                     if (!keepVisible) obj.visible = false;
                 });
                 camera.position.set(-30, 330, 200000); 
                 camera.rotation.set(0, Math.PI / 2, 0);
                 playerVelocity.set(0,0,0);
                 updateQuest("Dirija pela estrada");
                 
                 setTimeout(triggerCarDialogue, 4000);

                 setTimeout(() => {
                     screen.classList.remove('active');
                     setTimeout(() => {
                         screen.style.display = 'none';
                         if(!isMobile) controls.lock();
                     }, 2000);
                 }, 1000);
            }, 3000);
        }

        function generateFlareTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 64;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.4)');
            gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 64, 64);
            return canvas;
        }

        async function triggerDinnerDialogue() {
            if (hasHadDinnerConversation) return;
            hasHadDinnerConversation = true;
            
            showDialogue();
            const sequence = [
                { speaker: "Esposa", text: "Engra√ßado como f√©rias sempre parecem irreais at√© a gente realmente sair de casa. Eu ainda t√¥ com a sensa√ß√£o de que vou lembrar de alguma coisa importante na porta." },
                { speaker: "Player", text: "Sempre acontece. Mas dessa vez eu conferi tudo duas vezes, ent√£o, no m√°ximo, a gente esquece algo bobo." },
                { speaker: "Esposa", text: "Tomara. Eu s√≥ quero chegar l√°, largar as coisas e passar uns dias sem hor√°rio, sem barulho, sem gente." },
                { speaker: "Player", text: "√â exatamente por isso que eu escolhi esse lugar. Nada pra fazer, nada pra resolver. S√≥ descansar." },
                { speaker: "Esposa", text: "Ent√£o t√°. Terminando aqui, a gente sai e come√ßa oficialmente as f√©rias." },
                { speaker: "Player", text: "Come√ßa agora." }
            ];
            for (const line of sequence) {
                const color = line.speaker === "Esposa" ? "#ffb7b2" : "#aaccff"; 
                const displayText = `${line.speaker === "Player" ? "Voc√™" : "Esposa"}: ${line.text}`;
                const textEl = document.getElementById('dialogue-text');
                textEl.style.color = color;
                if(line.speaker === "Player") setPortrait('player');
                else setPortrait('wife');
                await typeWriter(displayText, 'dialogue-text', 40);
                await new Promise(r => setTimeout(r, 2500 + line.text.length * 30));
            }
            
            hideDialogue(() => {
                setPortrait(null);
                triggerTeleportToRoad();
            });
        }

        async function triggerCarDialogue() {
            if (hasTriggeredCarDialogue) return;
            hasTriggeredCarDialogue = true;
            
            showDialogue();
            
            const sequence = [
                { speaker: "Esposa", text: "Voc√™ reparou como √© f√°cil se perder aqui?" },
                { speaker: "Player", text: "O GPS ainda funciona." },
                { speaker: "Esposa", text: "Mesmo assim." },
                { speaker: "Esposa", text: "Parece que a gente devia saber pra onde est√° indo‚Ä¶ e n√£o sabe." },
                { speaker: "Player", text: "N√≥s nunca passamos por aqui." },
                { speaker: "Esposa", text: "Eu sei." },
                { speaker: "Esposa", text: "Mas isso n√£o me tranquiliza." },
                { speaker: "Player", text: "Voc√™ ia me pedir alguma coisa antes." },
                { speaker: "Esposa", text: "Ia." },
                { speaker: "Esposa", text: "Eu ia pedir pra voc√™ n√£o confiar em‚Äî" }
            ];

            for (let i = 0; i < sequence.length; i++) {
                const line = sequence[i];
                const color = line.speaker === "Esposa" ? "#ffb7b2" : "#aaccff"; 
                const displayText = `${line.speaker === "Player" ? "Voc√™" : "Esposa"}: ${line.text}`;
                const textEl = document.getElementById('dialogue-text');
                textEl.style.color = color;
                
                if(line.speaker === "Player") setPortrait('player');
                else setPortrait('wife');
                
                if (i === sequence.length - 1) {
                    await typeWriter(displayText, 'dialogue-text', 40);
                    
                    // Flash e cutscene
                    startDeerCutscene();
                    hideDialogue();
                    setPortrait(null);
                    return; 
                } else {
                    await typeWriter(displayText, 'dialogue-text', 40);
                    await new Promise(r => setTimeout(r, 2000 + line.text.length * 20));
                }
            }
        }
        
        let fliesParticles = null;
        let bloodPools = [];
        
        function createFliesAroundDeer() {
            if (!deerModel) return;
            
            const flyCount = 40;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(flyCount * 3);
            const velocities = [];
            const offsets = [];
            
            for (let i = 0; i < flyCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 200;
                positions[i * 3 + 1] = Math.random() * 80 + 20;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 200;
                
                velocities.push({
                    x: (Math.random() - 0.5) * 2,
                    y: (Math.random() - 0.5) * 1.5,
                    z: (Math.random() - 0.5) * 2,
                    phase: Math.random() * Math.PI * 2
                });
                offsets.push(Math.random() * 100);
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: 0x111111,
                size: 4,
                transparent: true,
                opacity: 0.9,
                sizeAttenuation: true
            });
            
            fliesParticles = new THREE.Points(geometry, material);
            fliesParticles.userData.velocities = velocities;
            fliesParticles.userData.offsets = offsets;
            fliesParticles.userData.basePosition = deerModel.position.clone();
            fliesParticles.visible = false;
            scene.add(fliesParticles);
            levelObjects.push(fliesParticles);
        }
        
        function updateFlies(delta) {
            if (!fliesParticles || !fliesParticles.visible) return;
            
            const positions = fliesParticles.geometry.attributes.position.array;
            const velocities = fliesParticles.userData.velocities;
            const basePos = fliesParticles.userData.basePosition;
            const time = performance.now() * 0.001;
            
            for (let i = 0; i < velocities.length; i++) {
                const v = velocities[i];
                
                // Movimento ca√≥tico de mosca
                positions[i * 3] += Math.sin(time * 3 + v.phase) * v.x * delta * 60;
                positions[i * 3 + 1] += Math.cos(time * 4 + v.phase) * v.y * delta * 60;
                positions[i * 3 + 2] += Math.sin(time * 2.5 + v.phase * 1.5) * v.z * delta * 60;
                
                // Manter moscas perto do cervo
                const dx = positions[i * 3];
                const dy = positions[i * 3 + 1];
                const dz = positions[i * 3 + 2];
                
                if (Math.abs(dx) > 150) positions[i * 3] *= 0.9;
                if (dy < 10 || dy > 120) positions[i * 3 + 1] = 50 + Math.random() * 40;
                if (Math.abs(dz) > 150) positions[i * 3 + 2] *= 0.9;
            }
            
            fliesParticles.position.copy(basePos);
            fliesParticles.geometry.attributes.position.needsUpdate = true;
        }
        
        function createEnhancedBloodPool() {
            if (!deerModel) return;
            
            // Po√ßa principal - tamanho reduzido
            const mainBloodGeo = new THREE.CircleGeometry(100, 32);
            const mainBloodMat = new THREE.MeshBasicMaterial({ 
                color: 0x4a0000, 
                transparent: true, 
                opacity: 0.85, 
                depthWrite: false,
                side: THREE.DoubleSide
            });
            const mainBlood = new THREE.Mesh(mainBloodGeo, mainBloodMat);
            mainBlood.rotation.x = -Math.PI / 2;
            mainBlood.visible = false;
            scene.add(mainBlood);
            bloodPools.push(mainBlood);
            levelObjects.push(mainBlood);
            
            // Apenas 3 po√ßas secund√°rias menores
            const bloodColors = [0x5a0000, 0x3a0000, 0x4a0505];
            for (let i = 0; i < 3; i++) {
                const size = 25 + Math.random() * 40;
                const geo = new THREE.CircleGeometry(size, 16);
                const mat = new THREE.MeshBasicMaterial({ 
                    color: bloodColors[i], 
                    transparent: true, 
                    opacity: 0.6 + Math.random() * 0.2, 
                    depthWrite: false,
                    side: THREE.DoubleSide
                });
                const pool = new THREE.Mesh(geo, mat);
                pool.rotation.x = -Math.PI / 2;
                pool.userData.offsetX = (Math.random() - 0.5) * 120;
                pool.userData.offsetZ = (Math.random() - 0.5) * 120;
                pool.visible = false;
                scene.add(pool);
                bloodPools.push(pool);
                levelObjects.push(pool);
            }
            
            // Apenas 2 rastros pequenos
            for (let i = 0; i < 2; i++) {
                const trailGeo = new THREE.PlaneGeometry(15 + Math.random() * 15, 40 + Math.random() * 50);
                const trailMat = new THREE.MeshBasicMaterial({ 
                    color: 0x3a0000, 
                    transparent: true, 
                    opacity: 0.4 + Math.random() * 0.2, 
                    depthWrite: false,
                    side: THREE.DoubleSide
                });
                const trail = new THREE.Mesh(trailGeo, trailMat);
                trail.rotation.x = -Math.PI / 2;
                trail.rotation.z = Math.random() * Math.PI * 2;
                trail.userData.offsetX = (Math.random() - 0.5) * 100;
                trail.userData.offsetZ = (Math.random() - 0.5) * 100;
                trail.visible = false;
                scene.add(trail);
                bloodPools.push(trail);
                levelObjects.push(trail);
            }
        }
        
        function positionBloodPools() {
            if (!deerModel || bloodPools.length === 0) return;
            
            const baseY = deerModel.position.y - 5;
            
            bloodPools.forEach((pool, index) => {
                pool.position.set(
                    deerModel.position.x + (pool.userData.offsetX || 0),
                    baseY - index * 0.1, // Pequeno offset Y para evitar z-fighting
                    deerModel.position.z + (pool.userData.offsetZ || 0)
                );
                pool.visible = true;
            });
        }
        
        function playImpactSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // Som de impacto grave e pesado
            const osc1 = audioCtx.createOscillator();
            const osc2 = audioCtx.createOscillator();
            const noise = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            const gain2 = audioCtx.createGain();
            const gainNoise = audioCtx.createGain();
            
            osc1.connect(gain1);
            osc2.connect(gain2);
            noise.connect(gainNoise);
            gain1.connect(audioCtx.destination);
            gain2.connect(audioCtx.destination);
            gainNoise.connect(audioCtx.destination);
            
            // Impacto grave
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(60, audioCtx.currentTime);
            osc1.frequency.exponentialRampToValueAtTime(20, audioCtx.currentTime + 0.5);
            gain1.gain.setValueAtTime(0.8, audioCtx.currentTime);
            gain1.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);
            
            // Crunch/crack sound
            osc2.type = 'sawtooth';
            osc2.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc2.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.15);
            gain2.gain.setValueAtTime(0.4, audioCtx.currentTime);
            gain2.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
            
            // White noise burst
            noise.type = 'sawtooth';
            noise.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNoise.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNoise.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            
            osc1.start();
            osc2.start();
            noise.start();
            osc1.stop(audioCtx.currentTime + 0.6);
            osc2.stop(audioCtx.currentTime + 0.2);
            noise.stop(audioCtx.currentTime + 0.1);
        }
        
        function triggerEnhancedFlashEffect() {
            const flash = document.getElementById('white-flash');
            const body = document.body;
            
            // Flash inicial intenso
            flash.style.transition = 'none';
            flash.style.opacity = '1';
            flash.style.background = '#fff';
            
            playImpactSound();
            
            // Shake intenso
            let shakeIntensity = 20;
            let shakeCount = 0;
            const maxShakes = 15;
            
            const shakeInterval = setInterval(() => {
                if (shakeCount >= maxShakes) {
                    clearInterval(shakeInterval);
                    body.style.transform = 'none';
                    return;
                }
                
                const x = (Math.random() - 0.5) * shakeIntensity;
                const y = (Math.random() - 0.5) * shakeIntensity;
                body.style.transform = `translate(${x}px, ${y}px)`;
                
                shakeIntensity *= 0.85;
                shakeCount++;
            }, 30);
            
            // Flash pulsante vermelho/branco
            setTimeout(() => {
                flash.style.transition = 'opacity 0.1s, background 0.1s';
                flash.style.background = '#ff3333';
                flash.style.opacity = '0.7';
            }, 50);
            
            setTimeout(() => {
                flash.style.background = '#fff';
                flash.style.opacity = '0.9';
            }, 100);
            
            setTimeout(() => {
                flash.style.background = '#ff0000';
                flash.style.opacity = '0.5';
            }, 150);
            
            setTimeout(() => {
                flash.style.background = '#fff';
                flash.style.opacity = '0.6';
            }, 200);
            
            setTimeout(() => {
                flash.style.transition = 'opacity 0.5s';
                flash.style.opacity = '0';
            }, 300);
            
            setTimeout(() => {
                flash.style.background = '#fff';
            }, 800);
        }
        
        function startDeerCutscene() {
            isDeerCutscene = true;
            cutsceneStartTime = performance.now();
            
            if (deerModel && carModel) {
                deerModel.position.copy(carModel.position);
                deerModel.position.z -= 600; 
                deerModel.position.x = 0; 
                deerModel.position.y -= 78;
                deerModel.rotation.set(0, Math.PI, 0); 
                deerModel.visible = true;

                // Criar e posicionar sangue melhorado
                if (bloodPools.length === 0) {
                    createEnhancedBloodPool();
                }
                positionBloodPools();
                
                // Esconder o bloodPool antigo se existir
                if (bloodPool) {
                    bloodPool.visible = false;
                }
                
                // Criar moscas
                if (!fliesParticles) {
                    createFliesAroundDeer();
                }
                if (fliesParticles) {
                    fliesParticles.userData.basePosition = deerModel.position.clone();
                    fliesParticles.visible = true;
                }

                if (carModel.userData.headlights) {
                    carModel.userData.headlights.target.position.copy(deerModel.position);
                }
                
                // Dispara efeito de flash melhorado
                triggerEnhancedFlashEffect();
            }
        }

        async function triggerPostCrashDialogue() {
            showDialogue();
            
            setPortrait('player');
            await typeWriter("Voc√™: CARALHO, que porra √© essa?", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2500));

            setPortrait('wife');
            await typeWriter("Esposa: Eu n√£o sei.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));

            setPortrait('player');
            await typeWriter("Voc√™: Vou l√° ver.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 1500));

            hideDialogue(() => {
                setPortrait(null);
                
                canExitCar = true;
                
                if (isMobile) {
                    mobileExitBtn = document.getElementById('mobile-exit-btn');
                    if (mobileExitBtn) mobileExitBtn.style.display = 'block';
                }
                
                if (!isMobile) {
                    showPrompt("Press E to Exit Car");
                }
            });
        }

        function exitCar() {
            canExitCar = false;
            if(mobileExitBtn) mobileExitBtn.style.display = 'none';
            hidePrompt();
            
            const fade = document.getElementById('black-fade');
            fade.classList.add('with-glow');
            fade.style.opacity = '1';
            
            setTimeout(() => {
                isDriving = false;
                isCarStopped = false;
                isDeerCutscene = false;
                hasExitedCar = true;
                
                const carPos = carModel.position.clone();
                camera.position.set(carPos.x - 250, carPos.y + 140, carPos.z + 50); 
                camera.lookAt(new THREE.Vector3(carPos.x, carPos.y + 100, carPos.z - 500));
                
                playerVelocity.set(0,0,0);
                
                createCrashSiteBoundaries(carPos.z);
                
                addCollisionToModel(carModel);
                addCollisionToModel(deerModel);
                
                carModel.userData.canEnterCar = true;

                updateQuest("Verifique o cervo");
                
                setTimeout(() => {
                    fade.style.opacity = '0';
                    setTimeout(() => fade.classList.remove('with-glow'), 800);
                }, 500);
            }, 1000);
        }
        
        function enterCar() {
            if (!hasDumpedDeer) return; // S√≥ pode entrar se descartou o cervo
            
            canExitCar = false;
            hasExitedCar = false;
            isDriving = true;
            isCarStopped = true; // Mant√©m parado durante a transi√ß√£o
            
            const fade = document.getElementById('black-fade');
            fade.classList.add('with-glow');
            fade.style.opacity = '1';

            setTimeout(() => {
                removeCrashSiteBoundaries();
                removeCollisionFromModel(carModel);
                
                // Remove zona de descarte se ainda existir
                if (deerDropZone) {
                    scene.remove(deerDropZone);
                    const idx = levelObjects.indexOf(deerDropZone);
                    if (idx > -1) levelObjects.splice(idx, 1);
                    deerDropZone = null;
                }
                
                // Esconde cervo e moscas
                if (deerModel) {
                    deerModel.visible = false;
                }
                if (fliesParticles) fliesParticles.visible = false;
                
                // Esconde sangue tamb√©m
                bloodPools.forEach(pool => pool.visible = false);
                if (bloodPool) bloodPool.visible = false;

                camera.position.set(-30, 330, carModel.position.z);
                camera.rotation.set(0, Math.PI / 2, 0);
                
                hidePrompt();
                if(mobileExitBtn) mobileExitBtn.style.display = 'none';
                
                // Fade out e depois di√°logo
                fade.style.opacity = '0';
                
                setTimeout(() => {
                    fade.classList.remove('with-glow');
                    // Di√°logo da esposa perguntando
                    triggerPostDeerDialogue();
                }, 1000);
            }, 800);
        }
        
        function teleportToForest() {
            const screen = document.getElementById('sleep-screen');
            const title = screen.querySelector('h1');
            const sub = screen.querySelector('p');
            title.innerText = "CAP√çTULO 2";
            sub.innerText = "A Floresta - M√≥dulo Completo";
            
            createSleepParticles();
            resetSleepScreenAnimations();
            
            screen.style.display = 'flex';
            void screen.offsetWidth;
            screen.classList.add('active');
            
            setTimeout(() => {
                // Load the COMPLETE forest module from index.html
                loadCompleteForestModule();
                
                // Fade out sleep screen
                setTimeout(() => {
                    screen.classList.remove('active');
                    setTimeout(() => {
                        screen.style.display = 'none';
                    }, 1500);
                }, 1000);
            }, 2000);
        }
        async function triggerPostDeerDialogue() {
            showDialogue();
            
            setPortrait('wife');
            await typeWriter("Esposa: O que era?", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            setPortrait('player');
            await typeWriter("Voc√™: Um cervo morto. Tava bloqueando a estrada.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            setPortrait('wife');
            await typeWriter("Esposa: Que horror... Voc√™ t√° bem?", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            setPortrait('player');
            await typeWriter("Voc√™: T√¥ sim. Vamos seguir em frente.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            setPortrait('wife');
            await typeWriter("Esposa: ...", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 1500));
            
            hideDialogue(() => {
                setPortrait(null);
                isCarStopped = false; // Agora o carro volta a andar!
                updateQuest("Continue a viagem");
                
                // Depois de 4 segundos, teleportar para a floresta
                setTimeout(() => {
                    teleportToForest();
                }, 4000);
            });
        }

        async function triggerDeerObservation() {
            showDialogue();
            
            setPortrait('player');
            await typeWriter("Voc√™: Tem um cervo morto aqui.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            await typeWriter("Voc√™: Merda... T√° bloqueando a estrada.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            await typeWriter("Voc√™: N√£o tenho escolha, vou ter que tirar isso do caminho.", 'dialogue-text', 40);
            await new Promise(r => setTimeout(r, 2000));
            
            hideDialogue(() => {
                setPortrait(null);
                updateQuest("Pegue o cervo");
            });
        }

        function wakeUp() {
            const screen = document.getElementById('sleep-screen');
            const loadingPromises = [];
            levelObjects.forEach((obj, index) => { 
                if(obj.userData.lockedForNight) obj.userData.lockedForNight = false;
                if (obj.userData.morningModelUrl) {
                    const p = new Promise((resolve, reject) => {
                        const loader = new GLTFLoader();
                        loader.load(obj.userData.morningModelUrl, (gltf) => {
                            const newModel = gltf.scene;
                            newModel.position.copy(obj.position);
                            newModel.rotation.copy(obj.rotation);
                            newModel.scale.copy(obj.scale);
                            newModel.userData = { ...obj.userData };
                            delete newModel.userData.morningModelUrl;
                            optimizeModelMaterial(newModel, "MorningAsset", false);
                            if (gltf.animations && gltf.animations.length > 0) {
                                 const mixer = new THREE.AnimationMixer(newModel);
                                 gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
                                 mixers.push(mixer);
                            }
                            const oldHitbox = obj.children.find(c => c.userData.isHitbox);
                            if(oldHitbox) {
                                 const idx = colliders.indexOf(oldHitbox);
                                 if(idx > -1) colliders.splice(idx, 1);
                            }
                            addCollisionToModel(newModel);
                            scene.remove(obj);
                            scene.add(newModel);
                            const currentIdx = levelObjects.indexOf(obj);
                            if(currentIdx > -1) levelObjects[currentIdx] = newModel;
                            resolve();
                        }, undefined, (err) => resolve());
                    });
                    loadingPromises.push(p);
                }
            });

            Promise.all(loadingPromises).then(() => {
                if (morningTorch) morningTorch.visible = true;
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog.color.set(0x87CEEB);
                scene.fog.near = 200;
                scene.fog.far = 6000;
                if(ambientLight) {
                    ambientLight.color.set(0xffffff);
                    ambientLight.intensity = 1.0;
                }
                if(dirLight) {
                    dirLight.color.set(0xffffee);
                    dirLight.intensity = 1.5;
                    dirLight.position.set(100, 2000, 100);
                }
                const dawnMusic = document.getElementById('dawn-music');
                if(dawnMusic) {
                    dawnMusic.volume = 0.5;
                    dawnMusic.play().catch(e => console.log(e));
                }
                levelObjects.forEach(obj => { if(obj.userData.isStove && !hasTalkedToWife) obj.userData.canTalk = true; });
                updateQuest("Fale com sua esposa");
                screen.classList.remove('active');
                setTimeout(() => {
                    screen.style.display = 'none';
                    gameStarted = true;
                    if (!isMobile) controls.lock();
                    else document.getElementById('mobile-controls').style.display = 'block';
                    
                    showDialogue();
                    setPortrait('player');
                    typeWriter("Mas que linda manh√£...", 'dialogue-text', 50);
                    setTimeout(() => {
                        hideDialogue(() => {
                            setPortrait(null);
                        });
                    }, 4000);
                }, 2000);
            });
        }
        
        function pickupSuitcase(target) {
            isCarryingSuitcase = true;
            carriedObject = target;
            const hitbox = target.children.find(c => c.userData.isHitbox);
            if(hitbox) {
                const idx = colliders.indexOf(hitbox);
                if(idx > -1) colliders.splice(idx, 1);
            }
            target.traverse((child) => {
                child.userData.isCarried = true;
                if (child.isMesh) {
                    child.userData.originalRaycast = child.raycast; 
                    child.raycast = () => []; 
                    child.frustumCulled = false;
                }
            });
            updateQuest("Coloque a mala na cama");
        }
        
        function pickupClothes(target) {
            isCarryingClothes = true;
            carriedObject = target;
            target.traverse((child) => {
                child.userData.isCarried = true;
                if (child.isMesh) {
                    child.userData.originalRaycast = child.raycast; 
                    child.raycast = () => []; 
                    child.frustumCulled = false;
                    if (child.material) {
                        const mats = Array.isArray(child.material) ? child.material : [child.material];
                        mats.forEach(m => { m.transparent = false; m.opacity = 1; });
                    }
                }
            });
            updateQuest("Coloque as roupas na mala");
        }
        
        function pickupDeer() {
            if (!deerModel || isCarryingDeer) return;
            isCarryingDeer = true;
            deerOriginalPosition = deerModel.position.clone();
            
            // Remover colis√£o do cervo
            removeCollisionFromModel(deerModel);
            
            deerModel.traverse((child) => {
                child.userData.isCarried = true;
                if (child.isMesh) {
                    child.frustumCulled = false;
                }
            });
            
            // Criar zona de descarte quando pegar o cervo
            if (carModel) {
                createDeerDropZone(carModel.position.z);
            }
            
            updateQuest("Descarte o cervo no mato");
        }
        
        function createDeerDropZone(centerZ) {
            if (deerDropZone) return;
            
            const group = new THREE.Group();
            
            // C√≠rculo externo GRANDE (anel)
            const ringGeo = new THREE.RingGeometry(180, 220, 32);
            const ringMat = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.9,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = -Math.PI / 2;
            ring.position.y = 5;
            group.add(ring);
            
            // C√≠rculo interior GRANDE
            const innerGeo = new THREE.CircleGeometry(175, 32);
            const innerMat = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.4,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            const inner = new THREE.Mesh(innerGeo, innerMat);
            inner.rotation.x = -Math.PI / 2;
            inner.position.y = 3;
            group.add(inner);
            
            // PILAR DE LUZ VERTICAL para ser bem vis√≠vel
            const pillarGeo = new THREE.CylinderGeometry(30, 80, 800, 16, 1, true);
            const pillarMat = new THREE.MeshBasicMaterial({
                color: 0x00ff00,
                transparent: true,
                opacity: 0.3,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            const pillar = new THREE.Mesh(pillarGeo, pillarMat);
            pillar.position.y = 400;
            group.add(pillar);
            
            // SETA 3D apontando para baixo
            const arrowGroup = new THREE.Group();
            
            // Corpo da seta (cilindro)
            const arrowBodyGeo = new THREE.CylinderGeometry(15, 15, 150, 8);
            const arrowMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.95 });
            const arrowBody = new THREE.Mesh(arrowBodyGeo, arrowMat);
            arrowBody.position.y = 120;
            arrowGroup.add(arrowBody);
            
            // Ponta da seta (cone)
            const arrowHeadGeo = new THREE.ConeGeometry(40, 80, 8);
            const arrowHead = new THREE.Mesh(arrowHeadGeo, arrowMat);
            arrowHead.position.y = 40;
            arrowHead.rotation.x = Math.PI; // Aponta para baixo
            arrowGroup.add(arrowHead);
            
            arrowGroup.position.y = 250;
            group.add(arrowGroup);
            
            // Texto "DESCARTE AQUI" usando sprites
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#00ff00';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('DESCARTE AQUI', 256, 80);
            
            const textTexture = new THREE.CanvasTexture(canvas);
            const textMat = new THREE.SpriteMaterial({ map: textTexture, transparent: true, opacity: 0.95 });
            const textSprite = new THREE.Sprite(textMat);
            textSprite.scale.set(400, 100, 1);
            textSprite.position.y = 500;
            group.add(textSprite);
            
            // Posi√ß√£o mais vis√≠vel - √† esquerda do carro mas n√£o t√£o longe
            group.position.set(-280, 210, centerZ - 200);
            group.userData.ring = ring;
            group.userData.inner = inner;
            group.userData.arrow = arrowGroup;
            group.userData.pillar = pillar;
            group.userData.baseOpacity = 0.9;
            
            scene.add(group);
            deerDropZone = group;
            levelObjects.push(group);
            
            console.log("Drop zone criada em:", group.position);
        }
        
        function dropDeer() {
            if (!isCarryingDeer || !deerModel || !deerDropZone) return;
            
            isCarryingDeer = false;
            hasDumpedDeer = true;
            
            playSuccessAnimation();
            
            // Posiciona o cervo na zona
            deerModel.position.copy(deerDropZone.position);
            deerModel.position.y = 215;
            deerModel.rotation.set(0, Math.random() * Math.PI * 2, 0);
            
            // Atualiza posi√ß√£o das moscas
            if (fliesParticles) {
                fliesParticles.userData.basePosition = deerModel.position.clone();
            }
            
            // Remove a zona de descarte
            scene.remove(deerDropZone);
            const idx = levelObjects.indexOf(deerDropZone);
            if (idx > -1) levelObjects.splice(idx, 1);
            deerDropZone = null;
            canDropDeer = false;
            
            updateQuest("Cervo descartado. Volte ao carro.");
            
            hidePrompt();
            
            console.log("Cervo descartado em:", deerModel.position);
        }
        
        function placeSuitcase() {
            if(!isCarryingSuitcase || !carriedObject) return;
            scene.remove(carriedObject);
            isCarryingSuitcase = false;
            carriedObject = null;
            levelObjects.forEach(obj => { if(obj.userData.isPackedSuitcase) obj.visible = true; });
            playSuccessAnimation();
            updateQuest("Pegue as roupas no arm√°rio");
        }
        
        function packClothes() {
            if(!isCarryingClothes || !carriedObject) return;
            scene.remove(carriedObject);
            isCarryingClothes = false;
            carriedObject = null;
            levelObjects.forEach(obj => { if(obj.userData.isPackedSuitcase) obj.visible = false; });
            levelObjects.forEach(obj => { if(obj.userData.isFinalSuitcase) obj.visible = true; });
            playSuccessAnimation();
            updateQuest("Mala Pronta");
            setTimeout(triggerWifeShout, 1500);
        }

        async function toggleCabinet(cabinet) {
             if (!cabinet.userData.canOpen) return;
             if (!hasSlept) {
                 cabinet.userData.lockedForNight = true;
                 if (cabinet.userData.sibling) cabinet.userData.sibling.userData.lockedForNight = true;
                 hidePrompt();
                 const mobileBtn = document.getElementById('mobile-talk-btn');
                 if (mobileBtn) mobileBtn.style.display = 'none';
                 canInteract = false;
                 interactionTarget = null;
                 const box = document.getElementById('dialogue-box');
                 if (box.classList.contains('visible')) return; 
                 showDialogue();
                 setPortrait('player');
                 await typeWriter("*Bocejo*... Tenho que dormir agora, resolvo isso amanh√£.", 'dialogue-text', 50);
                 setTimeout(() => {
                     hideDialogue(() => {
                        setPortrait(null);
                     });
                 }, 2000);
                 return;
             }
             const newState = !cabinet.userData.isOpen;
             cabinet.userData.isOpen = newState;
             if(cabinet.userData.sibling) cabinet.userData.sibling.userData.isOpen = newState;
             playSpeechSound(); 
        }

        function setupControls() {
            controls = new PointerLockControls(camera, document.body);
            const instructions = document.getElementById('instructions');
            const prompt = document.getElementById('interaction-prompt');
            prompt.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (isSitting) {
                    if (!isTrapped) toggleSit();
                    return;
                }
                if (canDropDeer) {
                    dropDeer();
                    return;
                }
                if (canInteract && interactionTarget) {
                    if (isCarryingSuitcase && interactionTarget.userData.canSleep) placeSuitcase();
                    else if (isCarryingClothes && interactionTarget.userData.isPackedSuitcase) packClothes();
                    else if (interactionTarget.userData.isClothes && !isCarryingClothes) pickupClothes(interactionTarget);
                    else if (interactionTarget.userData.canPickup && !isCarryingSuitcase && !isCarryingClothes) pickupSuitcase(interactionTarget);
                    else if (interactionTarget.userData.canSleep && !hasSlept) triggerSleep();
                    else if (interactionTarget.userData.canSit) sitDown(interactionTarget);
                    else if (interactionTarget.userData.canTalk) {
                        hidePrompt();
                        const mb = document.getElementById('mobile-talk-btn');
                        if(mb) mb.style.display = 'none';
                        triggerDialogueWife();
                    } else if (interactionTarget.userData.canOpen) toggleCabinet(interactionTarget);
                    else if (interactionTarget.userData.canEnterCar) enterCar();
                    else if (interactionTarget.userData.canCarryDeer) pickupDeer();
                }
            });
            const talkBtn = document.getElementById('mobile-talk-btn');
            if(talkBtn) {
                talkBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if(canInteract && interactionTarget && interactionTarget.userData.canTalk) {
                        talkBtn.style.display = 'none';
                        hidePrompt();
                        triggerDialogueWife();
                    }
                });
            }
            
            const exitBtn = document.getElementById('mobile-exit-btn');
            if(exitBtn) {
                exitBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if(canExitCar) exitCar();
                });
                exitBtn.addEventListener('click', (e) => {
                    if(canExitCar) exitCar();
                });
            }

            if (!isMobile) {
                instructions.addEventListener('click', () => { if (gameStarted) controls.lock(); });
                controls.addEventListener('lock', () => { instructions.style.display = 'none'; });
                controls.addEventListener('unlock', () => { if (gameStarted) instructions.style.display = 'flex'; });
                document.addEventListener('keydown', onKeyDown);
                document.addEventListener('keyup', onKeyUp);
            } else {
                document.getElementById('mobile-controls').style.display = 'block';
                document.addEventListener('keydown', onKeyDown);
                document.addEventListener('keyup', onKeyUp);
                setupMobileControls();
            }

            const playBtn = document.getElementById('play-btn');
            playBtn.addEventListener('click', () => {
                if (playBtn.disabled) return;
                playBtn.disabled = true;
                playBtn.style.pointerEvents = 'none'; 
                
                // Primeiro: apenas fade visual simples
                const introFade = document.getElementById('game-intro-fade');
                
                // Usa requestAnimationFrame para n√£o bloquear
                requestAnimationFrame(() => {
                    introFade.classList.add('active');
                    
                    // Delay antes de esconder menu (sem anima√ß√£o pesada)
                    setTimeout(() => {
                        const menu = document.getElementById('main-menu');
                        menu.style.transition = 'opacity 0.8s ease-out';
                        menu.style.opacity = '0';
                        
                        setTimeout(() => {
                            menu.style.display = 'none';
                        }, 800);
                    }, 400);
                    
                    // Resume audio context apenas depois da transi√ß√£o visual come√ßar
                    setTimeout(() => {
                        if (audioCtx.state === 'suspended') audioCtx.resume();
                    }, 200);
                    
                    // Fade out do intro e in√≠cio do jogo
                    setTimeout(() => {
                        introFade.style.transition = 'opacity 1s ease-out';
                        introFade.classList.remove('active');
                        
                        // Pequeno delay antes de ativar o jogo
                        setTimeout(() => {
                            gameStarted = true;
                            hidePrompt();
                            
                            // Controles e mon√≥logo com mais delay
                            setTimeout(() => {
                                if (isMobile) document.getElementById('mobile-controls').style.display = 'block';
                                else controls.lock();
                                
                                // Mon√≥logo come√ßa por √∫ltimo
                                setTimeout(() => {
                                    runMonologue();
                                }, 300);
                            }, 200);
                        }, 500);
                    }, 2000);
                });
            });
            const shortcutBtn = document.getElementById('car-shortcut-btn');
            if(shortcutBtn) {
                shortcutBtn.addEventListener('click', () => {
                     gameStarted = true;
                     document.getElementById('main-menu').style.display = 'none';
                     if(audioCtx.state === 'suspended') audioCtx.resume();
                     hidePrompt();
                     if (isMobile) document.getElementById('mobile-controls').style.display = 'block';
                     else controls.lock();
                     triggerTeleportToRoad();
                });
            }
            
            const forestShortcutBtn = document.getElementById('forest-shortcut-btn');
            if(forestShortcutBtn) {
                forestShortcutBtn.addEventListener('click', () => {
                     gameStarted = true;
                     document.getElementById('main-menu').style.display = 'none';
                     if(audioCtx.state === 'suspended') audioCtx.resume();
                     hidePrompt();
                     if (isMobile) document.getElementById('mobile-controls').style.display = 'block';
                     else controls.lock();
                     teleportToForest();
                });
            }
        }

        function onKeyDown(event) {
            if(isSitting) {
                if(event.code === 'KeyE' && !isTrapped) toggleSit();
                return;
            }
            switch (event.code) {
                case 'ArrowUp': case 'KeyW': input.forward = true; break;
                case 'ArrowDown': case 'KeyS': input.backward = true; break;
                case 'ArrowLeft': case 'KeyA': input.left = true; break;
                case 'ArrowRight': case 'KeyD': input.right = true; break;
                case 'Space': if(isGrounded) playerVelocity.y = PLAYER_JUMP; break;
                case 'KeyE': 
                    if (canExitCar) { exitCar(); break; }
                    if (canDropDeer) { dropDeer(); break; }
                    if(canInteract && interactionTarget) {
                        if (isCarryingSuitcase && interactionTarget.userData.canSleep) placeSuitcase();
                        else if (isCarryingClothes && interactionTarget.userData.isPackedSuitcase) packClothes();
                        else if (interactionTarget.userData.isClothes && !isCarryingClothes) pickupClothes(interactionTarget);
                        else if (interactionTarget.userData.canPickup && !isCarryingSuitcase && !isCarryingClothes) pickupSuitcase(interactionTarget);
                        else if (interactionTarget.userData.canSleep && !hasSlept) triggerSleep();
                        else if (interactionTarget.userData.canSit) sitDown(interactionTarget);
                        else if (interactionTarget.userData.canTalk) {
                            hidePrompt();
                            const mb = document.getElementById('mobile-talk-btn');
                            if(mb) mb.style.display = 'none';
                            triggerDialogueWife();
                        } else if (interactionTarget.userData.canOpen) toggleCabinet(interactionTarget);
                        else if (interactionTarget.userData.canEnterCar) enterCar();
                        else if (interactionTarget.userData.canCarryDeer) pickupDeer();
                    }
                    break;
            }
        }

        function sitDown(target) {
            if (isSitting) return;
            isSitting = true;
            if (!hasStoodUp && target.userData.canSit) hasStoodUp = true; 
            if (target.userData.sitPos) camera.position.copy(target.userData.sitPos);
            camera.lookAt(new THREE.Vector3(target.position.x, target.position.y + 100, target.position.z - 200));
            if (target.userData.isKitchenChair) {
                isTrapped = true;
                hidePrompt();
                const mb = document.getElementById('mobile-talk-btn');
                if(mb) mb.style.display = 'none';
                levelObjects.forEach(obj => {
                    if (obj.userData.isWifeSitting && obj.userData.actions) obj.userData.actions.forEach(act => { act.paused = false; act.play(); });
                });
                triggerDinnerDialogue();
            } else {
                showPrompt(isMobile ? "Tap to Stand" : "Press E to Stand");
            }
            canInteract = false; 
        }

        function toggleSit() {
            if(isSitting) {
                isSitting = false;
                hasStoodUp = true; 
                camera.position.y = 160;
                camera.position.add(new THREE.Vector3(50, 0, 50)); 
                hidePrompt();
                canInteract = false;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'ArrowUp': case 'KeyW': input.forward = false; break;
                case 'ArrowDown': case 'KeyS': input.backward = false; break;
                case 'ArrowLeft': case 'KeyA': input.left = false; break;
                case 'ArrowRight': case 'KeyD': input.right = false; break;
            }
        }

        function setupMobileControls() {
            const zone = document.getElementById('joystick');
            const knob = document.getElementById('knob');
            let joystickTouchId = null; 
            let joyStartX, joyStartY;

            zone.addEventListener('touchstart', (e) => {
                e.preventDefault(); e.stopPropagation();
                if (joystickTouchId !== null) return;
                const touch = e.changedTouches[0];
                joystickTouchId = touch.identifier;
                joyStartX = touch.clientX; joyStartY = touch.clientY;
                joystick.active = true;
            }, { passive: false });

            zone.addEventListener('touchmove', (e) => {
                e.preventDefault(); e.stopPropagation();
                if (!joystick.active) return;
                let touch = null;
                for (let i = 0; i < e.changedTouches.length; i++) {
                    if (e.changedTouches[i].identifier === joystickTouchId) {
                        touch = e.changedTouches[i]; break;
                    }
                }
                if (!touch) return;
                const maxDist = 35;
                let dx = touch.clientX - joyStartX;
                let dy = touch.clientY - joyStartY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > maxDist) {
                    dx = (dx / dist) * maxDist;
                    dy = (dy / dist) * maxDist;
                }
                knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                joystick.x = dx / maxDist; joystick.y = dy / maxDist;
            }, { passive: false });

            const resetJoystick = (e) => {
                e.preventDefault();
                for (let i = 0; i < e.changedTouches.length; i++) {
                    if (e.changedTouches[i].identifier === joystickTouchId) {
                        joystick.active = false; joystick.x = 0; joystick.y = 0;
                        knob.style.transform = `translate(-50%, -50%)`; joystickTouchId = null; break;
                    }
                }
            };
            zone.addEventListener('touchend', resetJoystick);
            zone.addEventListener('touchcancel', resetJoystick);

            let lookTouchId = null; let lookStartX, lookStartY;
            document.addEventListener('touchstart', (e) => {
                if (lookTouchId !== null) return;
                for(let i=0; i<e.changedTouches.length; i++){
                    const t = e.changedTouches[i];
                    if(t.clientX > window.innerWidth / 2) {
                        lookTouchId = t.identifier; lookStartX = t.clientX; lookStartY = t.clientY; break;
                    }
                }
            }, {passive: false});

            document.addEventListener('touchmove', (e) => {
                if (lookTouchId === null) return;
                for(let i=0; i<e.changedTouches.length; i++){
                    const t = e.changedTouches[i];
                    if(t.identifier === lookTouchId) {
                        const deltaX = t.clientX - lookStartX;
                        const deltaY = t.clientY - lookStartY;
                        const euler = new THREE.Euler(0, 0, 0, 'YXZ');
                        euler.setFromQuaternion(camera.quaternion);
                        euler.y -= deltaX * 0.005;
                        euler.x -= deltaY * 0.005;
                        euler.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, euler.x));
                        camera.quaternion.setFromEuler(euler);
                        lookStartX = t.clientX; lookStartY = t.clientY; break;
                    }
                }
            }, {passive: false});

            const endLook = (e) => {
                for(let i=0; i<e.changedTouches.length; i++){
                    if(e.changedTouches[i].identifier === lookTouchId) { lookTouchId = null; break; }
                }
            };
            document.addEventListener('touchend', endLook);
            document.addEventListener('touchcancel', endLook);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth / RENDER_SCALE, window.innerHeight / RENDER_SCALE, false);
        }

        function animate() {
            requestAnimationFrame(animate);

            const now = performance.now();
            frameCount++;
            frameCounter++;
            
            if (now - lastTimeFPS >= 1000) {
                fpsElement.innerText = `FPS: ${frameCount}`;
                frameCount = 0;
                lastTimeFPS = now;
            }

            const rawDelta = (now - prevTime) / 1000;
            const delta = Math.min(rawDelta, 0.1); 
            prevTime = now;
            
            if (mixers.length > 0) {
                mixers.forEach(mixer => {
                    const root = mixer.getRoot();
                    if (root && root.visible) {
                        if (root.userData.isTorch) {
                            if (camera.position.distanceToSquared(root.position) < 2250000) mixer.update(delta);
                        } else mixer.update(delta);
                    }
                });
            }
            
            // Atualizar moscas
            updateFlies(delta);
            
            // Atualizar zona de descarte do cervo
            if (deerDropZone) {
                const time = performance.now() * 0.001;
                const pulse = 0.5 + Math.sin(time * 3) * 0.4;
                
                // Pulsar o anel e c√≠rculo
                if (deerDropZone.userData.ring) {
                    deerDropZone.userData.ring.material.opacity = isCarryingDeer ? 0.95 : pulse;
                }
                if (deerDropZone.userData.inner) {
                    deerDropZone.userData.inner.material.opacity = isCarryingDeer ? 0.6 : pulse * 0.5;
                }
                
                // Animar a seta (flutuar para cima e para baixo)
                if (deerDropZone.userData.arrow) {
                    deerDropZone.userData.arrow.position.y = 250 + Math.sin(time * 2) * 50;
                    deerDropZone.userData.arrow.rotation.y += delta * 2; // Girar
                }
                
                // Animar o pilar
                if (deerDropZone.userData.pillar) {
                    deerDropZone.userData.pillar.material.opacity = 0.2 + Math.sin(time * 2) * 0.15;
                }
                
                // Verificar proximidade para descartar - √°rea MUITO grande
                if (isCarryingDeer) {
                    const dist = camera.position.distanceTo(deerDropZone.position);
                    if (dist < 500) { // √Årea de detec√ß√£o bem grande
                        canDropDeer = true;
                        showPrompt(isMobile ? "Tap to Dump Deer" : "Press E to Dump Deer");
                    } else {
                        canDropDeer = false;
                        // Esconder prompt se n√£o estiver perto
                        if (!canInteract) hidePrompt();
                    }
                }
            }
            
            levelObjects.forEach(obj => {
                if (obj.userData.canOpen) {
                    const dir = obj.userData.openDir || 1; 
                    const target = obj.userData.isOpen ? (obj.userData.baseRotation + (1.5 * dir)) : obj.userData.baseRotation;
                    if (Math.abs(obj.rotation.y - target) > 0.01) {
                         const step = 5 * delta;
                         obj.rotation.y += (target - obj.rotation.y) * step;
                         obj.updateMatrix();
                         obj.updateMatrixWorld(true);
                    }
                }
            });
            
            if ((isCarryingSuitcase || isCarryingClothes) && carriedObject) {
                const forward = new THREE.Vector3(0, 0, -1);
                forward.applyQuaternion(camera.quaternion);
                forward.multiplyScalar(200); 
                const up = new THREE.Vector3(0, 1, 0);
                up.applyQuaternion(camera.quaternion);
                let pos = camera.position.clone().add(forward).add(up.multiplyScalar(-60));
                
                // Verificar altura m√≠nima para n√£o atravessar o ch√£o
                const minY = camera.position.y - PLAYER_HEIGHT + 30; // 30 acima do ch√£o
                if (pos.y < minY) {
                    pos.y = minY;
                }
                
                carriedObject.position.copy(pos);
                carriedObject.rotation.copy(camera.rotation);
                carriedObject.rotateY(Math.PI);
                carriedObject.updateMatrix();
                carriedObject.updateMatrixWorld(true);
            }
            
            // Carregar cervo
            if (isCarryingDeer && deerModel) {
                const forward = new THREE.Vector3(0, 0, -1);
                forward.applyQuaternion(camera.quaternion);
                forward.multiplyScalar(350); 
                const up = new THREE.Vector3(0, 1, 0);
                let pos = camera.position.clone().add(forward).add(up.multiplyScalar(-120));
                
                // Verificar colis√£o com o ch√£o para n√£o atravessar
                const minY = 220; // Altura m√≠nima baseada no ch√£o da estrada (200) + offset
                if (pos.y < minY) {
                    pos.y = minY;
                }
                
                deerModel.position.copy(pos);
                deerModel.rotation.set(0, camera.rotation.y + Math.PI, 0);
                deerModel.updateMatrix();
                deerModel.updateMatrixWorld(true);
                
                // Moscas seguem o cervo
                if (fliesParticles) {
                    fliesParticles.userData.basePosition = deerModel.position.clone();
                }
            }
            
            if (isDriving && carModel) {
                if (!isDeerCutscene) {
                    if (!isCarStopped) {
                        const moveDist = CAR_SPEED * delta;
                        carModel.position.z -= moveDist;
                        camera.position.z -= moveDist;
                        carModel.position.x = 5;
                        camera.position.x = -30; 
                        
                        if (carModel.userData.wife) {
                            carModel.userData.wife.position.z = carModel.position.z;
                            carModel.userData.wife.position.x = carModel.position.x + 35;
                        }
                        
                        if (carModel.userData.headlights) {
                            const hl = carModel.userData.headlights;
                            hl.left.position.set(carModel.position.x - 35, 320, carModel.position.z - 20);
                            hl.fLeft.position.set(carModel.position.x - 35, 320, carModel.position.z - 25);
                            hl.right.position.set(carModel.position.x + 45, 320, carModel.position.z - 20);
                            hl.fRight.position.set(carModel.position.x + 45, 320, carModel.position.z - 25);
                            hl.target.position.set(carModel.position.x, 200, carModel.position.z - 2000);
                        }
                        if (carModel.userData.cabinLight) carModel.userData.cabinLight.position.set(carModel.position.x, 380, carModel.position.z + 50);

                        if (roadSegments.length > 0 && roadLength > 0) {
                            let rearmost = roadSegments[0];
                            let frontmost = roadSegments[0];
                            for(let i=1; i<roadSegments.length; i++) {
                                if (roadSegments[i].position.z > rearmost.position.z) rearmost = roadSegments[i];
                                if (roadSegments[i].position.z < frontmost.position.z) frontmost = roadSegments[i];
                            }
                            if ((rearmost.position.z - carModel.position.z) > roadLength * 1.5) {
                                rearmost.position.z = frontmost.position.z - roadLength;
                                rearmost.updateMatrix();
                                rearmost.updateMatrixWorld(true);
                            }
                        }
                    }
                } else {
                    const elapsed = now - cutsceneStartTime;
                    
                    const carCamPos = new THREE.Vector3(-30, 330, carModel.position.z);
                    const carCamLookAt = new THREE.Vector3(carModel.position.x, 320, carModel.position.z - 500);
                    
                    const deerCamPos = deerModel.position.clone().add(new THREE.Vector3(80, 100, 250));
                    const deerLookAt = deerModel.position.clone();

                    if (elapsed < 2000) {
                        camera.position.copy(carCamPos);
                        camera.lookAt(carCamLookAt);
                    } else if (elapsed < 4000) {
                        const alpha = (elapsed - 2000) / 2000;
                        const t = alpha < 0.5 ? 2 * alpha * alpha : -1 + (4 - 2 * alpha) * alpha; 
                        camera.position.lerpVectors(carCamPos, deerCamPos, t);
                        const currentLook = new THREE.Vector3().lerpVectors(carCamLookAt, deerLookAt, t);
                        camera.lookAt(currentLook);
                    } else if (elapsed < 6000) {
                        camera.position.copy(deerCamPos);
                        camera.lookAt(deerLookAt);
                    } else if (elapsed < 8000) {
                         const alpha = (elapsed - 6000) / 2000;
                         const t = alpha < 0.5 ? 2 * alpha * alpha : -1 + (4 - 2 * alpha) * alpha; 
                         camera.position.lerpVectors(deerCamPos, carCamPos, t);
                         const currentLook = new THREE.Vector3().lerpVectors(deerLookAt, carCamLookAt, t);
                         camera.lookAt(currentLook);
                    } else {
                        if (!hasResetHappened) {
                            camera.position.copy(carCamPos);
                            camera.lookAt(carCamLookAt);
                            hasResetHappened = true;
                            isDeerCutscene = false;
                            isCarStopped = true;
                            triggerPostCrashDialogue();
                        }
                    }
                }
            }

            if (!isSitting && gameStarted && !isDriving && frameCounter % 10 === 0) {
                interactionRay.setFromCamera(new THREE.Vector2(0,0), camera);
                const intersects = interactionRay.intersectObjects(levelObjects, true);
                let hitChair = false;
                
                for(let i=0; i<intersects.length; i++) {
                    if(intersects[i].distance > 1200) break;
                    let obj = intersects[i].object;
                    let foundTarget = false;
                    if (obj.userData.isCarried) continue;
                    let p = obj.parent;
                    let isCarried = false;
                    while(p) {
                        if(p.userData.isCarried || p === carriedObject) { isCarried = true; break; }
                        p = p.parent;
                    }
                    if(isCarried) continue;
                    if(obj.userData.isHitbox) continue;

                    let tempObj = obj;
                    while(tempObj) {
                        if(tempObj.userData.canSit) { foundTarget = true; interactionTarget = tempObj; break; }
                        if(tempObj.userData.canSleep) {
                            if (!hasSlept) { foundTarget = true; interactionTarget = tempObj; break; }
                            else if (isCarryingSuitcase) { foundTarget = true; interactionTarget = tempObj; break; }
                        }
                        if(tempObj.userData.canTalk) { foundTarget = true; interactionTarget = tempObj; break; }
                        if(tempObj.userData.canOpen) {
                            if (tempObj.userData.lockedForNight && !hasSlept) foundTarget = false;
                            else { foundTarget = true; interactionTarget = tempObj; break; }
                        }
                        if(tempObj.userData.canPickup && !isCarryingSuitcase && !isCarryingClothes) {
                            if (tempObj.userData.isSuitcase) {
                                if (currentQuest === "Arrume a mala") { foundTarget = true; interactionTarget = tempObj; break; }
                            } else if (tempObj.userData.isClothes) {
                                if (currentQuest === "Pegue as roupas no arm√°rio") { foundTarget = true; interactionTarget = tempObj; break; }
                            } else { foundTarget = true; interactionTarget = tempObj; break; }
                        }
                        if(tempObj.userData.isPackedSuitcase && isCarryingClothes) { foundTarget = true; interactionTarget = tempObj; break; }
                        if(tempObj.userData.canEnterCar && hasDumpedDeer) { foundTarget = true; interactionTarget = tempObj; break; }
                        // Detectar cervo para carregar
                        if(tempObj === deerModel && hasExitedCar && hasSeenDeer && !isCarryingDeer) { 
                            foundTarget = true; 
                            interactionTarget = tempObj; 
                            tempObj.userData.canCarryDeer = true;
                            break; 
                        }
                        tempObj = tempObj.parent;
                    }

                    if (foundTarget) { hitChair = true; break; }
                }
                
                const prompt = document.getElementById('interaction-prompt');
                const talkBtn = document.getElementById('mobile-talk-btn');
                
                if(hitChair) {
                    canInteract = true;
                    if(talkBtn) talkBtn.style.display = 'none';

                    let promptText = isMobile ? "Tap to Sit" : "Press E to Sit";
                    if (isCarryingSuitcase && interactionTarget.userData.canSleep) promptText = isMobile ? "Tap to Place Suitcase" : "Press E to Place Suitcase";
                    else if (isCarryingClothes && interactionTarget.userData.isPackedSuitcase) promptText = isMobile ? "Tap to Pack Clothes" : "Press E to Pack Clothes";
                    else if (interactionTarget.userData.isClothes && !isCarryingClothes) promptText = isMobile ? "Tap to Get Clothes" : "Press E to Get Clothes";
                    else if (interactionTarget.userData.canPickup) promptText = isMobile ? "Tap to Pick Up" : "Press E to Pick Up";
                    else if (interactionTarget.userData.canSleep) promptText = isMobile ? "Tap to Sleep" : "Press E to Sleep";
                    else if (interactionTarget.userData.canTalk) {
                        promptText = isMobile ? "Tap to Talk" : "Press E to Talk";
                        if (isMobile && talkBtn) talkBtn.style.display = 'flex';
                    } else if (interactionTarget.userData.canOpen) promptText = isMobile ? (interactionTarget.userData.isOpen ? "Tap to Close" : "Tap to Open") : (interactionTarget.userData.isOpen ? "Press E to Close" : "Press E to Open");
                    else if (interactionTarget.userData.canEnterCar) promptText = isMobile ? "Tap to Enter Car" : "Press E to Enter Car";
                    else if (interactionTarget.userData.canCarryDeer) promptText = isMobile ? "Tap to Carry Deer" : "Press E to Carry Deer";
                    
                    showPrompt(promptText);
                } else {
                    canInteract = false;
                    interactionTarget = null;
                    hidePrompt();
                    if(talkBtn) talkBtn.style.display = 'none';
                }
            }

            if (doors.length > 0) {
                const playerPos = camera.position;
                doors.forEach(door => {
                    const dist = playerPos.distanceTo(door.position);
                    const base = door.userData.baseRotation !== undefined ? door.userData.baseRotation : door.rotation.y;
                    const isKitchenDoor = Math.abs(door.position.x - 866) < 50;
                    const isFrontDoor = (door.position.y < -100) && !isKitchenDoor; 

                    if (isKitchenDoor) {
                        const targetRot = (dist < 300) ? base - 1.57 : base; 
                        if (Math.abs(door.rotation.y - targetRot) > 0.01) {
                            const step = 5 * delta;
                            door.rotation.y += (targetRot - door.rotation.y) * step;
                            door.updateMatrix(); 
                            door.updateMatrixWorld(true);
                        }
                    } else if (isFrontDoor) {
                        const targetRot = base;
                        if (Math.abs(door.rotation.y - targetRot) > 0.01) {
                            const step = 5 * delta;
                            door.rotation.y += (targetRot - door.rotation.y) * step;
                            door.updateMatrix();
                            door.updateMatrixWorld(true);
                        }
                        if (dist < 250) showLockedMessage();
                    } else {
                        if (!hasSlept) {
                            const targetRot = base;
                            if (Math.abs(door.rotation.y - targetRot) > 0.01) {
                                const step = 5 * delta;
                                door.rotation.y += (targetRot - door.rotation.y) * step;
                                door.updateMatrix(); 
                                door.updateMatrixWorld(true);
                            }
                        } else {
                            const targetRot = (dist < 300) ? base - 1.57 : base; 
                            if (Math.abs(door.rotation.y - targetRot) > 0.01) {
                                const step = 5 * delta;
                                door.rotation.y += (targetRot - door.rotation.y) * step;
                                door.updateMatrix(); 
                                door.updateMatrixWorld(true);
                            }
                        }
                    }
                });
            }

            if ((controls.isLocked || isMobile)) {
                if(isSitting) { renderer.render(scene, camera); return; }
                if (isDriving) { renderer.render(scene, camera); return; }

                if (hasExitedCar && !hasSeenDeer && deerModel) {
                    if (camera.position.distanceTo(deerModel.position) < 800) {
                        hasSeenDeer = true;
                        triggerDeerObservation();
                    }
                }

                let dirZ = Number(input.forward) - Number(input.backward);
                let dirX = Number(input.right) - Number(input.left);
                if(isMobile && joystick.active) { dirZ = -joystick.y; dirX = joystick.x; }

                playerVelocity.y -= GRAVITY * delta;
                playerVelocity.x -= playerVelocity.x * 10.0 * delta;
                playerVelocity.z -= playerVelocity.z * 10.0 * delta;

                if (dirZ !== 0 || dirX !== 0) {
                    _forward.set(0, 0, -1).applyQuaternion(camera.quaternion);
                    _forward.y = 0; _forward.normalize();
                    _right.set(1, 0, 0).applyQuaternion(camera.quaternion);
                    _right.y = 0; _right.normalize();
                    let currentSpeed = PLAYER_SPEED;
                    if (isCarryingSuitcase || isCarryingClothes) currentSpeed *= 0.35; 
                    const accX = (dirZ * _forward.x + dirX * _right.x) * currentSpeed * delta;
                    const accZ = (dirZ * _forward.z + dirX * _right.z) * currentSpeed * delta;
                    playerVelocity.x += accX;
                    playerVelocity.z += accZ;
                }

                const moveX = playerVelocity.x * delta;
                const moveZ = playerVelocity.z * delta;
                _intendedMove.set(moveX, 0, moveZ);
                
                if (_intendedMove.lengthSq() > 0.001) {
                    for(let iter=0; iter<3; iter++) {
                         if (_intendedMove.lengthSq() < 0.001) break;
                         const moveDir = _moveDir.copy(_intendedMove).normalize();
                         const moveLen = _intendedMove.length();
                         _sideVec.set(-moveDir.z, 0, moveDir.x).multiplyScalar(PLAYER_RADIUS * 0.7);
                         let nearestHit = null;
                         let minHitDist = Infinity;
                         for(let i=0; i<3; i++) {
                             _origin.copy(camera.position);
                             if(i===1) _origin.add(_sideVec);
                             else if(i===2) _origin.sub(_sideVec);
                             rayForward.ray.origin.copy(_origin);
                             rayForward.ray.origin.y -= PLAYER_HEIGHT * 0.5; 
                             rayForward.ray.direction.copy(moveDir);
                             const hits = rayForward.intersectObjects(colliders, false);
                             for(let h of hits) {
                                 if (h.distance > PLAYER_RADIUS + moveLen + 10) break;
                                 const wNorm = h.face.normal.clone().transformDirection(h.object.matrixWorld).normalize();
                                 if (Math.abs(wNorm.y) > 0.5) continue;
                                 if (h.distance < minHitDist) { minHitDist = h.distance; nearestHit = { hit: h, norm: wNorm }; }
                                 break;
                             }
                         }
                         if (nearestHit) {
                             const dot = _intendedMove.dot(nearestHit.norm);
                             if (dot < 0) {
                                 _intendedMove.sub(nearestHit.norm.multiplyScalar(dot));
                                 const velDot = playerVelocity.dot(nearestHit.norm);
                                 if (velDot < 0) playerVelocity.sub(nearestHit.norm.multiplyScalar(velDot));
                             }
                         } else break; 
                    }
                }
                camera.position.add(_intendedMove);

                rayDown.ray.origin.copy(camera.position);
                rayDown.ray.origin.y += STEP_HEIGHT; 
                rayDown.ray.direction.set(0, -1, 0);
                const hitsDown = rayDown.intersectObjects(colliders, false);
                let foundGround = false;
                if (hitsDown.length > 0) {
                    const groundY = hitsDown[0].point.y;
                    const currentFeetY = camera.position.y - PLAYER_HEIGHT;
                    if (groundY >= currentFeetY - 50 && groundY <= currentFeetY + STEP_HEIGHT + 10) {
                        if (playerVelocity.y <= 0) {
                            camera.position.y = groundY + PLAYER_HEIGHT;
                            playerVelocity.y = 0;
                            isGrounded = true;
                            foundGround = true;
                        }
                    }
                }

                if (!foundGround) {
                    isGrounded = false;
                    camera.position.y += playerVelocity.y * delta;
                }

                if (camera.position.y < -2000) {
                    playerVelocity.set(0,0,0);
                    camera.position.set(0, 200, 0);
                }
            }

            renderer.render(scene, camera);
        }

        init();
</script>
</html>
function loadCompleteForestModule() {
    console.log("üå≤ Loading COMPLETE forest module from index.html...");
    
    // Hide main game
    const mainContainer = document.getElementById('game-container');
    if (mainContainer) mainContainer.style.display = 'none';
    
    const fpsCounter = document.getElementById('fps-counter');
    if (fpsCounter) fpsCounter.style.display = 'none';
    
    const questBox = document.getElementById('quest-box');
    if (questBox) questBox.style.display = 'none';
    
    const crosshair = document.getElementById('crosshair');
    if (crosshair) crosshair.style.display = 'none';
    
    // Create container for forest module
    const forestContainer = document.createElement('div');
    forestContainer.id = 'forest-module-container';
    forestContainer.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;background:#000;';
    
    // Create iframe with embedded forest game
    const iframe = document.createElement('iframe');
    iframe.id = 'forest-module-iframe';
    iframe.style.cssText = 'width:100%;height:100%;border:none;';
    iframe.src = "data:text/html;base64,PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCxpbml0aWFsLXNjYWxlPTEsbWF4aW11bS1zY2FsZT0xLHVzZXItc2NhbGFibGU9bm8iPgo8dGl0bGU+U0lMRU5DRSBCRVRXRUVOIFRSRUVTIC0gRk9SRVNUIE1PRFVMRTwvdGl0bGU+CjxsaW5rIGhyZWY9Imh0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9Q3JlZXBzdGVyJmZhbWlseT1Ob3NpZmVyJmZhbWlseT1TcGVjaWFsK0VsaXRlJmRpc3BsYXk9c3dhcCIgcmVsPSJzdHlsZXNoZWV0Ij4KPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL3B5c2NyaXB0Lm5ldC9yZWxlYXNlcy8yMDI0LjEuMS9jb3JlLmNzcyI+CjxzY3JpcHQgdHlwZT0ibW9kdWxlIiBzcmM9Imh0dHBzOi8vcHlzY3JpcHQubmV0L3JlbGVhc2VzLzIwMjQuMS4xL2NvcmUuanMiPjwvc2NyaXB0Pgo8c3R5bGU+Cip7bWFyZ2luOjA7cGFkZGluZzowO2JveC1zaXppbmc6Ym9yZGVyLWJveH0KOnJvb3R7LS1wcmltYXJ5LWNvbG9yOiNiMGM0ZGU7LS1zZWNvbmRhcnktY29sb3I6IzU2NmQ4YjstLWFjY2VudC1jb2xvcjojOGZhYWM4Oy0tYmctZGFyazojMDUwNzBhOy0tYmctcGFuZWw6cmdiYSgxMCwxNSwyMCwwLjk1KTstLXRleHQtZGltOnJnYmEoMTUwLDE3MCwxOTAsMC45KTstLWJvcmRlci1zdWJ0bGU6cmdiYSg4NiwxMDksMTM5LDAuMyk7LS1zYWZlLXRvcDplbnYoc2FmZS1hcmVhLWluc2V0LXRvcCwwcHgpOy0tc2FmZS1ib3R0b206ZW52KHNhZmUtYXJlYS1pbnNldC1ib3R0b20sMHB4KTstLXNhZmUtbGVmdDplbnYoc2FmZS1hcmVhLWluc2V0LWxlZnQsMHB4KTstLXNhZmUtcmlnaHQ6ZW52KHNhZmUtYXJlYS1pbnNldC1yaWdodCwwcHgpfQpib2R5LGh0bWx7d2lkdGg6MTAwJTtoZWlnaHQ6MTAwJTtvdmVyZmxvdzpoaWRkZW47YmFja2dyb3VuZDp2YXIoLS1iZy1kYXJrKTt0b3VjaC1hY3Rpb246bm9uZTtmb250LWZhbWlseTonU3BlY2lhbCBFbGl0ZScsY3Vyc2l2ZTt1c2VyLXNlbGVjdDpub25lOy13ZWJraXQtdXNlci1zZWxlY3Q6bm9uZTstd2Via2l0LXRhcC1oaWdobGlnaHQtY29sb3I6dHJhbnNwYXJlbnR9CiNnYW1lLWNvbnRhaW5lcnt3aWR0aDoxMDAlO2hlaWdodDoxMDAlfQojZ2FtZS1jb250YWluZXIgY2FudmFze3dpZHRoOjEwMCUhaW1wb3J0YW50O2hlaWdodDoxMDAlIWltcG9ydGFudH0KI3B5dGhvbi1zdGF0dXN7cG9zaXRpb246YWJzb2x1dGU7dG9wOjYwcHg7bGVmdDoxMHB4O2NvbG9yOiNmZmNjMDA7Zm9udC1mYW1pbHk6bW9ub3NwYWNlO2ZvbnQtc2l6ZToxMXB4O2JhY2tncm91bmQ6cmdiYSgwLDAsMCwwLjgpO3BhZGRpbmc6NXB4IDEwcHg7Ym9yZGVyLXJhZGl1czo0cHg7ei1pbmRleDoxMDAxO2JvcmRlcjoxcHggc29saWQgI2ZmY2MwMDt0cmFuc2l0aW9uOmFsbCAwLjVzfQojZnBzLWNvdW50ZXJ7cG9zaXRpb246YWJzb2x1dGU7dG9wOmNhbGMoMTBweCArIHZhcigtLXNhZmUtdG9wKSk7bGVmdDpjYWxjKDEwcHggKyB2YXIoLS1zYWZlLWxlZnQpKTtjb2xvcjojMGYwO2JhY2tncm91bmQ6cmdiYSgwLDAsMCwuODUpO3BhZGRpbmc6OHB4IDE0cHg7Zm9udC1mYW1pbHk6bW9ub3NwYWNlO2ZvbnQtc2l6ZToxNHB4O2ZvbnQtd2VpZ2h0OjcwMDtib3JkZXItcmFkaXVzOjZweDtwb2ludGVyLWV2ZW50czpub25lO3otaW5kZXg6MTAwMDtib3JkZXI6MXB4IHNvbGlkICMwZjA7bWluLXdpZHRoOjEyMHB4O2xpbmUtaGVpZ2h0OjEuNX0KI3F1ZXN0LWJveHtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6Y2FsYygyMHB4ICsgdmFyKC0tc2FmZS10b3ApKTtyaWdodDpjYWxjKDIwcHggKyB2YXIoLS1zYWZlLXJpZ2h0KSk7dGV4dC1hbGlnbjpyaWdodDtwb2ludGVyLWV2ZW50czpub25lO3otaW5kZXg6MTUwO21heC13aWR0aDozMDBweDtiYWNrZ3JvdW5kOnJnYmEoNSwxMCwxNSwuODUpO3BhZGRpbmc6MTJweCAxOHB4O2JvcmRlcjoxcHggc29saWQgdmFyKC0tYm9yZGVyLXN1YnRsZSk7Ym9yZGVyLXJhZGl1czo0cHg7Ym94LXNoYWRvdzowIDRweCAxMnB4IHJnYmEoMCwwLDAsLjUpO2JhY2tkcm9wLWZpbHRlcjpibHVyKDRweCk7b3BhY2l0eTowO3RyYW5zZm9ybTp0cmFuc2xhdGVYKDIwcHgpO3RyYW5zaXRpb246b3BhY2l0eSAwLjVzLHRyYW5zZm9ybSAwLjVzfQojcXVlc3QtYm94LnZpc2libGV7b3BhY2l0eToxO3RyYW5zZm9ybTp0cmFuc2xhdGVYKDApfQoucXVlc3QtdGl0bGV7Zm9udC1mYW1pbHk6J1NwZWNpYWwgRWxpdGUnLGN1cnNpdmU7Y29sb3I6dmFyKC0tYWNjZW50LWNvbG9yKTtmb250LXNpemU6Y2xhbXAoMTJweCwyLjV2dywxNHB4KTtsZXR0ZXItc3BhY2luZzoycHg7bWFyZ2luLWJvdHRvbTo4cHg7Ym9yZGVyLWJvdHRvbToxcHggc29saWQgcmdiYSgxNDMsMTcwLDIwMCwuMyk7cGFkZGluZy1ib3R0b206NHB4O2Rpc3BsYXk6aW5saW5lLWJsb2NrfQoucXVlc3Qtb2JqZWN0aXZle2ZvbnQtZmFtaWx5OidTcGVjaWFsIEVsaXRlJyxjdXJzaXZlO2NvbG9yOiNmZmY7Zm9udC1zaXplOmNsYW1wKDE0cHgsMi41dncsMTZweCk7dGV4dC1zaGFkb3c6MCAwIDVweCByZ2JhKDI1NSwyNTUsMjU1LC4yKTtmb250LXdlaWdodDo3MDB9CiNjcm9zc2hhaXJ7cG9zaXRpb246YWJzb2x1dGU7dG9wOjUwJTtsZWZ0OjUwJTt3aWR0aDoyNHB4O2hlaWdodDoyNHB4O3RyYW5zZm9ybTp0cmFuc2xhdGUoLTUwJSwtNTAlKTtwb2ludGVyLWV2ZW50czpub25lO3otaW5kZXg6NTA7ZGlzcGxheTpub25lfQojY3Jvc3NoYWlyOjphZnRlciwjY3Jvc3NoYWlyOjpiZWZvcmV7Y29udGVudDonJztwb3NpdGlvbjphYnNvbHV0ZTtiYWNrZ3JvdW5kOnJnYmEoMjAwLDIyMCwyNTUsLjUpO2JvcmRlci1yYWRpdXM6MXB4fQojY3Jvc3NoYWlyOjpiZWZvcmV7dG9wOjExcHg7bGVmdDowO3dpZHRoOjI0cHg7aGVpZ2h0OjJweH0KI2Nyb3NzaGFpcjo6YWZ0ZXJ7dG9wOjA7bGVmdDoxMXB4O3dpZHRoOjJweDtoZWlnaHQ6MjRweH0KI2Nyb3NzaGFpciAuZG90e3Bvc2l0aW9uOmFic29sdXRlO3RvcDo1MCU7bGVmdDo1MCU7d2lkdGg6NHB4O2hlaWdodDo0cHg7YmFja2dyb3VuZDpyZ2JhKDIwMCwyMjAsMjU1LC44KTtib3JkZXItcmFkaXVzOjUwJTt0cmFuc2Zvcm06dHJhbnNsYXRlKC01MCUsLTUwJSl9CiNsb2FkaW5ne3Bvc2l0aW9uOmZpeGVkO2luc2V0OjA7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoMTgwZGVnLCMwNTA1MTAgMCUsdmFyKC0tYmctZGFyaykgNTAlLCMwNTA1MTAgMTAwJSk7ei1pbmRleDoyMDA7ZGlzcGxheTpmbGV4O2ZsZXgtZGlyZWN0aW9uOmNvbHVtbjtqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyO2FsaWduLWl0ZW1zOmNlbnRlcjtjb2xvcjojZmZmO3RyYW5zaXRpb246b3BhY2l0eSAwLjhzO3BhZGRpbmc6MjBweH0KI2xvYWRpbmc6OmJlZm9yZXtjb250ZW50OicnO3Bvc2l0aW9uOmFic29sdXRlO3RvcDo1MCU7bGVmdDo1MCU7d2lkdGg6MzAwcHg7aGVpZ2h0OjMwMHB4O2JhY2tncm91bmQ6cmFkaWFsLWdyYWRpZW50KGNpcmNsZSxyZ2JhKDEwMCwxNTAsMjAwLDAuMSkgMCUsdHJhbnNwYXJlbnQgNzAlKTt0cmFuc2Zvcm06dHJhbnNsYXRlKC01MCUsLTUwJSk7YW5pbWF0aW9uOmxvYWRpbmdHbG93IDNzIGVhc2UtaW4tb3V0IGluZmluaXRlfQpAa2V5ZnJhbWVzIGxvYWRpbmdHbG93ezAlLDEwMCV7b3BhY2l0eTowLjU7dHJhbnNmb3JtOnRyYW5zbGF0ZSgtNTAlLC01MCUpIHNjYWxlKDEpfTUwJXtvcGFjaXR5OjE7dHJhbnNmb3JtOnRyYW5zbGF0ZSgtNTAlLC01MCUpIHNjYWxlKDEuMil9fQoubG9hZGluZy1jb250ZW50e3RleHQtYWxpZ246Y2VudGVyO3dpZHRoOjEwMCU7bWF4LXdpZHRoOjQwMHB4O3Bvc2l0aW9uOnJlbGF0aXZlO3otaW5kZXg6MX0KLmxvYWRpbmctdGl0bGV7Zm9udC1mYW1pbHk6Tm9zaWZlcixjdXJzaXZlO2ZvbnQtc2l6ZTpjbGFtcCgxNHB4LDR2dywyNHB4KTtjb2xvcjp2YXIoLS1hY2NlbnQtY29sb3IpO3RleHQtc2hhZG93OjAgMCAyMHB4IHJnYmEoMTAwLDE1MCwyMDAsLjUpO21hcmdpbi1ib3R0b206Y2xhbXAoMzBweCw2dmgsNTBweCk7bGV0dGVyLXNwYWNpbmc6Y2xhbXAoMnB4LC41dncsNXB4KTthbmltYXRpb246bG9hZGluZ1RpdGxlUHVsc2UgMnMgZWFzZS1pbi1vdXQgaW5maW5pdGV9CkBrZXlmcmFtZXMgbG9hZGluZ1RpdGxlUHVsc2V7MCUsMTAwJXtvcGFjaXR5OjAuOH01MCV7b3BhY2l0eToxfX0KI2xvYWRpbmctYmFyLWNvbnRhaW5lcnt3aWR0aDoxMDAlO21heC13aWR0aDoyODBweDtoZWlnaHQ6M3B4O2JhY2tncm91bmQ6cmdiYSgxMDAsMTIwLDE1MCwuMTUpO292ZXJmbG93OmhpZGRlbjtwb3NpdGlvbjpyZWxhdGl2ZTttYXJnaW46MCBhdXRvO2JvcmRlci1yYWRpdXM6MnB4fQojbG9hZGluZy1iYXJ7d2lkdGg6MCU7aGVpZ2h0OjEwMCU7YmFja2dyb3VuZDpsaW5lYXItZ3JhZGllbnQoOTBkZWcsIzRiNmNiNywjN2I5ZWQ0KTt0cmFuc2l0aW9uOndpZHRoIC4xNXMgbGluZWFyO2JveC1zaGFkb3c6MCAwIDE1cHggcmdiYSgxMDAsMTUwLDI1NSwuNik7Ym9yZGVyLXJhZGl1czoycHh9CiNsb2FkaW5nLXRleHR7bWFyZ2luLXRvcDpjbGFtcCgxNnB4LDN2aCwyNHB4KTtmb250LXNpemU6Y2xhbXAoMTBweCwyLjV2dywxM3B4KTtjb2xvcjpyZ2JhKDE0MCwxNjAsMTgwLC41KTtmb250LWZhbWlseTonU3BlY2lhbCBFbGl0ZScsY3Vyc2l2ZTtsZXR0ZXItc3BhY2luZzoycHh9CiNpbnN0cnVjdGlvbnN7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDowO3dpZHRoOjEwMCU7aGVpZ2h0OjEwMCU7YmFja2dyb3VuZDpyZ2JhKDAsMCwwLC45KTtkaXNwbGF5Om5vbmU7ZmxleC1kaXJlY3Rpb246Y29sdW1uO2p1c3RpZnktY29udGVudDpjZW50ZXI7YWxpZ24taXRlbXM6Y2VudGVyO2NvbG9yOnZhcigtLWFjY2VudC1jb2xvcik7dGV4dC1hbGlnbjpjZW50ZXI7Y3Vyc29yOnBvaW50ZXI7ei1pbmRleDoxMDA7YmFja2Ryb3AtZmlsdGVyOmJsdXIoOHB4KX0KI2luc3RydWN0aW9ucyBoMXtmb250LXNpemU6Y2xhbXAoMjhweCw4dncsNDhweCk7bWFyZ2luLWJvdHRvbToyMHB4O2ZvbnQtZmFtaWx5Ok5vc2lmZXIsY3Vyc2l2ZTt0ZXh0LXNoYWRvdzowIDAgMjBweCByZ2JhKDEwMCwxNTAsMjAwLC4zKX0KI2luc3RydWN0aW9ucyBwe2ZvbnQtc2l6ZTpjbGFtcCgxNHB4LDR2dywxOHB4KTtjb2xvcjp2YXIoLS10ZXh0LWRpbSk7YW5pbWF0aW9uOnB1bHNlIDJzIGVhc2UtaW4tb3V0IGluZmluaXRlfQpAa2V5ZnJhbWVzIHB1bHNlezAlLDEwMCV7b3BhY2l0eTowLjV9NTAle29wYWNpdHk6MX19CiNjaGFwdGVyLXNjcmVlbntwb3NpdGlvbjpmaXhlZDt0b3A6MDtsZWZ0OjA7d2lkdGg6MTAwJTtoZWlnaHQ6MTAwJTtiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxODBkZWcsIzAwMCAwJSwjMGEwYTE1IDUwJSwjMDAwIDEwMCUpO3otaW5kZXg6MzAwO2Rpc3BsYXk6bm9uZTtmbGV4LWRpcmVjdGlvbjpjb2x1bW47anVzdGlmeS1jb250ZW50OmNlbnRlcjthbGlnbi1pdGVtczpjZW50ZXI7b3BhY2l0eTowO3RyYW5zaXRpb246b3BhY2l0eSAxLjVzO3BvaW50ZXItZXZlbnRzOm5vbmU7b3ZlcmZsb3c6aGlkZGVufQojY2hhcHRlci1zY3JlZW46OmJlZm9yZXtjb250ZW50OicnO3Bvc2l0aW9uOmFic29sdXRlO2luc2V0OjA7YmFja2dyb3VuZDpyYWRpYWwtZ3JhZGllbnQoZWxsaXBzZSBhdCBjZW50ZXIscmdiYSgxMDAsMTUwLDIwMCwwLjA4KSAwJSx0cmFuc3BhcmVudCA2MCUpO2FuaW1hdGlvbjpzbGVlcEdsb3cgNHMgZWFzZS1pbi1vdXQgaW5maW5pdGU7cG9pbnRlci1ldmVudHM6bm9uZX0KI2NoYXB0ZXItc2NyZWVuLmFjdGl2ZXtvcGFjaXR5OjE7cG9pbnRlci1ldmVudHM6YXV0b30KI2NoYXB0ZXItc2NyZWVuIGgxe2ZvbnQtZmFtaWx5Ok5vc2lmZXIsY3Vyc2l2ZTtjb2xvcjp2YXIoLS1hY2NlbnQtY29sb3IpO2ZvbnQtc2l6ZTpjbGFtcCgzMHB4LDh2dyw2MHB4KTttYXJnaW4tYm90dG9tOjIwcHg7dGV4dC1zaGFkb3c6MCAwIDMwcHggcmdiYSgxMDAsMTUwLDIwMCwuNik7b3BhY2l0eTowO3RyYW5zZm9ybTp0cmFuc2xhdGVZKDMwcHgpIHNjYWxlKDAuOSk7YW5pbWF0aW9uOnNsZWVwVGl0bGVJbiAxLjVzIGVhc2Utb3V0IDAuNXMgZm9yd2FyZHM7cG9zaXRpb246cmVsYXRpdmU7ei1pbmRleDoxfQojY2hhcHRlci1zY3JlZW4gcHtmb250LWZhbWlseTonU3BlY2lhbCBFbGl0ZScsY3Vyc2l2ZTtjb2xvcjojYWFhO2ZvbnQtc2l6ZTpjbGFtcCgxNHB4LDR2dywyMHB4KTttYXJnaW4tYm90dG9tOjQwcHg7b3BhY2l0eTowO3RyYW5zZm9ybTp0cmFuc2xhdGVZKDIwcHgpO2FuaW1hdGlvbjpzbGVlcFRleHRJbiAxLjJzIGVhc2Utb3V0IDFzIGZvcndhcmRzO3Bvc2l0aW9uOnJlbGF0aXZlO3otaW5kZXg6MTtsZXR0ZXItc3BhY2luZzoycHh9CkBrZXlmcmFtZXMgc2xlZXBUaXRsZUlue3Rve29wYWNpdHk6MTt0cmFuc2Zvcm06dHJhbnNsYXRlWSgwKSBzY2FsZSgxKX19CkBrZXlmcmFtZXMgc2xlZXBUZXh0SW57dG97b3BhY2l0eToxO3RyYW5zZm9ybTp0cmFuc2xhdGVZKDApfX0KQGtleWZyYW1lcyBzbGVlcEdsb3d7MCUsMTAwJXtvcGFjaXR5OjAuNTt0cmFuc2Zvcm06c2NhbGUoMSl9NTAle29wYWNpdHk6MTt0cmFuc2Zvcm06c2NhbGUoMS4xKX19CiNtb2JpbGUtY29udHJvbHN7cG9zaXRpb246YWJzb2x1dGU7Ym90dG9tOmNhbGMoMjBweCArIHZhcigtLXNhZmUtYm90dG9tKSk7bGVmdDpjYWxjKDIwcHggKyB2YXIoLS1zYWZlLWxlZnQpKTtyaWdodDpjYWxjKDIwcHggKyB2YXIoLS1zYWZlLXJpZ2h0KSk7aGVpZ2h0OjE0MHB4O3BvaW50ZXItZXZlbnRzOm5vbmU7ZGlzcGxheTpub25lO3otaW5kZXg6MTAwfQouam95c3RpY2stem9uZXtwb3NpdGlvbjphYnNvbHV0ZTtib3R0b206MTBweDtsZWZ0OjEwcHg7d2lkdGg6Y2xhbXAoMTAwcHgsMjV2dywxMzBweCk7aGVpZ2h0OmNsYW1wKDEwMHB4LDI1dncsMTMwcHgpO2JhY2tncm91bmQ6cmdiYSgxMDAsMTUwLDIwMCwuMDgpO2JvcmRlci1yYWRpdXM6NTAlO3BvaW50ZXItZXZlbnRzOmF1dG87dG91Y2gtYWN0aW9uOm5vbmU7Ym9yZGVyOjJweCBzb2xpZCByZ2JhKDEwMCwxNTAsMjAwLC4yNSk7YmFja2Ryb3AtZmlsdGVyOmJsdXIoNHB4KX0KLmpveXN0aWNrLWtub2J7cG9zaXRpb246YWJzb2x1dGU7dG9wOjUwJTtsZWZ0OjUwJTt3aWR0aDpjbGFtcCg0NXB4LDEydncsNTVweCk7aGVpZ2h0OmNsYW1wKDQ1cHgsMTJ2dyw1NXB4KTtiYWNrZ3JvdW5kOnJnYmEoMTAwLDE1MCwyMDAsLjI1KTtib3JkZXItcmFkaXVzOjUwJTt0cmFuc2Zvcm06dHJhbnNsYXRlKC01MCUsLTUwJSk7cG9pbnRlci1ldmVudHM6bm9uZTtib3JkZXI6MnB4IHNvbGlkIHJnYmEoMTUwLDE4MCwyMjAsLjMpO2JveC1zaGFkb3c6MCAwIDE1cHggcmdiYSgxMDAsMTUwLDIwMCwuMTUpfQpAbWVkaWEgKG9yaWVudGF0aW9uOmxhbmRzY2FwZSkgYW5kIChtYXgtaGVpZ2h0OjUwMHB4KXsjbW9iaWxlLWNvbnRyb2xze2hlaWdodDoxMTBweH0uam95c3RpY2stem9uZXt3aWR0aDpjbGFtcCg4MHB4LDE4dmgsMTEwcHgpO2hlaWdodDpjbGFtcCg4MHB4LDE4dmgsMTEwcHgpfS5qb3lzdGljay1rbm9ie3dpZHRoOmNsYW1wKDM1cHgsOHZoLDUwcHgpO2hlaWdodDpjbGFtcCgzNXB4LDh2aCw1MHB4KX19CiNjdXRzY2VuZS1vdmVybGF5e3Bvc2l0aW9uOmZpeGVkO3RvcDowO2xlZnQ6MDt3aWR0aDoxMDAlO2hlaWdodDoxMDAlO3BvaW50ZXItZXZlbnRzOm5vbmU7ei1pbmRleDo1MH0KI2N1dHNjZW5lLWJhcnN7cG9zaXRpb246YWJzb2x1dGU7d2lkdGg6MTAwJTtoZWlnaHQ6MTAwJTtwb2ludGVyLWV2ZW50czpub25lfQouY2luZW1hLWJhcntwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0OjA7d2lkdGg6MTAwJTtoZWlnaHQ6MDtiYWNrZ3JvdW5kOiMwMDA7dHJhbnNpdGlvbjpoZWlnaHQgMXMgZWFzZS1pbi1vdXR9Ci5jaW5lbWEtYmFyLnRvcHt0b3A6MH0KLmNpbmVtYS1iYXIuYm90dG9te2JvdHRvbTowfQouY2luZW1hLWJhci5hY3RpdmV7aGVpZ2h0OjEyJX0KI2N1dHNjZW5lLXZpZ25ldHRle3Bvc2l0aW9uOmFic29sdXRlO2luc2V0OjA7YmFja2dyb3VuZDpyYWRpYWwtZ3JhZGllbnQoZWxsaXBzZSBhdCBjZW50ZXIsdHJhbnNwYXJlbnQgNTAlLHJnYmEoMCwwLDAsMC40KSAxMDAlKTtvcGFjaXR5OjA7dHJhbnNpdGlvbjpvcGFjaXR5IDFzO3BvaW50ZXItZXZlbnRzOm5vbmV9CiNjdXRzY2VuZS12aWduZXR0ZS52aXNpYmxle29wYWNpdHk6MX0KI2N1dHNjZW5lLWZhZGV7cG9zaXRpb246YWJzb2x1dGU7aW5zZXQ6MDtiYWNrZ3JvdW5kOiMwMDA7b3BhY2l0eTowO3RyYW5zaXRpb246b3BhY2l0eSAxLjVzO3BvaW50ZXItZXZlbnRzOm5vbmV9CiNjdXRzY2VuZS1mYWRlLnZpc2libGV7b3BhY2l0eToxfQojZGlhbG9ndWUtYm94e3Bvc2l0aW9uOmFic29sdXRlO2JvdHRvbTpjbGFtcCg4MHB4LDE1dmgsMTIwcHgpO2xlZnQ6NTAlO3RyYW5zZm9ybTp0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoMjBweCk7d2lkdGg6Y2FsYygxMDAlIC0gNDBweCk7bWF4LXdpZHRoOjcwMHB4O2JhY2tncm91bmQ6dmFyKC0tYmctcGFuZWwpO2JvcmRlcjoycHggc29saWQgdmFyKC0tc2Vjb25kYXJ5LWNvbG9yKTtwYWRkaW5nOmNsYW1wKDE2cHgsNHZ3LDI0cHgpO2Rpc3BsYXk6bm9uZTthbGlnbi1pdGVtczpjZW50ZXI7ei1pbmRleDo4MDtmb250LWZhbWlseTonU3BlY2lhbCBFbGl0ZScsY3Vyc2l2ZTtjb2xvcjp2YXIoLS1wcmltYXJ5LWNvbG9yKTtmb250LXNpemU6Y2xhbXAoMTRweCwzLjV2dywyMHB4KTt0ZXh0LXNoYWRvdzoxcHggMXB4IDAgIzAwMDttaW4taGVpZ2h0OjgwcHg7Ym94LXNoYWRvdzowIDhweCAzMnB4IHJnYmEoMCwwLDAsLjYpO2JvcmRlci1yYWRpdXM6OHB4O2JhY2tkcm9wLWZpbHRlcjpibHVyKDEycHgpO29wYWNpdHk6MDt2aXNpYmlsaXR5OmhpZGRlbjtwb2ludGVyLWV2ZW50czpub25lO3RyYW5zaXRpb246b3BhY2l0eSAwLjVzIGN1YmljLWJlemllcigwLjQsMCwwLjIsMSksdHJhbnNmb3JtIDAuNXMgY3ViaWMtYmV6aWVyKDAuNCwwLDAuMiwxKX0KI2RpYWxvZ3VlLWJveC52aXNpYmxle29wYWNpdHk6MTt2aXNpYmlsaXR5OnZpc2libGU7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoLTUwJSkgdHJhbnNsYXRlWSgwKTtwb2ludGVyLWV2ZW50czphdXRvfQojZGlhbG9ndWUtdGV4dHtsaW5lLWhlaWdodDoxLjY7ZmxleC1ncm93OjF9CiNwb3J0cmFpdC1jb250YWluZXJ7d2lkdGg6NjRweDtoZWlnaHQ6NjRweDttaW4td2lkdGg6NjRweDtiYWNrZ3JvdW5kOiMwMDA7Ym9yZGVyOjJweCBzb2xpZCB2YXIoLS1hY2NlbnQtY29sb3IpO2JvcmRlci1yYWRpdXM6NHB4O292ZXJmbG93OmhpZGRlbjtkaXNwbGF5Om5vbmU7bWFyZ2luLXJpZ2h0OjE1cHg7Ym94LXNoYWRvdzowIDAgMTBweCByZ2JhKDAsMCwwLC41KX0KI3BvcnRyYWl0LWNvbnRhaW5lciBpbWd7d2lkdGg6MTAwJTtoZWlnaHQ6MTAwJTtvYmplY3QtZml0OmNvdmVyO2Rpc3BsYXk6bm9uZX0KLmRpYWxvZ3VlLWN1cnNvcjo6YWZ0ZXJ7Y29udGVudDon4paMJzthbmltYXRpb246YmxpbmsgLjhzIGluZmluaXRlO21hcmdpbi1sZWZ0OjJweDtjb2xvcjp2YXIoLS1hY2NlbnQtY29sb3IpfQpAa2V5ZnJhbWVzIGJsaW5rezAlLDEwMCV7b3BhY2l0eToxfTUwJXtvcGFjaXR5OjB9fQojaW50ZXJhY3Rpb24tcHJvbXB0e3Bvc2l0aW9uOmFic29sdXRlO2JvdHRvbToyMCU7bGVmdDo1MCU7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoLTUwJSk7Y29sb3I6I2ZmZjtmb250LWZhbWlseTonU3BlY2lhbCBFbGl0ZScsY3Vyc2l2ZTtmb250LXNpemU6MjRweDt0ZXh0LXNoYWRvdzowIDAgMTBweCByZ2JhKDI1NSwyNTUsMjU1LDAuNSk7cG9pbnRlci1ldmVudHM6YXV0bztjdXJzb3I6cG9pbnRlcjtiYWNrZ3JvdW5kOnJnYmEoMCwwLDAsMC42KTtwYWRkaW5nOjE1cHggMzBweDtib3JkZXI6MXB4IHNvbGlkIHJnYmEoMjU1LDI1NSwyNTUsMC4zKTtib3JkZXItcmFkaXVzOjRweDtvcGFjaXR5OjA7dmlzaWJpbGl0eTpoaWRkZW47dHJhbnNpdGlvbjpvcGFjaXR5IDAuNXMsIHZpc2liaWxpdHkgMC41czt6LWluZGV4OjIwMDtkaXNwbGF5OmJsb2NrfQojaW50ZXJhY3Rpb24tcHJvbXB0LnZpc2libGV7b3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZX0KI2ZyaWRnZS1wcm9tcHR7cG9zaXRpb246YWJzb2x1dGU7Ym90dG9tOjMwJTtsZWZ0OjUwJTt0cmFuc2Zvcm06dHJhbnNsYXRlWCgtNTAlKTtjb2xvcjojZmZmO2ZvbnQtZmFtaWx5OidTcGVjaWFsIEVsaXRlJyxjdXJzaXZlO2ZvbnQtc2l6ZToyNHB4O3RleHQtc2hhZG93OjAgMCAxNXB4IHJnYmEoMTAwLDIwMCwyNTUsMC44KTtwb2ludGVyLWV2ZW50czphdXRvO2N1cnNvcjpwb2ludGVyO2JhY2tncm91bmQ6cmdiYSgwLDUwLDgwLDAuOSk7cGFkZGluZzoyMHB4IDQwcHg7Ym9yZGVyOjNweCBzb2xpZCByZ2JhKDEwMCwyMDAsMjU1LDAuNyk7Ym9yZGVyLXJhZGl1czoxMHB4O29wYWNpdHk6MDt2aXNpYmlsaXR5OmhpZGRlbjt0cmFuc2l0aW9uOm9wYWNpdHkgMC4zcywgdmlzaWJpbGl0eSAwLjNzO3otaW5kZXg6MjAwO2Rpc3BsYXk6YmxvY2s7Ym94LXNoYWRvdzogMCAwIDMwcHggcmdiYSgwLCAxNTAsIDI1NSwgMC41KX0KI2ZyaWRnZS1wcm9tcHQudmlzaWJsZXtvcGFjaXR5OjE7dmlzaWJpbGl0eTp2aXNpYmxlfQojZnJpZGdlLXByb21wdDpob3ZlcntiYWNrZ3JvdW5kOnJnYmEoMCw4MCwxMjAsMSk7Ym9yZGVyLWNvbG9yOnJnYmEoMTAwLDIwMCwyNTUsMSk7dHJhbnNmb3JtOnRyYW5zbGF0ZVgoLTUwJSkgc2NhbGUoMS4wNSl9CiNtZWF0LWNhcnJ5aW5nLXVpe3Bvc2l0aW9uOmFic29sdXRlO3RvcDo1MCU7bGVmdDo1MCU7dHJhbnNmb3JtOnRyYW5zbGF0ZSgtNTAlLC01MCUpO2NvbG9yOiNmZjY2MDA7Zm9udC1mYW1pbHk6J1NwZWNpYWwgRWxpdGUnLGN1cnNpdmU7Zm9udC1zaXplOjE4cHg7dGV4dC1zaGFkb3c6MCAwIDEwcHggcmdiYSgyNTUsMTAwLDAsMC44KTtwb2ludGVyLWV2ZW50czpub25lO2JhY2tncm91bmQ6cmdiYSgwLDAsMCwwLjUpO3BhZGRpbmc6MTBweCAyMHB4O2JvcmRlcjoycHggc29saWQgcmdiYSgyNTUsMTAwLDAsMC41KTtib3JkZXItcmFkaXVzOjZweDtvcGFjaXR5OjA7dmlzaWJpbGl0eTpoaWRkZW47dHJhbnNpdGlvbjpvcGFjaXR5IDAuM3M7ei1pbmRleDoxNTB9CiNtZWF0LWNhcnJ5aW5nLXVpLnZpc2libGV7b3BhY2l0eToxO3Zpc2liaWxpdHk6dmlzaWJsZX0KI2VuZGluZy1zY3JlZW4ge3Bvc2l0aW9uOmZpeGVkOyB0b3A6MDsgbGVmdDowOyB3aWR0aDoxMDAlOyBoZWlnaHQ6MTAwJTsgYmFja2dyb3VuZDojMDAwOyB6LWluZGV4OjIwMDA7IGRpc3BsYXk6bm9uZTsgZmxleC1kaXJlY3Rpb246Y29sdW1uOyBqdXN0aWZ5LWNvbnRlbnQ6Y2VudGVyOyBhbGlnbi1pdGVtczpjZW50ZXI7IG9wYWNpdHk6MDsgdHJhbnNpdGlvbjpvcGFjaXR5IDJzOyBjb2xvcjojZmZmOyB0ZXh0LWFsaWduOmNlbnRlcjsgcGFkZGluZzogNDBweDt9CiNlbmRpbmctc2NyZWVuLnZpc2libGUge2Rpc3BsYXk6ZmxleDsgb3BhY2l0eToxO30KI2VuZGluZy1zY3JlZW4gaDEge2ZvbnQtZmFtaWx5OiAnTm9zaWZlcicsIGN1cnNpdmU7IGZvbnQtc2l6ZTogY2xhbXAoMzBweCwgNXZ3LCA2MHB4KTsgbWFyZ2luLWJvdHRvbTogMjBweDsgY29sb3I6ICNmZjAwMDA7IHRleHQtc2hhZG93OiAwIDAgMjBweCAjOTAwO30KI2VuZGluZy1zY3JlZW4gcCB7Zm9udC1mYW1pbHk6ICdTcGVjaWFsIEVsaXRlJywgY3Vyc2l2ZTsgZm9udC1zaXplOiBjbGFtcCgxNnB4LCAzdncsIDI0cHgpOyBtYXgtd2lkdGg6IDgwMHB4OyBsaW5lLWhlaWdodDogMS41OyBjb2xvcjogI2NjYzt9CgojZGVidWctb3ZlcmxheXtwb3NpdGlvbjphYnNvbHV0ZTt0b3A6MTAwcHg7bGVmdDoxMHB4O2NvbG9yOiMwMGZmMDA7Zm9udC1mYW1pbHk6bW9ub3NwYWNlO2ZvbnQtc2l6ZToxMXB4O2Rpc3BsYXk6bm9uZTtiYWNrZ3JvdW5kOnJnYmEoMCwyMCwwLDAuOSk7cGFkZGluZzoxMnB4O3BvaW50ZXItZXZlbnRzOm5vbmU7ei1pbmRleDoxMDAwO2JvcmRlcjoxcHggc29saWQgIzAwZmYwMDtib3JkZXItcmFkaXVzOjRweDttYXgtd2lkdGg6MzUwcHg7bGluZS1oZWlnaHQ6MS42fQo8L3N0eWxlPgo8c2NyaXB0IHR5cGU9ImltcG9ydG1hcCI+CnsiaW1wb3J0cyI6eyJ0aHJlZSI6Imh0dHBzOi8vdW5wa2cuY29tL3RocmVlQDAuMTYwLjAvYnVpbGQvdGhyZWUubW9kdWxlLmpzIiwidGhyZWUvYWRkb25zLyI6Imh0dHBzOi8vdW5wa2cuY29tL3RocmVlQDAuMTYwLjAvZXhhbXBsZXMvanNtLyJ9fQo8L3NjcmlwdD4KPC9oZWFkPgo8Ym9keT4KPGRpdiBpZD0icHl0aG9uLXN0YXR1cyI+8J+QjSBQeXRob246IExvYWRpbmcuLi48L2Rpdj4KPGRpdiBpZD0iZnBzLWNvdW50ZXIiPkZQUzogMDxicj5DaHVua3M6IDA8YnI+WDogMCBZOiAwIFo6IDA8L2Rpdj4KPGRpdiBpZD0iZGVidWctb3ZlcmxheSI+PC9kaXY+CjxkaXYgaWQ9InF1ZXN0LWJveCI+PGRpdiBjbGFzcz0icXVlc3QtdGl0bGUiPk9CSkVUSVZPIEFUVUFMPC9kaXY+PGRpdiBpZD0icXVlc3QtdGV4dCIgY2xhc3M9InF1ZXN0LW9iamVjdGl2ZSI+RW5jb250cmUgYSDDoXJlYSBkZSBjb3J0ZTwvZGl2PjwvZGl2Pgo8ZGl2IGlkPSJsb2FkaW5nIj48ZGl2IGNsYXNzPSJsb2FkaW5nLWNvbnRlbnQiPjxkaXYgY2xhc3M9ImxvYWRpbmctdGl0bGUiPkVOVEVSSU5HIFNJTEVOQ0UuLi48L2Rpdj48ZGl2IGlkPSJsb2FkaW5nLWJhci1jb250YWluZXIiPjxkaXYgaWQ9ImxvYWRpbmctYmFyIj48L2Rpdj48L2Rpdj48ZGl2IGlkPSJsb2FkaW5nLXRleHQiPkluaXRpYWxpemluZyBQeXRob24gV0FTTS4uLjwvZGl2PjwvZGl2PjwvZGl2Pgo8ZGl2IGlkPSJnYW1lLWNvbnRhaW5lciI+PC9kaXY+CjxkaXYgaWQ9ImNyb3NzaGFpciI+PGRpdiBjbGFzcz0iZG90Ij48L2Rpdj48L2Rpdj4KPGRpdiBpZD0iaW5zdHJ1Y3Rpb25zIj48aDE+UEFVU0VEPC9oMT48cD5DbGljayB0byBDb250aW51ZS4uLjwvcD48L2Rpdj4KPGRpdiBpZD0ibW9iaWxlLWNvbnRyb2xzIj48ZGl2IGlkPSJqb3lzdGljayIgY2xhc3M9ImpveXN0aWNrLXpvbmUiPjxkaXYgaWQ9Imtub2IiIGNsYXNzPSJqb3lzdGljay1rbm9iIj48L2Rpdj48L2Rpdj48L2Rpdj4KPGRpdiBpZD0iY2hhcHRlci1zY3JlZW4iPjxoMT5DQVDDjVRVTE8gMjwvaDE+PHA+QSBGTE9SRVNUQTwvcD48L2Rpdj4KPGRpdiBpZD0iZGlhbG9ndWUtYm94Ij4KICAgIDxkaXYgaWQ9InBvcnRyYWl0LWNvbnRhaW5lciI+CiAgICAgICAgPGltZyBpZD0icGxheWVyLXBvcnRyYWl0IiBzcmM9Imh0dHBzOi8vZ2l0aHViLmNvbS9GZWxpcGU5MjcyNzI3Ly1jb25lc2pvZ2Fkb3IvcmF3L3JlZnMvaGVhZHMvbWFpbi9maWxlXzAwMDAwMDAwMDU0YzcxZjZiMjg4OTc1NTIxYjNlMDgzLnBuZyI+CiAgICAgICAgPGltZyBpZD0id2lmZS1wb3J0cmFpdCIgc3JjPSJodHRwczovL2dpdGh1Yi5jb20vRmVsaXBlOTI3MjcyNy8tY29uZXNqb2dhZG9yL3Jhdy9yZWZzL2hlYWRzL21haW4vZmlsZV8wMDAwMDAwMDE0YWM3MjBlYjUxZGUwOWE4Njk1NDZkYyUyMCgxKS5wbmciPgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJkaWFsb2d1ZS10ZXh0Ij48L2Rpdj4KPC9kaXY+CjxkaXYgaWQ9ImludGVyYWN0aW9uLXByb21wdCI+UHJlc3Npb25lIEUgcGFyYSBTYWlyPC9kaXY+CjxkaXYgaWQ9ImZyaWRnZS1wcm9tcHQiPlBFR0FSIENBUk5FPC9kaXY+CjxkaXYgaWQ9Im1lYXQtY2FycnlpbmctdWkiPvCfpakgQ2FycmVnYW5kbyBDYXJuZTwvZGl2Pgo8ZGl2IGlkPSJlbmRpbmctc2NyZWVuIj4KICAgIDxoMT5GSU0gRE8gSk9HTzwvaDE+CiAgICA8cD5NZSBkZXNjdWxwYSBwIGZpbmFsIGJyb3hhbnRlLCBuw6NvIGRldSB0ZW1wbyBkZSBldSB0cmFiYWxoYXIgbWFpcyBubyBqb2dvLCBlc3RlIGZpbmFsIGZvaSBmZWl0byBjb21wbGV0YW1lbnRlIG5vIGltcHJvdmlzbywgZXNwZXJvIHF1ZSB0ZW5oYW0gZ29zdGFkbzwvcD4KPC9kaXY+Cgo8ZGl2IGlkPSJjdXRzY2VuZS1vdmVybGF5Ij4KICAgIDxkaXYgaWQ9ImN1dHNjZW5lLWJhcnMiPjxkaXYgY2xhc3M9ImNpbmVtYS1iYXIgdG9wIj48L2Rpdj48ZGl2IGNsYXNzPSJjaW5lbWEtYmFyIGJvdHRvbSI+PC9kaXY+PC9kaXY+CiAgICA8ZGl2IGlkPSJjdXRzY2VuZS12aWduZXR0ZSI+PC9kaXY+CiAgICA8ZGl2IGlkPSJjdXRzY2VuZS1mYWRlIj48L2Rpdj4KPC9kaXY+Cgo8YXVkaW8gaWQ9Im5pZ2h0bWFyZS1tdXNpYyIgbG9vcD4KICAgIDxzb3VyY2Ugc3JjPSJodHRwczovL2dpdGh1Yi5jb20vRmVsaXBlOTI3MjcyNy9NLXNpY2FzLWUtZWZlaXRvcy1zb25vcm9zLS9yYXcvcmVmcy9oZWFkcy9tYWluL1doaXNwZXJzJTIwQmV0d2VlbiUyMHRoZSUyMFBpbmVzLm1wMyIgdHlwZT0iYXVkaW8vbXBlZyI+CjwvYXVkaW8+Cgo8IS0tIFB5U2NyaXB0IFB5dGhvbiBTbWFydCBDb2xsaXNpb24gRW5naW5lIHYzLjEgLSBFbmhhbmNlZCBBY2N1cmFjeSAtLT4KPHNjcmlwdCB0eXBlPSJweSI+CmltcG9ydCBqcwpmcm9tIHB5b2RpZGUuZmZpIGltcG9ydCBjcmVhdGVfcHJveHkKaW1wb3J0IG1hdGgKaW1wb3J0IGpzb24KCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBTTUFSVCBQWVRIT04gQ09MTElTSU9OIEVOR0lORSB2My4xCiMgRW5oYW5jZWQgQWNjdXJhY3kgd2l0aCBCZXR0ZXIgQ2FyIERldGVjdGlvbgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgpQTEFZRVJfUkFESVVTID0gMzAKQ09MTElTSU9OX1BBRERJTkcgPSA1CkNMRUFSSU5HX1JBRElVUyA9IDc1MApST0FEX1dJRFRIID0gMTgwClJPQURfU1RBUlRfWiA9IDcwMApMVU1CRVJfUEFUSF9XSURUSCA9IDE0MApMVU1CRVJfUEFUSF9BTkdMRSA9IG1hdGgucGkgKiAwLjc1CkxVTUJFUl9QQVRIX1NUQVJUID0gQ0xFQVJJTkdfUkFESVVTIC0gMTAwCkxVTUJFUl9QQVRIX0xFTkdUSCA9IDE1MDAKTFVNQkVSX0FSRUFfQ0VOVEVSX1ggPSBtYXRoLmNvcyhMVU1CRVJfUEFUSF9BTkdMRSkgKiAoQ0xFQVJJTkdfUkFESVVTICsgTFVNQkVSX1BBVEhfTEVOR1RIKQpMVU1CRVJfQVJFQV9DRU5URVJfWiA9IG1hdGguc2luKExVTUJFUl9QQVRIX0FOR0xFKSAqIChDTEVBUklOR19SQURJVVMgKyBMVU1CRVJfUEFUSF9MRU5HVEgpCkxVTUJFUl9BUkVBX1JBRElVUyA9IDQwMAoKIyBDYWJpbiBsYXlvdXQgY29uc3RhbnRzCkNBQklOX0NFTlRFUl9YID0gMApDQUJJTl9DRU5URVJfWiA9IDAKQ0FCSU5fV0lEVEggPSA1MDAKQ0FCSU5fREVQVEggPSAzNjAKQ0FCSU5fV0FMTF9USElDS05FU1MgPSAyMApDQUJJTl9ET09SX1dJRFRIID0gMTAwCkNBQklOX0RPT1JfT0ZGU0VUX1ggPSAwCgojIENvbGxpc2lvbiBpdGVyYXRpb24gZm9yIGJldHRlciBhY2N1cmFjeQpNQVhfQ09MTElTSU9OX0lURVJBVElPTlMgPSA0ClBVU0hfRVBTSUxPTiA9IDAuNQoKCmNsYXNzIFNtYXJ0Q29sbGlzaW9uRW5naW5lOgogICAgIiIiQWR2YW5jZWQgUHl0aG9uIGNvbGxpc2lvbiBlbmdpbmUgdjMuMSB3aXRoIGVuaGFuY2VkIGFjY3VyYWN5IiIiCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmNvbGxpc2lvbl9jb3VudCA9IDAKICAgICAgICBzZWxmLmxhc3RfY29sbGlzaW9uX25hbWUgPSAiIgogICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fdHlwZSA9ICIiCiAgICAgICAgc2VsZi5ib3hfY29sbGlkZXJzID0gW10KICAgICAgICBzZWxmLmN5bGluZGVyX2NvbGxpZGVycyA9IFtdCiAgICAgICAgc2VsZi5vcmllbnRlZF9ib3hfY29sbGlkZXJzID0gW10KICAgICAgICBzZWxmLmZ1cm5pdHVyZV9yZWdpc3RyeSA9IHt9CiAgICAgICAgc2VsZi5zcGF0aWFsX2dyaWQgPSB7fQogICAgICAgIHNlbGYuZ3JpZF9zaXplID0gMjAwCiAgICAgICAgc2VsZi5oaXRfZm9yZXN0X2JvdW5kYXJ5ID0gRmFsc2UKICAgICAgICBzZWxmLmNhcl9jb2xsaWRlciA9IE5vbmUKICAgICAgICAKICAgICAgICBwcmludCgiW1B5dGhvbiBTbWFydCBFbmdpbmUgdjMuMV0gSW5pdGlhbGl6ZWQgd2l0aCBFbmhhbmNlZCBBY2N1cmFjeSIpCiAgICAKICAgIGRlZiBfZ2V0X2dyaWRfa2V5KHNlbGYsIHgsIHopOgogICAgICAgIHJldHVybiAoaW50KHggLy8gc2VsZi5ncmlkX3NpemUpLCBpbnQoeiAvLyBzZWxmLmdyaWRfc2l6ZSkpCiAgICAKICAgIGRlZiBfYWRkX3RvX2dyaWQoc2VsZiwgY29sbGlkZXIsIGNvbGxpZGVyX3R5cGUpOgogICAgICAgIGlmIGNvbGxpZGVyX3R5cGUgPT0gImJveCI6CiAgICAgICAgICAgIG1pbl9neCA9IGludChjb2xsaWRlclsibWluWCJdIC8vIHNlbGYuZ3JpZF9zaXplKQogICAgICAgICAgICBtYXhfZ3ggPSBpbnQoY29sbGlkZXJbIm1heFgiXSAvLyBzZWxmLmdyaWRfc2l6ZSkKICAgICAgICAgICAgbWluX2d6ID0gaW50KGNvbGxpZGVyWyJtaW5aIl0gLy8gc2VsZi5ncmlkX3NpemUpCiAgICAgICAgICAgIG1heF9neiA9IGludChjb2xsaWRlclsibWF4WiJdIC8vIHNlbGYuZ3JpZF9zaXplKQogICAgICAgIGVsaWYgY29sbGlkZXJfdHlwZSA9PSAiY3lsaW5kZXIiOgogICAgICAgICAgICBjeCwgY3osIHIgPSBjb2xsaWRlclsieCJdLCBjb2xsaWRlclsieiJdLCBjb2xsaWRlclsicmFkaXVzIl0KICAgICAgICAgICAgbWluX2d4ID0gaW50KChjeCAtIHIpIC8vIHNlbGYuZ3JpZF9zaXplKQogICAgICAgICAgICBtYXhfZ3ggPSBpbnQoKGN4ICsgcikgLy8gc2VsZi5ncmlkX3NpemUpCiAgICAgICAgICAgIG1pbl9neiA9IGludCgoY3ogLSByKSAvLyBzZWxmLmdyaWRfc2l6ZSkKICAgICAgICAgICAgbWF4X2d6ID0gaW50KChjeiArIHIpIC8vIHNlbGYuZ3JpZF9zaXplKQogICAgICAgIGVsaWYgY29sbGlkZXJfdHlwZSA9PSAib3JpZW50ZWRfYm94IjoKICAgICAgICAgICAgIyBVc2UgYm91bmRpbmcgY2lyY2xlIGZvciBncmlkIHBsYWNlbWVudAogICAgICAgICAgICBjeCwgY3ogPSBjb2xsaWRlclsiY3giXSwgY29sbGlkZXJbImN6Il0KICAgICAgICAgICAgciA9IG1heChjb2xsaWRlclsiaHciXSwgY29sbGlkZXJbImhkIl0pICogMS41CiAgICAgICAgICAgIG1pbl9neCA9IGludCgoY3ggLSByKSAvLyBzZWxmLmdyaWRfc2l6ZSkKICAgICAgICAgICAgbWF4X2d4ID0gaW50KChjeCArIHIpIC8vIHNlbGYuZ3JpZF9zaXplKQogICAgICAgICAgICBtaW5fZ3ogPSBpbnQoKGN6IC0gcikgLy8gc2VsZi5ncmlkX3NpemUpCiAgICAgICAgICAgIG1heF9neiA9IGludCgoY3ogKyByKSAvLyBzZWxmLmdyaWRfc2l6ZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBmb3IgZ3ggaW4gcmFuZ2UobWluX2d4LCBtYXhfZ3ggKyAxKToKICAgICAgICAgICAgZm9yIGd6IGluIHJhbmdlKG1pbl9neiwgbWF4X2d6ICsgMSk6CiAgICAgICAgICAgICAgICBrZXkgPSAoZ3gsIGd6KQogICAgICAgICAgICAgICAgaWYga2V5IG5vdCBpbiBzZWxmLnNwYXRpYWxfZ3JpZDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnNwYXRpYWxfZ3JpZFtrZXldID0geyJib3hlcyI6IFtdLCAiY3lsaW5kZXJzIjogW10sICJvcmllbnRlZF9ib3hlcyI6IFtdfQogICAgICAgICAgICAgICAgaWYgY29sbGlkZXJfdHlwZSA9PSAiYm94IjoKICAgICAgICAgICAgICAgICAgICBzZWxmLnNwYXRpYWxfZ3JpZFtrZXldWyJib3hlcyJdLmFwcGVuZChjb2xsaWRlcikKICAgICAgICAgICAgICAgIGVsaWYgY29sbGlkZXJfdHlwZSA9PSAiY3lsaW5kZXIiOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc3BhdGlhbF9ncmlkW2tleV1bImN5bGluZGVycyJdLmFwcGVuZChjb2xsaWRlcikKICAgICAgICAgICAgICAgIGVsaWYgY29sbGlkZXJfdHlwZSA9PSAib3JpZW50ZWRfYm94IjoKICAgICAgICAgICAgICAgICAgICBzZWxmLnNwYXRpYWxfZ3JpZFtrZXldWyJvcmllbnRlZF9ib3hlcyJdLmFwcGVuZChjb2xsaWRlcikKICAgIAogICAgZGVmIHJlZ2lzdGVyX2JveChzZWxmLCBuYW1lLCBtaW5feCwgbWF4X3gsIG1pbl96LCBtYXhfeik6CiAgICAgICAgY29sbGlkZXIgPSB7Im5hbWUiOiBuYW1lLCAibWluWCI6IG1pbl94LCAibWF4WCI6IG1heF94LCAibWluWiI6IG1pbl96LCAibWF4WiI6IG1heF96fQogICAgICAgIHNlbGYuYm94X2NvbGxpZGVycy5hcHBlbmQoY29sbGlkZXIpCiAgICAgICAgc2VsZi5fYWRkX3RvX2dyaWQoY29sbGlkZXIsICJib3giKQogICAgICAgIHByaW50KGYiW1B5XSBCb3ggJ3tuYW1lfSc6IFgoe21pbl94Oi4wZn0se21heF94Oi4wZn0pIFooe21pbl96Oi4wZn0se21heF96Oi4wZn0pIikKICAgICAgICByZXR1cm4gbGVuKHNlbGYuYm94X2NvbGxpZGVycykgLSAxCiAgICAKICAgIGRlZiByZWdpc3Rlcl9jeWxpbmRlcihzZWxmLCBuYW1lLCBjeCwgY3osIHJhZGl1cyk6CiAgICAgICAgY29sbGlkZXIgPSB7Im5hbWUiOiBuYW1lLCAieCI6IGN4LCAieiI6IGN6LCAicmFkaXVzIjogcmFkaXVzfQogICAgICAgIHNlbGYuY3lsaW5kZXJfY29sbGlkZXJzLmFwcGVuZChjb2xsaWRlcikKICAgICAgICBzZWxmLl9hZGRfdG9fZ3JpZChjb2xsaWRlciwgImN5bGluZGVyIikKICAgICAgICBwcmludChmIltQeV0gQ3lsaW5kZXIgJ3tuYW1lfSc6ICh7Y3g6LjBmfSx7Y3o6LjBmfSkgcj17cmFkaXVzOi4wZn0iKQogICAgICAgIHJldHVybiBsZW4oc2VsZi5jeWxpbmRlcl9jb2xsaWRlcnMpIC0gMQogICAgCiAgICBkZWYgcmVnaXN0ZXJfb3JpZW50ZWRfYm94KHNlbGYsIG5hbWUsIGN4LCBjeiwgaGFsZl93aWR0aCwgaGFsZl9kZXB0aCwgcm90YXRpb24pOgogICAgICAgICIiIlJlZ2lzdGVyIGFuIG9yaWVudGVkIGJvdW5kaW5nIGJveCAoT0JCKSBmb3IgYWNjdXJhdGUgcm90YXRlZCBjb2xsaXNpb24iIiIKICAgICAgICBjb2xsaWRlciA9IHsKICAgICAgICAgICAgIm5hbWUiOiBuYW1lLCAKICAgICAgICAgICAgImN4IjogY3gsIAogICAgICAgICAgICAiY3oiOiBjeiwgCiAgICAgICAgICAgICJodyI6IGhhbGZfd2lkdGgsIAogICAgICAgICAgICAiaGQiOiBoYWxmX2RlcHRoLCAKICAgICAgICAgICAgInJvdCI6IHJvdGF0aW9uLAogICAgICAgICAgICAiY29zX3IiOiBtYXRoLmNvcyhyb3RhdGlvbiksCiAgICAgICAgICAgICJzaW5fciI6IG1hdGguc2luKHJvdGF0aW9uKQogICAgICAgIH0KICAgICAgICBzZWxmLm9yaWVudGVkX2JveF9jb2xsaWRlcnMuYXBwZW5kKGNvbGxpZGVyKQogICAgICAgIHNlbGYuX2FkZF90b19ncmlkKGNvbGxpZGVyLCAib3JpZW50ZWRfYm94IikKICAgICAgICBwcmludChmIltQeV0gT0JCICd7bmFtZX0nOiAoe2N4Oi4wZn0se2N6Oi4wZn0pIHtoYWxmX3dpZHRoKjI6LjBmfXh7aGFsZl9kZXB0aCoyOi4wZn0gcm90PXttYXRoLmRlZ3JlZXMocm90YXRpb24pOi4xZn3CsCIpCiAgICAgICAgcmV0dXJuIGxlbihzZWxmLm9yaWVudGVkX2JveF9jb2xsaWRlcnMpIC0gMQogICAgCiAgICBkZWYgcmVnaXN0ZXJfY2FyKHNlbGYsIGN4LCBjeiwgcm90X3ksIGxlbmd0aCwgd2lkdGgpOgogICAgICAgICIiIlJlZ2lzdGVyIGNhciB3aXRoIGFjY3VyYXRlIG9yaWVudGVkIGNvbGxpc2lvbiBib3giIiIKICAgICAgICBoYWxmX2xlbmd0aCA9IGxlbmd0aCAvIDIgKyBDT0xMSVNJT05fUEFERElORwogICAgICAgIGhhbGZfd2lkdGggPSB3aWR0aCAvIDIgKyBDT0xMSVNJT05fUEFERElORwogICAgICAgIAogICAgICAgICMgUmVtb3ZlIG9sZCBjYXIgY29sbGlkZXIgaWYgZXhpc3RzCiAgICAgICAgaWYgc2VsZi5jYXJfY29sbGlkZXI6CiAgICAgICAgICAgIHNlbGYucmVtb3ZlX2NvbGxpZGVyKCJjYXJfcGFya2VkIikKICAgICAgICAKICAgICAgICBzZWxmLmNhcl9jb2xsaWRlciA9IHsKICAgICAgICAgICAgIm5hbWUiOiAiY2FyX3BhcmtlZCIsCiAgICAgICAgICAgICJjeCI6IGN4LAogICAgICAgICAgICAiY3oiOiBjeiwKICAgICAgICAgICAgImh3IjogaGFsZl93aWR0aCwKICAgICAgICAgICAgImhkIjogaGFsZl9sZW5ndGgsCiAgICAgICAgICAgICJyb3QiOiByb3RfeSwKICAgICAgICAgICAgImNvc19yIjogbWF0aC5jb3Mocm90X3kpLAogICAgICAgICAgICAic2luX3IiOiBtYXRoLnNpbihyb3RfeSkKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgIyBBZGQgdG8gc3BhdGlhbCBncmlkCiAgICAgICAgciA9IG1heChoYWxmX2xlbmd0aCwgaGFsZl93aWR0aCkgKiAxLjUKICAgICAgICBtaW5fZ3ggPSBpbnQoKGN4IC0gcikgLy8gc2VsZi5ncmlkX3NpemUpCiAgICAgICAgbWF4X2d4ID0gaW50KChjeCArIHIpIC8vIHNlbGYuZ3JpZF9zaXplKQogICAgICAgIG1pbl9neiA9IGludCgoY3ogLSByKSAvLyBzZWxmLmdyaWRfc2l6ZSkKICAgICAgICBtYXhfZ3ogPSBpbnQoKGN6ICsgcikgLy8gc2VsZi5ncmlkX3NpemUpCiAgICAgICAgCiAgICAgICAgZm9yIGd4IGluIHJhbmdlKG1pbl9neCwgbWF4X2d4ICsgMSk6CiAgICAgICAgICAgIGZvciBneiBpbiByYW5nZShtaW5fZ3osIG1heF9neiArIDEpOgogICAgICAgICAgICAgICAga2V5ID0gKGd4LCBneikKICAgICAgICAgICAgICAgIGlmIGtleSBub3QgaW4gc2VsZi5zcGF0aWFsX2dyaWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zcGF0aWFsX2dyaWRba2V5XSA9IHsiYm94ZXMiOiBbXSwgImN5bGluZGVycyI6IFtdLCAib3JpZW50ZWRfYm94ZXMiOiBbXX0KICAgICAgICAgICAgICAgIGlmIHNlbGYuY2FyX2NvbGxpZGVyIG5vdCBpbiBzZWxmLnNwYXRpYWxfZ3JpZFtrZXldLmdldCgib3JpZW50ZWRfYm94ZXMiLCBbXSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zcGF0aWFsX2dyaWRba2V5XVsib3JpZW50ZWRfYm94ZXMiXS5hcHBlbmQoc2VsZi5jYXJfY29sbGlkZXIpCiAgICAgICAgCiAgICAgICAgcHJpbnQoZiJbUHldIENhciByZWdpc3RlcmVkOiAoe2N4Oi4wZn0se2N6Oi4wZn0pIHtsZW5ndGg6LjBmfXh7d2lkdGg6LjBmfSByb3Q9e21hdGguZGVncmVlcyhyb3RfeSk6LjFmfcKwIikKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgdXBkYXRlX2Nhcl9wb3NpdGlvbihzZWxmLCBjeCwgY3osIHJvdF95KToKICAgICAgICAiIiJVcGRhdGUgY2FyIHBvc2l0aW9uIGR1cmluZyBjdXRzY2VuZSBmb3IgcmVhbC10aW1lIGNvbGxpc2lvbiIiIgogICAgICAgIGlmIG5vdCBzZWxmLmNhcl9jb2xsaWRlcjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBVcGRhdGUgY29sbGlkZXIgdmFsdWVzCiAgICAgICAgc2VsZi5jYXJfY29sbGlkZXJbImN4Il0gPSBjeAogICAgICAgIHNlbGYuY2FyX2NvbGxpZGVyWyJjeiJdID0gY3oKICAgICAgICBzZWxmLmNhcl9jb2xsaWRlclsicm90Il0gPSByb3RfeQogICAgICAgIHNlbGYuY2FyX2NvbGxpZGVyWyJjb3NfciJdID0gbWF0aC5jb3Mocm90X3kpCiAgICAgICAgc2VsZi5jYXJfY29sbGlkZXJbInNpbl9yIl0gPSBtYXRoLnNpbihyb3RfeSkKICAgIAogICAgZGVmIHJlbW92ZV9jb2xsaWRlcihzZWxmLCBuYW1lKToKICAgICAgICAiIiJSZW1vdmUgYSBjb2xsaWRlciBieSBuYW1lIiIiCiAgICAgICAgIyBSZW1vdmUgZnJvbSBib3ggY29sbGlkZXJzCiAgICAgICAgc2VsZi5ib3hfY29sbGlkZXJzID0gW2MgZm9yIGMgaW4gc2VsZi5ib3hfY29sbGlkZXJzIGlmIGNbIm5hbWUiXSAhPSBuYW1lXQogICAgICAgIHNlbGYuY3lsaW5kZXJfY29sbGlkZXJzID0gW2MgZm9yIGMgaW4gc2VsZi5jeWxpbmRlcl9jb2xsaWRlcnMgaWYgY1sibmFtZSJdICE9IG5hbWVdCiAgICAgICAgc2VsZi5vcmllbnRlZF9ib3hfY29sbGlkZXJzID0gW2MgZm9yIGMgaW4gc2VsZi5vcmllbnRlZF9ib3hfY29sbGlkZXJzIGlmIGNbIm5hbWUiXSAhPSBuYW1lXQogICAgICAgIAogICAgICAgICMgUmVtb3ZlIGZyb20gc3BhdGlhbCBncmlkCiAgICAgICAgZm9yIGtleSBpbiBzZWxmLnNwYXRpYWxfZ3JpZDoKICAgICAgICAgICAgc2VsZi5zcGF0aWFsX2dyaWRba2V5XVsiYm94ZXMiXSA9IFtjIGZvciBjIGluIHNlbGYuc3BhdGlhbF9ncmlkW2tleV0uZ2V0KCJib3hlcyIsIFtdKSBpZiBjWyJuYW1lIl0gIT0gbmFtZV0KICAgICAgICAgICAgc2VsZi5zcGF0aWFsX2dyaWRba2V5XVsiY3lsaW5kZXJzIl0gPSBbYyBmb3IgYyBpbiBzZWxmLnNwYXRpYWxfZ3JpZFtrZXldLmdldCgiY3lsaW5kZXJzIiwgW10pIGlmIGNbIm5hbWUiXSAhPSBuYW1lXQogICAgICAgICAgICBzZWxmLnNwYXRpYWxfZ3JpZFtrZXldWyJvcmllbnRlZF9ib3hlcyJdID0gW2MgZm9yIGMgaW4gc2VsZi5zcGF0aWFsX2dyaWRba2V5XS5nZXQoIm9yaWVudGVkX2JveGVzIiwgW10pIGlmIGNbIm5hbWUiXSAhPSBuYW1lXQogICAgCiAgICBkZWYgYW5hbHl6ZV9hbmRfcmVnaXN0ZXIoc2VsZiwgbmFtZSwgY2F0ZWdvcnksIG1pbl94LCBtYXhfeCwgbWluX3ksIG1heF95LCBtaW5feiwgbWF4X3opOgogICAgICAgICIiIkludGVsbGlnZW50bHkgYW5hbHl6ZSBvYmplY3QgYm91bmRzIGFuZCBjcmVhdGUgb3B0aW1hbCBjb2xsaWRlciIiIgogICAgICAgIHdpZHRoID0gbWF4X3ggLSBtaW5feAogICAgICAgIGRlcHRoID0gbWF4X3ogLSBtaW5fegogICAgICAgIGhlaWdodCA9IG1heF95IC0gbWluX3kKICAgICAgICBjeCA9IChtaW5feCArIG1heF94KSAvIDIKICAgICAgICBjeiA9IChtaW5feiArIG1heF96KSAvIDIKICAgICAgICAKICAgICAgICBzZWxmLmZ1cm5pdHVyZV9yZWdpc3RyeVtuYW1lXSA9IHsKICAgICAgICAgICAgImNhdGVnb3J5IjogY2F0ZWdvcnksCiAgICAgICAgICAgICJib3VuZHMiOiBbbWluX3gsIG1heF94LCBtaW5feSwgbWF4X3ksIG1pbl96LCBtYXhfel0sCiAgICAgICAgICAgICJjZW50ZXIiOiBbY3gsIGN6XSwKICAgICAgICAgICAgInNpemUiOiBbd2lkdGgsIGRlcHRoLCBoZWlnaHRdCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGFzcGVjdCA9IHdpZHRoIC8gZGVwdGggaWYgZGVwdGggPiAwLjAxIGVsc2UgMQogICAgICAgIGFyZWEgPSB3aWR0aCAqIGRlcHRoCiAgICAgICAgCiAgICAgICAgIyBBZGQgcGFkZGluZyBmb3IgYmV0dGVyIGNvbGxpc2lvbgogICAgICAgIHBhZCA9IENPTExJU0lPTl9QQURESU5HCiAgICAgICAgCiAgICAgICAgaWYgY2F0ZWdvcnkgPT0gImNoYWlyIiBvciAoMC43IDwgYXNwZWN0IDwgMS40IGFuZCBhcmVhIDwgMzAwMCk6CiAgICAgICAgICAgIHIgPSBtYXgod2lkdGgsIGRlcHRoKSAvIDIgKyBwYWQgKyA4CiAgICAgICAgICAgIHNlbGYucmVnaXN0ZXJfY3lsaW5kZXIobmFtZSwgY3gsIGN6LCByKQogICAgICAgICAgICBzaGFwZSA9ICJjeWxpbmRlciIKICAgICAgICBlbGlmIGNhdGVnb3J5ID09ICJ0YWJsZSIgYW5kIGFzcGVjdCA+IDEuODoKICAgICAgICAgICAgc2VsZi5yZWdpc3Rlcl9ib3gobmFtZSwgbWluX3ggLSBwYWQsIG1heF94ICsgcGFkLCBtaW5feiAtIHBhZCwgbWF4X3ogKyBwYWQpCiAgICAgICAgICAgIHNoYXBlID0gImJveCIKICAgICAgICBlbGlmIGNhdGVnb3J5ID09ICJsYW1wIiBvciBhcmVhIDwgMTUwMDoKICAgICAgICAgICAgciA9IG1heCh3aWR0aCwgZGVwdGgpIC8gMiArIHBhZCArIDUKICAgICAgICAgICAgc2VsZi5yZWdpc3Rlcl9jeWxpbmRlcihuYW1lLCBjeCwgY3osIHIpCiAgICAgICAgICAgIHNoYXBlID0gImN5bGluZGVyIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYucmVnaXN0ZXJfYm94KG5hbWUsIG1pbl94IC0gcGFkLCBtYXhfeCArIHBhZCwgbWluX3ogLSBwYWQsIG1heF96ICsgcGFkKQogICAgICAgICAgICBzaGFwZSA9ICJib3giCiAgICAgICAgCiAgICAgICAgcmVzdWx0ID0geyJuYW1lIjogbmFtZSwgInNoYXBlIjogc2hhcGUsICJ3aWR0aCI6IHdpZHRoLCAiZGVwdGgiOiBkZXB0aCwgImhlaWdodCI6IGhlaWdodH0KICAgICAgICBwcmludChmIltQeV0gU21hcnQgcmVnaXN0ZXIgJ3tuYW1lfScgYXMge3NoYXBlfSAoe3dpZHRoOi4wZn14e2RlcHRoOi4wZn0pIikKICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhyZXN1bHQpCiAgICAKICAgIGRlZiByZWdpc3Rlcl9wcmVjaXNlX2NhYmluKHNlbGYpOgogICAgICAgICIiIkNyZWF0ZSBwcmVjaXNlIGNhYmluIGNvbGxpc2lvbiBtYXRjaGluZyB0aGUgYWN0dWFsIG1vZGVsIiIiCiAgICAgICAgY3gsIGN6ID0gQ0FCSU5fQ0VOVEVSX1gsIENBQklOX0NFTlRFUl9aCiAgICAgICAgaHcgPSBDQUJJTl9XSURUSCAvIDIKICAgICAgICBoZCA9IENBQklOX0RFUFRIIC8gMgogICAgICAgIHd0ID0gQ0FCSU5fV0FMTF9USElDS05FU1MKICAgICAgICBkdyA9IENBQklOX0RPT1JfV0lEVEggLyAyCiAgICAgICAgZG8gPSBDQUJJTl9ET09SX09GRlNFVF9YCiAgICAgICAgCiAgICAgICAgc2VsZi5yZWdpc3Rlcl9ib3goImNhYmluX2JhY2siLCBjeCAtIGh3LCBjeCArIGh3LCBjeiAtIGhkIC0gd3QsIGN6IC0gaGQgKyB3dCkKICAgICAgICBzZWxmLnJlZ2lzdGVyX2JveCgiY2FiaW5fbGVmdCIsIGN4IC0gaHcgLSB3dCwgY3ggLSBodyArIHd0LCBjeiAtIGhkLCBjeiArIGhkKQogICAgICAgIHNlbGYucmVnaXN0ZXJfYm94KCJjYWJpbl9yaWdodCIsIGN4ICsgaHcgLSB3dCwgY3ggKyBodyArIHd0LCBjeiAtIGhkLCBjeiArIGhkKQogICAgICAgIHNlbGYucmVnaXN0ZXJfYm94KCJjYWJpbl9mcm9udF9MIiwgY3ggLSBodywgY3ggKyBkbyAtIGR3LCBjeiArIGhkIC0gd3QsIGN6ICsgaGQgKyB3dCkKICAgICAgICBzZWxmLnJlZ2lzdGVyX2JveCgiY2FiaW5fZnJvbnRfUiIsIGN4ICsgZG8gKyBkdywgY3ggKyBodywgY3ogKyBoZCAtIHd0LCBjeiArIGhkICsgd3QpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl9jeWxpbmRlcigiY2FiaW5fYmVhbV8xIiwgY3ggLSBodyArIDQwLCBjeiAtIGhkICsgODAsIDEyKQogICAgICAgIHNlbGYucmVnaXN0ZXJfY3lsaW5kZXIoImNhYmluX2JlYW1fMiIsIGN4ICsgaHcgLSA0MCwgY3ogLSBoZCArIDgwLCAxMikKICAgICAgICAKICAgICAgICBwcmludChmIltQeV0gUHJlY2lzZSBjYWJpbiByZWdpc3RlcmVkOiB7Q0FCSU5fV0lEVEh9eHtDQUJJTl9ERVBUSH0gd2l0aCB7Q0FCSU5fRE9PUl9XSURUSH0gZG9vciIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgZGVmIGdldF9mdXJuaXR1cmVfbGF5b3V0KHNlbGYpOgogICAgICAgICIiIlJldHVybiBvcHRpbWFsIGZ1cm5pdHVyZSBwb3NpdGlvbnMgZm9yIHRoZSBjYWJpbiIiIgogICAgICAgIGN4LCBjeiA9IENBQklOX0NFTlRFUl9YLCBDQUJJTl9DRU5URVJfWgogICAgICAgIGh3ID0gQ0FCSU5fV0lEVEggLyAyCiAgICAgICAgaGQgPSBDQUJJTl9ERVBUSCAvIDIKICAgICAgICAKICAgICAgICBsYXlvdXQgPSB7CiAgICAgICAgICAgICJiZWQiOiB7IngiOiAxNzAsICJ6IjogMjAsICJyb3RZIjogMH0sCiAgICAgICAgICAgICJzdG92ZSI6IHsieCI6IC0xNzAsICJ6IjogMTAwLCAicm90WSI6IG1hdGgucGkvMn0sCiAgICAgICAgICAgICJmcmlkZ2UiOiB7IngiOiBjeCAtIGh3ICsgODAsICJ6IjogY3ogLSBoZCArIDgwLCAicm90WSI6IG1hdGgucGkvMn0sCiAgICAgICAgICAgICJ0YWJsZSI6IHsieCI6IDEzMCwgInoiOiAyMDAsICJyb3RZIjogbWF0aC5waX0sCiAgICAgICAgICAgICJjaGFpcl8xIjogeyJ4IjogY3ggKyAxMDAsICJ6IjogY3ogKyBoZCAtIDEwMCwgInJvdFkiOiAtbWF0aC5waS8yfSwKICAgICAgICAgICAgImNoYWlyXzIiOiB7IngiOiBjeCwgInoiOiBjeiArIGhkIC0gMTAwLCAicm90WSI6IG1hdGgucGkvMn0sCiAgICAgICAgICAgICJib29rc2hlbGYiOiB7IngiOiBjeCAtIGh3ICsgNjAsICJ6IjogY3ogKyBoZCAtIDgwLCAicm90WSI6IG1hdGgucGkvMn0sCiAgICAgICAgICAgICJjYWJpbmV0IjogeyJ4IjogY3ggKyBodyAtIDYwLCAieiI6IGN6ICsgaGQgLSA4MCwgInJvdFkiOiAtbWF0aC5waS8yfSwKICAgICAgICAgICAgImxhbXAiOiB7IngiOiBjeCArIGh3IC0gMTAwLCAieiI6IGN6IC0gaGQgKyAyMDAsICJyb3RZIjogMH0sCiAgICAgICAgICAgICJydWciOiB7IngiOiBjeCwgInoiOiBjeiwgInJvdFkiOiAwfSwKICAgICAgICAgICAgImZpcmVwbGFjZSI6IHsieCI6IGN4LCAieiI6IGN6IC0gaGQgKyAzMCwgInJvdFkiOiAwfSwKICAgICAgICAgICAgIndvcm5fY2hhaXIiOiB7IngiOiAwLCAieiI6IC03MCwgInJvdFkiOiAwLjM0OX0sCiAgICAgICAgICAgICJzb2ZhIjogeyJ4IjogOTAsICJ6IjogLTEzMCwgInJvdFkiOiAwfQogICAgICAgIH0KICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhsYXlvdXQpCiAgICAKICAgIGRlZiByZXNvbHZlX2JveChzZWxmLCB4LCB6LCBib3gpOgogICAgICAgICIiIlJlc29sdmUgY29sbGlzaW9uIHdpdGggYXhpcy1hbGlnbmVkIGJveCB1c2luZyBjb250aW51b3VzIGNvbGxpc2lvbiIiIgogICAgICAgIHByID0gUExBWUVSX1JBRElVUyArIENPTExJU0lPTl9QQURESU5HCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBpZiBpbnNpZGUgZXhwYW5kZWQgYm94CiAgICAgICAgaWYgbm90ICh4ID4gYm94WyJtaW5YIl0gLSBwciBhbmQgeCA8IGJveFsibWF4WCJdICsgcHIgYW5kCiAgICAgICAgICAgICAgICB6ID4gYm94WyJtaW5aIl0gLSBwciBhbmQgeiA8IGJveFsibWF4WiJdICsgcHIpOgogICAgICAgICAgICByZXR1cm4geCwgeiwgRmFsc2UKICAgICAgICAKICAgICAgICAjIENhbGN1bGF0ZSBwZW5ldHJhdGlvbiBkZXB0aHMKICAgICAgICBwZW5fbCA9IHggLSAoYm94WyJtaW5YIl0gLSBwcikKICAgICAgICBwZW5fciA9IChib3hbIm1heFgiXSArIHByKSAtIHgKICAgICAgICBwZW5fYiA9IHogLSAoYm94WyJtaW5aIl0gLSBwcikKICAgICAgICBwZW5fZiA9IChib3hbIm1heFoiXSArIHByKSAtIHoKICAgICAgICAKICAgICAgICBtaW5fcGVuID0gbWluKHBlbl9sLCBwZW5fciwgcGVuX2IsIHBlbl9mKQogICAgICAgIAogICAgICAgICMgUHVzaCBvdXQgYWxvbmcgbWluaW11bSBwZW5ldHJhdGlvbiBheGlzCiAgICAgICAgaWYgbWluX3BlbiA9PSBwZW5fbDoKICAgICAgICAgICAgcmV0dXJuIGJveFsibWluWCJdIC0gcHIgLSBQVVNIX0VQU0lMT04sIHosIFRydWUKICAgICAgICBlbGlmIG1pbl9wZW4gPT0gcGVuX3I6CiAgICAgICAgICAgIHJldHVybiBib3hbIm1heFgiXSArIHByICsgUFVTSF9FUFNJTE9OLCB6LCBUcnVlCiAgICAgICAgZWxpZiBtaW5fcGVuID09IHBlbl9iOgogICAgICAgICAgICByZXR1cm4geCwgYm94WyJtaW5aIl0gLSBwciAtIFBVU0hfRVBTSUxPTiwgVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiB4LCBib3hbIm1heFoiXSArIHByICsgUFVTSF9FUFNJTE9OLCBUcnVlCiAgICAKICAgIGRlZiByZXNvbHZlX2N5bGluZGVyKHNlbGYsIHgsIHosIGN5bCk6CiAgICAgICAgIiIiUmVzb2x2ZSBjb2xsaXNpb24gd2l0aCBjeWxpbmRlciIiIgogICAgICAgIGR4ID0geCAtIGN5bFsieCJdCiAgICAgICAgZHogPSB6IC0gY3lsWyJ6Il0KICAgICAgICBkaXN0ID0gbWF0aC5zcXJ0KGR4KmR4ICsgZHoqZHopCiAgICAgICAgbWluX2QgPSBjeWxbInJhZGl1cyJdICsgUExBWUVSX1JBRElVUyArIENPTExJU0lPTl9QQURESU5HCiAgICAgICAgCiAgICAgICAgaWYgZGlzdCA8IG1pbl9kIGFuZCBkaXN0ID4gMC4wMToKICAgICAgICAgICAgZiA9IChtaW5fZCArIFBVU0hfRVBTSUxPTikgLyBkaXN0CiAgICAgICAgICAgIHJldHVybiBjeWxbIngiXSArIGR4KmYsIGN5bFsieiJdICsgZHoqZiwgVHJ1ZQogICAgICAgIHJldHVybiB4LCB6LCBGYWxzZQogICAgCiAgICBkZWYgcmVzb2x2ZV9vcmllbnRlZF9ib3goc2VsZiwgeCwgeiwgb2JiKToKICAgICAgICAiIiJSZXNvbHZlIGNvbGxpc2lvbiB3aXRoIG9yaWVudGVkIGJvdW5kaW5nIGJveCAoT0JCKSIiIgogICAgICAgICMgVHJhbnNmb3JtIHBsYXllciBwb3NpdGlvbiB0byBPQkIgbG9jYWwgc3BhY2UKICAgICAgICBkeCA9IHggLSBvYmJbImN4Il0KICAgICAgICBkeiA9IHogLSBvYmJbImN6Il0KICAgICAgICAKICAgICAgICBjb3NfciA9IG9iYlsiY29zX3IiXQogICAgICAgIHNpbl9yID0gb2JiWyJzaW5fciJdCiAgICAgICAgCiAgICAgICAgIyBSb3RhdGUgdG8gbG9jYWwgc3BhY2UKICAgICAgICBsb2NhbF94ID0gZHggKiBjb3NfciArIGR6ICogc2luX3IKICAgICAgICBsb2NhbF96ID0gLWR4ICogc2luX3IgKyBkeiAqIGNvc19yCiAgICAgICAgCiAgICAgICAgIyBFeHBhbmQgT0JCIGJ5IHBsYXllciByYWRpdXMKICAgICAgICBodyA9IG9iYlsiaHciXSArIFBMQVlFUl9SQURJVVMgKyBDT0xMSVNJT05fUEFERElORwogICAgICAgIGhkID0gb2JiWyJoZCJdICsgUExBWUVSX1JBRElVUyArIENPTExJU0lPTl9QQURESU5HCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBpZiBpbnNpZGUgZXhwYW5kZWQgT0JCCiAgICAgICAgaWYgbm90IChhYnMobG9jYWxfeCkgPCBodyBhbmQgYWJzKGxvY2FsX3opIDwgaGQpOgogICAgICAgICAgICByZXR1cm4geCwgeiwgRmFsc2UKICAgICAgICAKICAgICAgICAjIENhbGN1bGF0ZSBwZW5ldHJhdGlvbiBpbiBsb2NhbCBzcGFjZQogICAgICAgIHBlbl9sID0gbG9jYWxfeCArIGh3CiAgICAgICAgcGVuX3IgPSBodyAtIGxvY2FsX3gKICAgICAgICBwZW5fYiA9IGxvY2FsX3ogKyBoZAogICAgICAgIHBlbl9mID0gaGQgLSBsb2NhbF96CiAgICAgICAgCiAgICAgICAgbWluX3BlbiA9IG1pbihwZW5fbCwgcGVuX3IsIHBlbl9iLCBwZW5fZikKICAgICAgICAKICAgICAgICAjIFB1c2ggb3V0IGFsb25nIG1pbmltdW0gcGVuZXRyYXRpb24gYXhpcwogICAgICAgIGlmIG1pbl9wZW4gPT0gcGVuX2w6CiAgICAgICAgICAgIGxvY2FsX3ggPSAtaHcgLSBQVVNIX0VQU0lMT04KICAgICAgICBlbGlmIG1pbl9wZW4gPT0gcGVuX3I6CiAgICAgICAgICAgIGxvY2FsX3ggPSBodyArIFBVU0hfRVBTSUxPTgogICAgICAgIGVsaWYgbWluX3BlbiA9PSBwZW5fYjoKICAgICAgICAgICAgbG9jYWxfeiA9IC1oZCAtIFBVU0hfRVBTSUxPTgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvY2FsX3ogPSBoZCArIFBVU0hfRVBTSUxPTgogICAgICAgIAogICAgICAgICMgVHJhbnNmb3JtIGJhY2sgdG8gd29ybGQgc3BhY2UKICAgICAgICBuZXdfeCA9IG9iYlsiY3giXSArIGxvY2FsX3ggKiBjb3NfciAtIGxvY2FsX3ogKiBzaW5fcgogICAgICAgIG5ld196ID0gb2JiWyJjeiJdICsgbG9jYWxfeCAqIHNpbl9yICsgbG9jYWxfeiAqIGNvc19yCiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ld194LCBuZXdfeiwgVHJ1ZQogICAgCiAgICBkZWYgaXNfaW5fbHVtYmVyX3BhdGgoc2VsZiwgeCwgeik6CiAgICAgICAgZHggPSBtYXRoLmNvcyhMVU1CRVJfUEFUSF9BTkdMRSkKICAgICAgICBkeiA9IG1hdGguc2luKExVTUJFUl9QQVRIX0FOR0xFKQogICAgICAgIGRvdCA9IHgqZHggKyB6KmR6CiAgICAgICAgaWYgZG90IDwgTFVNQkVSX1BBVEhfU1RBUlQgLSA1MCBvciBkb3QgPiBDTEVBUklOR19SQURJVVMgKyBMVU1CRVJfUEFUSF9MRU5HVEggLSBMVU1CRVJfQVJFQV9SQURJVVMgKyA1MDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcHggPSB4IC0gZG90KmR4CiAgICAgICAgcHogPSB6IC0gZG90KmR6CiAgICAgICAgcmV0dXJuIChweCpweCArIHB6KnB6KSA8IExVTUJFUl9QQVRIX1dJRFRIKioyCiAgICAKICAgIGRlZiBpc19pbl9sdW1iZXJfYXJlYShzZWxmLCB4LCB6KToKICAgICAgICBkeCA9IHggLSBMVU1CRVJfQVJFQV9DRU5URVJfWAogICAgICAgIGR6ID0geiAtIExVTUJFUl9BUkVBX0NFTlRFUl9aCiAgICAgICAgcmV0dXJuIChkeCpkeCArIGR6KmR6KSA8IExVTUJFUl9BUkVBX1JBRElVUyoqMgogICAgCiAgICBkZWYgY29uc3RyYWluX2x1bWJlcl9wYXRoKHNlbGYsIHgsIHopOgogICAgICAgIGR4ID0gbWF0aC5jb3MoTFVNQkVSX1BBVEhfQU5HTEUpCiAgICAgICAgZHogPSBtYXRoLnNpbihMVU1CRVJfUEFUSF9BTkdMRSkKICAgICAgICBkb3QgPSB4KmR4ICsgeipkegogICAgICAgIHB4ID0geCAtIGRvdCpkeAogICAgICAgIHB6ID0geiAtIGRvdCpkegogICAgICAgIHBkID0gbWF0aC5zcXJ0KHB4KnB4ICsgcHoqcHopCiAgICAgICAgbWF4X3AgPSBMVU1CRVJfUEFUSF9XSURUSCAtIFBMQVlFUl9SQURJVVMKICAgICAgICBpZiBwZCA+IG1heF9wIGFuZCBwZCA+IDAuMDE6CiAgICAgICAgICAgIGYgPSBtYXhfcCAvIHBkCiAgICAgICAgICAgIHJldHVybiBkb3QqZHggKyBweCpmLCBkb3QqZHogKyBweipmCiAgICAgICAgcmV0dXJuIHgsIHoKICAgIAogICAgZGVmIGNoZWNrX3dvcmxkX2JvdW5kcyhzZWxmLCB4LCB6LCBvcmlnaW5hbF94LCBvcmlnaW5hbF96KToKICAgICAgICAiIiJDaGVjayBhbmQgY29uc3RyYWluIHBsYXllciB0byB2YWxpZCB6b25lcywgZGV0ZWN0IGZvcmVzdCBib3VuZGFyeSBoaXQiIiIKICAgICAgICBkaXN0ID0gbWF0aC5zcXJ0KHgqeCArIHoqeikKICAgICAgICBtYXhfciA9IENMRUFSSU5HX1JBRElVUyAtIFBMQVlFUl9SQURJVVMKICAgICAgICAKICAgICAgICBpbl9jbGVhciA9IGRpc3QgPCBtYXhfcgogICAgICAgIGluX3JvYWQgPSB6ID4gUk9BRF9TVEFSVF9aIC0gMTAwIGFuZCBhYnMoeCkgPCBST0FEX1dJRFRIIC0gUExBWUVSX1JBRElVUwogICAgICAgIGluX2xwYXRoID0gc2VsZi5pc19pbl9sdW1iZXJfcGF0aCh4LCB6KQogICAgICAgIGluX2xhcmVhID0gc2VsZi5pc19pbl9sdW1iZXJfYXJlYSh4LCB6KQogICAgICAgIAogICAgICAgIG5ld194LCBuZXdfeiA9IHgsIHoKICAgICAgICBoaXRfYm91bmRhcnkgPSBGYWxzZQogICAgICAgIAogICAgICAgIGlmIGluX2NsZWFyIG9yIGluX3JvYWQgb3IgaW5fbHBhdGggb3IgaW5fbGFyZWE6CiAgICAgICAgICAgICMgUGxheWVyIGlzIGluIGEgdmFsaWQgem9uZQogICAgICAgICAgICBpZiBpbl9yb2FkIGFuZCB6ID4gUk9BRF9TVEFSVF9aOgogICAgICAgICAgICAgICAgcmwgPSBST0FEX1dJRFRIIC0gUExBWUVSX1JBRElVUwogICAgICAgICAgICAgICAgbmV3X3ggPSBtYXgoLXJsLCBtaW4ocmwsIHgpKQogICAgICAgICAgICBpZiBpbl9scGF0aCBhbmQgbm90IGluX2NsZWFyIGFuZCBub3QgaW5fbGFyZWE6CiAgICAgICAgICAgICAgICBuZXdfeCwgbmV3X3ogPSBzZWxmLmNvbnN0cmFpbl9sdW1iZXJfcGF0aCh4LCB6KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgUGxheWVyIHRyaWVkIHRvIGVudGVyIHRoZSBmb3Jlc3QgLSBwdXNoIGJhY2sgYW5kIHNob3cgd2FybmluZwogICAgICAgICAgICBoaXRfYm91bmRhcnkgPSBUcnVlCiAgICAgICAgICAgIGlmIGRpc3QgPCBDTEVBUklOR19SQURJVVMgKyAyMDA6CiAgICAgICAgICAgICAgICAjIE5lYXIgY2xlYXJpbmcsIHB1c2ggdG8gY2xlYXJpbmcgZWRnZQogICAgICAgICAgICAgICAgYSA9IG1hdGguYXRhbjIoeiwgeCkKICAgICAgICAgICAgICAgIG5ld194LCBuZXdfeiA9IG1hdGguY29zKGEpKm1heF9yLCBtYXRoLnNpbihhKSptYXhfcgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBTb21ld2hlcmUgYWxvbmcgbHVtYmVyIHBhdGgsIGNvbnN0cmFpbiB0byBwYXRoCiAgICAgICAgICAgICAgICBuZXdfeCwgbmV3X3ogPSBzZWxmLmNvbnN0cmFpbl9sdW1iZXJfcGF0aCh4LCB6KQogICAgICAgIAogICAgICAgIHJldHVybiBuZXdfeCwgbmV3X3osIGhpdF9ib3VuZGFyeQogICAgCiAgICBkZWYgaGFuZGxlX2NvbGxpc2lvbihzZWxmLCBweCwgcHopOgogICAgICAgICIiIk1haW4gY29sbGlzaW9uIGhhbmRsZXIgd2l0aCBtdWx0aXBsZSBpdGVyYXRpb25zIGZvciBhY2N1cmFjeSIiIgogICAgICAgIHgsIHogPSBweCwgcHoKICAgICAgICBvcmlnaW5hbF94LCBvcmlnaW5hbF96ID0gcHgsIHB6CiAgICAgICAgaGl0ID0gRmFsc2UKICAgICAgICBzZWxmLmxhc3RfY29sbGlzaW9uX25hbWUgPSAiIgogICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fdHlwZSA9ICIiCiAgICAgICAgc2VsZi5oaXRfZm9yZXN0X2JvdW5kYXJ5ID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIE11bHRpcGxlIGl0ZXJhdGlvbnMgZm9yIGJldHRlciBhY2N1cmFjeQogICAgICAgIGZvciBpdGVyYXRpb24gaW4gcmFuZ2UoTUFYX0NPTExJU0lPTl9JVEVSQVRJT05TKToKICAgICAgICAgICAgaXRlcmF0aW9uX2hpdCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFVzZSBzcGF0aWFsIGdyaWQgZm9yIG5lYXJieSBjb2xsaWRlcnMKICAgICAgICAgICAgZ2sgPSBzZWxmLl9nZXRfZ3JpZF9rZXkoeCwgeikKICAgICAgICAgICAgbmVhcmJ5X2JveGVzID0gW10KICAgICAgICAgICAgbmVhcmJ5X2N5bHMgPSBbXQogICAgICAgICAgICBuZWFyYnlfb2JicyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgZHggaW4gcmFuZ2UoLTEsIDIpOgogICAgICAgICAgICAgICAgZm9yIGR6IGluIHJhbmdlKC0xLCAyKToKICAgICAgICAgICAgICAgICAgICBrZXkgPSAoZ2tbMF0rZHgsIGdrWzFdK2R6KQogICAgICAgICAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLnNwYXRpYWxfZ3JpZDoKICAgICAgICAgICAgICAgICAgICAgICAgbmVhcmJ5X2JveGVzLmV4dGVuZChzZWxmLnNwYXRpYWxfZ3JpZFtrZXldLmdldCgiYm94ZXMiLCBbXSkpCiAgICAgICAgICAgICAgICAgICAgICAgIG5lYXJieV9jeWxzLmV4dGVuZChzZWxmLnNwYXRpYWxfZ3JpZFtrZXldLmdldCgiY3lsaW5kZXJzIiwgW10pKQogICAgICAgICAgICAgICAgICAgICAgICBuZWFyYnlfb2Jicy5leHRlbmQoc2VsZi5zcGF0aWFsX2dyaWRba2V5XS5nZXQoIm9yaWVudGVkX2JveGVzIiwgW10pKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaGVjayBib3hlcwogICAgICAgICAgICBjaGVja2VkID0gc2V0KCkKICAgICAgICAgICAgZm9yIGJveCBpbiBuZWFyYnlfYm94ZXM6CiAgICAgICAgICAgICAgICBiaWQgPSBpZChib3gpCiAgICAgICAgICAgICAgICBpZiBiaWQgaW4gY2hlY2tlZDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgY2hlY2tlZC5hZGQoYmlkKQogICAgICAgICAgICAgICAgbngsIG56LCBoID0gc2VsZi5yZXNvbHZlX2JveCh4LCB6LCBib3gpCiAgICAgICAgICAgICAgICBpZiBoOgogICAgICAgICAgICAgICAgICAgIHgsIHogPSBueCwgbnoKICAgICAgICAgICAgICAgICAgICBpdGVyYXRpb25faGl0ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fbmFtZSA9IGJveFsibmFtZSJdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sYXN0X2NvbGxpc2lvbl90eXBlID0gImJveCIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2hlY2sgY3lsaW5kZXJzCiAgICAgICAgICAgIGNoZWNrZWQgPSBzZXQoKQogICAgICAgICAgICBmb3IgY3lsIGluIG5lYXJieV9jeWxzOgogICAgICAgICAgICAgICAgY2lkID0gaWQoY3lsKQogICAgICAgICAgICAgICAgaWYgY2lkIGluIGNoZWNrZWQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGNoZWNrZWQuYWRkKGNpZCkKICAgICAgICAgICAgICAgIG54LCBueiwgaCA9IHNlbGYucmVzb2x2ZV9jeWxpbmRlcih4LCB6LCBjeWwpCiAgICAgICAgICAgICAgICBpZiBoOgogICAgICAgICAgICAgICAgICAgIHgsIHogPSBueCwgbnoKICAgICAgICAgICAgICAgICAgICBpdGVyYXRpb25faGl0ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fbmFtZSA9IGN5bFsibmFtZSJdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sYXN0X2NvbGxpc2lvbl90eXBlID0gImN5bGluZGVyIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaGVjayBvcmllbnRlZCBib3hlcyAoaW5jbHVkaW5nIGNhcikKICAgICAgICAgICAgY2hlY2tlZCA9IHNldCgpCiAgICAgICAgICAgIGZvciBvYmIgaW4gbmVhcmJ5X29iYnM6CiAgICAgICAgICAgICAgICBvaWQgPSBpZChvYmIpCiAgICAgICAgICAgICAgICBpZiBvaWQgaW4gY2hlY2tlZDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgY2hlY2tlZC5hZGQob2lkKQogICAgICAgICAgICAgICAgbngsIG56LCBoID0gc2VsZi5yZXNvbHZlX29yaWVudGVkX2JveCh4LCB6LCBvYmIpCiAgICAgICAgICAgICAgICBpZiBoOgogICAgICAgICAgICAgICAgICAgIHgsIHogPSBueCwgbnoKICAgICAgICAgICAgICAgICAgICBpdGVyYXRpb25faGl0ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fbmFtZSA9IG9iYlsibmFtZSJdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sYXN0X2NvbGxpc2lvbl90eXBlID0gIm9yaWVudGVkX2JveCIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2hlY2sgY2FyIGNvbGxpZGVyIHNlcGFyYXRlbHkgaWYgZXhpc3RzCiAgICAgICAgICAgIGlmIHNlbGYuY2FyX2NvbGxpZGVyOgogICAgICAgICAgICAgICAgbngsIG56LCBoID0gc2VsZi5yZXNvbHZlX29yaWVudGVkX2JveCh4LCB6LCBzZWxmLmNhcl9jb2xsaWRlcikKICAgICAgICAgICAgICAgIGlmIGg6CiAgICAgICAgICAgICAgICAgICAgeCwgeiA9IG54LCBuegogICAgICAgICAgICAgICAgICAgIGl0ZXJhdGlvbl9oaXQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sYXN0X2NvbGxpc2lvbl9uYW1lID0gImNhciIKICAgICAgICAgICAgICAgICAgICBzZWxmLmxhc3RfY29sbGlzaW9uX3R5cGUgPSAib3JpZW50ZWRfYm94IgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgaXRlcmF0aW9uX2hpdDoKICAgICAgICAgICAgICAgIGhpdCA9IFRydWUKICAgICAgICAgICAgICAgIHNlbGYuY29sbGlzaW9uX2NvdW50ICs9IDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJyZWFrICAjIE5vIG1vcmUgY29sbGlzaW9ucywgc3RvcCBpdGVyYXRpbmcKICAgICAgICAKICAgICAgICAjIFdvcmxkIGJvdW5kcyAoZm9yZXN0IGJvdW5kYXJ5KQogICAgICAgIHgsIHosIGJvdW5kYXJ5X2hpdCA9IHNlbGYuY2hlY2tfd29ybGRfYm91bmRzKHgsIHosIG9yaWdpbmFsX3gsIG9yaWdpbmFsX3opCiAgICAgICAgaWYgYm91bmRhcnlfaGl0OgogICAgICAgICAgICBzZWxmLmhpdF9mb3Jlc3RfYm91bmRhcnkgPSBUcnVlCiAgICAgICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fbmFtZSA9ICJmb3Jlc3RfYm91bmRhcnkiCiAgICAgICAgICAgIHNlbGYubGFzdF9jb2xsaXNpb25fdHlwZSA9ICJ3b3JsZF9ib3VuZHMiCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMoewogICAgICAgICAgICAieCI6IHgsIAogICAgICAgICAgICAieiI6IHosIAogICAgICAgICAgICAiaGl0IjogaGl0IG9yIGJvdW5kYXJ5X2hpdCwKICAgICAgICAgICAgImZvcmVzdF9ib3VuZGFyeV9oaXQiOiBzZWxmLmhpdF9mb3Jlc3RfYm91bmRhcnksCiAgICAgICAgICAgICJjb2xsaWRlciI6IHNlbGYubGFzdF9jb2xsaXNpb25fbmFtZSwKICAgICAgICAgICAgInR5cGUiOiBzZWxmLmxhc3RfY29sbGlzaW9uX3R5cGUKICAgICAgICB9KQogICAgCiAgICBkZWYgZ2V0X2NvbGxpZGVyX2NvdW50KHNlbGYpOgogICAgICAgIHRvdGFsID0gbGVuKHNlbGYuYm94X2NvbGxpZGVycykgKyBsZW4oc2VsZi5jeWxpbmRlcl9jb2xsaWRlcnMpICsgbGVuKHNlbGYub3JpZW50ZWRfYm94X2NvbGxpZGVycykKICAgICAgICBpZiBzZWxmLmNhcl9jb2xsaWRlcjoKICAgICAgICAgICAgdG90YWwgKz0gMQogICAgICAgIHJldHVybiB0b3RhbAogICAgCiAgICBkZWYgZ2V0X3pvbmVfaW5mbyhzZWxmLCB4LCB6KToKICAgICAgICBkaXN0ID0gbWF0aC5zcXJ0KHgqeCArIHoqeikKICAgICAgICBpZiBzZWxmLmlzX2luX2x1bWJlcl9hcmVhKHgsIHopOgogICAgICAgICAgICByZXR1cm4gImx1bWJlcl9hcmVhIgogICAgICAgIGVsaWYgc2VsZi5pc19pbl9sdW1iZXJfcGF0aCh4LCB6KToKICAgICAgICAgICAgcmV0dXJuICJsdW1iZXJfcGF0aCIKICAgICAgICBlbGlmIHogPiBST0FEX1NUQVJUX1ogYW5kIGFicyh4KSA8IFJPQURfV0lEVEg6CiAgICAgICAgICAgIHJldHVybiAicm9hZCIKICAgICAgICBlbGlmIGRpc3QgPCBDTEVBUklOR19SQURJVVM6CiAgICAgICAgICAgIHJldHVybiAiY2xlYXJpbmciCiAgICAgICAgcmV0dXJuICJmb3Jlc3QiCiAgICAKICAgIGRlZiBnZXRfZGVidWdfaW5mbyhzZWxmLCB4LCB6KToKICAgICAgICByZXR1cm4ganNvbi5kdW1wcyh7CiAgICAgICAgICAgICJ6b25lIjogc2VsZi5nZXRfem9uZV9pbmZvKHgsIHopLAogICAgICAgICAgICAiYm94ZXMiOiBsZW4oc2VsZi5ib3hfY29sbGlkZXJzKSwKICAgICAgICAgICAgImN5bGluZGVycyI6IGxlbihzZWxmLmN5bGluZGVyX2NvbGxpZGVycyksCiAgICAgICAgICAgICJvcmllbnRlZF9ib3hlcyI6IGxlbihzZWxmLm9yaWVudGVkX2JveF9jb2xsaWRlcnMpLAogICAgICAgICAgICAiY2FyX2FjdGl2ZSI6IHNlbGYuY2FyX2NvbGxpZGVyIGlzIG5vdCBOb25lLAogICAgICAgICAgICAiZnVybml0dXJlIjogbGlzdChzZWxmLmZ1cm5pdHVyZV9yZWdpc3RyeS5rZXlzKCkpLAogICAgICAgICAgICAiY29sbGlzaW9ucyI6IHNlbGYuY29sbGlzaW9uX2NvdW50LAogICAgICAgICAgICAibGFzdF9oaXQiOiBzZWxmLmxhc3RfY29sbGlzaW9uX25hbWUsCiAgICAgICAgICAgICJsYXN0X3R5cGUiOiBzZWxmLmxhc3RfY29sbGlzaW9uX3R5cGUsCiAgICAgICAgICAgICJmb3Jlc3RfYm91bmRhcnkiOiBzZWxmLmhpdF9mb3Jlc3RfYm91bmRhcnksCiAgICAgICAgICAgICJncmlkX2NlbGxzIjogbGVuKHNlbGYuc3BhdGlhbF9ncmlkKQogICAgICAgIH0pCiAgICAKICAgIGRlZiBwcmludF9yZXBvcnQoc2VsZik6CiAgICAgICAgcHJpbnQoIlxuIiArICI9Iio2MCkKICAgICAgICBwcmludCgi8J+QjSBTTUFSVCBDT0xMSVNJT04gRU5HSU5FIHYzLjEgLSBSRVBPUlQiKQogICAgICAgIHByaW50KCI9Iio2MCkKICAgICAgICBwcmludChmIkJveCBDb2xsaWRlcnM6IHtsZW4oc2VsZi5ib3hfY29sbGlkZXJzKX0iKQogICAgICAgIHByaW50KGYiQ3lsaW5kZXIgQ29sbGlkZXJzOiB7bGVuKHNlbGYuY3lsaW5kZXJfY29sbGlkZXJzKX0iKQogICAgICAgIHByaW50KGYiT3JpZW50ZWQgQm94IENvbGxpZGVyczoge2xlbihzZWxmLm9yaWVudGVkX2JveF9jb2xsaWRlcnMpfSIpCiAgICAgICAgcHJpbnQoZiJDYXIgQ29sbGlkZXI6IHsnQWN0aXZlJyBpZiBzZWxmLmNhcl9jb2xsaWRlciBlbHNlICdOb25lJ30iKQogICAgICAgIHByaW50KGYiVG90YWw6IHtzZWxmLmdldF9jb2xsaWRlcl9jb3VudCgpfSIpCiAgICAgICAgcHJpbnQoZiJTcGF0aWFsIEdyaWQgQ2VsbHM6IHtsZW4oc2VsZi5zcGF0aWFsX2dyaWQpfSIpCiAgICAgICAgcHJpbnQoIj0iKjYwKQoKCmNsYXNzIFNtYXJ0UGF0aGZpbmRlcjoKICAgICIiIkFkdmFuY2VkIEEqIFBhdGhmaW5kaW5nIHdpdGggY29sbGlzaW9uIGF2b2lkYW5jZSIiIgogICAgCiAgICBkZWYgX19pbml0X18oc2VsZiwgY29sbGlzaW9uX2VuZ2luZSk6CiAgICAgICAgc2VsZi5lbmdpbmUgPSBjb2xsaXNpb25fZW5naW5lCiAgICAgICAgc2VsZi5ncmlkX3Jlc29sdXRpb24gPSA0MCAgIyBTaXplIG9mIGVhY2ggcGF0aGZpbmRpbmcgZ3JpZCBjZWxsCiAgICAgICAgc2VsZi5ucGNfcmFkaXVzID0gMjAgICMgTlBDIGNvbGxpc2lvbiByYWRpdXMKICAgICAgICBzZWxmLm1heF9pdGVyYXRpb25zID0gMjAwMCAgIyBQcmV2ZW50IGluZmluaXRlIGxvb3BzCiAgICAgICAgcHJpbnQoIltQeXRob24gUGF0aGZpbmRlcl0gSW5pdGlhbGl6ZWQgd2l0aCBBKiBhbGdvcml0aG0iKQogICAgCiAgICBkZWYgX2lzX3dhbGthYmxlKHNlbGYsIHgsIHopOgogICAgICAgICIiIkNoZWNrIGlmIGEgcG9zaXRpb24gaXMgd2Fsa2FibGUgKG5vIGNvbGxpc2lvbikiIiIKICAgICAgICAjIENoZWNrIGFnYWluc3QgYWxsIGNvbGxpZGVycyB3aXRoIE5QQyByYWRpdXMKICAgICAgICBwciA9IHNlbGYubnBjX3JhZGl1cwogICAgICAgIAogICAgICAgICMgQ2hlY2sgYm94IGNvbGxpZGVycwogICAgICAgIGZvciBib3ggaW4gc2VsZi5lbmdpbmUuYm94X2NvbGxpZGVyczoKICAgICAgICAgICAgaWYgKHggPiBib3hbIm1pblgiXSAtIHByIGFuZCB4IDwgYm94WyJtYXhYIl0gKyBwciBhbmQKICAgICAgICAgICAgICAgIHogPiBib3hbIm1pbloiXSAtIHByIGFuZCB6IDwgYm94WyJtYXhaIl0gKyBwcik6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIENoZWNrIGN5bGluZGVyIGNvbGxpZGVycwogICAgICAgIGZvciBjeWwgaW4gc2VsZi5lbmdpbmUuY3lsaW5kZXJfY29sbGlkZXJzOgogICAgICAgICAgICBkeCA9IHggLSBjeWxbIngiXQogICAgICAgICAgICBkeiA9IHogLSBjeWxbInoiXQogICAgICAgICAgICBkaXN0ID0gbWF0aC5zcXJ0KGR4KmR4ICsgZHoqZHopCiAgICAgICAgICAgIGlmIGRpc3QgPCBjeWxbInJhZGl1cyJdICsgcHI6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIENoZWNrIG9yaWVudGVkIGJveCBjb2xsaWRlcnMKICAgICAgICBmb3Igb2JiIGluIHNlbGYuZW5naW5lLm9yaWVudGVkX2JveF9jb2xsaWRlcnM6CiAgICAgICAgICAgIGR4ID0geCAtIG9iYlsiY3giXQogICAgICAgICAgICBkeiA9IHogLSBvYmJbImN6Il0KICAgICAgICAgICAgY29zX3IgPSBvYmJbImNvc19yIl0KICAgICAgICAgICAgc2luX3IgPSBvYmJbInNpbl9yIl0KICAgICAgICAgICAgbG9jYWxfeCA9IGR4ICogY29zX3IgKyBkeiAqIHNpbl9yCiAgICAgICAgICAgIGxvY2FsX3ogPSAtZHggKiBzaW5fciArIGR6ICogY29zX3IKICAgICAgICAgICAgaHcgPSBvYmJbImh3Il0gKyBwcgogICAgICAgICAgICBoZCA9IG9iYlsiaGQiXSArIHByCiAgICAgICAgICAgIGlmIGFicyhsb2NhbF94KSA8IGh3IGFuZCBhYnMobG9jYWxfeikgPCBoZDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgQ2hlY2sgY2FyIGNvbGxpZGVyCiAgICAgICAgaWYgc2VsZi5lbmdpbmUuY2FyX2NvbGxpZGVyOgogICAgICAgICAgICBvYmIgPSBzZWxmLmVuZ2luZS5jYXJfY29sbGlkZXIKICAgICAgICAgICAgZHggPSB4IC0gb2JiWyJjeCJdCiAgICAgICAgICAgIGR6ID0geiAtIG9iYlsiY3oiXQogICAgICAgICAgICBjb3NfciA9IG9iYlsiY29zX3IiXQogICAgICAgICAgICBzaW5fciA9IG9iYlsic2luX3IiXQogICAgICAgICAgICBsb2NhbF94ID0gZHggKiBjb3NfciArIGR6ICogc2luX3IKICAgICAgICAgICAgbG9jYWxfeiA9IC1keCAqIHNpbl9yICsgZHogKiBjb3NfcgogICAgICAgICAgICBodyA9IG9iYlsiaHciXSArIHByCiAgICAgICAgICAgIGhkID0gb2JiWyJoZCJdICsgcHIKICAgICAgICAgICAgaWYgYWJzKGxvY2FsX3gpIDwgaHcgYW5kIGFicyhsb2NhbF96KSA8IGhkOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgZGVmIF9oZXVyaXN0aWMoc2VsZiwgeDEsIHoxLCB4MiwgejIpOgogICAgICAgICIiIk1hbmhhdHRhbiBkaXN0YW5jZSBoZXVyaXN0aWMgZm9yIEEqIiIiCiAgICAgICAgcmV0dXJuIGFicyh4MiAtIHgxKSArIGFicyh6MiAtIHoxKQogICAgCiAgICBkZWYgX2dldF9uZWlnaGJvcnMoc2VsZiwgeCwgeik6CiAgICAgICAgIiIiR2V0IHdhbGthYmxlIG5laWdoYm9ycyAoOCBkaXJlY3Rpb25zKSIiIgogICAgICAgIG5laWdoYm9ycyA9IFtdCiAgICAgICAgZGlyZWN0aW9ucyA9IFsKICAgICAgICAgICAgKHNlbGYuZ3JpZF9yZXNvbHV0aW9uLCAwKSwKICAgICAgICAgICAgKC1zZWxmLmdyaWRfcmVzb2x1dGlvbiwgMCksCiAgICAgICAgICAgICgwLCBzZWxmLmdyaWRfcmVzb2x1dGlvbiksCiAgICAgICAgICAgICgwLCAtc2VsZi5ncmlkX3Jlc29sdXRpb24pLAogICAgICAgICAgICAoc2VsZi5ncmlkX3Jlc29sdXRpb24sIHNlbGYuZ3JpZF9yZXNvbHV0aW9uKSwKICAgICAgICAgICAgKHNlbGYuZ3JpZF9yZXNvbHV0aW9uLCAtc2VsZi5ncmlkX3Jlc29sdXRpb24pLAogICAgICAgICAgICAoLXNlbGYuZ3JpZF9yZXNvbHV0aW9uLCBzZWxmLmdyaWRfcmVzb2x1dGlvbiksCiAgICAgICAgICAgICgtc2VsZi5ncmlkX3Jlc29sdXRpb24sIC1zZWxmLmdyaWRfcmVzb2x1dGlvbikKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgZm9yIGR4LCBkeiBpbiBkaXJlY3Rpb25zOgogICAgICAgICAgICBueCwgbnogPSB4ICsgZHgsIHogKyBkegogICAgICAgICAgICBpZiBzZWxmLl9pc193YWxrYWJsZShueCwgbnopOgogICAgICAgICAgICAgICAgIyBEaWFnb25hbCBtb3ZlcyBjb3N0IG1vcmUKICAgICAgICAgICAgICAgIGNvc3QgPSAxLjQxNCBpZiBkeCAhPSAwIGFuZCBkeiAhPSAwIGVsc2UgMS4wCiAgICAgICAgICAgICAgICBuZWlnaGJvcnMuYXBwZW5kKChueCwgbnosIGNvc3QpKQogICAgICAgIAogICAgICAgIHJldHVybiBuZWlnaGJvcnMKICAgIAogICAgZGVmIGZpbmRfcGF0aChzZWxmLCBzdGFydF94LCBzdGFydF96LCBlbmRfeCwgZW5kX3opOgogICAgICAgICIiIkZpbmQgcGF0aCB1c2luZyBBKiBhbGdvcml0aG0iIiIKICAgICAgICBpbXBvcnQgaGVhcHEKICAgICAgICAKICAgICAgICAjIFNuYXAgdG8gZ3JpZAogICAgICAgIHN0YXJ0X3ggPSByb3VuZChzdGFydF94IC8gc2VsZi5ncmlkX3Jlc29sdXRpb24pICogc2VsZi5ncmlkX3Jlc29sdXRpb24KICAgICAgICBzdGFydF96ID0gcm91bmQoc3RhcnRfeiAvIHNlbGYuZ3JpZF9yZXNvbHV0aW9uKSAqIHNlbGYuZ3JpZF9yZXNvbHV0aW9uCiAgICAgICAgZW5kX3ggPSByb3VuZChlbmRfeCAvIHNlbGYuZ3JpZF9yZXNvbHV0aW9uKSAqIHNlbGYuZ3JpZF9yZXNvbHV0aW9uCiAgICAgICAgZW5kX3ogPSByb3VuZChlbmRfeiAvIHNlbGYuZ3JpZF9yZXNvbHV0aW9uKSAqIHNlbGYuZ3JpZF9yZXNvbHV0aW9uCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBpZiBzdGFydCBhbmQgZW5kIGFyZSB2YWxpZAogICAgICAgIGlmIG5vdCBzZWxmLl9pc193YWxrYWJsZShzdGFydF94LCBzdGFydF96KToKICAgICAgICAgICAgIyBGaW5kIG5lYXJlc3Qgd2Fsa2FibGUgcG9zaXRpb24gdG8gc3RhcnQKICAgICAgICAgICAgZm9yIHIgaW4gcmFuZ2UoMSwgNik6CiAgICAgICAgICAgICAgICBmb3IgZHggaW4gcmFuZ2UoLXIsIHIrMSk6CiAgICAgICAgICAgICAgICAgICAgZm9yIGR6IGluIHJhbmdlKC1yLCByKzEpOgogICAgICAgICAgICAgICAgICAgICAgICB0ZXN0X3ggPSBzdGFydF94ICsgZHggKiBzZWxmLmdyaWRfcmVzb2x1dGlvbgogICAgICAgICAgICAgICAgICAgICAgICB0ZXN0X3ogPSBzdGFydF96ICsgZHogKiBzZWxmLmdyaWRfcmVzb2x1dGlvbgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9pc193YWxrYWJsZSh0ZXN0X3gsIHRlc3Rfeik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydF94LCBzdGFydF96ID0gdGVzdF94LCB0ZXN0X3oKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICBpZiBub3Qgc2VsZi5faXNfd2Fsa2FibGUoZW5kX3gsIGVuZF96KToKICAgICAgICAgICAgIyBGaW5kIG5lYXJlc3Qgd2Fsa2FibGUgcG9zaXRpb24gdG8gZW5kCiAgICAgICAgICAgIGZvciByIGluIHJhbmdlKDEsIDYpOgogICAgICAgICAgICAgICAgZm9yIGR4IGluIHJhbmdlKC1yLCByKzEpOgogICAgICAgICAgICAgICAgICAgIGZvciBkeiBpbiByYW5nZSgtciwgcisxKToKICAgICAgICAgICAgICAgICAgICAgICAgdGVzdF94ID0gZW5kX3ggKyBkeCAqIHNlbGYuZ3JpZF9yZXNvbHV0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RfeiA9IGVuZF96ICsgZHogKiBzZWxmLmdyaWRfcmVzb2x1dGlvbgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9pc193YWxrYWJsZSh0ZXN0X3gsIHRlc3Rfeik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRfeCwgZW5kX3ogPSB0ZXN0X3gsIHRlc3RfegogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgICMgQSogYWxnb3JpdGhtCiAgICAgICAgb3Blbl9zZXQgPSBbXQogICAgICAgIGhlYXBxLmhlYXBwdXNoKG9wZW5fc2V0LCAoMCwgc3RhcnRfeCwgc3RhcnRfeikpCiAgICAgICAgCiAgICAgICAgY2FtZV9mcm9tID0ge30KICAgICAgICBnX3Njb3JlID0geyhzdGFydF94LCBzdGFydF96KTogMH0KICAgICAgICBmX3Njb3JlID0geyhzdGFydF94LCBzdGFydF96KTogc2VsZi5faGV1cmlzdGljKHN0YXJ0X3gsIHN0YXJ0X3osIGVuZF94LCBlbmRfeil9CiAgICAgICAgCiAgICAgICAgb3Blbl9zZXRfaGFzaCA9IHsoc3RhcnRfeCwgc3RhcnRfeil9CiAgICAgICAgaXRlcmF0aW9ucyA9IDAKICAgICAgICAKICAgICAgICB3aGlsZSBvcGVuX3NldCBhbmQgaXRlcmF0aW9ucyA8IHNlbGYubWF4X2l0ZXJhdGlvbnM6CiAgICAgICAgICAgIGl0ZXJhdGlvbnMgKz0gMQogICAgICAgICAgICBjdXJyZW50ID0gaGVhcHEuaGVhcHBvcChvcGVuX3NldCkKICAgICAgICAgICAgY3VycmVudF94LCBjdXJyZW50X3ogPSBjdXJyZW50WzFdLCBjdXJyZW50WzJdCiAgICAgICAgICAgIGN1cnJlbnRfa2V5ID0gKGN1cnJlbnRfeCwgY3VycmVudF96KQogICAgICAgICAgICBvcGVuX3NldF9oYXNoLmRpc2NhcmQoY3VycmVudF9rZXkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENoZWNrIGlmIHdlIHJlYWNoZWQgdGhlIGdvYWwKICAgICAgICAgICAgaWYgYWJzKGN1cnJlbnRfeCAtIGVuZF94KSA8IHNlbGYuZ3JpZF9yZXNvbHV0aW9uIGFuZCBhYnMoY3VycmVudF96IC0gZW5kX3opIDwgc2VsZi5ncmlkX3Jlc29sdXRpb246CiAgICAgICAgICAgICAgICAjIFJlY29uc3RydWN0IHBhdGgKICAgICAgICAgICAgICAgIHBhdGggPSBbXQogICAgICAgICAgICAgICAgd2hpbGUgY3VycmVudF9rZXkgaW4gY2FtZV9mcm9tOgogICAgICAgICAgICAgICAgICAgIHBhdGguYXBwZW5kKHsieCI6IGN1cnJlbnRfa2V5WzBdLCAieiI6IGN1cnJlbnRfa2V5WzFdfSkKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2tleSA9IGNhbWVfZnJvbVtjdXJyZW50X2tleV0KICAgICAgICAgICAgICAgIHBhdGguYXBwZW5kKHsieCI6IHN0YXJ0X3gsICJ6Ijogc3RhcnRfen0pCiAgICAgICAgICAgICAgICBwYXRoLnJldmVyc2UoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNtb290aCBwYXRoIC0gcmVtb3ZlIHVubmVjZXNzYXJ5IHdheXBvaW50cwogICAgICAgICAgICAgICAgc21vb3RoZWRfcGF0aCA9IHNlbGYuX3Ntb290aF9wYXRoKHBhdGgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHByaW50KGYiW1BhdGhmaW5kZXJdIEZvdW5kIHBhdGggd2l0aCB7bGVuKHNtb290aGVkX3BhdGgpfSB3YXlwb2ludHMgaW4ge2l0ZXJhdGlvbnN9IGl0ZXJhdGlvbnMiKQogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMoeyJzdWNjZXNzIjogVHJ1ZSwgInBhdGgiOiBzbW9vdGhlZF9wYXRofSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRXhwbG9yZSBuZWlnaGJvcnMKICAgICAgICAgICAgZm9yIG54LCBueiwgY29zdCBpbiBzZWxmLl9nZXRfbmVpZ2hib3JzKGN1cnJlbnRfeCwgY3VycmVudF96KToKICAgICAgICAgICAgICAgIG5laWdoYm9yX2tleSA9IChueCwgbnopCiAgICAgICAgICAgICAgICB0ZW50YXRpdmVfZyA9IGdfc2NvcmUuZ2V0KGN1cnJlbnRfa2V5LCBmbG9hdCgnaW5mJykpICsgY29zdCAqIHNlbGYuZ3JpZF9yZXNvbHV0aW9uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHRlbnRhdGl2ZV9nIDwgZ19zY29yZS5nZXQobmVpZ2hib3Jfa2V5LCBmbG9hdCgnaW5mJykpOgogICAgICAgICAgICAgICAgICAgIGNhbWVfZnJvbVtuZWlnaGJvcl9rZXldID0gY3VycmVudF9rZXkKICAgICAgICAgICAgICAgICAgICBnX3Njb3JlW25laWdoYm9yX2tleV0gPSB0ZW50YXRpdmVfZwogICAgICAgICAgICAgICAgICAgIGYgPSB0ZW50YXRpdmVfZyArIHNlbGYuX2hldXJpc3RpYyhueCwgbnosIGVuZF94LCBlbmRfeikKICAgICAgICAgICAgICAgICAgICBmX3Njb3JlW25laWdoYm9yX2tleV0gPSBmCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgbmVpZ2hib3Jfa2V5IG5vdCBpbiBvcGVuX3NldF9oYXNoOgogICAgICAgICAgICAgICAgICAgICAgICBoZWFwcS5oZWFwcHVzaChvcGVuX3NldCwgKGYsIG54LCBueikpCiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5fc2V0X2hhc2guYWRkKG5laWdoYm9yX2tleSkKICAgICAgICAKICAgICAgICAjIE5vIHBhdGggZm91bmQgLSByZXR1cm4gZGlyZWN0IHBhdGgKICAgICAgICBwcmludChmIltQYXRoZmluZGVyXSBObyBwYXRoIGZvdW5kIGFmdGVyIHtpdGVyYXRpb25zfSBpdGVyYXRpb25zLCB1c2luZyBkaXJlY3QgcGF0aCIpCiAgICAgICAgcmV0dXJuIGpzb24uZHVtcHMoewogICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLCAKICAgICAgICAgICAgInBhdGgiOiBbCiAgICAgICAgICAgICAgICB7IngiOiBzdGFydF94LCAieiI6IHN0YXJ0X3p9LAogICAgICAgICAgICAgICAgeyJ4IjogZW5kX3gsICJ6IjogZW5kX3p9CiAgICAgICAgICAgIF0KICAgICAgICB9KQogICAgCiAgICBkZWYgX3Ntb290aF9wYXRoKHNlbGYsIHBhdGgpOgogICAgICAgICIiIlJlbW92ZSB1bm5lY2Vzc2FyeSB3YXlwb2ludHMgZm9yIHNtb290aGVyIG1vdmVtZW50IiIiCiAgICAgICAgaWYgbGVuKHBhdGgpIDw9IDI6CiAgICAgICAgICAgIHJldHVybiBwYXRoCiAgICAgICAgCiAgICAgICAgc21vb3RoZWQgPSBbcGF0aFswXV0KICAgICAgICBpID0gMAogICAgICAgIAogICAgICAgIHdoaWxlIGkgPCBsZW4ocGF0aCkgLSAxOgogICAgICAgICAgICAjIFRyeSB0byBza2lwIGFzIG1hbnkgcG9pbnRzIGFzIHBvc3NpYmxlIHdoaWxlIG1haW50YWluaW5nIGxpbmUgb2Ygc2lnaHQKICAgICAgICAgICAgZnVydGhlc3QgPSBpICsgMQogICAgICAgICAgICBmb3IgaiBpbiByYW5nZShpICsgMiwgbGVuKHBhdGgpKToKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2xpbmVfb2Zfc2lnaHQocGF0aFtpXVsieCJdLCBwYXRoW2ldWyJ6Il0sIHBhdGhbal1bIngiXSwgcGF0aFtqXVsieiJdKToKICAgICAgICAgICAgICAgICAgICBmdXJ0aGVzdCA9IGoKICAgICAgICAgICAgCiAgICAgICAgICAgIHNtb290aGVkLmFwcGVuZChwYXRoW2Z1cnRoZXN0XSkKICAgICAgICAgICAgaSA9IGZ1cnRoZXN0CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNtb290aGVkCiAgICAKICAgIGRlZiBfbGluZV9vZl9zaWdodChzZWxmLCB4MSwgejEsIHgyLCB6Mik6CiAgICAgICAgIiIiQ2hlY2sgaWYgdGhlcmUncyBhIGNsZWFyIGxpbmUgb2Ygc2lnaHQgYmV0d2VlbiB0d28gcG9pbnRzIiIiCiAgICAgICAgZHggPSB4MiAtIHgxCiAgICAgICAgZHogPSB6MiAtIHoxCiAgICAgICAgZGlzdCA9IG1hdGguc3FydChkeCpkeCArIGR6KmR6KQogICAgICAgIAogICAgICAgIGlmIGRpc3QgPCAxOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgICAgIHN0ZXBzID0gaW50KGRpc3QgLyAoc2VsZi5ncmlkX3Jlc29sdXRpb24gLyAyKSkKICAgICAgICBpZiBzdGVwcyA8IDE6CiAgICAgICAgICAgIHN0ZXBzID0gMQogICAgICAgIAogICAgICAgIGZvciBpIGluIHJhbmdlKDEsIHN0ZXBzICsgMSk6CiAgICAgICAgICAgIHQgPSBpIC8gc3RlcHMKICAgICAgICAgICAgeCA9IHgxICsgZHggKiB0CiAgICAgICAgICAgIHogPSB6MSArIGR6ICogdAogICAgICAgICAgICBpZiBub3Qgc2VsZi5faXNfd2Fsa2FibGUoeCwgeik6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgZ2V0X25leHRfbW92ZShzZWxmLCBjdXJyZW50X3gsIGN1cnJlbnRfeiwgdGFyZ2V0X3gsIHRhcmdldF96KToKICAgICAgICAiIiJHZXQgdGhlIG5leHQgcG9zaXRpb24gdG8gbW92ZSB0bywgYXZvaWRpbmcgb2JzdGFjbGVzIiIiCiAgICAgICAgZHggPSB0YXJnZXRfeCAtIGN1cnJlbnRfeAogICAgICAgIGR6ID0gdGFyZ2V0X3ogLSBjdXJyZW50X3oKICAgICAgICBkaXN0ID0gbWF0aC5zcXJ0KGR4KmR4ICsgZHoqZHopCiAgICAgICAgCiAgICAgICAgaWYgZGlzdCA8IDE6CiAgICAgICAgICAgIHJldHVybiBqc29uLmR1bXBzKHsieCI6IHRhcmdldF94LCAieiI6IHRhcmdldF96LCAiYXJyaXZlZCI6IFRydWV9KQogICAgICAgIAogICAgICAgICMgTm9ybWFsaXplIGRpcmVjdGlvbgogICAgICAgIG54ID0gZHggLyBkaXN0CiAgICAgICAgbnogPSBkeiAvIGRpc3QKICAgICAgICAKICAgICAgICAjIFRyeSBkaXJlY3QgbW92ZW1lbnQgZmlyc3QKICAgICAgICBzdGVwID0gbWluKGRpc3QsIHNlbGYuZ3JpZF9yZXNvbHV0aW9uKQogICAgICAgIG5ld194ID0gY3VycmVudF94ICsgbnggKiBzdGVwCiAgICAgICAgbmV3X3ogPSBjdXJyZW50X3ogKyBueiAqIHN0ZXAKICAgICAgICAKICAgICAgICBpZiBzZWxmLl9pc193YWxrYWJsZShuZXdfeCwgbmV3X3opOgogICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyh7IngiOiBuZXdfeCwgInoiOiBuZXdfeiwgImFycml2ZWQiOiBGYWxzZX0pCiAgICAgICAgCiAgICAgICAgIyBUcnkgYW5nbGVkIG1vdmVtZW50cyAoc3RlZXJpbmcgYXJvdW5kIG9ic3RhY2xlKQogICAgICAgIGZvciBhbmdsZV9vZmZzZXQgaW4gWzAuMywgLTAuMywgMC42LCAtMC42LCAwLjksIC0wLjksIDEuMiwgLTEuMl06CiAgICAgICAgICAgIGNvc19hID0gbWF0aC5jb3MoYW5nbGVfb2Zmc2V0KQogICAgICAgICAgICBzaW5fYSA9IG1hdGguc2luKGFuZ2xlX29mZnNldCkKICAgICAgICAgICAgcm90YXRlZF94ID0gbnggKiBjb3NfYSAtIG56ICogc2luX2EKICAgICAgICAgICAgcm90YXRlZF96ID0gbnggKiBzaW5fYSArIG56ICogY29zX2EKICAgICAgICAgICAgCiAgICAgICAgICAgIG5ld194ID0gY3VycmVudF94ICsgcm90YXRlZF94ICogc3RlcAogICAgICAgICAgICBuZXdfeiA9IGN1cnJlbnRfeiArIHJvdGF0ZWRfeiAqIHN0ZXAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2lzX3dhbGthYmxlKG5ld194LCBuZXdfeik6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5kdW1wcyh7IngiOiBuZXdfeCwgInoiOiBuZXdfeiwgImFycml2ZWQiOiBGYWxzZX0pCiAgICAgICAgCiAgICAgICAgIyBJZiBhbGwgZWxzZSBmYWlscywgc3RheSBpbiBwbGFjZQogICAgICAgIHJldHVybiBqc29uLmR1bXBzKHsieCI6IGN1cnJlbnRfeCwgInoiOiBjdXJyZW50X3osICJhcnJpdmVkIjogRmFsc2UsICJzdHVjayI6IFRydWV9KQoKCmNsYXNzIFRyZWVHZW5lcmF0b3I6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5lbmdpbmUgPSBOb25lCiAgICAKICAgIGRlZiBzZXRfZW5naW5lKHNlbGYsIGUpOgogICAgICAgIHNlbGYuZW5naW5lID0gZQogICAgCiAgICBkZWYgZ2VuZXJhdGVfdHJlZXNfanNvbihzZWxmLCBiYXNlX3NjYWxlLCB5X29mZnNldCk6CiAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgIHJhbmRvbS5zZWVkKDQyKQogICAgICAgIAogICAgICAgIGluc3RzID0gW10KICAgICAgICBkeCA9IG1hdGguY29zKExVTUJFUl9QQVRIX0FOR0xFKQogICAgICAgIGR6ID0gbWF0aC5zaW4oTFVNQkVSX1BBVEhfQU5HTEUpCiAgICAgICAgcHgsIHB6ID0gLWR6LCBkeAogICAgICAgIAogICAgICAgIGZvciBpIGluIHJhbmdlKDgwKToKICAgICAgICAgICAgYSA9IChpLzgwKSptYXRoLnBpKjIgKyAocmFuZG9tLnJhbmRvbSgpLTAuNSkqMC4xNQogICAgICAgICAgICByID0gQ0xFQVJJTkdfUkFESVVTICsgMjAgKyByYW5kb20ucmFuZG9tKCkqODAKICAgICAgICAgICAgeCwgeiA9IG1hdGguY29zKGEpKnIsIG1hdGguc2luKGEpKnIKICAgICAgICAgICAgaWYgeiA+IFJPQURfU1RBUlRfWi0xMDAgYW5kIGFicyh4KSA8IFJPQURfV0lEVEgrMTAwOiBjb250aW51ZQogICAgICAgICAgICBpZiBzZWxmLmVuZ2luZSBhbmQgc2VsZi5lbmdpbmUuaXNfaW5fbHVtYmVyX3BhdGgoeCx6KTogY29udGludWUKICAgICAgICAgICAgaWYgc2VsZi5lbmdpbmUgYW5kIHNlbGYuZW5naW5lLmlzX2luX2x1bWJlcl9hcmVhKHgseik6IGNvbnRpbnVlCiAgICAgICAgICAgIHMgPSBiYXNlX3NjYWxlKigwLjgrcmFuZG9tLnJhbmRvbSgpKjAuNCkKICAgICAgICAgICAgaW5zdHMuYXBwZW5kKHsieCI6eCwieSI6eV9vZmZzZXQqcywieiI6eiwicm90WSI6cmFuZG9tLnJhbmRvbSgpKm1hdGgucGkqMiwicyI6c30pCiAgICAgICAgCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoNjApOgogICAgICAgICAgICBhID0gKGkvNjApKm1hdGgucGkqMiArIChyYW5kb20ucmFuZG9tKCktMC41KSowLjIKICAgICAgICAgICAgciA9IENMRUFSSU5HX1JBRElVUyArIDEwMCArIHJhbmRvbS5yYW5kb20oKSoxNTAKICAgICAgICAgICAgeCwgeiA9IG1hdGguY29zKGEpKnIsIG1hdGguc2luKGEpKnIKICAgICAgICAgICAgaWYgeiA+IFJPQURfU1RBUlRfWi0xMDAgYW5kIGFicyh4KSA8IFJPQURfV0lEVEgrMTUwOiBjb250aW51ZQogICAgICAgICAgICBpZiBzZWxmLmVuZ2luZSBhbmQgc2VsZi5lbmdpbmUuaXNfaW5fbHVtYmVyX3BhdGgoeCx6KTogY29udGludWUKICAgICAgICAgICAgcyA9IGJhc2Vfc2NhbGUqKDAuNytyYW5kb20ucmFuZG9tKCkqMC41KQogICAgICAgICAgICBpbnN0cy5hcHBlbmQoeyJ4Ijp4LCJ5Ijp5X29mZnNldCpzLCJ6Ijp6LCJyb3RZIjpyYW5kb20ucmFuZG9tKCkqbWF0aC5waSoyLCJzIjpzfSkKICAgICAgICAKICAgICAgICBmb3IgaSBpbiByYW5nZSg1MCk6CiAgICAgICAgICAgIGEgPSAoaS81MCkqbWF0aC5waSoyICsgKHJhbmRvbS5yYW5kb20oKS0wLjUpKjAuMjUKICAgICAgICAgICAgciA9IENMRUFSSU5HX1JBRElVUyArIDI1MCArIHJhbmRvbS5yYW5kb20oKSoyMDAKICAgICAgICAgICAgeCwgeiA9IG1hdGguY29zKGEpKnIsIG1hdGguc2luKGEpKnIKICAgICAgICAgICAgaWYgeiA+IFJPQURfU1RBUlRfWi01MCBhbmQgYWJzKHgpIDwgUk9BRF9XSURUSCsyMDA6IGNvbnRpbnVlCiAgICAgICAgICAgIGlmIHNlbGYuZW5naW5lIGFuZCBzZWxmLmVuZ2luZS5pc19pbl9sdW1iZXJfcGF0aCh4LHopOiBjb250aW51ZQogICAgICAgICAgICBzID0gYmFzZV9zY2FsZSooMC42K3JhbmRvbS5yYW5kb20oKSowLjYpCiAgICAgICAgICAgIGluc3RzLmFwcGVuZCh7IngiOngsInkiOnlfb2Zmc2V0KnMsInoiOnosInJvdFkiOnJhbmRvbS5yYW5kb20oKSptYXRoLnBpKjIsInMiOnN9KQogICAgICAgIAogICAgICAgIGQgPSBDTEVBUklOR19SQURJVVMgKyAxMDAKICAgICAgICB3aGlsZSBkIDwgQ0xFQVJJTkdfUkFESVVTICsgTFVNQkVSX1BBVEhfTEVOR1RIIC0gTFVNQkVSX0FSRUFfUkFESVVTOgogICAgICAgICAgICBjeCwgY3ogPSBkeCpkLCBkeipkCiAgICAgICAgICAgIG9mZiA9IExVTUJFUl9QQVRIX1dJRFRIICsgMzAKICAgICAgICAgICAgZm9yIHNpZGUgaW4gWzEsLTFdOgogICAgICAgICAgICAgICAgcyA9IGJhc2Vfc2NhbGUqKDAuNytyYW5kb20ucmFuZG9tKCkqMC40KQogICAgICAgICAgICAgICAgaW5zdHMuYXBwZW5kKHsieCI6Y3grcHgqb2ZmKnNpZGUsInkiOnlfb2Zmc2V0KnMsInoiOmN6K3B6Km9mZipzaWRlLCJyb3RZIjpyYW5kb20ucmFuZG9tKCkqbWF0aC5waSoyLCJzIjpzfSkKICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA+IDAuNDoKICAgICAgICAgICAgICAgICAgICBzID0gYmFzZV9zY2FsZSooMC42K3JhbmRvbS5yYW5kb20oKSowLjQpCiAgICAgICAgICAgICAgICAgICAgaW5zdHMuYXBwZW5kKHsieCI6Y3grcHgqKG9mZis4MCkqc2lkZSwieSI6eV9vZmZzZXQqcywieiI6Y3orcHoqKG9mZis4MCkqc2lkZSwicm90WSI6cmFuZG9tLnJhbmRvbSgpKm1hdGgucGkqMiwicyI6c30pCiAgICAgICAgICAgIGQgKz0gMTIwCiAgICAgICAgCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMjUpOgogICAgICAgICAgICBhID0gcmFuZG9tLnJhbmRvbSgpKm1hdGgucGkqMgogICAgICAgICAgICBlYSA9IExVTUJFUl9QQVRIX0FOR0xFICsgbWF0aC5waQogICAgICAgICAgICBpZiBhYnMoKChhLWVhK21hdGgucGkqMyklKG1hdGgucGkqMikpLW1hdGgucGkpIDwgMC40OiBjb250aW51ZQogICAgICAgICAgICByID0gTFVNQkVSX0FSRUFfUkFESVVTICsgMzAgKyByYW5kb20ucmFuZG9tKCkqMTAwCiAgICAgICAgICAgIHggPSBMVU1CRVJfQVJFQV9DRU5URVJfWCArIG1hdGguY29zKGEpKnIKICAgICAgICAgICAgeiA9IExVTUJFUl9BUkVBX0NFTlRFUl9aICsgbWF0aC5zaW4oYSkqcgogICAgICAgICAgICBzID0gYmFzZV9zY2FsZSooMC43K3JhbmRvbS5yYW5kb20oKSowLjUpCiAgICAgICAgICAgIGluc3RzLmFwcGVuZCh7IngiOngsInkiOnlfb2Zmc2V0KnMsInoiOnosInJvdFkiOnJhbmRvbS5yYW5kb20oKSptYXRoLnBpKjIsInMiOnN9KQogICAgICAgIAogICAgICAgIENBUl9aID0gMjIwMAogICAgICAgIHJ6ID0gUk9BRF9TVEFSVF9aICsgMTAwCiAgICAgICAgd2hpbGUgcnogPCBDQVJfWiArIDYwMDoKICAgICAgICAgICAgZm9yIHNpZGUgaW4gWy0xLDFdOgogICAgICAgICAgICAgICAgcyA9IGJhc2Vfc2NhbGUqKDAuNytyYW5kb20ucmFuZG9tKCkqMC41KQogICAgICAgICAgICAgICAgaW5zdHMuYXBwZW5kKHsieCI6KFJPQURfV0lEVEgrNTApKnNpZGUsInkiOnlfb2Zmc2V0KnMsInoiOnJ6LCJyb3RZIjpyYW5kb20ucmFuZG9tKCkqbWF0aC5waSoyLCJzIjpzfSkKICAgICAgICAgICAgICAgIHMgPSBiYXNlX3NjYWxlKigwLjYrcmFuZG9tLnJhbmRvbSgpKjAuNSkKICAgICAgICAgICAgICAgIGluc3RzLmFwcGVuZCh7IngiOihST0FEX1dJRFRIKzE3MCkqc2lkZSwieSI6eV9vZmZzZXQqcywieiI6cnorNjAsInJvdFkiOnJhbmRvbS5yYW5kb20oKSptYXRoLnBpKjIsInMiOnN9KQogICAgICAgICAgICByeiArPSAxODAKICAgICAgICAKICAgICAgICBmb3IgaSBpbiByYW5nZSgxMDApOgogICAgICAgICAgICBhID0gcmFuZG9tLnJhbmRvbSgpKm1hdGgucGkqMgogICAgICAgICAgICByID0gQ0xFQVJJTkdfUkFESVVTICsgNDAwICsgcmFuZG9tLnJhbmRvbSgpKjgwMAogICAgICAgICAgICB4LCB6ID0gbWF0aC5jb3MoYSkqciwgbWF0aC5zaW4oYSkqcgogICAgICAgICAgICBpZiB6ID4gUk9BRF9TVEFSVF9aIGFuZCBhYnMoeCkgPCBST0FEX1dJRFRIKzM1MDogY29udGludWUKICAgICAgICAgICAgaWYgc2VsZi5lbmdpbmUgYW5kIHNlbGYuZW5naW5lLmlzX2luX2x1bWJlcl9wYXRoKHgseik6IGNvbnRpbnVlCiAgICAgICAgICAgIHMgPSBiYXNlX3NjYWxlKigwLjUrcmFuZG9tLnJhbmRvbSgpKjAuNykKICAgICAgICAgICAgaW5zdHMuYXBwZW5kKHsieCI6eCwieSI6eV9vZmZzZXQqcywieiI6eiwicm90WSI6cmFuZG9tLnJhbmRvbSgpKm1hdGgucGkqMiwicyI6c30pCiAgICAgICAgCiAgICAgICAgcHJpbnQoZiJbUHl0aG9uXSBHZW5lcmF0ZWQge2xlbihpbnN0cyl9IHRyZWVzICh2aXN1YWwgb25seSwgbm8gaW5kaXZpZHVhbCBjb2xsaXNpb24pIikKICAgICAgICByZXR1cm4ganNvbi5kdW1wcyhpbnN0cykKCgojIENyZWF0ZSBpbnN0YW5jZXMKY29sbGlzaW9uX2VuZ2luZSA9IFNtYXJ0Q29sbGlzaW9uRW5naW5lKCkKdHJlZV9nZW5lcmF0b3IgPSBUcmVlR2VuZXJhdG9yKCkKdHJlZV9nZW5lcmF0b3Iuc2V0X2VuZ2luZShjb2xsaXNpb25fZW5naW5lKQpwYXRoZmluZGVyID0gU21hcnRQYXRoZmluZGVyKGNvbGxpc2lvbl9lbmdpbmUpCgojIEV4cG9ydCB0byBKYXZhU2NyaXB0CmpzLndpbmRvdy5weUNvbGxpc2lvbkVuZ2luZSA9IGNyZWF0ZV9wcm94eShjb2xsaXNpb25fZW5naW5lKQpqcy53aW5kb3cucHlUcmVlR2VuZXJhdG9yID0gY3JlYXRlX3Byb3h5KHRyZWVfZ2VuZXJhdG9yKQpqcy53aW5kb3cucHlQYXRoZmluZGVyID0gY3JlYXRlX3Byb3h5KHBhdGhmaW5kZXIpCmpzLndpbmRvdy5weXRob25SZWFkeSA9IFRydWUKCnByaW50KCJbUHl0aG9uIFNtYXJ0IEVuZ2luZSB2My4xXSBSZWFkeSB3aXRoIEVuaGFuY2VkIEFjY3VyYWN5ICsgUGF0aGZpbmRpbmchIikKCnN0YXR1c19lbCA9IGpzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJweXRob24tc3RhdHVzIikKaWYgc3RhdHVzX2VsOgogICAgc3RhdHVzX2VsLmlubmVySFRNTCA9ICLwn5CNIFB5dGhvbjogU21hcnQgRW5naW5lIHYzLjEiCiAgICBzdGF0dXNfZWwuc3R5bGUuY29sb3IgPSAiIzAwZmYwMCIKICAgIHN0YXR1c19lbC5zdHlsZS5ib3JkZXJDb2xvciA9ICIjMDBmZjAwIgo8L3NjcmlwdD4KCjxzY3JpcHQgdHlwZT0ibW9kdWxlIj4KaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnOwppbXBvcnQgeyBQb2ludGVyTG9ja0NvbnRyb2xzIH0gZnJvbSAndGhyZWUvYWRkb25zL2NvbnRyb2xzL1BvaW50ZXJMb2NrQ29udHJvbHMuanMnOwppbXBvcnQgeyBHTFRGTG9hZGVyIH0gZnJvbSAndGhyZWUvYWRkb25zL2xvYWRlcnMvR0xURkxvYWRlci5qcyc7Cgpjb25zdCBQTEFZRVJfSEVJR0hUID0gMTYwOwpjb25zdCBQTEFZRVJfUkFESVVTID0gMzA7CmNvbnN0IFBMQVlFUl9TUEVFRCA9IDM1MDsKY29uc3QgUExBWUVSX0pVTVAgPSAzMjA7CmNvbnN0IEdSQVZJVFkgPSA2MDA7CmNvbnN0IFJFTkRFUl9TQ0FMRSA9IDEuNTsKY29uc3QgQ0hVTktfU0laRSA9IDUwMDsKY29uc3QgUkVOREVSX0RJU1RBTkNFID0gMzsKY29uc3QgVU5MT0FEX0RJU1RBTkNFID0gNDsKCi8vIENhciBkaW1lbnNpb25zIGZvciBjb2xsaXNpb24KY29uc3QgQ0FSX0xFTkdUSCA9IDI4MDsKY29uc3QgQ0FSX1dJRFRIID0gMTIwOwoKLy8gUGxheWVyIHNwYXduIHBvc2l0aW9uIGFmdGVyIGN1dHNjZW5lCmNvbnN0IFBMQVlFUl9TUEFXTl9YID0gMzMwOwpjb25zdCBQTEFZRVJfU1BBV05fWiA9IDMwMDsKCi8vIFdpZmUgc3Bhd24gcG9zaXRpb24gYWZ0ZXIgZXhpdGluZyBjYXIKY29uc3QgV0lGRV9TUEFXTl9YID0gNDEyOwpjb25zdCBXSUZFX1NQQVdOX1ogPSA1MzA7CgovLyBXaWZlIGNoYXJhY3RlciBzY2FsZSAoc2FtZSBmb3Igc2l0dGluZyBhbmQgd2Fsa2luZykKY29uc3QgV0lGRV9DSEFSQUNURVJfU0NBTEUgPSAzMDsKCi8vIE1lYXQgY2Fycnlpbmcgc3lzdGVtCmxldCBjYXJyeWluZ01lYXQgPSBmYWxzZTsKbGV0IGNhcnJpZWRNZWF0T2JqZWN0ID0gbnVsbDsKbGV0IGlzQ29va2luZyA9IGZhbHNlOwpsZXQgaXNDb29rZWQgPSBmYWxzZTsKCi8vIFNvZmEgcG9zaXRpb24gZm9yIHdpZmUgdG8gd2FsayB0bwovLyByb3RZOiAwIGRlZ3JlZXMgKDAgcmFkaWFucykgYW5kIHBvc2l0aW9uZWQgY2xvc2VyIHRvIHRoZSBiZWQKY29uc3QgU09GQV9QT1NJVElPTiA9IHsgeDogOTAsIHo6IC0xMzAsIHJvdFk6IDAgfTsKCmxldCBzY2VuZSwgY2FtZXJhLCByZW5kZXJlciwgY29udHJvbHM7CmxldCBwbGF5ZXJWZWxvY2l0eSA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CmxldCBpc0dyb3VuZGVkID0gZmFsc2U7CmxldCBtaXhlcnMgPSBbXTsKY29uc3QgYXVkaW9DdHggPSBuZXcgKHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCkoKTsKCmxldCBweUNvbGxpc2lvbkVuZ2luZSA9IG51bGw7CmxldCBweVRyZWVHZW5lcmF0b3IgPSBudWxsOwpsZXQgcHlQYXRoZmluZGVyID0gbnVsbDsKbGV0IGlzRGVidWdWaXNpYmxlID0gZmFsc2U7CgpsZXQgY3V0c2NlbmVBY3RpdmUgPSBmYWxzZTsKbGV0IGN1dHNjZW5lVGltZSA9IDA7CmxldCBjYXJPYmplY3QgPSBudWxsOwpsZXQgZ2lybE9iamVjdCA9IG51bGw7CmxldCBnaXJsU2l0dGluZ09iamVjdCA9IG51bGw7ICAvLyBXaWZlIHNpdHRpbmcgaW4gY2FyCmxldCBnaXJsV2Fsa2luZ09iamVjdCA9IG51bGw7ICAvLyBXaWZlIHdhbGtpbmcKbGV0IGdpcmxTb2ZhU2l0dGluZ09iamVjdCA9IG51bGw7ICAvLyBXaWZlIHNpdHRpbmcgb24gc29mYQoKLy8gV2lmZSBzdGF0ZSBtYWNoaW5lCmNvbnN0IFdJRkVfU1RBVEUgPSB7CiAgICBTSVRUSU5HX0NBUjogJ3NpdHRpbmdfY2FyJywKICAgIFdBTEtJTkc6ICd3YWxraW5nJywKICAgIFNJVFRJTkdfU09GQTogJ3NpdHRpbmdfc29mYScsCiAgICBDSEFTSU5HOiAnY2hhc2luZycKfTsKbGV0IHdpZmVTdGF0ZSA9IFdJRkVfU1RBVEUuU0lUVElOR19DQVI7CmxldCB3aWZlV2Fsa2luZ1RhcmdldCA9IG51bGw7CmxldCB3aWZlV2Fsa2luZ1NwZWVkID0gMTIwOwpsZXQgd2lmZVdhbGtpbmdNaXhlciA9IG51bGw7CmxldCB3aWZlUGF0aFdheXBvaW50cyA9IFtdOwpsZXQgd2lmZUN1cnJlbnRXYXlwb2ludEluZGV4ID0gMDsKCmNvbnN0IENBUl9TVEFSVF9aID0gMjIwMDsKY29uc3QgQ0FSX1RVUk5fWiA9IDcwMDsKY29uc3QgQ0FSX0VORF9aID0gNDUwOwpjb25zdCBDQVJfRU5EX1ggPSAzNTA7CgpsZXQgY2FuRXhpdENhciA9IGZhbHNlOwpsZXQgZXhpdENhckJ1dHRvbkhpZGRlbiA9IGZhbHNlOwpsZXQgY3V0c2NlbmVDYW1lcmFZYXcgPSAwOwpsZXQgY3V0c2NlbmVDYW1lcmFQaXRjaCA9IDA7Cgpjb25zdCBkcml2ZXJTZWF0T2Zmc2V0ID0gbmV3IFRIUkVFLlZlY3RvcjMoLTEyLCA1MCwgLTQwKTsKY29uc3QgZ2lybFNlYXRPZmZzZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygtMTIsIC01MCwgNDApOwoKbGV0IHNtb290aENhbVggPSAwLCBzbW9vdGhDYW1ZID0gMCwgc21vb3RoQ2FtWiA9IDA7Cgpjb25zdCBDTEVBUklOR19SQURJVVMgPSA3NTA7CmNvbnN0IFJPQURfV0lEVEggPSAxODA7CmNvbnN0IFJPQURfU1RBUlRfWiA9IDcwMDsKY29uc3QgTUFQX1NJWkUgPSA4MDAwOwoKY29uc3QgTFVNQkVSX1BBVEhfV0lEVEggPSAxNDA7CmNvbnN0IExVTUJFUl9QQVRIX0FOR0xFID0gTWF0aC5QSSAqIDAuNzU7CmNvbnN0IExVTUJFUl9QQVRIX0xFTkdUSCA9IDE1MDA7CmNvbnN0IExVTUJFUl9BUkVBX0NFTlRFUl9YID0gTWF0aC5jb3MoTFVNQkVSX1BBVEhfQU5HTEUpICogKENMRUFSSU5HX1JBRElVUyArIExVTUJFUl9QQVRIX0xFTkdUSCk7CmNvbnN0IExVTUJFUl9BUkVBX0NFTlRFUl9aID0gTWF0aC5zaW4oTFVNQkVSX1BBVEhfQU5HTEUpICogKENMRUFSSU5HX1JBRElVUyArIExVTUJFUl9QQVRIX0xFTkdUSCk7CmNvbnN0IExVTUJFUl9BUkVBX1JBRElVUyA9IDQwMDsKCmNvbnN0IGlucHV0ID0geyBmb3J3YXJkOiBmYWxzZSwgYmFja3dhcmQ6IGZhbHNlLCBsZWZ0OiBmYWxzZSwgcmlnaHQ6IGZhbHNlIH07CmNvbnN0IGpveXN0aWNrID0geyBhY3RpdmU6IGZhbHNlLCB4OiAwLCB5OiAwIH07CmNvbnN0IGlzTW9iaWxlID0gL0FuZHJvaWR8aVBob25lfGlQYWR8aVBvZC9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCk7CgpsZXQgZnJhbWVDb3VudCA9IDA7CmxldCBsYXN0VGltZUZQUyA9IHBlcmZvcm1hbmNlLm5vdygpOwpsZXQgcHJldlRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKY29uc3QgZnBzRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmcHMtY291bnRlcicpOwoKY29uc3QgX2ZvcndhcmQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwpjb25zdCBfcmlnaHQgPSBuZXcgVEhSRUUuVmVjdG9yMygpOwpjb25zdCBfbW92ZVZlYyA9IG5ldyBUSFJFRS5WZWN0b3IzKCk7CmNvbnN0IF9ldWxlciA9IG5ldyBUSFJFRS5FdWxlcigwLCAwLCAwLCAnWVhaJyk7CgovLyBQeXRob24gQnJpZGdlCmZ1bmN0aW9uIHdhaXRGb3JQeXRob24oKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICBjb25zdCBjaGVjayA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHdpbmRvdy5weXRob25SZWFkeSAmJiB3aW5kb3cucHlDb2xsaXNpb25FbmdpbmUgJiYgd2luZG93LnB5VHJlZUdlbmVyYXRvciAmJiB3aW5kb3cucHlQYXRoZmluZGVyKSB7CiAgICAgICAgICAgICAgICBweUNvbGxpc2lvbkVuZ2luZSA9IHdpbmRvdy5weUNvbGxpc2lvbkVuZ2luZTsKICAgICAgICAgICAgICAgIHB5VHJlZUdlbmVyYXRvciA9IHdpbmRvdy5weVRyZWVHZW5lcmF0b3I7CiAgICAgICAgICAgICAgICBweVBhdGhmaW5kZXIgPSB3aW5kb3cucHlQYXRoZmluZGVyOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIltKU10gUHl0aG9uIFNtYXJ0IEVuZ2luZSB2My4xICsgUGF0aGZpbmRlciBjb25uZWN0ZWQhIik7CiAgICAgICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGNoZWNrLCAxMDApOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjaGVjaygpOwogICAgfSk7Cn0KCmZ1bmN0aW9uIGhhbmRsZUNvbGxpc2lvblB5dGhvbihwb3MpIHsKICAgIGlmICghcHlDb2xsaXNpb25FbmdpbmUpIHJldHVybjsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gSlNPTi5wYXJzZShweUNvbGxpc2lvbkVuZ2luZS5oYW5kbGVfY29sbGlzaW9uKHBvcy54LCBwb3MueikpOwogICAgICAgIHBvcy54ID0gcmVzdWx0Lng7CiAgICAgICAgcG9zLnogPSByZXN1bHQuejsKICAgICAgICAKICAgICAgICBpZiAoaXNEZWJ1Z1Zpc2libGUpIHVwZGF0ZURlYnVnT3ZlcmxheShyZXN1bHQpOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIltKU10gQ29sbGlzaW9uIGVycm9yOiIsIGUpOwogICAgfQp9CgpmdW5jdGlvbiB1cGRhdGVDYXJDb2xsaXNpb24oKSB7CiAgICBpZiAoIXB5Q29sbGlzaW9uRW5naW5lIHx8ICFjYXJPYmplY3QpIHJldHVybjsKICAgIHRyeSB7CiAgICAgICAgcHlDb2xsaXNpb25FbmdpbmUudXBkYXRlX2Nhcl9wb3NpdGlvbigKICAgICAgICAgICAgY2FyT2JqZWN0LnBvc2l0aW9uLngsCiAgICAgICAgICAgIGNhck9iamVjdC5wb3NpdGlvbi56LAogICAgICAgICAgICBjYXJPYmplY3Qucm90YXRpb24ueQogICAgICAgICk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiW0pTXSBDYXIgY29sbGlzaW9uIHVwZGF0ZSBlcnJvcjoiLCBlKTsKICAgIH0KfQoKZnVuY3Rpb24gcmVnaXN0ZXJDYXJDb2xsaXNpb24oKSB7CiAgICBpZiAoIXB5Q29sbGlzaW9uRW5naW5lIHx8ICFjYXJPYmplY3QpIHJldHVybjsKICAgIHRyeSB7CiAgICAgICAgcHlDb2xsaXNpb25FbmdpbmUucmVnaXN0ZXJfY2FyKAogICAgICAgICAgICBjYXJPYmplY3QucG9zaXRpb24ueCwKICAgICAgICAgICAgY2FyT2JqZWN0LnBvc2l0aW9uLnosCiAgICAgICAgICAgIGNhck9iamVjdC5yb3RhdGlvbi55LAogICAgICAgICAgICBDQVJfTEVOR1RILAogICAgICAgICAgICBDQVJfV0lEVEgKICAgICAgICApOwogICAgICAgIGNvbnNvbGUubG9nKCJbSlNdIENhciBjb2xsaXNpb24gcmVnaXN0ZXJlZCIpOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIltKU10gQ2FyIGNvbGxpc2lvbiByZWdpc3RyYXRpb24gZXJyb3I6IiwgZSk7CiAgICB9Cn0KCmZ1bmN0aW9uIHVwZGF0ZURlYnVnT3ZlcmxheShyZXN1bHQpIHsKICAgIGNvbnN0IG92ZXJsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVidWctb3ZlcmxheScpOwogICAgaWYgKCFvdmVybGF5IHx8ICFweUNvbGxpc2lvbkVuZ2luZSkgcmV0dXJuOwogICAgCiAgICBsZXQgaW5mbyA9IHt9OwogICAgdHJ5IHsgaW5mbyA9IEpTT04ucGFyc2UocHlDb2xsaXNpb25FbmdpbmUuZ2V0X2RlYnVnX2luZm8oY2FtZXJhLnBvc2l0aW9uLngsIGNhbWVyYS5wb3NpdGlvbi56KSk7IH0gY2F0Y2goZSkge30KICAgIAogICAgb3ZlcmxheS5pbm5lckhUTUwgPSBgCiAgICAgICAgPGRpdiBzdHlsZT0iY29sb3I6I2ZmY2MwMDtmb250LXdlaWdodDpib2xkO21hcmdpbi1ib3R0b206OHB4Ij7wn5CNIFNNQVJUIEVOR0lORSB2My4xPC9kaXY+CiAgICAgICAgPGRpdj5ab25lOiA8c3BhbiBzdHlsZT0iY29sb3I6Izg4ZmY4OCI+JHtpbmZvLnpvbmUgfHwgJ3Vua25vd24nfTwvc3Bhbj48L2Rpdj4KICAgICAgICA8ZGl2PlBvczogJHtjYW1lcmEucG9zaXRpb24ueC50b0ZpeGVkKDApfSwgJHtjYW1lcmEucG9zaXRpb24uei50b0ZpeGVkKDApfTwvZGl2PgogICAgICAgIDxociBzdHlsZT0iYm9yZGVyLWNvbG9yOiMzMzM7bWFyZ2luOjZweCAwIj4KICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjojYWFmZmFhIj5Db2xsaWRlcnM6PC9kaXY+CiAgICAgICAgPGRpdj7igKIgQm94ZXM6ICR7aW5mby5ib3hlcyB8fCAwfTwvZGl2PgogICAgICAgIDxkaXY+4oCiIEN5bGluZGVyczogJHtpbmZvLmN5bGluZGVycyB8fCAwfTwvZGl2PgogICAgICAgIDxkaXY+4oCiIE9yaWVudGVkIEJveGVzOiAke2luZm8ub3JpZW50ZWRfYm94ZXMgfHwgMH08L2Rpdj4KICAgICAgICA8ZGl2PuKAoiBDYXIgQWN0aXZlOiAke2luZm8uY2FyX2FjdGl2ZSA/ICdZZXMnIDogJ05vJ308L2Rpdj4KICAgICAgICA8ZGl2PuKAoiBHcmlkIENlbGxzOiAke2luZm8uZ3JpZF9jZWxscyB8fCAwfTwvZGl2PgogICAgICAgIDxociBzdHlsZT0iYm9yZGVyLWNvbG9yOiMzMzM7bWFyZ2luOjZweCAwIj4KICAgICAgICA8ZGl2PkNvbGxpc2lvbnM6ICR7aW5mby5jb2xsaXNpb25zIHx8IDB9PC9kaXY+CiAgICAgICAgPGRpdj5MYXN0OiA8c3BhbiBzdHlsZT0iY29sb3I6I2ZmODg4OCI+JHtpbmZvLmxhc3RfaGl0IHx8ICdub25lJ308L3NwYW4+PC9kaXY+CiAgICAgICAgPGRpdj5UeXBlOiA8c3BhbiBzdHlsZT0iY29sb3I6Izg4YWFmZiI+JHtpbmZvLmxhc3RfdHlwZSB8fCAnbm9uZSd9PC9zcGFuPjwvZGl2PgogICAgICAgIDxkaXY+Rm9yZXN0IEJvdW5kYXJ5OiA8c3BhbiBzdHlsZT0iY29sb3I6JHtpbmZvLmZvcmVzdF9ib3VuZGFyeSA/ICcjZmZhYTAwJyA6ICcjNjY2J30iPiR7aW5mby5mb3Jlc3RfYm91bmRhcnkgPyAnSElUJyA6ICdubyd9PC9zcGFuPjwvZGl2PgogICAgICAgIDxociBzdHlsZT0iYm9yZGVyLWNvbG9yOiMzMzM7bWFyZ2luOjZweCAwIj4KICAgICAgICA8ZGl2IHN0eWxlPSJjb2xvcjojZmZhYWZmIj5XaWZlIFN0YXRlOiAke3dpZmVTdGF0ZX08L2Rpdj4KICAgICAgICA8ZGl2IHN0eWxlPSJtYXJnaW4tdG9wOjhweDtjb2xvcjojNjY2Ij5QcmVzcyBQIHRvIHRvZ2dsZTwvZGl2PgogICAgYDsKfQoKZnVuY3Rpb24gcmVnaXN0ZXJXaXRoUHl0aG9uKG9iaiwgbmFtZSwgY2F0ZWdvcnkpIHsKICAgIGlmICghcHlDb2xsaXNpb25FbmdpbmUgfHwgIW9iaikgcmV0dXJuIG51bGw7CiAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3Qob2JqKTsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UocHlDb2xsaXNpb25FbmdpbmUuYW5hbHl6ZV9hbmRfcmVnaXN0ZXIoCiAgICAgICAgICAgIG5hbWUsIGNhdGVnb3J5LAogICAgICAgICAgICBib3gubWluLngsIGJveC5tYXgueCwgYm94Lm1pbi55LCBib3gubWF4LnksIGJveC5taW4ueiwgYm94Lm1heC56CiAgICAgICAgKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgW0pTXSBGYWlsZWQgdG8gcmVnaXN0ZXIgJHtuYW1lfTpgLCBlKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KfQoKZnVuY3Rpb24gdG9nZ2xlRGVidWdNb2RlKCkgewogICAgaXNEZWJ1Z1Zpc2libGUgPSAhaXNEZWJ1Z1Zpc2libGU7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVidWctb3ZlcmxheScpLnN0eWxlLmRpc3BsYXkgPSBpc0RlYnVnVmlzaWJsZSA/ICdibG9jaycgOiAnbm9uZSc7Cn0KCi8vIENodW5rIE1hbmFnZXIKY2xhc3MgQ2h1bmtNYW5hZ2VyIHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuZ3Jhc3NDaHVua3MgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy50cmVlQ2h1bmtzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMubG9hZGVkQ2h1bmtzID0gbmV3IFNldCgpOwogICAgICAgIHRoaXMuYWN0aXZlQ2h1bmtzID0gMDsKICAgICAgICB0aGlzLmdyYXNzRGF0YSA9IG5ldyBNYXAoKTsKICAgICAgICB0aGlzLnRyZWVEYXRhID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuZ3Jhc3NNYXRlcmlhbCA9IG51bGw7CiAgICAgICAgdGhpcy50cmVlTWF0ZXJpYWxzID0gW107CiAgICAgICAgdGhpcy50cmVlR2VvbWV0cmllcyA9IFtdOwogICAgfQogICAgCiAgICBnZXRDaHVua0tleSh4LCB6KSB7IHJldHVybiBgJHtNYXRoLmZsb29yKHggLyBDSFVOS19TSVpFKX06JHtNYXRoLmZsb29yKHogLyBDSFVOS19TSVpFKX1gOyB9CiAgICBnZXRDaHVua0Nvb3JkcyhrZXkpIHsgY29uc3QgW2N4LCBjel0gPSBrZXkuc3BsaXQoJzonKS5tYXAoTnVtYmVyKTsgcmV0dXJuIHsgY3gsIGN6IH07IH0KICAgIAogICAgdXBkYXRlKHB4LCBweikgewogICAgICAgIGNvbnN0IHBjeCA9IE1hdGguZmxvb3IocHggLyBDSFVOS19TSVpFKTsKICAgICAgICBjb25zdCBwY3ogPSBNYXRoLmZsb29yKHB6IC8gQ0hVTktfU0laRSk7CiAgICAgICAgCiAgICAgICAgZm9yIChsZXQgZHggPSAtUkVOREVSX0RJU1RBTkNFOyBkeCA8PSBSRU5ERVJfRElTVEFOQ0U7IGR4KyspIHsKICAgICAgICAgICAgZm9yIChsZXQgZHogPSAtUkVOREVSX0RJU1RBTkNFOyBkeiA8PSBSRU5ERVJfRElTVEFOQ0U7IGR6KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke3BjeCArIGR4fToke3BjeiArIGR6fWA7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMubG9hZGVkQ2h1bmtzLmhhcyhrZXkpKSB0aGlzLmxvYWRDaHVuayhrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IHRvVW5sb2FkID0gW107CiAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgdGhpcy5sb2FkZWRDaHVua3MpIHsKICAgICAgICAgICAgY29uc3QgeyBjeCwgY3ogfSA9IHRoaXMuZ2V0Q2h1bmtDb29yZHMoa2V5KTsKICAgICAgICAgICAgaWYgKE1hdGgubWF4KE1hdGguYWJzKGN4IC0gcGN4KSwgTWF0aC5hYnMoY3ogLSBwY3opKSA+IFVOTE9BRF9ESVNUQU5DRSkgdG9VbmxvYWQucHVzaChrZXkpOwogICAgICAgIH0KICAgICAgICB0b1VubG9hZC5mb3JFYWNoKGsgPT4gdGhpcy51bmxvYWRDaHVuayhrKSk7CiAgICAgICAgdGhpcy5hY3RpdmVDaHVua3MgPSB0aGlzLmxvYWRlZENodW5rcy5zaXplOwogICAgfQogICAgCiAgICBsb2FkQ2h1bmsoa2V5KSB7CiAgICAgICAgaWYgKHRoaXMuZ3Jhc3NEYXRhLmhhcyhrZXkpKSB7CiAgICAgICAgICAgIGNvbnN0IG1lc2ggPSB0aGlzLmNyZWF0ZUdyYXNzQ2h1bmsoa2V5KTsKICAgICAgICAgICAgaWYgKG1lc2gpIHsgdGhpcy5ncmFzc0NodW5rcy5zZXQoa2V5LCBtZXNoKTsgc2NlbmUuYWRkKG1lc2gpOyB9CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnRyZWVEYXRhLmhhcyhrZXkpICYmIHRoaXMudHJlZUdlb21ldHJpZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBtZXNoZXMgPSB0aGlzLmNyZWF0ZVRyZWVDaHVuayhrZXkpOwogICAgICAgICAgICBpZiAobWVzaGVzLmxlbmd0aCkgeyB0aGlzLnRyZWVDaHVua3Muc2V0KGtleSwgbWVzaGVzKTsgbWVzaGVzLmZvckVhY2gobSA9PiBzY2VuZS5hZGQobSkpOyB9CiAgICAgICAgfQogICAgICAgIHRoaXMubG9hZGVkQ2h1bmtzLmFkZChrZXkpOwogICAgfQogICAgCiAgICB1bmxvYWRDaHVuayhrZXkpIHsKICAgICAgICBpZiAodGhpcy5ncmFzc0NodW5rcy5oYXMoa2V5KSkgewogICAgICAgICAgICBjb25zdCBtID0gdGhpcy5ncmFzc0NodW5rcy5nZXQoa2V5KTsKICAgICAgICAgICAgc2NlbmUucmVtb3ZlKG0pOyBtLmdlb21ldHJ5LmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5ncmFzc0NodW5rcy5kZWxldGUoa2V5KTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudHJlZUNodW5rcy5oYXMoa2V5KSkgewogICAgICAgICAgICB0aGlzLnRyZWVDaHVua3MuZ2V0KGtleSkuZm9yRWFjaChtID0+IHNjZW5lLnJlbW92ZShtKSk7CiAgICAgICAgICAgIHRoaXMudHJlZUNodW5rcy5kZWxldGUoa2V5KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sb2FkZWRDaHVua3MuZGVsZXRlKGtleSk7CiAgICB9CiAgICAKICAgIHJlZ2lzdGVyR3Jhc3NEYXRhKHBvc2l0aW9ucykgewogICAgICAgIGZvciAoY29uc3QgcCBvZiBwb3NpdGlvbnMpIHsKICAgICAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5nZXRDaHVua0tleShwLngsIHAueik7CiAgICAgICAgICAgIGlmICghdGhpcy5ncmFzc0RhdGEuaGFzKGtleSkpIHRoaXMuZ3Jhc3NEYXRhLnNldChrZXksIFtdKTsKICAgICAgICAgICAgdGhpcy5ncmFzc0RhdGEuZ2V0KGtleSkucHVzaChwKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJlZ2lzdGVyVHJlZURhdGEoaW5zdGFuY2VzKSB7CiAgICAgICAgZm9yIChjb25zdCBpbnN0IG9mIGluc3RhbmNlcykgewogICAgICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmdldENodW5rS2V5KGluc3QueCwgaW5zdC56KTsKICAgICAgICAgICAgaWYgKCF0aGlzLnRyZWVEYXRhLmhhcyhrZXkpKSB0aGlzLnRyZWVEYXRhLnNldChrZXksIFtdKTsKICAgICAgICAgICAgdGhpcy50cmVlRGF0YS5nZXQoa2V5KS5wdXNoKGluc3QpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgY3JlYXRlR3Jhc3NDaHVuayhrZXkpIHsKICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSB0aGlzLmdyYXNzRGF0YS5nZXQoa2V5KTsKICAgICAgICBpZiAoIXBvc2l0aW9ucz8ubGVuZ3RoIHx8ICF0aGlzLmdyYXNzTWF0ZXJpYWwpIHJldHVybiBudWxsOwogICAgICAgIAogICAgICAgIGNvbnN0IGJsYWRlR2VvID0gbmV3IFRIUkVFLkJ1ZmZlckdlb21ldHJ5KCk7CiAgICAgICAgYmxhZGVHZW8uc2V0QXR0cmlidXRlKCdwb3NpdGlvbicsIG5ldyBUSFJFRS5CdWZmZXJBdHRyaWJ1dGUobmV3IEZsb2F0MzJBcnJheShbCiAgICAgICAgICAgIC00LDAsMCwgNCwwLDAsIDAsMzAsMCwgMCwwLC00LCAwLDAsNCwgMCwzMCwwCiAgICAgICAgXSksIDMpKTsKICAgICAgICBibGFkZUdlby5zZXRBdHRyaWJ1dGUoJ3V2JywgbmV3IFRIUkVFLkJ1ZmZlckF0dHJpYnV0ZShuZXcgRmxvYXQzMkFycmF5KFswLDAsMSwwLDAuNSwxLDAsMCwxLDAsMC41LDFdKSwgMikpOwogICAgICAgIAogICAgICAgIGNvbnN0IGdlbyA9IG5ldyBUSFJFRS5JbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSgpOwogICAgICAgIGdlby5hdHRyaWJ1dGVzLnBvc2l0aW9uID0gYmxhZGVHZW8uYXR0cmlidXRlcy5wb3NpdGlvbjsKICAgICAgICBnZW8uYXR0cmlidXRlcy51diA9IGJsYWRlR2VvLmF0dHJpYnV0ZXMudXY7CiAgICAgICAgCiAgICAgICAgY29uc3QgY291bnQgPSBwb3NpdGlvbnMubGVuZ3RoOwogICAgICAgIGNvbnN0IGlQb3MgPSBuZXcgRmxvYXQzMkFycmF5KGNvdW50ICogMyk7CiAgICAgICAgY29uc3QgaVJvdCA9IG5ldyBGbG9hdDMyQXJyYXkoY291bnQpOwogICAgICAgIGNvbnN0IGlTY2FsZSA9IG5ldyBGbG9hdDMyQXJyYXkoY291bnQpOwogICAgICAgIAogICAgICAgIGxldCBtaW5YID0gSW5maW5pdHksIG1heFggPSAtSW5maW5pdHksIG1pblogPSBJbmZpbml0eSwgbWF4WiA9IC1JbmZpbml0eTsKICAgICAgICBwb3NpdGlvbnMuZm9yRWFjaCgocCwgaSkgPT4gewogICAgICAgICAgICBpUG9zW2kqM10gPSBwLng7IGlQb3NbaSozKzFdID0gMjsgaVBvc1tpKjMrMl0gPSBwLno7CiAgICAgICAgICAgIGlSb3RbaV0gPSBwLnJvdDsgaVNjYWxlW2ldID0gcC5zY2FsZTsKICAgICAgICAgICAgaWYgKHAueCA8IG1pblgpIG1pblggPSBwLng7IGlmIChwLnggPiBtYXhYKSBtYXhYID0gcC54OwogICAgICAgICAgICBpZiAocC56IDwgbWluWikgbWluWiA9IHAuejsgaWYgKHAueiA+IG1heFopIG1heFogPSBwLno7CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgZ2VvLnNldEF0dHJpYnV0ZSgnaW5zdGFuY2VQb3NpdGlvbicsIG5ldyBUSFJFRS5JbnN0YW5jZWRCdWZmZXJBdHRyaWJ1dGUoaVBvcywgMykpOwogICAgICAgIGdlby5zZXRBdHRyaWJ1dGUoJ2luc3RhbmNlUm90YXRpb24nLCBuZXcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKGlSb3QsIDEpKTsKICAgICAgICBnZW8uc2V0QXR0cmlidXRlKCdpbnN0YW5jZVNjYWxlJywgbmV3IFRIUkVFLkluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZShpU2NhbGUsIDEpKTsKICAgICAgICAKICAgICAgICBjb25zdCByYWRpdXMgPSBNYXRoLnNxcnQoKG1heFgtbWluWCkqKjIgKyAobWF4Wi1taW5aKSoqMikgLyAyICsgNTA7CiAgICAgICAgZ2VvLmJvdW5kaW5nU3BoZXJlID0gbmV3IFRIUkVFLlNwaGVyZShuZXcgVEhSRUUuVmVjdG9yMygobWluWCttYXhYKS8yLCAyMCwgKG1pblorbWF4WikvMiksIHJhZGl1cyk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIG5ldyBUSFJFRS5NZXNoKGdlbywgdGhpcy5ncmFzc01hdGVyaWFsKTsKICAgIH0KICAgIAogICAgY3JlYXRlVHJlZUNodW5rKGtleSkgewogICAgICAgIGNvbnN0IGluc3RhbmNlcyA9IHRoaXMudHJlZURhdGEuZ2V0KGtleSk7CiAgICAgICAgaWYgKCFpbnN0YW5jZXM/Lmxlbmd0aCB8fCAhdGhpcy50cmVlR2VvbWV0cmllcy5sZW5ndGgpIHJldHVybiBbXTsKICAgICAgICAKICAgICAgICBjb25zdCBtZXNoZXMgPSBbXTsKICAgICAgICBjb25zdCBkdW1teSA9IG5ldyBUSFJFRS5PYmplY3QzRCgpOwogICAgICAgIAogICAgICAgIHRoaXMudHJlZUdlb21ldHJpZXMuZm9yRWFjaCgoZ2VvLCBpZHgpID0+IHsKICAgICAgICAgICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5JbnN0YW5jZWRNZXNoKGdlbywgdGhpcy50cmVlTWF0ZXJpYWxzW2lkeF0sIGluc3RhbmNlcy5sZW5ndGgpOwogICAgICAgICAgICBtZXNoLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICBtZXNoLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKChpbnN0LCBpKSA9PiB7CiAgICAgICAgICAgICAgICBkdW1teS5wb3NpdGlvbi5zZXQoaW5zdC54LCBpbnN0LnksIGluc3Queik7CiAgICAgICAgICAgICAgICBkdW1teS5yb3RhdGlvbi5zZXQoMCwgaW5zdC5yb3RZLCAwKTsKICAgICAgICAgICAgICAgIGR1bW15LnNjYWxlLnNldFNjYWxhcihpbnN0LnMpOwogICAgICAgICAgICAgICAgZHVtbXkudXBkYXRlTWF0cml4KCk7CiAgICAgICAgICAgICAgICBtZXNoLnNldE1hdHJpeEF0KGksIGR1bW15Lm1hdHJpeCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWVzaC5pbnN0YW5jZU1hdHJpeC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIG1lc2hlcy5wdXNoKG1lc2gpOwogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIHJldHVybiBtZXNoZXM7CiAgICB9Cn0KCmNvbnN0IGNodW5rTWFuYWdlciA9IG5ldyBDaHVua01hbmFnZXIoKTsKCi8vIEhlbHBlcnMKZnVuY3Rpb24gaXNJbkx1bWJlclBhdGgoeCwgeikgewogICAgY29uc3QgZHggPSBNYXRoLmNvcyhMVU1CRVJfUEFUSF9BTkdMRSksIGR6ID0gTWF0aC5zaW4oTFVNQkVSX1BBVEhfQU5HTEUpOwogICAgY29uc3QgZG90ID0geCpkeCArIHoqZHo7CiAgICBpZiAoZG90IDwgQ0xFQVJJTkdfUkFESVVTIC0gMTUwIHx8IGRvdCA+IENMRUFSSU5HX1JBRElVUyArIExVTUJFUl9QQVRIX0xFTkdUSCAtIExVTUJFUl9BUkVBX1JBRElVUyArIDUwKSByZXR1cm4gZmFsc2U7CiAgICBjb25zdCBweCA9IHggLSBkb3QqZHgsIHB6ID0geiAtIGRvdCpkejsKICAgIHJldHVybiAocHgqcHggKyBweipweikgPCBMVU1CRVJfUEFUSF9XSURUSCoqMjsKfQoKZnVuY3Rpb24gaXNJbkx1bWJlckFyZWEoeCwgeikgewogICAgY29uc3QgZHggPSB4IC0gTFVNQkVSX0FSRUFfQ0VOVEVSX1gsIGR6ID0geiAtIExVTUJFUl9BUkVBX0NFTlRFUl9aOwogICAgcmV0dXJuIChkeCpkeCArIGR6KmR6KSA8IExVTUJFUl9BUkVBX1JBRElVUyoqMjsKfQoKLy8gRGlhbG9ndWUgU3lzdGVtCmxldCBoaWRlVGltZW91dCA9IG51bGw7CmxldCBjdXJyZW50VHlwZXdyaXRlcklkID0gMDsKCmZ1bmN0aW9uIHBsYXlTcGVlY2hTb3VuZCgpIHsKICAgIGlmIChhdWRpb0N0eC5zdGF0ZSA9PT0gJ3N1c3BlbmRlZCcpIGF1ZGlvQ3R4LnJlc3VtZSgpOwogICAgY29uc3Qgb3NjID0gYXVkaW9DdHguY3JlYXRlT3NjaWxsYXRvcigpOwogICAgY29uc3QgZ2FpbiA9IGF1ZGlvQ3R4LmNyZWF0ZUdhaW4oKTsKICAgIG9zYy5jb25uZWN0KGdhaW4pOyBnYWluLmNvbm5lY3QoYXVkaW9DdHguZGVzdGluYXRpb24pOwogICAgb3NjLnR5cGUgPSAnc3F1YXJlJzsKICAgIG9zYy5mcmVxdWVuY3kudmFsdWUgPSAxMDAgKyBNYXRoLnJhbmRvbSgpICogNTA7CiAgICBnYWluLmdhaW4uc2V0VmFsdWVBdFRpbWUoMC4wOCwgYXVkaW9DdHguY3VycmVudFRpbWUpOwogICAgZ2Fpbi5nYWluLmV4cG9uZW50aWFsUmFtcFRvVmFsdWVBdFRpbWUoMC4wMDEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lICsgMC4wOCk7CiAgICBvc2Muc3RhcnQoKTsgb3NjLnN0b3AoYXVkaW9DdHguY3VycmVudFRpbWUgKyAwLjA4KTsKfQoKZnVuY3Rpb24gc2V0UG9ydHJhaXQodHlwZSkgewogICAgY29uc3QgYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb3J0cmFpdC1jb250YWluZXInKTsKICAgIGNvbnN0IHAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGxheWVyLXBvcnRyYWl0Jyk7CiAgICBjb25zdCB3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpZmUtcG9ydHJhaXQnKTsKICAgIGlmICghdHlwZSkgeyBjLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IHJldHVybjsgfQogICAgYy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgIHAuc3R5bGUuZGlzcGxheSA9IHR5cGUgPT09ICdwbGF5ZXInID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgIHcuc3R5bGUuZGlzcGxheSA9IHR5cGUgPT09ICd3aWZlJyA/ICdibG9jaycgOiAnbm9uZSc7Cn0KCmZ1bmN0aW9uIHNob3dEaWFsb2d1ZSgpIHsKICAgIGNvbnN0IGJveCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2d1ZS1ib3gnKTsKICAgIGlmIChoaWRlVGltZW91dCkgeyBjbGVhclRpbWVvdXQoaGlkZVRpbWVvdXQpOyBoaWRlVGltZW91dCA9IG51bGw7IH0KICAgIGJveC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgYm94Lm9mZnNldEhlaWdodDsKICAgIGJveC5jbGFzc0xpc3QuYWRkKCd2aXNpYmxlJyk7Cn0KCmZ1bmN0aW9uIGhpZGVEaWFsb2d1ZSgpIHsKICAgIGNvbnN0IGJveCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2d1ZS1ib3gnKTsKICAgIGJveC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICBpZiAoaGlkZVRpbWVvdXQpIGNsZWFyVGltZW91dChoaWRlVGltZW91dCk7CiAgICBoaWRlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4geyBpZiAoIWJveC5jbGFzc0xpc3QuY29udGFpbnMoJ3Zpc2libGUnKSkgYm94LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IH0sIDUwMCk7Cn0KCmFzeW5jIGZ1bmN0aW9uIHR5cGVXcml0ZXIodGV4dCwgZWxJZCwgc3BlZWQgPSA1MCkgewogICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbElkKTsKICAgIGNvbnN0IG15SWQgPSArK2N1cnJlbnRUeXBld3JpdGVySWQ7CiAgICBlbC50ZXh0Q29udGVudCA9ICcnOwogICAgZWwuY2xhc3NMaXN0LmFkZCgnZGlhbG9ndWUtY3Vyc29yJyk7CiAgICBmb3IgKGNvbnN0IGNoYXIgb2YgdGV4dCkgewogICAgICAgIGlmIChjdXJyZW50VHlwZXdyaXRlcklkICE9PSBteUlkKSByZXR1cm47CiAgICAgICAgZWwudGV4dENvbnRlbnQgKz0gY2hhcjsKICAgICAgICBpZiAoY2hhciAhPT0gJyAnKSBwbGF5U3BlZWNoU291bmQoKTsKICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgc3BlZWQgKyBNYXRoLnJhbmRvbSgpICogMjApKTsKICAgIH0KICAgIGlmIChjdXJyZW50VHlwZXdyaXRlcklkID09PSBteUlkKSBlbC5jbGFzc0xpc3QucmVtb3ZlKCdkaWFsb2d1ZS1jdXJzb3InKTsKfQoKZnVuY3Rpb24gc2hvd0RpYWxvZ3VlTGluZSh0ZXh0LCBzcGVha2VyKSB7CiAgICBzaG93RGlhbG9ndWUoKTsKICAgIHNldFBvcnRyYWl0KHNwZWFrZXIgPT09ICJNQVJJRE8iID8gJ3BsYXllcicgOiAoc3BlYWtlciA9PT0gIkVTUE9TQSIgPyAnd2lmZScgOiBudWxsKSk7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGlhbG9ndWUtdGV4dCcpLnN0eWxlLmNvbG9yID0gc3BlYWtlciA9PT0gIkVTUE9TQSIgPyAiI2ZmYjdiMiIgOiAiI2FhY2NmZiI7CiAgICB0eXBlV3JpdGVyKHRleHQsICdkaWFsb2d1ZS10ZXh0JywgNDApOwp9CgovLyBFeGl0IGNhciBidXR0b24gbWFuYWdlbWVudApmdW5jdGlvbiBoaWRlRXhpdENhckJ1dHRvbigpIHsKICAgIGNvbnN0IHByb21wdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnRlcmFjdGlvbi1wcm9tcHQnKTsKICAgIHByb21wdC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICBjYW5FeGl0Q2FyID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIHNob3dFeGl0Q2FyQnV0dG9uKCkgewogICAgY29uc3QgcHJvbXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ludGVyYWN0aW9uLXByb21wdCcpOwogICAgcHJvbXB0LmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTsKICAgIGNhbkV4aXRDYXIgPSB0cnVlOwp9CgpmdW5jdGlvbiBkaXNhYmxlRXhpdENhckJ1dHRvbigpIHsKICAgIGhpZGVFeGl0Q2FyQnV0dG9uKCk7CiAgICBleGl0Q2FyQnV0dG9uSGlkZGVuID0gdHJ1ZTsKfQoKZnVuY3Rpb24gdXBkYXRlUXVlc3QodGV4dCkgewogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1ZXN0LXRleHQnKS5pbm5lclRleHQgPSB0ZXh0OwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3F1ZXN0LWJveCcpLmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTsKfQoKLy8gV2lmZSBzdGF0ZSBtYW5hZ2VtZW50CmZ1bmN0aW9uIHN0YXJ0V2lmZVdhbGtpbmcoKSB7CiAgICBpZiAod2lmZVN0YXRlICE9PSBXSUZFX1NUQVRFLlNJVFRJTkdfQ0FSKSByZXR1cm47CiAgICAKICAgIGNvbnNvbGUubG9nKCJbV2lmZV0gU3RhcnRpbmcgdG8gd2FsayB0byBzb2ZhIHdpdGggcGF0aGZpbmRpbmciKTsKICAgIHdpZmVTdGF0ZSA9IFdJRkVfU1RBVEUuV0FMS0lORzsKICAgIAogICAgLy8gSGlkZSBzaXR0aW5nIHdpZmUsIHNob3cgd2Fsa2luZyB3aWZlCiAgICBpZiAoZ2lybFNpdHRpbmdPYmplY3QpIHsKICAgICAgICBnaXJsU2l0dGluZ09iamVjdC52aXNpYmxlID0gZmFsc2U7CiAgICB9CiAgICAKICAgIGlmIChnaXJsV2Fsa2luZ09iamVjdCkgewogICAgICAgIC8vIFRlbGVwb3J0IHdpZmUgdG8gc3Bhd24gcG9zaXRpb24gd2hlbiBleGl0aW5nIGNhcgogICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLnNldChXSUZFX1NQQVdOX1gsIDIyLCBXSUZFX1NQQVdOX1opOwogICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnZpc2libGUgPSB0cnVlOwogICAgICAgIAogICAgICAgIC8vIFVzZSBQeXRob24gcGF0aGZpbmRlciB0byBmaW5kIHBhdGggdG8gc29mYQogICAgICAgIC8vIFN0YXJ0IGZyb20gd2lmZSBzcGF3biBwb3NpdGlvbgogICAgICAgIGNvbnN0IHN0YXJ0WCA9IFdJRkVfU1BBV05fWDsKICAgICAgICBjb25zdCBzdGFydFogPSBXSUZFX1NQQVdOX1o7CiAgICAgICAgCiAgICAgICAgaWYgKHB5UGF0aGZpbmRlcikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29uc3QgcGF0aFJlc3VsdCA9IEpTT04ucGFyc2UocHlQYXRoZmluZGVyLmZpbmRfcGF0aCgKICAgICAgICAgICAgICAgICAgICBzdGFydFgsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRaLAogICAgICAgICAgICAgICAgICAgIFNPRkFfUE9TSVRJT04ueCwKICAgICAgICAgICAgICAgICAgICBTT0ZBX1BPU0lUSU9OLnoKICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocGF0aFJlc3VsdC5zdWNjZXNzICYmIHBhdGhSZXN1bHQucGF0aC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgd2lmZVBhdGhXYXlwb2ludHMgPSBwYXRoUmVzdWx0LnBhdGg7CiAgICAgICAgICAgICAgICAgICAgd2lmZUN1cnJlbnRXYXlwb2ludEluZGV4ID0gMDsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW1dpZmVdIFBhdGhmaW5kZXIgZm91bmQgJHt3aWZlUGF0aFdheXBvaW50cy5sZW5ndGh9IHdheXBvaW50c2ApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBkaXJlY3QgcGF0aCBhdm9pZGluZyBjYXIgLSBnbyB3aWRlIGFyb3VuZCBpdAogICAgICAgICAgICAgICAgICAgIHdpZmVQYXRoV2F5cG9pbnRzID0gWwogICAgICAgICAgICAgICAgICAgICAgICB7IHg6IHN0YXJ0WCwgejogc3RhcnRaIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsgeDogNTAwLCB6OiA0MDAgfSwgIC8vIEdvIHdpZGUgcmlnaHQgdG8gYXZvaWQgY2FyCiAgICAgICAgICAgICAgICAgICAgICAgIHsgeDogNDAwLCB6OiAyNTAgfSwgIC8vIENvbnRpbnVlIGFyb3VuZAogICAgICAgICAgICAgICAgICAgICAgICB7IHg6IDI1MCwgejogMTAwIH0sICAvLyBBcHByb2FjaCBjYWJpbiBhcmVhCiAgICAgICAgICAgICAgICAgICAgICAgIHsgeDogMTAwLCB6OiAwIH0sICAgIC8vIE5lYXIgY2FiaW4gZW50cmFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgeyB4OiBTT0ZBX1BPU0lUSU9OLngsIHo6IFNPRkFfUE9TSVRJT04ueiB9CiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICB3aWZlQ3VycmVudFdheXBvaW50SW5kZXggPSAwOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbV2lmZV0gVXNpbmcgZmFsbGJhY2sgd2F5cG9pbnQgcGF0aCBhcm91bmQgY2FyIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIltXaWZlXSBQYXRoZmluZGluZyBlcnJvcjoiLCBlKTsKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHdpdGggaW50ZXJtZWRpYXRlIHdheXBvaW50cyB0byBnbyBhcm91bmQgY2FyCiAgICAgICAgICAgICAgICB3aWZlUGF0aFdheXBvaW50cyA9IFsKICAgICAgICAgICAgICAgICAgICB7IHg6IHN0YXJ0WCwgejogc3RhcnRaIH0sCiAgICAgICAgICAgICAgICAgICAgeyB4OiA1MDAsIHo6IDQwMCB9LCAgLy8gR28gd2lkZSByaWdodAogICAgICAgICAgICAgICAgICAgIHsgeDogMzUwLCB6OiAyMDAgfSwgIC8vIENvbnRpbnVlIGFyb3VuZAogICAgICAgICAgICAgICAgICAgIHsgeDogMTUwLCB6OiA1MCB9LCAgIC8vIEFwcHJvYWNoIGNhYmluCiAgICAgICAgICAgICAgICAgICAgeyB4OiBTT0ZBX1BPU0lUSU9OLngsIHo6IFNPRkFfUE9TSVRJT04ueiB9CiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgd2lmZUN1cnJlbnRXYXlwb2ludEluZGV4ID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE5vIHBhdGhmaW5kZXIsIHVzZSB3YXlwb2ludCBwYXRoIHRoYXQgZ29lcyBhcm91bmQgY2FyCiAgICAgICAgICAgIHdpZmVQYXRoV2F5cG9pbnRzID0gWwogICAgICAgICAgICAgICAgeyB4OiBzdGFydFgsIHo6IHN0YXJ0WiB9LAogICAgICAgICAgICAgICAgeyB4OiA1MDAsIHo6IDQwMCB9LCAgLy8gR28gd2lkZSByaWdodCB0byBhdm9pZCBjYXIKICAgICAgICAgICAgICAgIHsgeDogMzUwLCB6OiAyMDAgfSwgIC8vIENvbnRpbnVlIGFyb3VuZAogICAgICAgICAgICAgICAgeyB4OiAxNTAsIHo6IDUwIH0sICAgLy8gQXBwcm9hY2ggY2FiaW4KICAgICAgICAgICAgICAgIHsgeDogU09GQV9QT1NJVElPTi54LCB6OiBTT0ZBX1BPU0lUSU9OLnogfQogICAgICAgICAgICBdOwogICAgICAgICAgICB3aWZlQ3VycmVudFdheXBvaW50SW5kZXggPSAwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTZXQgaW5pdGlhbCB0YXJnZXQKICAgICAgICB3aWZlV2Fsa2luZ1RhcmdldCA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgICAgICB3aWZlUGF0aFdheXBvaW50c1t3aWZlQ3VycmVudFdheXBvaW50SW5kZXhdLngsCiAgICAgICAgICAgIDAsCiAgICAgICAgICAgIHdpZmVQYXRoV2F5cG9pbnRzW3dpZmVDdXJyZW50V2F5cG9pbnRJbmRleF0uegogICAgICAgICk7CiAgICAgICAgCiAgICAgICAgLy8gRmFjZSB0b3dhcmQgdGFyZ2V0CiAgICAgICAgY29uc3QgZHggPSB3aWZlV2Fsa2luZ1RhcmdldC54IC0gZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueDsKICAgICAgICBjb25zdCBkeiA9IHdpZmVXYWxraW5nVGFyZ2V0LnogLSBnaXJsV2Fsa2luZ09iamVjdC5wb3NpdGlvbi56OwogICAgICAgIGlmIChkeCAhPT0gMCB8fCBkeiAhPT0gMCkgewogICAgICAgICAgICBnaXJsV2Fsa2luZ09iamVjdC5yb3RhdGlvbi55ID0gTWF0aC5hdGFuMihkeCwgZHopOwogICAgICAgIH0KICAgIH0KICAgIAogICAgc2hvd0RpYWxvZ3VlTGluZSgiVm91IGRlc2NhbnNhciBubyBzb2bDoS4uLiIsICJFU1BPU0EiKTsKICAgIHNldFRpbWVvdXQoKCkgPT4gaGlkZURpYWxvZ3VlKCksIDIwMDApOwp9CgpmdW5jdGlvbiB1cGRhdGVXaWZlV2Fsa2luZyhkZWx0YSkgewogICAgaWYgKHdpZmVTdGF0ZSAhPT0gV0lGRV9TVEFURS5XQUxLSU5HIHx8ICFnaXJsV2Fsa2luZ09iamVjdCB8fCAhd2lmZVdhbGtpbmdUYXJnZXQpIHJldHVybjsKICAgIAogICAgY29uc3QgZHggPSB3aWZlV2Fsa2luZ1RhcmdldC54IC0gZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueDsKICAgIGNvbnN0IGR6ID0gd2lmZVdhbGtpbmdUYXJnZXQueiAtIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLno7CiAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeiAqIGR6KTsKICAgIAogICAgLy8gQ2hlY2sgaWYgcmVhY2hlZCBjdXJyZW50IHdheXBvaW50CiAgICBpZiAoZGlzdCA8IDI1KSB7CiAgICAgICAgd2lmZUN1cnJlbnRXYXlwb2ludEluZGV4Kys7CiAgICAgICAgCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyB3YXMgdGhlIGxhc3Qgd2F5cG9pbnQgKHNvZmEpCiAgICAgICAgaWYgKHdpZmVDdXJyZW50V2F5cG9pbnRJbmRleCA+PSB3aWZlUGF0aFdheXBvaW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgLy8gQXJyaXZlZCBhdCBzb2ZhCiAgICAgICAgICAgIHdpZmVBcnJpdmVkQXRTb2ZhKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gTW92ZSB0byBuZXh0IHdheXBvaW50CiAgICAgICAgd2lmZVdhbGtpbmdUYXJnZXQgPSBuZXcgVEhSRUUuVmVjdG9yMygKICAgICAgICAgICAgd2lmZVBhdGhXYXlwb2ludHNbd2lmZUN1cnJlbnRXYXlwb2ludEluZGV4XS54LAogICAgICAgICAgICAwLAogICAgICAgICAgICB3aWZlUGF0aFdheXBvaW50c1t3aWZlQ3VycmVudFdheXBvaW50SW5kZXhdLnoKICAgICAgICApOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgLy8gTW92ZSB0b3dhcmQgY3VycmVudCB3YXlwb2ludAogICAgY29uc3QgbW92ZVNwZWVkID0gd2lmZVdhbGtpbmdTcGVlZCAqIGRlbHRhOwogICAgY29uc3QgbnggPSBkeCAvIGRpc3Q7CiAgICBjb25zdCBueiA9IGR6IC8gZGlzdDsKICAgIAogICAgLy8gVXNlIFB5dGhvbiBwYXRoZmluZGVyIGZvciByZWFsLXRpbWUgb2JzdGFjbGUgYXZvaWRhbmNlCiAgICBpZiAocHlQYXRoZmluZGVyKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgbW92ZVJlc3VsdCA9IEpTT04ucGFyc2UocHlQYXRoZmluZGVyLmdldF9uZXh0X21vdmUoCiAgICAgICAgICAgICAgICBnaXJsV2Fsa2luZ09iamVjdC5wb3NpdGlvbi54LAogICAgICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueiwKICAgICAgICAgICAgICAgIHdpZmVXYWxraW5nVGFyZ2V0LngsCiAgICAgICAgICAgICAgICB3aWZlV2Fsa2luZ1RhcmdldC56CiAgICAgICAgICAgICkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1vdmVSZXN1bHQuc3R1Y2spIHsKICAgICAgICAgICAgICAgIC8vIFJlY2FsY3VsYXRlIHBhdGggaWYgc3R1Y2sKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbV2lmZV0gU3R1Y2ssIHJlY2FsY3VsYXRpbmcgcGF0aC4uLiIpOwogICAgICAgICAgICAgICAgY29uc3QgcGF0aFJlc3VsdCA9IEpTT04ucGFyc2UocHlQYXRoZmluZGVyLmZpbmRfcGF0aCgKICAgICAgICAgICAgICAgICAgICBnaXJsV2Fsa2luZ09iamVjdC5wb3NpdGlvbi54LAogICAgICAgICAgICAgICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLnosCiAgICAgICAgICAgICAgICAgICAgU09GQV9QT1NJVElPTi54LAogICAgICAgICAgICAgICAgICAgIFNPRkFfUE9TSVRJT04uegogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChwYXRoUmVzdWx0LnN1Y2Nlc3MgJiYgcGF0aFJlc3VsdC5wYXRoLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB3aWZlUGF0aFdheXBvaW50cyA9IHBhdGhSZXN1bHQucGF0aDsKICAgICAgICAgICAgICAgICAgICB3aWZlQ3VycmVudFdheXBvaW50SW5kZXggPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTW92ZSB0b3dhcmQgcGF0aGZpbmRlci1zdWdnZXN0ZWQgcG9zaXRpb24KICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFggPSBtb3ZlUmVzdWx0Lng7CiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRaID0gbW92ZVJlc3VsdC56OwogICAgICAgICAgICAgICAgY29uc3QgdGR4ID0gdGFyZ2V0WCAtIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICBjb25zdCB0ZHogPSB0YXJnZXRaIC0gZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24uejsKICAgICAgICAgICAgICAgIGNvbnN0IHRkaXN0ID0gTWF0aC5zcXJ0KHRkeCAqIHRkeCArIHRkeiAqIHRkeik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0ZGlzdCA+IDAuMSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRueCA9IHRkeCAvIHRkaXN0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRueiA9IHRkeiAvIHRkaXN0OwogICAgICAgICAgICAgICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLnggKz0gdG54ICogbW92ZVNwZWVkOwogICAgICAgICAgICAgICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLnogKz0gdG56ICogbW92ZVNwZWVkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEZhY2UgZGlyZWN0aW9uIG9mIG1vdmVtZW50CiAgICAgICAgICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3Qucm90YXRpb24ueSA9IE1hdGguYXRhbjIodGR4LCB0ZHopOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAvLyBGYWxsYmFjayB0byBzaW1wbGUgbW92ZW1lbnQKICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueCArPSBueCAqIG1vdmVTcGVlZDsKICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueiArPSBueiAqIG1vdmVTcGVlZDsKICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3Qucm90YXRpb24ueSA9IE1hdGguYXRhbjIoZHgsIGR6KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIE5vIHBhdGhmaW5kZXIsIHNpbXBsZSBtb3ZlbWVudAogICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLnggKz0gbnggKiBtb3ZlU3BlZWQ7CiAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueiArPSBueiAqIG1vdmVTcGVlZDsKICAgICAgICBnaXJsV2Fsa2luZ09iamVjdC5yb3RhdGlvbi55ID0gTWF0aC5hdGFuMihkeCwgZHopOwogICAgfQp9CgpmdW5jdGlvbiB3aWZlQXJyaXZlZEF0U29mYSgpIHsKICAgIGNvbnNvbGUubG9nKCJbV2lmZV0gQXJyaXZlZCBhdCBzb2ZhLCBzaXR0aW5nIGRvd24iKTsKICAgIHdpZmVTdGF0ZSA9IFdJRkVfU1RBVEUuU0lUVElOR19TT0ZBOwogICAgd2lmZVdhbGtpbmdUYXJnZXQgPSBudWxsOwogICAgd2lmZVBhdGhXYXlwb2ludHMgPSBbXTsKICAgIHdpZmVDdXJyZW50V2F5cG9pbnRJbmRleCA9IDA7CiAgICAKICAgIC8vIEhpZGUgd2Fsa2luZyB3aWZlLCBzaG93IHNpdHRpbmcgb24gc29mYSB3aWZlCiAgICBpZiAoZ2lybFdhbGtpbmdPYmplY3QpIHsKICAgICAgICBnaXJsV2Fsa2luZ09iamVjdC52aXNpYmxlID0gZmFsc2U7CiAgICB9CiAgICAKICAgIGlmIChnaXJsU29mYVNpdHRpbmdPYmplY3QpIHsKICAgICAgICBnaXJsU29mYVNpdHRpbmdPYmplY3QucG9zaXRpb24uc2V0KFNPRkFfUE9TSVRJT04ueCwgMjIsIFNPRkFfUE9TSVRJT04ueik7CiAgICAgICAgZ2lybFNvZmFTaXR0aW5nT2JqZWN0LnJvdGF0aW9uLnkgPSBTT0ZBX1BPU0lUSU9OLnJvdFk7ICAvLyAyMCBkZWdyZWVzIGZvcndhcmQKICAgICAgICBnaXJsU29mYVNpdHRpbmdPYmplY3QudmlzaWJsZSA9IHRydWU7CiAgICB9CiAgICAKICAgIHNob3dEaWFsb2d1ZUxpbmUoIkFoLCBtdWl0byBtZWxob3IuLi4iLCAiRVNQT1NBIik7CiAgICBzZXRUaW1lb3V0KCgpID0+IGhpZGVEaWFsb2d1ZSgpLCAyMDAwKTsKfQoKLy8gQ3V0c2NlbmUKbGV0IGhlYWRCb2JUaW1lID0gMCwgYXV0b0xvb2tUaW1lID0gMCwgbGFzdFBsYXllcklucHV0ID0gMDsKCmNvbnN0IHN1YnRpdGxlcyA9IFsKICAgIHsgdGltZTogMC41LCBzcGVha2VyOiAiRVNQT1NBIiwgdGV4dDogIkZpbmFsbWVudGUgY2hlZ2Ftb3MuIiwgZHVyYXRpb246IDIuMCB9LAogICAgeyB0aW1lOiAyLjgsIHNwZWFrZXI6ICJNQVJJRE8iLCB0ZXh0OiAiRGVtb3JvdSBhdMOpIGEgbWFuaMOjIHNlZ3VpbnRlLiIsIGR1cmF0aW9uOiAyLjUgfSwKICAgIHsgdGltZTogNS41LCBzcGVha2VyOiAiRVNQT1NBIiwgdGV4dDogIlBvaXMgw6kuIiwgZHVyYXRpb246IDEuMiB9LAogICAgeyB0aW1lOiA3LjAsIHNwZWFrZXI6ICJNQVJJRE8iLCB0ZXh0OiAiVWF1Li4uIEEgY2FzYSBlc3TDoSBwaW9yIGRvIHF1ZSBlc3BlcmF2YS4iLCBkdXJhdGlvbjogMi41IH0sCiAgICB7IHRpbWU6IDEwLjAsIHNwZWFrZXI6ICJFU1BPU0EiLCB0ZXh0OiAiUGlvciDDqSBldWZlbWlzbW8uIiwgZHVyYXRpb246IDIuMCB9LAogICAgeyB0aW1lOiAxMi41LCBzcGVha2VyOiAiTUFSSURPIiwgdGV4dDogIlZhbW9zIHRlciBxdWUgc2FpciBtYWlzIGNlZG8uIiwgZHVyYXRpb246IDIuMCB9LAogICAgeyB0aW1lOiAxNS4wLCBzcGVha2VyOiAiRVNQT1NBIiwgdGV4dDogIlZhbW9zIGRvcm1pciBhcXVpIGUgaXIgZW1ib3JhIGFtYW5ow6MuIiwgZHVyYXRpb246IDIuNSB9Cl07CgpmdW5jdGlvbiBlYXNlSW5PdXRRdWFkKHQpIHsgcmV0dXJuIHQgPCAwLjUgPyAyKnQqdCA6IDEgLSBNYXRoLnBvdygtMip0ICsgMiwgMikvMjsgfQoKZnVuY3Rpb24gc3RhcnRDdXRzY2VuZSgpIHsKICAgIGN1dHNjZW5lQWN0aXZlID0gdHJ1ZTsKICAgIGN1dHNjZW5lVGltZSA9IGN1dHNjZW5lQ2FtZXJhWWF3ID0gY3V0c2NlbmVDYW1lcmFQaXRjaCA9IGhlYWRCb2JUaW1lID0gYXV0b0xvb2tUaW1lID0gbGFzdFBsYXllcklucHV0ID0gMDsKICAgIGNhbkV4aXRDYXIgPSBmYWxzZTsKICAgIGV4aXRDYXJCdXR0b25IaWRkZW4gPSBmYWxzZTsKICAgIHdpZmVTdGF0ZSA9IFdJRkVfU1RBVEUuU0lUVElOR19DQVI7CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnRlcmFjdGlvbi1wcm9tcHQnKS5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICBzdWJ0aXRsZXMuZm9yRWFjaChzID0+IHMudHJpZ2dlcmVkID0gZmFsc2UpOwogICAgaWYgKGF1ZGlvQ3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgYXVkaW9DdHgucmVzdW1lKCk7CiAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY2luZW1hLWJhcicpLmZvckVhY2goYiA9PiBiLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpKTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXRzY2VuZS12aWduZXR0ZScpLmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjcm9zc2hhaXInKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgaWYgKGNvbnRyb2xzKSBjb250cm9scy5kaXNjb25uZWN0KCk7CiAgICBpZiAoIWlzTW9iaWxlKSBkb2N1bWVudC5ib2R5LnJlcXVlc3RQb2ludGVyTG9jaygpOwogICAgCiAgICBpZiAoY2FyT2JqZWN0KSB7CiAgICAgICAgY2FyT2JqZWN0LnBvc2l0aW9uLnNldCgwLCBjYXJPYmplY3QucG9zaXRpb24ueSwgQ0FSX1NUQVJUX1opOwogICAgICAgIGNhck9iamVjdC5yb3RhdGlvbi55ID0gTWF0aC5QSSAvIDI7CiAgICAgICAgcmVnaXN0ZXJDYXJDb2xsaXNpb24oKTsKICAgIH0KICAgIAogICAgLy8gU2hvdyBzaXR0aW5nIHdpZmUsIGhpZGUgb3RoZXJzCiAgICBpZiAoZ2lybFNpdHRpbmdPYmplY3QpIGdpcmxTaXR0aW5nT2JqZWN0LnZpc2libGUgPSB0cnVlOwogICAgaWYgKGdpcmxXYWxraW5nT2JqZWN0KSBnaXJsV2Fsa2luZ09iamVjdC52aXNpYmxlID0gZmFsc2U7CiAgICBpZiAoZ2lybFNvZmFTaXR0aW5nT2JqZWN0KSBnaXJsU29mYVNpdHRpbmdPYmplY3QudmlzaWJsZSA9IGZhbHNlOwp9CgpmdW5jdGlvbiBlbmRDdXRzY2VuZSgpIHsKICAgIGRpc2FibGVFeGl0Q2FyQnV0dG9uKCk7CiAgICAKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXRzY2VuZS1mYWRlJykuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpOwogICAgCiAgICBpZiAoY2FyT2JqZWN0ICYmIHB5Q29sbGlzaW9uRW5naW5lKSB7CiAgICAgICAgcmVnaXN0ZXJDYXJDb2xsaXNpb24oKTsKICAgIH0KICAgIAogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgY3V0c2NlbmVBY3RpdmUgPSBmYWxzZTsKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuY2luZW1hLWJhcicpLmZvckVhY2goYiA9PiBiLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpKTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3V0c2NlbmUtdmlnbmV0dGUnKS5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICAgICAgaGlkZURpYWxvZ3VlKCk7CiAgICAgICAgCiAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnNldChQTEFZRVJfU1BBV05fWCwgUExBWUVSX0hFSUdIVCwgUExBWUVSX1NQQVdOX1opOwogICAgICAgIGNhbWVyYS5sb29rQXQoMCwgUExBWUVSX0hFSUdIVCAtIDYwLCAwKTsKICAgICAgICAKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1dHNjZW5lLWZhZGUnKS5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjcm9zc2hhaXInKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVlc3QtYm94JykuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpLCA1MDApOwogICAgICAgICAgICBpZiAoIWlzTW9iaWxlKSB7IGNvbnRyb2xzLmNvbm5lY3QoKTsgY29udHJvbHMubG9jaygpOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTaG93IHdpZmUgd2Fsa2luZyBwcm9tcHQgYWZ0ZXIgZXhpdGluZyBjYXIKICAgICAgICAgICAgLy8gQXV0b21hdGljYWxseSBzdGFydCB3aWZlIHdhbGtpbmcgYWZ0ZXIgMiBzZWNvbmRzCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKHdpZmVTdGF0ZSA9PT0gV0lGRV9TVEFURS5TSVRUSU5HX0NBUikgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0V2lmZVdhbGtpbmcoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgMjAwMCk7CiAgICAgICAgfSwgMzAwKTsKICAgIH0sIDgwMCk7Cn0KCmZ1bmN0aW9uIGdldERyaXZlclNlYXRXb3JsZFBvc2l0aW9uKGNhclBvcywgY2FyUm90WSkgewogICAgY29uc3QgYyA9IE1hdGguY29zKGNhclJvdFkpLCBzID0gTWF0aC5zaW4oY2FyUm90WSk7CiAgICByZXR1cm4gewogICAgICAgIHg6IGNhclBvcy54ICsgZHJpdmVyU2VhdE9mZnNldC54ICogYyArIGRyaXZlclNlYXRPZmZzZXQueiAqIHMsCiAgICAgICAgeTogY2FyUG9zLnkgKyBkcml2ZXJTZWF0T2Zmc2V0LnksCiAgICAgICAgejogY2FyUG9zLnogLSBkcml2ZXJTZWF0T2Zmc2V0LnggKiBzICsgZHJpdmVyU2VhdE9mZnNldC56ICogYwogICAgfTsKfQoKZnVuY3Rpb24gZ2V0R2lybFNlYXRXb3JsZFBvc2l0aW9uKGNhclBvcywgY2FyUm90WSkgewogICAgY29uc3QgYyA9IE1hdGguY29zKGNhclJvdFkpLCBzID0gTWF0aC5zaW4oY2FyUm90WSk7CiAgICByZXR1cm4gewogICAgICAgIHg6IGNhclBvcy54ICsgZ2lybFNlYXRPZmZzZXQueCAqIGMgKyBnaXJsU2VhdE9mZnNldC56ICogcywKICAgICAgICB5OiBjYXJQb3MueSArIGdpcmxTZWF0T2Zmc2V0LnksCiAgICAgICAgejogY2FyUG9zLnogLSBnaXJsU2VhdE9mZnNldC54ICogcyArIGdpcmxTZWF0T2Zmc2V0LnogKiBjCiAgICB9Owp9CgpmdW5jdGlvbiB1cGRhdGVDdXRzY2VuZShkZWx0YSkgewogICAgaWYgKCFjdXRzY2VuZUFjdGl2ZSB8fCAhY2FyT2JqZWN0KSByZXR1cm47CiAgICAKICAgIGN1dHNjZW5lVGltZSArPSBkZWx0YTsKICAgIGhlYWRCb2JUaW1lICs9IGRlbHRhOwogICAgYXV0b0xvb2tUaW1lICs9IGRlbHRhOwogICAgCiAgICBmb3IgKGNvbnN0IHN1YiBvZiBzdWJ0aXRsZXMpIHsKICAgICAgICBpZiAoY3V0c2NlbmVUaW1lID49IHN1Yi50aW1lICYmICFzdWIudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgIHN1Yi50cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICBzaG93RGlhbG9ndWVMaW5lKHN1Yi50ZXh0LCBzdWIuc3BlYWtlcik7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gaGlkZURpYWxvZ3VlKCksIHN1Yi5kdXJhdGlvbiAqIDEwMDApOwogICAgICAgIH0KICAgIH0KICAgIAogICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbihjdXRzY2VuZVRpbWUgLyAxOCwgMSk7CiAgICBsZXQgY2FyWiwgY2FyWCwgY2FyUm90WTsKICAgIAogICAgaWYgKHByb2dyZXNzIDwgMC43NSkgewogICAgICAgIGNhclogPSBDQVJfU1RBUlRfWiAtIChDQVJfU1RBUlRfWiAtIENBUl9UVVJOX1opICogKHByb2dyZXNzIC8gMC43NSk7CiAgICAgICAgY2FyWCA9IDA7CiAgICAgICAgY2FyUm90WSA9IE1hdGguUEkgLyAyOwogICAgfSBlbHNlIGlmIChwcm9ncmVzcyA8IDAuOTUpIHsKICAgICAgICBjb25zdCB0ID0gZWFzZUluT3V0UXVhZCgocHJvZ3Jlc3MgLSAwLjc1KSAvIDAuMik7CiAgICAgICAgY2FyWiA9IENBUl9UVVJOX1ogLSAoQ0FSX1RVUk5fWiAtIENBUl9FTkRfWikgKiB0OwogICAgICAgIGNhclggPSBDQVJfRU5EX1ggKiB0OwogICAgICAgIGNhclJvdFkgPSBNYXRoLlBJIC8gMiAtIChNYXRoLlBJIC8gNCkgKiB0OwogICAgfSBlbHNlIHsKICAgICAgICBjYXJaID0gQ0FSX0VORF9aOyBjYXJYID0gQ0FSX0VORF9YOwogICAgICAgIGNhclJvdFkgPSBNYXRoLlBJIC8gMiAtIE1hdGguUEkgLyA0OwogICAgICAgIGlmICghY2FuRXhpdENhciAmJiAhZXhpdENhckJ1dHRvbkhpZGRlbikgewogICAgICAgICAgICBzaG93RXhpdENhckJ1dHRvbigpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgY2FyT2JqZWN0LnBvc2l0aW9uLnggPSBjYXJYOwogICAgY2FyT2JqZWN0LnBvc2l0aW9uLnogPSBjYXJaOwogICAgY2FyT2JqZWN0LnJvdGF0aW9uLnkgPSBjYXJSb3RZOwogICAgCiAgICB1cGRhdGVDYXJDb2xsaXNpb24oKTsKICAgIAogICAgY29uc3QgaXNNb3ZpbmcgPSBwcm9ncmVzcyA8IDAuODU7CiAgICBjb25zdCB2aWJZID0gTWF0aC5zaW4oY3V0c2NlbmVUaW1lICogMTIpICogKGlzTW92aW5nID8gMC4wOCA6IDApOwogICAgY29uc3QgYnJlYXRoWSA9IE1hdGguc2luKGhlYWRCb2JUaW1lKSAqIDAuNTsKICAgIAogICAgY29uc3Qgc2VhdCA9IGdldERyaXZlclNlYXRXb3JsZFBvc2l0aW9uKGNhck9iamVjdC5wb3NpdGlvbiwgY2FyT2JqZWN0LnJvdGF0aW9uLnkpOwogICAgc21vb3RoQ2FtWCArPSAoc2VhdC54IC0gc21vb3RoQ2FtWCkgKiAwLjI1OwogICAgc21vb3RoQ2FtWSArPSAoc2VhdC55ICsgdmliWSArIGJyZWF0aFkgLSBzbW9vdGhDYW1ZKSAqIDAuMjU7CiAgICBzbW9vdGhDYW1aICs9IChzZWF0LnogLSBzbW9vdGhDYW1aKSAqIDAuMjU7CiAgICAKICAgIGNhbWVyYS5wb3NpdGlvbi5zZXQoc21vb3RoQ2FtWCwgc21vb3RoQ2FtWSwgc21vb3RoQ2FtWik7CiAgICAKICAgIGxldCBhdXRvWWF3ID0gMCwgYXV0b1BpdGNoID0gMDsKICAgIGlmIChhdXRvTG9va1RpbWUgLSBsYXN0UGxheWVySW5wdXQgPiAyICYmIHByb2dyZXNzID4gMC44NSkgewogICAgICAgIGNvbnN0IGludGVuc2l0eSA9IE1hdGgubWluKChhdXRvTG9va1RpbWUgLSBsYXN0UGxheWVySW5wdXQgLSAyKSAqIDAuMTUsIDAuNSk7CiAgICAgICAgYXV0b1lhdyA9IE1hdGguc2luKGF1dG9Mb29rVGltZSAqIDAuMTUpICogMC4xICogaW50ZW5zaXR5OwogICAgICAgIGF1dG9QaXRjaCA9IE1hdGguc2luKGF1dG9Mb29rVGltZSAqIDAuMSArIDAuNSkgKiAwLjAzICogaW50ZW5zaXR5OwogICAgfQogICAgCiAgICBfZXVsZXIueSA9IGN1dHNjZW5lQ2FtZXJhWWF3ICsgYXV0b1lhdyArIGNhck9iamVjdC5yb3RhdGlvbi55IC0gTWF0aC5QSTsKICAgIF9ldWxlci54ID0gY3V0c2NlbmVDYW1lcmFQaXRjaCArIGF1dG9QaXRjaDsKICAgIGNhbWVyYS5xdWF0ZXJuaW9uLnNldEZyb21FdWxlcihfZXVsZXIpOwogICAgCiAgICAvLyBVcGRhdGUgc2l0dGluZyB3aWZlIHBvc2l0aW9uIGluIGNhciAoeSA9IDIyKQogICAgaWYgKGdpcmxTaXR0aW5nT2JqZWN0ICYmIGdpcmxTaXR0aW5nT2JqZWN0LnZpc2libGUpIHsKICAgICAgICBjb25zdCBncCA9IGdldEdpcmxTZWF0V29ybGRQb3NpdGlvbihjYXJPYmplY3QucG9zaXRpb24sIGNhck9iamVjdC5yb3RhdGlvbi55KTsKICAgICAgICBnaXJsU2l0dGluZ09iamVjdC5wb3NpdGlvbi5zZXQoZ3AueCwgMjIsIGdwLnopOwogICAgICAgIGdpcmxTaXR0aW5nT2JqZWN0LnJvdGF0aW9uLnkgPSBjYXJPYmplY3Qucm90YXRpb24ueSArIE1hdGguUEkgLyAyOwogICAgfQp9CgovLyBMZXZlbCBCdWlsZGVyCmFzeW5jIGZ1bmN0aW9uIGJ1aWxkRm9yZXN0TGV2ZWwoKSB7CiAgICBjb25zb2xlLmxvZygiQnVpbGRpbmcgZm9yZXN0IGxldmVsLi4uIik7CiAgICBzY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKDB4ODdDRUVCKTsKICAgIHNjZW5lLmZvZyA9IG5ldyBUSFJFRS5Gb2coMHg4N0NFRUIsIDgwMCwgMzUwMCk7CiAgICBzY2VuZS5hZGQobmV3IFRIUkVFLkFtYmllbnRMaWdodCgweGZmZmZmZiwgMS40KSk7CgogICAgY29uc3QgdGV4dHVyZUxvYWRlciA9IG5ldyBUSFJFRS5UZXh0dXJlTG9hZGVyKCk7CgogICAgLy8gR3JvdW5kCiAgICBjb25zdCBmbG9vclRleCA9IHRleHR1cmVMb2FkZXIubG9hZCgnaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0ZlbGlwZTkyNzI3MjcvVGV4dHVyYXMtcHJvLWpvZ28vbWFpbi9maWxlXzAwMDAwMDAwYjg5MDcxZjY5ODRjYTI1NjU0Y2IyZjZlLnBuZycpOwogICAgZmxvb3JUZXgud3JhcFMgPSBmbG9vclRleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgZmxvb3JUZXgucmVwZWF0LnNldCg0MCwgNDApOwogICAgZmxvb3JUZXguY29sb3JTcGFjZSA9IFRIUkVFLlNSR0JDb2xvclNwYWNlOwogICAgCiAgICBjb25zdCBncm91bmQgPSBuZXcgVEhSRUUuTWVzaCgKICAgICAgICBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeShNQVBfU0laRSwgTUFQX1NJWkUpLAogICAgICAgIG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IG1hcDogZmxvb3JUZXggfSkKICAgICk7CiAgICBncm91bmQucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgIGdyb3VuZC5wb3NpdGlvbi5zZXQoMCwgLTIsIDE1MDApOwogICAgZ3JvdW5kLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKICAgIGdyb3VuZC51cGRhdGVNYXRyaXgoKTsKICAgIHNjZW5lLmFkZChncm91bmQpOwoKICAgIC8vIENsZWFyaW5nCiAgICBjb25zdCBncmFzc1RleCA9IHRleHR1cmVMb2FkZXIubG9hZCgnaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0ZlbGlwZTkyNzI3MjcvVGV4dHVyYXMtcHJvLWpvZ28vbWFpbi9maWxlXzAwMDAwMDAwMmQxODcxZjY5MTA5YjNjYzI5YTFiNmEyLnBuZycpOwogICAgZ3Jhc3NUZXgud3JhcFMgPSBncmFzc1RleC53cmFwVCA9IFRIUkVFLlJlcGVhdFdyYXBwaW5nOwogICAgZ3Jhc3NUZXgucmVwZWF0LnNldCg4LCA4KTsKICAgIGdyYXNzVGV4LmNvbG9yU3BhY2UgPSBUSFJFRS5TUkdCQ29sb3JTcGFjZTsKCiAgICBjb25zdCBjbGVhcmluZyA9IG5ldyBUSFJFRS5NZXNoKAogICAgICAgIG5ldyBUSFJFRS5DaXJjbGVHZW9tZXRyeShDTEVBUklOR19SQURJVVMsIDE2KSwKICAgICAgICBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBtYXA6IGdyYXNzVGV4IH0pCiAgICApOwogICAgY2xlYXJpbmcucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgIGNsZWFyaW5nLnBvc2l0aW9uLnkgPSAxOwogICAgY2xlYXJpbmcubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwogICAgY2xlYXJpbmcudXBkYXRlTWF0cml4KCk7CiAgICBzY2VuZS5hZGQoY2xlYXJpbmcpOwoKICAgIC8vIDNEIEdyYXNzCiAgICBjb25zdCBncmFzc1Bvc2l0aW9ucyA9IFtdOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNDAwMDsgaSsrKSB7CiAgICAgICAgY29uc3QgciA9IDUwICsgTWF0aC5yYW5kb20oKSAqIChDTEVBUklOR19SQURJVVMgLSAzMCk7CiAgICAgICAgY29uc3QgdGhldGEgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CiAgICAgICAgY29uc3QgeCA9IHIgKiBNYXRoLmNvcyh0aGV0YSksIHogPSByICogTWF0aC5zaW4odGhldGEpOwogICAgICAgIAogICAgICAgIGlmIChNYXRoLmFicyh4KSA8IDMyMCAmJiBNYXRoLmFicyh6KSA8IDI4MCkgY29udGludWU7CiAgICAgICAgaWYgKHogPiBST0FEX1NUQVJUX1ogLSAxMDAgJiYgTWF0aC5hYnMoeCkgPCBST0FEX1dJRFRIICsgNTApIGNvbnRpbnVlOwogICAgICAgIGlmICh4ID4gMjgwICYmIHggPCA0NTAgJiYgeiA+IDM1MCAmJiB6IDwgNTUwKSBjb250aW51ZTsKICAgICAgICBpZiAoaXNJbkx1bWJlclBhdGgoeCwgeikpIGNvbnRpbnVlOwogICAgICAgIAogICAgICAgIGdyYXNzUG9zaXRpb25zLnB1c2goeyB4LCB6LCByb3Q6IE1hdGgucmFuZG9tKCkgKiBNYXRoLlBJICogMiwgc2NhbGU6IDAuOCArIE1hdGgucmFuZG9tKCkgKiAwLjYgfSk7CiAgICB9CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTYwMDA7IGkrKykgewogICAgICAgIGNvbnN0IHIgPSBDTEVBUklOR19SQURJVVMgKyBNYXRoLnJhbmRvbSgpICogMjUwOwogICAgICAgIGNvbnN0IHRoZXRhID0gTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyOwogICAgICAgIGNvbnN0IHggPSByICogTWF0aC5jb3ModGhldGEpLCB6ID0gciAqIE1hdGguc2luKHRoZXRhKTsKICAgICAgICAKICAgICAgICBpZiAoeiA+IFJPQURfU1RBUlRfWiAtIDEwMCAmJiBNYXRoLmFicyh4KSA8IFJPQURfV0lEVEggKyAxMDApIGNvbnRpbnVlOwogICAgICAgIGlmIChpc0luTHVtYmVyUGF0aCh4LCB6KSB8fCBpc0luTHVtYmVyQXJlYSh4LCB6KSkgY29udGludWU7CiAgICAgICAgCiAgICAgICAgZ3Jhc3NQb3NpdGlvbnMucHVzaCh7IHgsIHosIHJvdDogTWF0aC5yYW5kb20oKSAqIE1hdGguUEkgKiAyLCBzY2FsZTogMC42ICsgTWF0aC5yYW5kb20oKSAqIDAuNSB9KTsKICAgIH0KICAgIAogICAgY29uc3QgZ3Jhc3NNYXQgPSBuZXcgVEhSRUUuU2hhZGVyTWF0ZXJpYWwoewogICAgICAgIHVuaWZvcm1zOiB7IHRpbWU6IHsgdmFsdWU6IDAgfSwgcGxheWVyUG9zOiB7IHZhbHVlOiBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCA0MDApIH0gfSwKICAgICAgICB2ZXJ0ZXhTaGFkZXI6IGAKICAgICAgICAgICAgdW5pZm9ybSBmbG9hdCB0aW1lOwogICAgICAgICAgICB1bmlmb3JtIHZlYzMgcGxheWVyUG9zOwogICAgICAgICAgICBhdHRyaWJ1dGUgdmVjMyBpbnN0YW5jZVBvc2l0aW9uOwogICAgICAgICAgICBhdHRyaWJ1dGUgZmxvYXQgaW5zdGFuY2VSb3RhdGlvbjsKICAgICAgICAgICAgYXR0cmlidXRlIGZsb2F0IGluc3RhbmNlU2NhbGU7CiAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgIHZVdiA9IHV2OwogICAgICAgICAgICAgICAgZmxvYXQgYyA9IGNvcyhpbnN0YW5jZVJvdGF0aW9uKSwgcyA9IHNpbihpbnN0YW5jZVJvdGF0aW9uKTsKICAgICAgICAgICAgICAgIHZlYzMgcG9zID0gcG9zaXRpb24gKiBpbnN0YW5jZVNjYWxlOwogICAgICAgICAgICAgICAgcG9zLnh6ID0gbWF0MihjLCAtcywgcywgYykgKiBwb3MueHo7CiAgICAgICAgICAgICAgICB2ZWMzIHdvcmxkUG9zID0gcG9zICsgaW5zdGFuY2VQb3NpdGlvbjsKICAgICAgICAgICAgICAgIGZsb2F0IGhmID0gY2xhbXAocG9zaXRpb24ueSAvIDMwLjAsIDAuMCwgMS4wKTsKICAgICAgICAgICAgICAgIGZsb2F0IHdzID0gdGltZSAqIDMuMDsKICAgICAgICAgICAgICAgIHdvcmxkUG9zLnggKz0gc2luKHdzICsgaW5zdGFuY2VQb3NpdGlvbi54ICogMC4wMTUgKyBpbnN0YW5jZVBvc2l0aW9uLnogKiAwLjAxKSAqIGhmICogaGYgKiAyMC4wOwogICAgICAgICAgICAgICAgd29ybGRQb3MueiArPSBjb3Mod3MgKiAwLjcgKyBpbnN0YW5jZVBvc2l0aW9uLnogKiAwLjAxMikgKiBoZiAqIGhmICogMTIuMDsKICAgICAgICAgICAgICAgIHZlYzIgdG9QbGF5ZXIgPSB3b3JsZFBvcy54eiAtIHBsYXllclBvcy54ejsKICAgICAgICAgICAgICAgIGZsb2F0IGRpc3QgPSBsZW5ndGgodG9QbGF5ZXIpOwogICAgICAgICAgICAgICAgaWYgKGRpc3QgPCAxMjAuMCAmJiBkaXN0ID4gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgd29ybGRQb3MueHogKz0gKHRvUGxheWVyIC8gZGlzdCkgKiAoMS4wIC0gZGlzdCAvIDEyMC4wKSAqIGhmICogNDAuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQod29ybGRQb3MsIDEuMCk7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgICAgIGZyYWdtZW50U2hhZGVyOiBgCiAgICAgICAgICAgIHZhcnlpbmcgdmVjMiB2VXY7CiAgICAgICAgICAgIHZvaWQgbWFpbigpIHsKICAgICAgICAgICAgICAgIHZlYzMgY29sID0gbWl4KHZlYzMoMC4xOCwgMC4zMiwgMC4xMiksIHZlYzMoMC40MCwgMC42MCwgMC4yOCksIHZVdi55KTsKICAgICAgICAgICAgICAgIGZsb2F0IGEgPSBzbW9vdGhzdGVwKDAuMCwgMC4xNSwgdlV2LnkpOwogICAgICAgICAgICAgICAgaWYgKGEgPCAwLjEpIGRpc2NhcmQ7CiAgICAgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KGNvbCwgYSk7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLAogICAgICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsCiAgICAgICAgZGVwdGhXcml0ZTogZmFsc2UKICAgIH0pOwogICAgCiAgICBjaHVua01hbmFnZXIuZ3Jhc3NNYXRlcmlhbCA9IGdyYXNzTWF0OwogICAgY2h1bmtNYW5hZ2VyLnJlZ2lzdGVyR3Jhc3NEYXRhKGdyYXNzUG9zaXRpb25zKTsKICAgIHdpbmRvdy5ncmFzc1VuaWZvcm1zID0gZ3Jhc3NNYXQudW5pZm9ybXM7CgogICAgLy8gUm9hZAogICAgY29uc3Qgcm9hZFRleCA9IHRleHR1cmVMb2FkZXIubG9hZCgnaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0ZlbGlwZTkyNzI3MjcvVGV4dHVyYS1qc2pzL21haW4vZmlsZV8wMDAwMDAwMDk0NWM3MjBlODI5OWY2ZWM4MDU0N2M1ZC5wbmcnKTsKICAgIHJvYWRUZXgud3JhcFMgPSByb2FkVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICByb2FkVGV4LnJlcGVhdC5zZXQoMSwgMTUpOwogICAgcm9hZFRleC5jb2xvclNwYWNlID0gVEhSRUUuU1JHQkNvbG9yU3BhY2U7CiAgICAKICAgIGNvbnN0IHJvYWQgPSBuZXcgVEhSRUUuTWVzaCgKICAgICAgICBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeShST0FEX1dJRFRIICogMiwgMzAwMCksCiAgICAgICAgbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgbWFwOiByb2FkVGV4IH0pCiAgICApOwogICAgcm9hZC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgcm9hZC5wb3NpdGlvbi5zZXQoMCwgMiwgUk9BRF9TVEFSVF9aICsgMTUwMCk7CiAgICByb2FkLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKICAgIHJvYWQudXBkYXRlTWF0cml4KCk7CiAgICBzY2VuZS5hZGQocm9hZCk7CgogICAgY29uc3QgcGFya2luZyA9IG5ldyBUSFJFRS5NZXNoKAogICAgICAgIG5ldyBUSFJFRS5QbGFuZUdlb21ldHJ5KDIwMCwgMjAwKSwKICAgICAgICBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHg3YTZhNTUgfSkKICAgICk7CiAgICBwYXJraW5nLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICBwYXJraW5nLnBvc2l0aW9uLnNldCgzNTAsIDIuNSwgNDUwKTsKICAgIHBhcmtpbmcubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwogICAgcGFya2luZy51cGRhdGVNYXRyaXgoKTsKICAgIHNjZW5lLmFkZChwYXJraW5nKTsKCiAgICBidWlsZEx1bWJlclBhdGgoKTsKICAgIGF3YWl0IGxvYWRDYXJBbmRHaXJsKCk7CiAgICBhd2FpdCBidWlsZENhYmluV2l0aEZ1cm5pdHVyZSgpOwogICAgYXdhaXQgbG9hZFRyZWVzKCk7CiAgICAKICAgIGNodW5rTWFuYWdlci51cGRhdGUoMCwgQ0FSX1NUQVJUX1opOwogICAgCiAgICBpZiAocHlDb2xsaXNpb25FbmdpbmUpIHB5Q29sbGlzaW9uRW5naW5lLnByaW50X3JlcG9ydCgpOwogICAgY29uc29sZS5sb2coIkZvcmVzdCBsZXZlbCBidWlsdCEiKTsKfQoKYXN5bmMgZnVuY3Rpb24gbG9hZENhckFuZEdpcmwoKSB7CiAgICBjb25zdCBsb2FkZXIgPSBuZXcgR0xURkxvYWRlcigpOwogICAgY29uc3QgQkFTRV9VUkwgPSAiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0ZlbGlwZTkyNzI3MjcvIjsKICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCBjYXJHbHRmID0gYXdhaXQgbG9hZGVyLmxvYWRBc3luYyhCQVNFX1VSTCArICJNLXZlaXMtaGVoZS9tYWluL2JsYWNrK3N1diszZCttb2RlbC5nbGIiKTsKICAgICAgICBjb25zdCBjYXIgPSBjYXJHbHRmLnNjZW5lOwogICAgICAgIGNhci5zY2FsZS5zZXRTY2FsYXIoNDgwKTsKICAgICAgICBjb25zdCBib3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QoY2FyKTsKICAgICAgICBjYXIucG9zaXRpb24uc2V0KDAsIDIgLSBib3gubWluLnksIENBUl9TVEFSVF9aKTsKICAgICAgICBjYXIucm90YXRpb24ueSA9IE1hdGguUEkgLyAyOwogICAgICAgIGNhci50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgaWYgKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYy5tYXRyaXhBdXRvVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChjLm1hdGVyaWFsKSB7IGMubWF0ZXJpYWwuZW52TWFwID0gbnVsbDsgYy5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7IH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHNjZW5lLmFkZChjYXIpOwogICAgICAgIGNhci51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKICAgICAgICBjYXJPYmplY3QgPSBjYXI7CiAgICAgICAgCiAgICAgICAgcmVnaXN0ZXJDYXJDb2xsaXNpb24oKTsKICAgICAgICAKICAgICAgICBjb25zdCBzZWF0ID0gZ2V0RHJpdmVyU2VhdFdvcmxkUG9zaXRpb24oY2FyLnBvc2l0aW9uLCBjYXIucm90YXRpb24ueSk7CiAgICAgICAgc21vb3RoQ2FtWCA9IHNlYXQueDsgc21vb3RoQ2FtWSA9IHNlYXQueTsgc21vb3RoQ2FtWiA9IHNlYXQuejsKICAgICAgICAKICAgICAgICAvLyBMb2FkIFNJVFRJTkcgd2lmZSBmb3IgY2FyIChzYW1lIHNjYWxlIGFzIHdhbGtpbmcpCiAgICAgICAgY29uc3QgZ2lybFNpdHRpbmdHbHRmID0gYXdhaXQgbG9hZGVyLmxvYWRBc3luYyhCQVNFX1VSTCArICJBbmltYXRpb25zL21haW4vSW1hZ2VUb1N0bC5jb21fU2l0dGluZyUyQlRhbGtpbmcoMikuZ2xiIik7CiAgICAgICAgY29uc3QgZ2lybFNpdHRpbmcgPSBnaXJsU2l0dGluZ0dsdGYuc2NlbmU7CiAgICAgICAgCiAgICAgICAgLy8gQ2FsY3VsYXRlIHNjYWxlIHRvIG1hdGNoIHRhcmdldCBoZWlnaHQKICAgICAgICBjb25zdCBzaXR0aW5nQm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KGdpcmxTaXR0aW5nKTsKICAgICAgICBjb25zdCBzaXR0aW5nSGVpZ2h0ID0gc2l0dGluZ0JveC5tYXgueSAtIHNpdHRpbmdCb3gubWluLnk7CiAgICAgICAgY29uc3Qgc2l0dGluZ1NjYWxlID0gV0lGRV9DSEFSQUNURVJfU0NBTEUgLyBzaXR0aW5nSGVpZ2h0OwogICAgICAgIGdpcmxTaXR0aW5nLnNjYWxlLnNldFNjYWxhcihzaXR0aW5nU2NhbGUpOwogICAgICAgIAogICAgICAgIGNvbnN0IGdwID0gZ2V0R2lybFNlYXRXb3JsZFBvc2l0aW9uKGNhci5wb3NpdGlvbiwgY2FyLnJvdGF0aW9uLnkpOwogICAgICAgIGdpcmxTaXR0aW5nLnBvc2l0aW9uLnNldChncC54LCAyMiwgZ3Aueik7CiAgICAgICAgZ2lybFNpdHRpbmcucm90YXRpb24ueSA9IGNhci5yb3RhdGlvbi55ICsgTWF0aC5QSSAvIDI7CiAgICAgICAgCiAgICAgICAgaWYgKGdpcmxTaXR0aW5nR2x0Zi5hbmltYXRpb25zPy5sZW5ndGgpIHsKICAgICAgICAgICAgY29uc3QgbWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIoZ2lybFNpdHRpbmcpOwogICAgICAgICAgICBjb25zdCBhY3Rpb24gPSBtaXhlci5jbGlwQWN0aW9uKGdpcmxTaXR0aW5nR2x0Zi5hbmltYXRpb25zWzBdKTsKICAgICAgICAgICAgYWN0aW9uLnBsYXkoKTsgYWN0aW9uLnBhdXNlZCA9IHRydWU7CiAgICAgICAgICAgIG1peGVycy5wdXNoKG1peGVyKTsKICAgICAgICB9CiAgICAgICAgZ2lybFNpdHRpbmcudHJhdmVyc2UoYyA9PiB7IGlmIChjLmlzTWVzaCkgeyBjLmZydXN0dW1DdWxsZWQgPSB0cnVlOyBjLm1hdHJpeEF1dG9VcGRhdGUgPSB0cnVlOyB9IH0pOwogICAgICAgIHNjZW5lLmFkZChnaXJsU2l0dGluZyk7CiAgICAgICAgZ2lybFNpdHRpbmdPYmplY3QgPSBnaXJsU2l0dGluZzsKICAgICAgICBnaXJsT2JqZWN0ID0gZ2lybFNpdHRpbmc7ICAvLyBLZWVwIHJlZmVyZW5jZSBmb3IgY29tcGF0aWJpbGl0eQogICAgICAgIAogICAgICAgIC8vIExvYWQgV0FMS0lORyB3aWZlIChzYW1lIHNjYWxlIGFzIHNpdHRpbmcpCiAgICAgICAgY29uc3QgZ2lybFdhbGtpbmdHbHRmID0gYXdhaXQgbG9hZGVyLmxvYWRBc3luYyhCQVNFX1VSTCArICJBbmltYXRpb25zL21haW4vSW1hZ2VUb1N0bGNvbVdhbGtpbmcoMykuZ2xiIik7CiAgICAgICAgY29uc3QgZ2lybFdhbGtpbmcgPSBnaXJsV2Fsa2luZ0dsdGYuc2NlbmU7CiAgICAgICAgCiAgICAgICAgLy8gQ2FsY3VsYXRlIHNjYWxlIHRvIG1hdGNoIHRhcmdldCBoZWlnaHQKICAgICAgICBjb25zdCB3YWxraW5nQm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KGdpcmxXYWxraW5nKTsKICAgICAgICBjb25zdCB3YWxraW5nSGVpZ2h0ID0gd2Fsa2luZ0JveC5tYXgueSAtIHdhbGtpbmdCb3gubWluLnk7CiAgICAgICAgY29uc3Qgd2Fsa2luZ1NjYWxlID0gV0lGRV9DSEFSQUNURVJfU0NBTEUgLyB3YWxraW5nSGVpZ2h0OwogICAgICAgIGdpcmxXYWxraW5nLnNjYWxlLnNldFNjYWxhcih3YWxraW5nU2NhbGUpOwogICAgICAgIAogICAgICAgIGdpcmxXYWxraW5nLnBvc2l0aW9uLnNldChncC54LCAyMiwgZ3Aueik7CiAgICAgICAgZ2lybFdhbGtpbmcudmlzaWJsZSA9IGZhbHNlOyAgLy8gSGlkZGVuIGluaXRpYWxseQogICAgICAgIAogICAgICAgIGlmIChnaXJsV2Fsa2luZ0dsdGYuYW5pbWF0aW9ucz8ubGVuZ3RoKSB7CiAgICAgICAgICAgIHdpZmVXYWxraW5nTWl4ZXIgPSBuZXcgVEhSRUUuQW5pbWF0aW9uTWl4ZXIoZ2lybFdhbGtpbmcpOwogICAgICAgICAgICBjb25zdCBhY3Rpb24gPSB3aWZlV2Fsa2luZ01peGVyLmNsaXBBY3Rpb24oZ2lybFdhbGtpbmdHbHRmLmFuaW1hdGlvbnNbMF0pOwogICAgICAgICAgICBhY3Rpb24ucGxheSgpOwogICAgICAgICAgICBtaXhlcnMucHVzaCh3aWZlV2Fsa2luZ01peGVyKTsKICAgICAgICB9CiAgICAgICAgZ2lybFdhbGtpbmcudHJhdmVyc2UoYyA9PiB7IGlmIChjLmlzTWVzaCkgeyBjLmZydXN0dW1DdWxsZWQgPSB0cnVlOyBjLm1hdHJpeEF1dG9VcGRhdGUgPSB0cnVlOyB9IH0pOwogICAgICAgIHNjZW5lLmFkZChnaXJsV2Fsa2luZyk7CiAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QgPSBnaXJsV2Fsa2luZzsKICAgICAgICAKICAgICAgICAvLyBMb2FkIFNJVFRJTkcgd2lmZSBmb3Igc29mYSAoc2FtZSBtb2RlbCBhcyBjYXIgc2l0dGluZywgc2FtZSBzY2FsZSkKICAgICAgICBjb25zdCBnaXJsU29mYUdsdGYgPSBhd2FpdCBsb2FkZXIubG9hZEFzeW5jKEJBU0VfVVJMICsgIkFuaW1hdGlvbnMvbWFpbi9JbWFnZVRvU3RsLmNvbV9TaXR0aW5nJTJCVGFsa2luZygyKS5nbGIiKTsKICAgICAgICBjb25zdCBnaXJsU29mYSA9IGdpcmxTb2ZhR2x0Zi5zY2VuZTsKICAgICAgICAKICAgICAgICAvLyBTYW1lIHNjYWxlIGFzIHNpdHRpbmcgaW4gY2FyCiAgICAgICAgY29uc3Qgc29mYUJveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChnaXJsU29mYSk7CiAgICAgICAgY29uc3Qgc29mYUhlaWdodCA9IHNvZmFCb3gubWF4LnkgLSBzb2ZhQm94Lm1pbi55OwogICAgICAgIGNvbnN0IHNvZmFTY2FsZSA9IFdJRkVfQ0hBUkFDVEVSX1NDQUxFIC8gc29mYUhlaWdodDsKICAgICAgICBnaXJsU29mYS5zY2FsZS5zZXRTY2FsYXIoc29mYVNjYWxlKTsKICAgICAgICAKICAgICAgICBnaXJsU29mYS5wb3NpdGlvbi5zZXQoU09GQV9QT1NJVElPTi54LCAyMiwgU09GQV9QT1NJVElPTi56KTsKICAgICAgICBnaXJsU29mYS5yb3RhdGlvbi55ID0gU09GQV9QT1NJVElPTi5yb3RZIHx8IDA7CiAgICAgICAgZ2lybFNvZmEudmlzaWJsZSA9IGZhbHNlOyAgLy8gSGlkZGVuIGluaXRpYWxseQogICAgICAgIAogICAgICAgIGlmIChnaXJsU29mYUdsdGYuYW5pbWF0aW9ucz8ubGVuZ3RoKSB7CiAgICAgICAgICAgIGNvbnN0IG1peGVyID0gbmV3IFRIUkVFLkFuaW1hdGlvbk1peGVyKGdpcmxTb2ZhKTsKICAgICAgICAgICAgY29uc3QgYWN0aW9uID0gbWl4ZXIuY2xpcEFjdGlvbihnaXJsU29mYUdsdGYuYW5pbWF0aW9uc1swXSk7CiAgICAgICAgICAgIGFjdGlvbi5wbGF5KCk7CiAgICAgICAgICAgIG1peGVycy5wdXNoKG1peGVyKTsKICAgICAgICB9CiAgICAgICAgZ2lybFNvZmEudHJhdmVyc2UoYyA9PiB7IGlmIChjLmlzTWVzaCkgeyBjLmZydXN0dW1DdWxsZWQgPSB0cnVlOyBjLm1hdHJpeEF1dG9VcGRhdGUgPSB0cnVlOyB9IH0pOwogICAgICAgIHNjZW5lLmFkZChnaXJsU29mYSk7CiAgICAgICAgZ2lybFNvZmFTaXR0aW5nT2JqZWN0ID0gZ2lybFNvZmE7CiAgICAgICAgCiAgICAgICAgY29uc29sZS5sb2coYFtXaWZlXSBBbGwgbW9kZWxzIGxvYWRlZCB3aXRoIHNjYWxlICR7V0lGRV9DSEFSQUNURVJfU0NBTEV9YCk7CiAgICAgICAgCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJyb3IgbG9hZGluZyBjYXIvZ2lybDoiLCBlKTsKICAgIH0KfQoKZnVuY3Rpb24gYnVpbGRMdW1iZXJQYXRoKCkgewogICAgY29uc3QgZGlyWCA9IE1hdGguY29zKExVTUJFUl9QQVRIX0FOR0xFKTsKICAgIGNvbnN0IGRpclogPSBNYXRoLnNpbihMVU1CRVJfUEFUSF9BTkdMRSk7CiAgICBjb25zdCBwYXRoRGlzdCA9IENMRUFSSU5HX1JBRElVUyArIExVTUJFUl9QQVRIX0xFTkdUSCAvIDIgLSAyMDA7CiAgICAKICAgIGNvbnN0IHBhdGggPSBuZXcgVEhSRUUuTWVzaCgKICAgICAgICBuZXcgVEhSRUUuUGxhbmVHZW9tZXRyeShMVU1CRVJfUEFUSF9XSURUSCAqIDIsIExVTUJFUl9QQVRIX0xFTkdUSCArIDIwMCksCiAgICAgICAgbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4OUI4MzY1IH0pCiAgICApOwogICAgcGF0aC5yb3RhdGlvbi54ID0gLU1hdGguUEkgLyAyOwogICAgcGF0aC5yb3RhdGlvbi56ID0gLUxVTUJFUl9QQVRIX0FOR0xFICsgTWF0aC5QSSAvIDI7CiAgICBwYXRoLnBvc2l0aW9uLnNldChkaXJYICogcGF0aERpc3QsIDIuNSwgZGlyWiAqIHBhdGhEaXN0KTsKICAgIHBhdGgubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwogICAgcGF0aC51cGRhdGVNYXRyaXgoKTsKICAgIHNjZW5lLmFkZChwYXRoKTsKICAgIAogICAgY29uc3QgbHVtYmVyQ2xlYXIgPSBuZXcgVEhSRUUuTWVzaCgKICAgICAgICBuZXcgVEhSRUUuQ2lyY2xlR2VvbWV0cnkoTFVNQkVSX0FSRUFfUkFESVVTLCAxMiksCiAgICAgICAgbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4NWE3YTRhIH0pCiAgICApOwogICAgbHVtYmVyQ2xlYXIucm90YXRpb24ueCA9IC1NYXRoLlBJIC8gMjsKICAgIGx1bWJlckNsZWFyLnBvc2l0aW9uLnNldChMVU1CRVJfQVJFQV9DRU5URVJfWCwgMywgTFVNQkVSX0FSRUFfQ0VOVEVSX1opOwogICAgbHVtYmVyQ2xlYXIubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwogICAgbHVtYmVyQ2xlYXIudXBkYXRlTWF0cml4KCk7CiAgICBzY2VuZS5hZGQobHVtYmVyQ2xlYXIpOwogICAgCiAgICBjb25zdCB3b3JrQXJlYSA9IG5ldyBUSFJFRS5NZXNoKAogICAgICAgIG5ldyBUSFJFRS5DaXJjbGVHZW9tZXRyeSgxMDAsIDgpLAogICAgICAgIG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDhCNzM1NSB9KQogICAgKTsKICAgIHdvcmtBcmVhLnJvdGF0aW9uLnggPSAtTWF0aC5QSSAvIDI7CiAgICB3b3JrQXJlYS5wb3NpdGlvbi5zZXQoTFVNQkVSX0FSRUFfQ0VOVEVSX1gsIDQsIExVTUJFUl9BUkVBX0NFTlRFUl9aKTsKICAgIHdvcmtBcmVhLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKICAgIHdvcmtBcmVhLnVwZGF0ZU1hdHJpeCgpOwogICAgc2NlbmUuYWRkKHdvcmtBcmVhKTsKICAgIAogICAgY29uc3Qgc3R1bXBHZW8gPSBuZXcgVEhSRUUuQ3lsaW5kZXJHZW9tZXRyeSgyNSwgMzUsIDMwLCA2KTsKICAgIGNvbnN0IHN0dW1wTWF0ID0gbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4NUQ0RTM3IH0pOwogICAgW3t4OiAwLCB6OiAwfSwge3g6IDEyMCwgejogLTYwfSwge3g6IC0xMDAsIHo6IDgwfV0uZm9yRWFjaCgoc3AsIGkpID0+IHsKICAgICAgICBjb25zdCBzdHVtcCA9IG5ldyBUSFJFRS5NZXNoKHN0dW1wR2VvLCBzdHVtcE1hdCk7CiAgICAgICAgY29uc3Qgc3ggPSBMVU1CRVJfQVJFQV9DRU5URVJfWCArIHNwLng7CiAgICAgICAgY29uc3Qgc3ogPSBMVU1CRVJfQVJFQV9DRU5URVJfWiArIHNwLno7CiAgICAgICAgc3R1bXAucG9zaXRpb24uc2V0KHN4LCAxNSwgc3opOwogICAgICAgIHN0dW1wLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKICAgICAgICBzdHVtcC51cGRhdGVNYXRyaXgoKTsKICAgICAgICBzY2VuZS5hZGQoc3R1bXApOwogICAgICAgIGlmIChweUNvbGxpc2lvbkVuZ2luZSkgcHlDb2xsaXNpb25FbmdpbmUucmVnaXN0ZXJfY3lsaW5kZXIoYHN0dW1wXyR7aX1gLCBzeCwgc3osIDM1KTsKICAgIH0pOwp9Cgphc3luYyBmdW5jdGlvbiBidWlsZENhYmluV2l0aEZ1cm5pdHVyZSgpIHsKICAgIGNvbnN0IGxvYWRlciA9IG5ldyBHTFRGTG9hZGVyKCk7CiAgICBjb25zdCB0ZXh0dXJlTG9hZGVyID0gbmV3IFRIUkVFLlRleHR1cmVMb2FkZXIoKTsKCiAgICBpZiAocHlDb2xsaXNpb25FbmdpbmUpIHsKICAgICAgICBweUNvbGxpc2lvbkVuZ2luZS5yZWdpc3Rlcl9wcmVjaXNlX2NhYmluKCk7CiAgICB9CgogICAgbGV0IHdhbGxUZXg7CiAgICB0cnkgewogICAgICAgIHdhbGxUZXggPSBhd2FpdCB0ZXh0dXJlTG9hZGVyLmxvYWRBc3luYygnaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0ZlbGlwZTkyNzI3MjcvVGV4dHVyYXMtcHJvLWpvZ28vbWFpbi9maWxlXzAwMDAwMDAwOGY1ODcyMGU4MWYyMGQ0ZjEyYmNiMWIxLnBuZycpOwogICAgICAgIHdhbGxUZXgud3JhcFMgPSB3YWxsVGV4LndyYXBUID0gVEhSRUUuUmVwZWF0V3JhcHBpbmc7CiAgICAgICAgd2FsbFRleC5jb2xvclNwYWNlID0gVEhSRUUuU1JHQkNvbG9yU3BhY2U7CiAgICB9IGNhdGNoIChlKSB7fQoKICAgIGxldCBjYWJpbk1vZGVsOwogICAgdHJ5IHsKICAgICAgICBjb25zdCBjYWJpbkdsdGYgPSBhd2FpdCBsb2FkZXIubG9hZEFzeW5jKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRmVsaXBlOTI3MjcyNy9NLXZlaXMtaGVoZS9tYWluL01lc2h5X0FJXzNEX21vZGVsX29mX2FuX2FiYW5kb18wMTMwMTc1NTI4X3RleHR1cmUuZ2xiJyk7CiAgICAgICAgY2FiaW5Nb2RlbCA9IGNhYmluR2x0Zi5zY2VuZTsKICAgICAgICBjYWJpbk1vZGVsLnRyYXZlcnNlKGMgPT4geyBpZiAoYy5pc01lc2gpIHsgYy5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7IGMuZnJ1c3R1bUN1bGxlZCA9IHRydWU7IH0gfSk7CiAgICAgICAgCiAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KGNhYmluTW9kZWwpOwogICAgICAgIGNvbnN0IHNjYWxlID0gODAwIC8gYm94LmdldFNpemUobmV3IFRIUkVFLlZlY3RvcjMoKSkueDsKICAgICAgICBjYWJpbk1vZGVsLnNjYWxlLnNldFNjYWxhcihzY2FsZSk7CiAgICAgICAgY2FiaW5Nb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKICAgICAgICAKICAgICAgICBjb25zdCBzY2FsZWRCb3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3QoY2FiaW5Nb2RlbCk7CiAgICAgICAgY2FiaW5Nb2RlbC5wb3NpdGlvbi5zZXQoMCwgLXNjYWxlZEJveC5taW4ueSArIDEgLSA0MCwgMCk7CiAgICAgICAgY2FiaW5Nb2RlbC51cGRhdGVNYXRyaXhXb3JsZCh0cnVlKTsKICAgICAgICBzY2VuZS5hZGQoY2FiaW5Nb2RlbCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiRXJyb3IgbG9hZGluZyBjYWJpbjoiLCBlKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIGNvbnN0IGJhY2tXYWxsID0gbmV3IFRIUkVFLk1lc2goCiAgICAgICAgbmV3IFRIUkVFLlBsYW5lR2VvbWV0cnkoNDQ1LCAzMzApLAogICAgICAgIG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IG1hcDogd2FsbFRleCwgc2lkZTogVEhSRUUuRG91YmxlU2lkZSB9KQogICAgKTsKICAgIGJhY2tXYWxsLnBvc2l0aW9uLnNldCgwLCAxMjUsIC0xNzApOwogICAgYmFja1dhbGwubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwogICAgYmFja1dhbGwudXBkYXRlTWF0cml4KCk7CiAgICBzY2VuZS5hZGQoYmFja1dhbGwpOwogICAgCiAgICBjb25zdCBjYWJpbkxpZ2h0ID0gbmV3IFRIUkVFLlBvaW50TGlnaHQoMHhmZmRkYWEsIDEuNSwgNTAwKTsKICAgIGNhYmluTGlnaHQucG9zaXRpb24uc2V0KDAsIDIxMCwgNTApOwogICAgc2NlbmUuYWRkKGNhYmluTGlnaHQpOwoKICAgIGxldCBsYXlvdXQgPSB7fTsKICAgIGlmIChweUNvbGxpc2lvbkVuZ2luZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxheW91dCA9IEpTT04ucGFyc2UocHlDb2xsaXNpb25FbmdpbmUuZ2V0X2Z1cm5pdHVyZV9sYXlvdXQoKSk7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0KCiAgICBjb25zdCBsb2FkRnVybml0dXJlID0gYXN5bmMgKHVybCwgaGVpZ2h0LCB4LCB6LCByb3RZLCBuYW1lLCBjYXRlZ29yeSkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGdsdGYgPSBhd2FpdCBsb2FkZXIubG9hZEFzeW5jKHVybCk7CiAgICAgICAgICAgIGNvbnN0IHByb3AgPSBnbHRmLnNjZW5lOwogICAgICAgICAgICBjb25zdCBwQm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KHByb3ApOwogICAgICAgICAgICBjb25zdCBzID0gaGVpZ2h0IC8gcEJveC5nZXRTaXplKG5ldyBUSFJFRS5WZWN0b3IzKCkpLnk7CiAgICAgICAgICAgIHByb3Auc2NhbGUuc2V0U2NhbGFyKHMpOwogICAgICAgICAgICBwcm9wLnBvc2l0aW9uLnNldCh4LCA1IC0gcEJveC5taW4ueSAqIHMsIHopOwogICAgICAgICAgICBwcm9wLnJvdGF0aW9uLnkgPSByb3RZOwogICAgICAgICAgICBwcm9wLnRyYXZlcnNlKGMgPT4geyBpZiAoYy5pc01lc2gpIHsgYy5mcnVzdHVtQ3VsbGVkID0gdHJ1ZTsgYy5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7IH0gfSk7CiAgICAgICAgICAgIHByb3AudXBkYXRlTWF0cml4V29ybGQodHJ1ZSk7CiAgICAgICAgICAgIHNjZW5lLmFkZChwcm9wKTsKICAgICAgICAgICAgcmVnaXN0ZXJXaXRoUHl0aG9uKHByb3AsIG5hbWUsIGNhdGVnb3J5KTsKICAgICAgICAgICAgcmV0dXJuIHByb3A7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9OwoKICAgIGNvbnN0IGJlZFBvcyA9IGxheW91dC5iZWQgfHwgeyB4OiAxNzAsIHo6IDIwLCByb3RZOiAwIH07CiAgICBhd2FpdCBsb2FkRnVybml0dXJlKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRmVsaXBlOTI3MjcyNy9NLXZlaXMtaGVoZS9tYWluL01lc2h5X0FJX1J1c3RpY19Db21mb3J0X0JlZF8wMTMxMDM0MzEyX3RleHR1cmUuZ2xiJywgCiAgICAgICAgODUsIGJlZFBvcy54LCBiZWRQb3MueiwgYmVkUG9zLnJvdFksICJiZWQiLCAiYmVkIik7CgogICAgY29uc3Qgc3RvdmVQb3MgPSBsYXlvdXQuc3RvdmUgfHwgeyB4OiAtMTcwLCB6OiAxMDAsIHJvdFk6IE1hdGguUEkvMiB9OwogICAgY29uc3Qgc3RvdmUgPSBhd2FpdCBsb2FkRnVybml0dXJlKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRmVsaXBlOTI3MjcyNy9NLXZlaXMtaGVoZS9tYWluL01lc2h5X0FJX0ZvZyVDMyVBM29fY2FiYW5hXzAxMzEwMzU2NTNfdGV4dHVyZS5nbGInLCAKICAgICAgICAxMzAsIHN0b3ZlUG9zLngsIHN0b3ZlUG9zLnosIHN0b3ZlUG9zLnJvdFksICJzdG92ZSIsICJzdG92ZSIpOwogICAgCiAgICBpZiAoc3RvdmUpIHsKICAgICAgICBzdG92ZS51c2VyRGF0YS5pc1N0b3ZlID0gdHJ1ZTsKICAgICAgICBzdG92ZS51c2VyRGF0YS5jYW5Db29rID0gdHJ1ZTsKICAgICAgICAKICAgICAgICAvLyBBZGQgcGFuIHN0ZWFrIG1vZGVsIHRvIFNDRU5FIChpbml0aWFsbHkgaGlkZGVuKSB0byBhdm9pZCBzY2FsZSBpc3N1ZXMgd2l0aCBzdG92ZQogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHN0ZWFrR2x0ZiA9IGF3YWl0IGxvYWRlci5sb2FkQXN5bmMoJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9GZWxpcGU5MjcyNzI3L00tdmVpcy1oZWhlL21haW4vTWVzaHlfQUlfU3RlYWtfR2xvd18wMjAxMTEzNzA3X3RleHR1cmUuZ2xiJyk7CiAgICAgICAgICAgIGNvbnN0IHN0ZWFrID0gc3RlYWtHbHRmLnNjZW5lOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm9ybWFsaXplIHNjYWxlIGxpa2UgaW4gZnJpZGdlCiAgICAgICAgICAgIGNvbnN0IG1Cb3ggPSBuZXcgVEhSRUUuQm94MygpLnNldEZyb21PYmplY3Qoc3RlYWspOwogICAgICAgICAgICBjb25zdCBtU2l6ZSA9IG1Cb3guZ2V0U2l6ZShuZXcgVEhSRUUuVmVjdG9yMygpKTsKICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSAyNSAvIE1hdGgubWF4KG1TaXplLngsIG1TaXplLnopOyAvLyBTbGlnaHRseSBsYXJnZXIgZm9yIHBhbgogICAgICAgICAgICBzdGVhay5zY2FsZS5zZXRTY2FsYXIoc2NhbGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gUG9zaXRpb24gb24gdG9wIG9mIHN0b3ZlL3BhbgogICAgICAgICAgICAvLyBQYW4gaXMgYXQgc3RvdmVQb3MueCwgfjEyMCwgc3RvdmVQb3MuegogICAgICAgICAgICBzdGVhay5wb3NpdGlvbi5zZXQoc3RvdmVQb3MueCwgMTM1LCBzdG92ZVBvcy56KTsgCiAgICAgICAgICAgIHN0ZWFrLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFkanVzdCBtYXRlcmlhbCB0byBsb29rIGNvb2tlZC9nbG93eQogICAgICAgICAgICBzdGVhay50cmF2ZXJzZShjID0+IHsKICAgICAgICAgICAgICAgIGlmKGMuaXNNZXNoKSB7CiAgICAgICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IC8vIEFsd2F5cyByZW5kZXIKICAgICAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLmNvbG9yLnNldEhleCgweDhCNDUxMyk7IC8vIERhcmtlciBjb29rZWQgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5lbWlzc2l2ZS5zZXRIZXgoMHgzMzExMDApOwogICAgICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgc2NlbmUuYWRkKHN0ZWFrKTsKICAgICAgICAgICAgc3RvdmUudXNlckRhdGEucGFuU3RlYWsgPSBzdGVhazsKICAgICAgICB9IGNhdGNoKGUpIHsgY29uc29sZS53YXJuKCJDb3VsZCBub3QgbG9hZCBwYW4gc3RlYWsiKTsgfQogICAgfQoKICAgIC8vIEZyeWluZyBQYW4gb24gU3RvdmUKICAgIHRyeSB7CiAgICAgICAgY29uc3QgcGFuR2x0ZiA9IGF3YWl0IGxvYWRlci5sb2FkQXN5bmMoJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9GZWxpcGU5MjcyNzI3L00tdmVpcy1oZWhlL21haW4vTWVzaHlfQUlfTm9uc3RpY2tfU2tpbGxldF8wMjAxMTEyNjI3X3RleHR1cmUuZ2xiJyk7CiAgICAgICAgY29uc3QgcGFuID0gcGFuR2x0Zi5zY2VuZTsKICAgICAgICBjb25zdCBwQm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KHBhbik7CiAgICAgICAgY29uc3QgcFNpemUgPSBwQm94LmdldFNpemUobmV3IFRIUkVFLlZlY3RvcjMoKSk7CiAgICAgICAgY29uc3QgdGFyZ2V0V2lkdGggPSAzNTsKICAgICAgICBjb25zdCBzY2FsZSA9IHRhcmdldFdpZHRoIC8gTWF0aC5tYXgocFNpemUueCwgcFNpemUueik7CiAgICAgICAgCiAgICAgICAgcGFuLnNjYWxlLnNldFNjYWxhcihzY2FsZSk7CiAgICAgICAgcGFuLnBvc2l0aW9uLnNldChzdG92ZVBvcy54LCAxMzAgLSBwQm94Lm1pbi55ICogc2NhbGUgLSAyMCwgc3RvdmVQb3Mueik7CiAgICAgICAgcGFuLnJvdGF0aW9uLnkgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSTsKICAgICAgICAKICAgICAgICBwYW4udHJhdmVyc2UoYyA9PiB7IAogICAgICAgICAgICBpZiAoYy5pc01lc2gpIHsgCiAgICAgICAgICAgICAgICBjLmZydXN0dW1DdWxsZWQgPSB0cnVlOyAKICAgICAgICAgICAgICAgIGMubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKGMubWF0ZXJpYWwpIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgIH0gCiAgICAgICAgfSk7CiAgICAgICAgcGFuLnVwZGF0ZU1hdHJpeFdvcmxkKHRydWUpOwogICAgICAgIHNjZW5lLmFkZChwYW4pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybigiRXJyb3IgbG9hZGluZyBmcnlpbmcgcGFuOiIsIGUpOwogICAgfQoKICAgIGNvbnN0IHRhYmxlUG9zID0gbGF5b3V0LnRhYmxlIHx8IHsgeDogMTMwLCB6OiAyMDAsIHJvdFk6IE1hdGguUEkgfTsKICAgIGF3YWl0IGxvYWRGdXJuaXR1cmUoJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9GZWxpcGU5MjcyNzI3L00tdmVpcy1oZWhlL21haW4vTWVzaHlfQUlfQWpqYWpfMDEzMTA0MDYyMF90ZXh0dXJlLmdsYicsIAogICAgICAgIDkwLCB0YWJsZVBvcy54LCB0YWJsZVBvcy56LCB0YWJsZVBvcy5yb3RZLCAidGFibGUiLCAidGFibGUiKTsKCiAgICAvLyBTb2ZhIGZvciB3aWZlIHRvIHNpdCBvbgogICAgLy8gVXNlIGxheW91dCBjb29yZGluYXRlcyAodXBkYXRlZCBpbiBQeXRob24pIG9yIGZhbGxiYWNrIGlmIFB5dGhvbiBmYWlscwogICAgY29uc3Qgc29mYVBvcyA9IGxheW91dC5zb2ZhIHx8IHsgeDogOTAsIHo6IC0xMzAsIHJvdFk6IDAgfTsKICAgIGF3YWl0IGxvYWRGdXJuaXR1cmUoJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9GZWxpcGU5MjcyNzI3L00tdmVpcy1oZWhlL21haW4vTWVzaHlfQUlfV29ybl9Db21mb3J0XzAxMzEyMzQ2MzNfdGV4dHVyZS5nbGInLAogICAgICAgIDk1LCBzb2ZhUG9zLngsIHNvZmFQb3Mueiwgc29mYVBvcy5yb3RZLCAic29mYSIsICJjaGFpciIpOwoKICAgIGF3YWl0IGNyZWF0ZUZyaWRnZShsYXlvdXQuZnJpZGdlPy54IHx8IC0xNzAsIGxheW91dC5mcmlkZ2U/LnogfHwgLTEwMCwgbGF5b3V0LmZyaWRnZT8ucm90WSB8fCBNYXRoLlBJLzIpOwp9CgpsZXQgZnJpZGdlR3JvdXAgPSBudWxsLCBmcmlkZ2VPcGVuID0gZmFsc2UsIGZyaWRnZUFuaW1hdGluZyA9IGZhbHNlOwpsZXQgZnJpZGdlUmF3TWVhdCA9IG51bGw7Cgphc3luYyBmdW5jdGlvbiBjcmVhdGVGcmlkZ2UoeCwgeiwgcm90WSkgewogICAgY29uc3QgbG9hZGVyID0gbmV3IEdMVEZMb2FkZXIoKTsKICAgIAogICAgZnJpZGdlR3JvdXAgPSBuZXcgVEhSRUUuR3JvdXAoKTsKICAgIGZyaWRnZUdyb3VwLnBvc2l0aW9uLnNldCh4LCAwLCB6KTsKICAgIGlmIChyb3RZICE9PSB1bmRlZmluZWQpIGZyaWRnZUdyb3VwLnJvdGF0aW9uLnkgPSByb3RZOwogICAgCiAgICAvLyBOaWNlciBmcmlkZ2UgYm9keSB3aXRoIHJvdW5kZWQgZWRnZXMgZWZmZWN0IHVzaW5nIG11bHRpcGxlIG1hdGVyaWFscwogICAgY29uc3QgYm9keU1hdCA9IG5ldyBUSFJFRS5NZXNoU3RhbmRhcmRNYXRlcmlhbCh7IAogICAgICAgIGNvbG9yOiAweGU4ZThlOCwgCiAgICAgICAgbWV0YWxuZXNzOiAwLjMsIAogICAgICAgIHJvdWdobmVzczogMC40IAogICAgfSk7CiAgICBjb25zdCBib2R5ID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLkJveEdlb21ldHJ5KDU1LCAxNTAsIDU1KSwgYm9keU1hdCk7CiAgICBib2R5LnBvc2l0aW9uLnkgPSA3NTsKICAgIGZyaWRnZUdyb3VwLmFkZChib2R5KTsKICAgIAogICAgLy8gRGVjb3JhdGl2ZSB0cmltIGF0IHRvcAogICAgY29uc3QgdG9wVHJpbSA9IG5ldyBUSFJFRS5NZXNoKAogICAgICAgIG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg1OCwgNSwgNTgpLCAKICAgICAgICBuZXcgVEhSRUUuTWVzaFN0YW5kYXJkTWF0ZXJpYWwoeyBjb2xvcjogMHhjY2NjY2MsIG1ldGFsbmVzczogMC41LCByb3VnaG5lc3M6IDAuMyB9KQogICAgKTsKICAgIHRvcFRyaW0ucG9zaXRpb24ueSA9IDE1MjsKICAgIGZyaWRnZUdyb3VwLmFkZCh0b3BUcmltKTsKICAgIAogICAgLy8gRnJlZXplciBjb21wYXJ0bWVudCBsaW5lCiAgICBjb25zdCBmcmVlemVyTGluZSA9IG5ldyBUSFJFRS5NZXNoKAogICAgICAgIG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg1MiwgMiwgMiksCiAgICAgICAgbmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsgY29sb3I6IDB4ODg4ODg4IH0pCiAgICApOwogICAgZnJlZXplckxpbmUucG9zaXRpb24uc2V0KDAsIDEyMCwgMjgpOwogICAgZnJpZGdlR3JvdXAuYWRkKGZyZWV6ZXJMaW5lKTsKICAgIAogICAgLy8gSW50ZXJpb3Igd2l0aCBjb29sIGJsdWUgdGludAogICAgY29uc3QgaW50ZXJpb3JNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHgxYTJhM2EgfSk7CiAgICBjb25zdCBpbnRlcmlvciA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg1MCwgMTQ1LCA1MCksIGludGVyaW9yTWF0KTsKICAgIGludGVyaW9yLnBvc2l0aW9uLnNldCgwLCA3NSwgMCk7CiAgICBmcmlkZ2VHcm91cC5hZGQoaW50ZXJpb3IpOwogICAgCiAgICAvLyBHbGFzcyBzaGVsdmVzIHdpdGggdHJhbnNwYXJlbmN5IGVmZmVjdAogICAgY29uc3Qgc2hlbGZNYXQgPSBuZXcgVEhSRUUuTWVzaFN0YW5kYXJkTWF0ZXJpYWwoeyAKICAgICAgICBjb2xvcjogMHhhYWRkZmYsIAogICAgICAgIHRyYW5zcGFyZW50OiB0cnVlLCAKICAgICAgICBvcGFjaXR5OiAwLjYsCiAgICAgICAgbWV0YWxuZXNzOiAwLjEsCiAgICAgICAgcm91Z2huZXNzOiAwLjIKICAgIH0pOwogICAgWzQwLCA3NSwgMTEwXS5mb3JFYWNoKGggPT4gewogICAgICAgIGNvbnN0IHNoZWxmID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLkJveEdlb21ldHJ5KDQ4LCAzLCA0OCksIHNoZWxmTWF0KTsKICAgICAgICBzaGVsZi5wb3NpdGlvbi5zZXQoMCwgaCwgMCk7CiAgICAgICAgZnJpZGdlR3JvdXAuYWRkKHNoZWxmKTsKICAgIH0pOwogICAgCiAgICAvLyBEb29yIHdpdGggbmljZSBmaW5pc2gKICAgIGNvbnN0IGRvb3JQaXZvdCA9IG5ldyBUSFJFRS5Hcm91cCgpOwogICAgZG9vclBpdm90LnBvc2l0aW9uLnNldCgyNy41LCA3NSwgMjcuNSk7CiAgICAKICAgIGNvbnN0IGRvb3JNYXQgPSBuZXcgVEhSRUUuTWVzaFN0YW5kYXJkTWF0ZXJpYWwoeyAKICAgICAgICBjb2xvcjogMHhmMGYwZjAsIAogICAgICAgIG1ldGFsbmVzczogMC40LCAKICAgICAgICByb3VnaG5lc3M6IDAuMyAKICAgIH0pOwogICAgY29uc3QgZG9vciA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg1NSwgMTQ2LCA1KSwgZG9vck1hdCk7CiAgICBkb29yLnBvc2l0aW9uLnNldCgtMjcuNSwgMCwgMi41KTsKICAgIAogICAgLy8gQ2hyb21lIGhhbmRsZQogICAgY29uc3QgaGFuZGxlTWF0ID0gbmV3IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsKHsgCiAgICAgICAgY29sb3I6IDB4Y2NjY2NjLCAKICAgICAgICBtZXRhbG5lc3M6IDAuOSwgCiAgICAgICAgcm91Z2huZXNzOiAwLjEgCiAgICB9KTsKICAgIGNvbnN0IGhhbmRsZSA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgzLCAzNSwgNSksIGhhbmRsZU1hdCk7CiAgICBoYW5kbGUucG9zaXRpb24uc2V0KC01MCwgNSwgNSk7CiAgICBkb29yLmFkZChoYW5kbGUpOwogICAgCiAgICAvLyBIYW5kbGUgYWNjZW50CiAgICBjb25zdCBoYW5kbGVBY2NlbnQgPSBuZXcgVEhSRUUuTWVzaCgKICAgICAgICBuZXcgVEhSRUUuQm94R2VvbWV0cnkoNCwgMzcsIDIpLAogICAgICAgIG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDY2NjY2NiB9KQogICAgKTsKICAgIGhhbmRsZUFjY2VudC5wb3NpdGlvbi5zZXQoLTUwLCA1LCA4KTsKICAgIGRvb3IuYWRkKGhhbmRsZUFjY2VudCk7CiAgICAKICAgIGRvb3JQaXZvdC5hZGQoZG9vcik7CiAgICBmcmlkZ2VHcm91cC5hZGQoZG9vclBpdm90KTsKICAgIAogICAgLy8gSW50ZXJpb3IgbGlnaHQgKGJyaWdodGVyLCBjb29sZXIpCiAgICBjb25zdCBsaWdodCA9IG5ldyBUSFJFRS5Qb2ludExpZ2h0KDB4YWFkZGZmLCAwLCAxMDApOwogICAgbGlnaHQucG9zaXRpb24uc2V0KDAsIDEwMCwgMCk7CiAgICBmcmlkZ2VHcm91cC5hZGQobGlnaHQpOwogICAgCiAgICAvLyBBZGQgZ2xvd2luZyBzdGVhayBpbnNpZGUgdGhlIGZyaWRnZSAtIHBvc2l0aW9uZWQgaW4gRlJPTlQgb2YgdGhlIGludGVyaW9yCiAgICB0cnkgewogICAgICAgIGNvbnN0IGdsb3dTdGVha0dsdGYgPSBhd2FpdCBsb2FkZXIubG9hZEFzeW5jKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vRmVsaXBlOTI3MjcyNy9NLXZlaXMtaGVoZS9tYWluL01lc2h5X0FJX1N0ZWFrX0dsb3dfMDIwMTExMzcwN190ZXh0dXJlLmdsYicpOwogICAgICAgIGNvbnN0IGdsb3dTdGVhayA9IGdsb3dTdGVha0dsdGYuc2NlbmU7CiAgICAgICAgY29uc3QgbUJveCA9IG5ldyBUSFJFRS5Cb3gzKCkuc2V0RnJvbU9iamVjdChnbG93U3RlYWspOwogICAgICAgIGNvbnN0IG1TaXplID0gbUJveC5nZXRTaXplKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgIGNvbnN0IHNjYWxlID0gMjAgLyBNYXRoLm1heChtU2l6ZS54LCBtU2l6ZS56KTsKICAgICAgICBnbG93U3RlYWsuc2NhbGUuc2V0U2NhbGFyKHNjYWxlKTsKICAgICAgICAvLyBQb3NpdGlvbiBvbiBib3R0b20gc2hlbGYgLSBpbiBmcm9udCBzbyBpdCdzIHZpc2libGUsIHo9MTUgdG8gYmUgaW4gZnJvbnQgb2YgaW50ZXJpb3IKICAgICAgICBnbG93U3RlYWsucG9zaXRpb24uc2V0KDAsIDQ1LCAxNSk7CiAgICAgICAgZ2xvd1N0ZWFrLnJvdGF0aW9uLnkgPSBNYXRoLlBJIC8gNDsKICAgICAgICBnbG93U3RlYWsucmVuZGVyT3JkZXIgPSA5OTk7ICAvLyBSZW5kZXIgb24gdG9wCiAgICAgICAgZ2xvd1N0ZWFrLnRyYXZlcnNlKGMgPT4geyAKICAgICAgICAgICAgaWYgKGMuaXNNZXNoKSB7IAogICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IAogICAgICAgICAgICAgICAgYy5tYXRyaXhBdXRvVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGMucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxOwogICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgfSk7CiAgICAgICAgZnJpZGdlR3JvdXAuYWRkKGdsb3dTdGVhayk7CiAgICAgICAgZnJpZGdlR3JvdXAudXNlckRhdGEuZ2xvd1N0ZWFrMSA9IGdsb3dTdGVhazsKICAgICAgICAKICAgICAgICAvLyBBZGQgYSBzZWNvbmQgZ2xvd2luZyBzdGVhayBvbiBtaWRkbGUgc2hlbGYKICAgICAgICBjb25zdCBnbG93U3RlYWsyR2x0ZiA9IGF3YWl0IGxvYWRlci5sb2FkQXN5bmMoJ2h0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9GZWxpcGU5MjcyNzI3L00tdmVpcy1oZWhlL21haW4vTWVzaHlfQUlfU3RlYWtfR2xvd18wMjAxMTEzNzA3X3RleHR1cmUuZ2xiJyk7CiAgICAgICAgY29uc3QgZ2xvd1N0ZWFrMiA9IGdsb3dTdGVhazJHbHRmLnNjZW5lOwogICAgICAgIGNvbnN0IHNjYWxlMiA9IDE4IC8gTWF0aC5tYXgobVNpemUueCwgbVNpemUueik7CiAgICAgICAgZ2xvd1N0ZWFrMi5zY2FsZS5zZXRTY2FsYXIoc2NhbGUyKTsKICAgICAgICAvLyBQb3NpdGlvbiBvbiBtaWRkbGUgc2hlbGYgLSB6PTEyIHRvIGJlIHZpc2libGUKICAgICAgICBnbG93U3RlYWsyLnBvc2l0aW9uLnNldCgtOCwgODAsIDEyKTsKICAgICAgICBnbG93U3RlYWsyLnJvdGF0aW9uLnkgPSAtTWF0aC5QSSAvIDM7CiAgICAgICAgZ2xvd1N0ZWFrMi5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICBnbG93U3RlYWsyLnRyYXZlcnNlKGMgPT4geyAKICAgICAgICAgICAgaWYgKGMuaXNNZXNoKSB7IAogICAgICAgICAgICAgICAgYy5mcnVzdHVtQ3VsbGVkID0gZmFsc2U7IAogICAgICAgICAgICAgICAgYy5tYXRyaXhBdXRvVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGMucmVuZGVyT3JkZXIgPSA5OTk7CiAgICAgICAgICAgICAgICBpZiAoYy5tYXRlcmlhbCkgewogICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBjLm1hdGVyaWFsLm9wYWNpdHkgPSAxOwogICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuc2lkZSA9IFRIUkVFLkRvdWJsZVNpZGU7CiAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5kZXB0aFRlc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGMubWF0ZXJpYWwuZGVwdGhXcml0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYy5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gCiAgICAgICAgfSk7CiAgICAgICAgZnJpZGdlR3JvdXAuYWRkKGdsb3dTdGVhazIpOwogICAgICAgIGZyaWRnZUdyb3VwLnVzZXJEYXRhLmdsb3dTdGVhazIgPSBnbG93U3RlYWsyOwogICAgICAgIAogICAgICAgIGNvbnNvbGUubG9nKCJbRnJpZGdlXSBHbG93aW5nIHN0ZWFrcyBhZGRlZCB0byBmcmlkZ2UgYXQgdmlzaWJsZSBwb3NpdGlvbnMiKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oIkVycm9yIGxvYWRpbmcgZ2xvd2luZyBzdGVhayBmb3IgZnJpZGdlOiIsIGUpOwogICAgfQogICAgCiAgICAvLyBBZGQgc29tZSBmb29kIGNvbnRhaW5lcnMgZm9yIHJlYWxpc20KICAgIGNvbnN0IGNvbnRhaW5lck1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweDQ0ODhmZiwgdHJhbnNwYXJlbnQ6IHRydWUsIG9wYWNpdHk6IDAuNyB9KTsKICAgIGNvbnN0IGNvbnRhaW5lcjEgPSBuZXcgVEhSRUUuTWVzaChuZXcgVEhSRUUuQm94R2VvbWV0cnkoMTIsIDgsIDEyKSwgY29udGFpbmVyTWF0KTsKICAgIGNvbnRhaW5lcjEucG9zaXRpb24uc2V0KC0xNSwgNDgsIDEwKTsKICAgIGZyaWRnZUdyb3VwLmFkZChjb250YWluZXIxKTsKICAgIAogICAgY29uc3QgY29udGFpbmVyMiA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSgxMCwgMTAsIDEwKSwgY29udGFpbmVyTWF0KTsKICAgIGNvbnRhaW5lcjIucG9zaXRpb24uc2V0KDE1LCA4NCwgLTEwKTsKICAgIGZyaWRnZUdyb3VwLmFkZChjb250YWluZXIyKTsKICAgIAogICAgLy8gTWlsayBjYXJ0b24KICAgIGNvbnN0IG1pbGtNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyBjb2xvcjogMHhmZmZmZmYgfSk7CiAgICBjb25zdCBtaWxrID0gbmV3IFRIUkVFLk1lc2gobmV3IFRIUkVFLkJveEdlb21ldHJ5KDgsIDIwLCA4KSwgbWlsa01hdCk7CiAgICBtaWxrLnBvc2l0aW9uLnNldCgtMTUsIDkwLCAtMTApOwogICAgZnJpZGdlR3JvdXAuYWRkKG1pbGspOwogICAgCiAgICAvLyBSZWQgY2FwIG9uIG1pbGsKICAgIGNvbnN0IGNhcE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmNDQ0NCB9KTsKICAgIGNvbnN0IGNhcCA9IG5ldyBUSFJFRS5NZXNoKG5ldyBUSFJFRS5Cb3hHZW9tZXRyeSg2LCAzLCA2KSwgY2FwTWF0KTsKICAgIGNhcC5wb3NpdGlvbi5zZXQoLTE1LCAxMDEsIC0xMCk7CiAgICBmcmlkZ2VHcm91cC5hZGQoY2FwKTsKICAgIAogICAgZnJpZGdlR3JvdXAudXNlckRhdGEubGlnaHQgPSBsaWdodDsKICAgIGZyaWRnZUdyb3VwLnVzZXJEYXRhLmRvb3JQaXZvdCA9IGRvb3JQaXZvdDsKICAgIGZyaWRnZUdyb3VwLnVzZXJEYXRhLmRvb3JBbmdsZSA9IDA7CiAgICBmcmlkZ2VHcm91cC51c2VyRGF0YS5tZWF0SW5GcmlkZ2UgPSB0cnVlOwogICAgCiAgICBzY2VuZS5hZGQoZnJpZGdlR3JvdXApOwogICAgZnJpZGdlR3JvdXAudXBkYXRlTWF0cml4V29ybGQodHJ1ZSk7CiAgICAKICAgIGlmIChweUNvbGxpc2lvbkVuZ2luZSkgcHlDb2xsaXNpb25FbmdpbmUucmVnaXN0ZXJfYm94KCJmcmlkZ2UiLCB4IC0gMzAsIHggKyAzMCwgeiAtIDMwLCB6ICsgMzApOwp9CgpmdW5jdGlvbiB0b2dnbGVGcmlkZ2UoKSB7CiAgICBpZiAoIWZyaWRnZUdyb3VwIHx8IGZyaWRnZUFuaW1hdGluZykgcmV0dXJuOwogICAgZnJpZGdlQW5pbWF0aW5nID0gdHJ1ZTsKICAgIGZyaWRnZU9wZW4gPSAhZnJpZGdlT3BlbjsKICAgIAogICAgY29uc3QgcGl2b3QgPSBmcmlkZ2VHcm91cC51c2VyRGF0YS5kb29yUGl2b3Q7CiAgICBjb25zdCBsaWdodCA9IGZyaWRnZUdyb3VwLnVzZXJEYXRhLmxpZ2h0OwogICAgY29uc3QgdGFyZ2V0ID0gZnJpZGdlT3BlbiA/IE1hdGguUEkgKiAwLjcgOiAwOwogICAgY29uc3Qgc3RhcnQgPSBmcmlkZ2VHcm91cC51c2VyRGF0YS5kb29yQW5nbGUgfHwgMDsKICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgCiAgICBmdW5jdGlvbiBhbmltYXRlKCkgewogICAgICAgIGNvbnN0IHQgPSBNYXRoLm1pbigocGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWUpIC8gNDAwLCAxKTsKICAgICAgICBjb25zdCBlYXNlZCA9IDEgLSBNYXRoLnBvdygxIC0gdCwgMyk7CiAgICAgICAgY29uc3QgYW5nbGUgPSBzdGFydCArICh0YXJnZXQgLSBzdGFydCkgKiBlYXNlZDsKICAgICAgICBwaXZvdC5yb3RhdGlvbi55ID0gYW5nbGU7CiAgICAgICAgZnJpZGdlR3JvdXAudXNlckRhdGEuZG9vckFuZ2xlID0gYW5nbGU7CiAgICAgICAgbGlnaHQuaW50ZW5zaXR5ID0gZnJpZGdlT3BlbiA/IGVhc2VkICogMiA6ICgxIC0gZWFzZWQpICogMjsKICAgICAgICBpZiAodCA8IDEpIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTsKICAgICAgICBlbHNlIGZyaWRnZUFuaW1hdGluZyA9IGZhbHNlOwogICAgfQogICAgYW5pbWF0ZSgpOwp9CgpsZXQgZnJpZGdlUHJvbXB0VmlzaWJsZSA9IGZhbHNlOwoKZnVuY3Rpb24gc2hvd0ZyaWRnZVByb21wdCgpIHsKICAgIGNvbnN0IHByb21wdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmcmlkZ2UtcHJvbXB0Jyk7CiAgICBpZiAoIWZyaWRnZVByb21wdFZpc2libGUpIHsKICAgICAgICBwcm9tcHQuY2xhc3NMaXN0LmFkZCgndmlzaWJsZScpOwogICAgICAgIGZyaWRnZVByb21wdFZpc2libGUgPSB0cnVlOwogICAgfQp9CgpmdW5jdGlvbiBoaWRlRnJpZGdlUHJvbXB0KCkgewogICAgY29uc3QgcHJvbXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ZyaWRnZS1wcm9tcHQnKTsKICAgIHByb21wdC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICBmcmlkZ2VQcm9tcHRWaXNpYmxlID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGNoZWNrRnJpZGdlUHJveGltaXR5KCkgewogICAgaWYgKCFmcmlkZ2VHcm91cCB8fCBjdXRzY2VuZUFjdGl2ZSkgcmV0dXJuOwogICAgY29uc3QgZHggPSBjYW1lcmEucG9zaXRpb24ueCAtIGZyaWRnZUdyb3VwLnBvc2l0aW9uLng7CiAgICBjb25zdCBkeiA9IGNhbWVyYS5wb3NpdGlvbi56IC0gZnJpZGdlR3JvdXAucG9zaXRpb24uejsKICAgIGNvbnN0IGRpc3QgPSBNYXRoLnNxcnQoZHgqZHggKyBkeipkeik7CiAgICAKICAgIGlmIChkaXN0IDwgMjAwKSB7IC8vIEluY3JlYXNlZCBkaXN0YW5jZSB0byBtYWtlIGl0IGVhc2llcgogICAgICAgIHNob3dGcmlkZ2VQcm9tcHQoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaGlkZUZyaWRnZVByb21wdCgpOwogICAgfQp9CgpmdW5jdGlvbiBjaGVja0ZyaWRnZUludGVyYWN0aW9uKCkgewogICAgaWYgKCFmcmlkZ2VHcm91cCkgcmV0dXJuOwogICAgY29uc3QgZHggPSBjYW1lcmEucG9zaXRpb24ueCAtIGZyaWRnZUdyb3VwLnBvc2l0aW9uLng7CiAgICBjb25zdCBkeiA9IGNhbWVyYS5wb3NpdGlvbi56IC0gZnJpZGdlR3JvdXAucG9zaXRpb24uejsKICAgIGlmIChNYXRoLnNxcnQoZHgqZHggKyBkeipkeikgPCAyMDApIHsgLy8gSW5jcmVhc2VkIGludGVyYWN0aW9uIGRpc3RhbmNlCiAgICAgICAgaWYgKGZyaWRnZU9wZW4gJiYgIWNhcnJ5aW5nTWVhdCAmJiBmcmlkZ2VHcm91cC51c2VyRGF0YS5tZWF0SW5GcmlkZ2UpIHsKICAgICAgICAgICAgLy8gUGljayB1cCBtZWF0CiAgICAgICAgICAgIHBpY2tVcE1lYXQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0b2dnbGVGcmlkZ2UoKTsKICAgICAgICB9CiAgICB9Cn0KCmZ1bmN0aW9uIHBpY2tVcE1lYXQoKSB7CiAgICBpZiAoY2FycnlpbmdNZWF0IHx8ICFmcmlkZ2VHcm91cC51c2VyRGF0YS5tZWF0SW5GcmlkZ2UpIHJldHVybjsKICAgIAogICAgLy8gSGlkZSB0aGUgbWVhdCBpbiB0aGUgZnJpZGdlCiAgICBpZiAoZnJpZGdlR3JvdXAudXNlckRhdGEuZ2xvd1N0ZWFrMSkgewogICAgICAgIGZyaWRnZUdyb3VwLnVzZXJEYXRhLmdsb3dTdGVhazEudmlzaWJsZSA9IGZhbHNlOwogICAgfQogICAgaWYgKGZyaWRnZUdyb3VwLnVzZXJEYXRhLmdsb3dTdGVhazIpIHsKICAgICAgICBmcmlkZ2VHcm91cC51c2VyRGF0YS5nbG93U3RlYWsyLnZpc2libGUgPSBmYWxzZTsKICAgIH0KICAgIGZyaWRnZUdyb3VwLnVzZXJEYXRhLm1lYXRJbkZyaWRnZSA9IGZhbHNlOwogICAgCiAgICAvLyBDcmVhdGUgbWVhdCBvYmplY3QgdG8gY2FycnkgLSBVc2UgdGhlIDNEIE1vZGVsIGluc3RlYWQgb2YgYSBib3gKICAgIGlmIChmcmlkZ2VHcm91cC51c2VyRGF0YS5nbG93U3RlYWsxKSB7CiAgICAgICAgLy8gQ2xvbmUgdGhlIG1vZGVsIGZyb20gdGhlIGZyaWRnZQogICAgICAgIGNhcnJpZWRNZWF0T2JqZWN0ID0gZnJpZGdlR3JvdXAudXNlckRhdGEuZ2xvd1N0ZWFrMS5jbG9uZSgpOwogICAgICAgIGNhcnJpZWRNZWF0T2JqZWN0LnZpc2libGUgPSB0cnVlOwogICAgICAgIHNjZW5lLmFkZChjYXJyaWVkTWVhdE9iamVjdCk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEZhbGxiYWNrIGlmIG1vZGVsIG5vdCBsb2FkZWQKICAgICAgICBjb25zdCBtZWF0R2VvID0gbmV3IFRIUkVFLkJveEdlb21ldHJ5KDE1LCA1LCAyMCk7CiAgICAgICAgY29uc3QgbWVhdE1hdCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCh7IGNvbG9yOiAweGZmNDQyMiB9KTsKICAgICAgICBjYXJyaWVkTWVhdE9iamVjdCA9IG5ldyBUSFJFRS5NZXNoKG1lYXRHZW8sIG1lYXRNYXQpOwogICAgICAgIGNhcnJpZWRNZWF0T2JqZWN0LnZpc2libGUgPSB0cnVlOwogICAgICAgIHNjZW5lLmFkZChjYXJyaWVkTWVhdE9iamVjdCk7CiAgICB9CiAgICAKICAgIGNhcnJ5aW5nTWVhdCA9IHRydWU7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVhdC1jYXJyeWluZy11aScpLmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTsKICAgIAogICAgLy8gVXBkYXRlIGZyaWRnZSBwcm9tcHQKICAgIGhpZGVGcmlkZ2VQcm9tcHQoKTsKICAgIAogICAgY29uc29sZS5sb2coIltNZWF0XSBQaWNrZWQgdXAgbWVhdCBtb2RlbCBmcm9tIGZyaWRnZSIpOwp9CgpmdW5jdGlvbiB1cGRhdGVDYXJyaWVkTWVhdCgpIHsKICAgIGlmICghY2FycnlpbmdNZWF0IHx8ICFjYXJyaWVkTWVhdE9iamVjdCkgcmV0dXJuOwogICAgCiAgICAvLyBQb3NpdGlvbiBtZWF0IGluIGZyb250IG9mIGNhbWVyYSAtIENFTlRFUkVECiAgICBjb25zdCBmb3J3YXJkID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgLTEpOwogICAgZm9yd2FyZC5hcHBseVF1YXRlcm5pb24oY2FtZXJhLnF1YXRlcm5pb24pOwogICAgCiAgICBjb25zdCBtZWF0UG9zID0gY2FtZXJhLnBvc2l0aW9uLmNsb25lKCk7CiAgICBtZWF0UG9zLmFkZChmb3J3YXJkLm11bHRpcGx5U2NhbGFyKDUwKSk7ICAvLyA1MCB1bml0cyBpbiBmcm9udAogICAgY29uc3QgdXAgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKTsKICAgIHVwLmFwcGx5UXVhdGVybmlvbihjYW1lcmEucXVhdGVybmlvbik7CiAgICBtZWF0UG9zLmFkZCh1cC5tdWx0aXBseVNjYWxhcigtMTApKTsgLy8gU2xpZ2h0bHkgYmVsb3cgZXllIGxldmVsCiAgICAKICAgIGNhcnJpZWRNZWF0T2JqZWN0LnBvc2l0aW9uLmNvcHkobWVhdFBvcyk7CiAgICBjYXJyaWVkTWVhdE9iamVjdC5xdWF0ZXJuaW9uLmNvcHkoY2FtZXJhLnF1YXRlcm5pb24pOwogICAgLy8gUm90YXRlIHRvIGZhY2UgY2FtZXJhIG5pY2VseQogICAgY2FycmllZE1lYXRPYmplY3Qucm90YXRlWChNYXRoLlBJIC8gNCk7Cn0KCmZ1bmN0aW9uIHBsYWNlTWVhdE9uUGFuKCkgewogICAgaWYgKCFjYXJyeWluZ01lYXQgfHwgIWNhcnJpZWRNZWF0T2JqZWN0KSByZXR1cm47CiAgICAKICAgIC8vIEZpbmQgdGhlIHN0b3ZlL3BhbiBzdGVhawogICAgbGV0IHBhblN0ZWFrID0gbnVsbDsKICAgIHNjZW5lLnRyYXZlcnNlKG9iaiA9PiB7CiAgICAgICAgaWYgKG9iai51c2VyRGF0YS5pc1N0b3ZlICYmIG9iai51c2VyRGF0YS5wYW5TdGVhaykgewogICAgICAgICAgICBwYW5TdGVhayA9IG9iai51c2VyRGF0YS5wYW5TdGVhazsKICAgICAgICB9CiAgICB9KTsKICAgIAogICAgaWYgKHBhblN0ZWFrKSB7CiAgICAgICAgcGFuU3RlYWsudmlzaWJsZSA9IHRydWU7CiAgICAgICAgLy8gQnVtcCB1cCBZIHNsaWdodGx5IHRvIGVuc3VyZSB2aXNpYmlsaXR5IG9uIHBhbgogICAgICAgIHBhblN0ZWFrLnBvc2l0aW9uLnkgPSAxMzU7CiAgICAgICAgCiAgICAgICAgLy8gUmVtb3ZlIGNhcnJpZWQgbWVhdAogICAgICAgIHNjZW5lLnJlbW92ZShjYXJyaWVkTWVhdE9iamVjdCk7CiAgICAgICAgY2FycmllZE1lYXRPYmplY3QgPSBudWxsOwogICAgICAgIGNhcnJ5aW5nTWVhdCA9IGZhbHNlOwogICAgICAgIAogICAgICAgIC8vIEhpZGUgVUkgYW5kIHByb21wdHMKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVhdC1jYXJyeWluZy11aScpLmNsYXNzTGlzdC5yZW1vdmUoJ3Zpc2libGUnKTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW50ZXJhY3Rpb24tcHJvbXB0JykuY2xhc3NMaXN0LnJlbW92ZSgndmlzaWJsZScpOwogICAgICAgIAogICAgICAgIC8vIFBsYXkgc291bmQgZWZmZWN0CiAgICAgICAgaWYgKGF1ZGlvQ3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgYXVkaW9DdHgucmVzdW1lKCk7CiAgICAgICAgY29uc3Qgb3NjID0gYXVkaW9DdHguY3JlYXRlT3NjaWxsYXRvcigpOwogICAgICAgIGNvbnN0IGdhaW4gPSBhdWRpb0N0eC5jcmVhdGVHYWluKCk7CiAgICAgICAgb3NjLmNvbm5lY3QoZ2Fpbik7CiAgICAgICAgZ2Fpbi5jb25uZWN0KGF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICBvc2MudHlwZSA9ICdzYXd0b290aCc7IC8vIFNpenpsZSBzb3VuZAogICAgICAgIG9zYy5mcmVxdWVuY3kuc2V0VmFsdWVBdFRpbWUoMTAwLCBhdWRpb0N0eC5jdXJyZW50VGltZSk7CiAgICAgICAgb3NjLmZyZXF1ZW5jeS5leHBvbmVudGlhbFJhbXBUb1ZhbHVlQXRUaW1lKDUwLCBhdWRpb0N0eC5jdXJyZW50VGltZSArIDEpOwogICAgICAgIGdhaW4uZ2Fpbi5zZXRWYWx1ZUF0VGltZSgwLjEsIGF1ZGlvQ3R4LmN1cnJlbnRUaW1lKTsKICAgICAgICBnYWluLmdhaW4uZXhwb25lbnRpYWxSYW1wVG9WYWx1ZUF0VGltZSgwLjAxLCBhdWRpb0N0eC5jdXJyZW50VGltZSArIDEpOwogICAgICAgIG9zYy5zdGFydCgpOwogICAgICAgIG9zYy5zdG9wKGF1ZGlvQ3R4LmN1cnJlbnRUaW1lICsgMSk7CiAgICAgICAgCiAgICAgICAgLy8gVXBkYXRlIHN0YXRlCiAgICAgICAgaXNDb29raW5nID0gdHJ1ZTsKICAgICAgICB1cGRhdGVRdWVzdCgiRXNwZXJhbmRvIGNhcm5lIGNvemluaGFyLi4uIik7CiAgICAgICAgCiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICBpc0Nvb2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgIGlzQ29va2VkID0gdHJ1ZTsKICAgICAgICAgICAgIHVwZGF0ZVF1ZXN0KCJDYXJuZSBwcm9udGEuIENvbWEuIik7CiAgICAgICAgfSwgMzAwMCk7IC8vIDMgc2Vjb25kcyBjb29raW5nIHRpbWUKICAgICAgICAKICAgICAgICBjb25zb2xlLmxvZygiW01lYXRdIFBsYWNlZCBtZWF0IG9uIHBhbiIpOwogICAgfQp9CgpmdW5jdGlvbiBlYXRNZWF0KCkgewogICAgc3RhcnROaWdodG1hcmUoKTsKfQoKZnVuY3Rpb24gc3RhcnROaWdodG1hcmUoKSB7CiAgICAvLyBGYWRlIG91dAogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1dHNjZW5lLWZhZGUnKS5jbGFzc0xpc3QuYWRkKCd2aXNpYmxlJyk7CiAgICAKICAgIC8vIFBsYXkgbmlnaHRtYXJlIG11c2ljCiAgICBjb25zdCBtdXNpYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduaWdodG1hcmUtbXVzaWMnKTsKICAgIGlmIChtdXNpYykgewogICAgICAgIG11c2ljLnZvbHVtZSA9IDAuNTsKICAgICAgICBtdXNpYy5wbGF5KCkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZygiQXVkaW8gcGxheSBmYWlsZWQiLCBlKSk7CiAgICB9CiAgICAKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIC8vIENoYW5nZSBlbnZpcm9ubWVudCB0byBuaWdodC9uaWdodG1hcmUKICAgICAgICBzY2VuZS5iYWNrZ3JvdW5kID0gbmV3IFRIUkVFLkNvbG9yKDB4MDAwMDAwKTsKICAgICAgICBzY2VuZS5mb2cgPSBuZXcgVEhSRUUuRm9nKDB4MDAwMDAwLCAxMDAsIDEwMDApOwogICAgICAgIAogICAgICAgIC8vIFRlbGVwb3J0IFBsYXllciBPdXRzaWRlCiAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnNldCgzMDAsIFBMQVlFUl9IRUlHSFQsIDEyMDApOyAKICAgICAgICBjYW1lcmEubG9va0F0KDAsIFBMQVlFUl9IRUlHSFQsIDApOyAKICAgICAgICAKICAgICAgICAvLyBUZWxlcG9ydCBXaWZlIGZvciBDaGFzZQogICAgICAgIHdpZmVTdGF0ZSA9IFdJRkVfU1RBVEUuQ0hBU0lORzsKICAgICAgICBpZiAoZ2lybFdhbGtpbmdPYmplY3QpIHsKICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIC8vIFNwYXduIHdpZmUgb24gc29mYSBhcyByZXF1ZXN0ZWQKICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24uc2V0KFNPRkFfUE9TSVRJT04ueCwgMjIsIFNPRkFfUE9TSVRJT04ueik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBZGQgdmlzaWJsZSBtYXJrZXIgKEdyZWVuIENpcmNsZSkKICAgICAgICAgICAgY29uc3QgcmluZ0dlbyA9IG5ldyBUSFJFRS5SaW5nR2VvbWV0cnkoNDAsIDQ1LCAzMik7CiAgICAgICAgICAgIGNvbnN0IHJpbmdNYXQgPSBuZXcgVEhSRUUuTWVzaEJhc2ljTWF0ZXJpYWwoeyAKICAgICAgICAgICAgICAgIGNvbG9yOiAweDAwZmYwMCwgCiAgICAgICAgICAgICAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLCAKICAgICAgICAgICAgICAgIGRlcHRoVGVzdDogZmFsc2UsCiAgICAgICAgICAgICAgICB0cmFuc3BhcmVudDogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgbWFya2VyID0gbmV3IFRIUkVFLk1lc2gocmluZ0dlbywgcmluZ01hdCk7CiAgICAgICAgICAgIG1hcmtlci5wb3NpdGlvbi55ID0gODA7CiAgICAgICAgICAgIG1hcmtlci5yZW5kZXJPcmRlciA9IDk5OTsKICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QuYWRkKG1hcmtlcik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIEhpZGUgY2FiaW4gaW50ZXJpb3JzL3NpdHRpbmcgd2lmZQogICAgICAgIGlmIChnaXJsU2l0dGluZ09iamVjdCkgZ2lybFNpdHRpbmdPYmplY3QudmlzaWJsZSA9IGZhbHNlOwogICAgICAgIGlmIChnaXJsU29mYVNpdHRpbmdPYmplY3QpIGdpcmxTb2ZhU2l0dGluZ09iamVjdC52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgLy8gU3RhcnQgQ2hhc2UKICAgICAgICB1cGRhdGVRdWVzdCgiQ09SUkEhIik7CiAgICAgICAgCiAgICAgICAgLy8gRmFkZSBpbgogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXRzY2VuZS1mYWRlJykuY2xhc3NMaXN0LnJlbW92ZSgndmlzaWJsZScpOwogICAgfSwgMjAwMCk7Cn0KCmZ1bmN0aW9uIHRyaWdnZXJFbmRpbmcoKSB7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZW5kaW5nLXNjcmVlbicpLmNsYXNzTGlzdC5hZGQoJ3Zpc2libGUnKTsKICAgIC8vIFN0b3AgZ2FtZSBsb29wIGxvZ2ljCiAgICBjb250cm9scy51bmxvY2soKTsKICAgIC8vIFN0b3AgbXVzaWMKICAgIGNvbnN0IG11c2ljID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25pZ2h0bWFyZS1tdXNpYycpOwogICAgaWYobXVzaWMpIG11c2ljLnBhdXNlKCk7Cn0KCmFzeW5jIGZ1bmN0aW9uIGxvYWRUcmVlcygpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgICAgICBjb25zdCBsb2FkZXIgPSBuZXcgR0xURkxvYWRlcigpOwogICAgICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHsgY29uc29sZS53YXJuKCJUcmVlIGxvYWRpbmcgdGltZW91dCIpOyByZXNvbHZlKCk7IH0sIDE1MDAwKTsKICAgICAgICAKICAgICAgICBsb2FkZXIubG9hZCgnaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0ZlbGlwZTkyNzI3MjcvTW9kZWxvcy1hdHVhbGl6YWRvcy9tYWluL01lc2h5X0FJX1RoZV9NYWplc3RpY19PYWtfMDEyOTA5NTUwNF90ZXh0dXJlLmdsYicsIGdsdGYgPT4gewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICAgICAgICAgIGNvbnN0IG1vZGVsID0gZ2x0Zi5zY2VuZTsKICAgICAgICAgICAgY29uc3QgYm94ID0gbmV3IFRIUkVFLkJveDMoKS5zZXRGcm9tT2JqZWN0KG1vZGVsKTsKICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IGJveC5nZXRTaXplKG5ldyBUSFJFRS5WZWN0b3IzKCkpOwogICAgICAgICAgICBjb25zdCBiYXNlU2NhbGUgPSA0MDAgLyBzaXplLnk7CiAgICAgICAgICAgIGNvbnN0IHlPZmZzZXQgPSAtYm94Lm1pbi55OwoKICAgICAgICAgICAgbGV0IGluc3RhbmNlcyA9IFtdOwogICAgICAgICAgICBpZiAocHlUcmVlR2VuZXJhdG9yKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlcyA9IEpTT04ucGFyc2UocHlUcmVlR2VuZXJhdG9yLmdlbmVyYXRlX3RyZWVzX2pzb24oYmFzZVNjYWxlLCB5T2Zmc2V0KSk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtKU10gUHl0aG9uIGdlbmVyYXRlZCAke2luc3RhbmNlcy5sZW5ndGh9IHRyZWVzICh2aXN1YWwgb25seSlgKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCJbSlNdIFB5dGhvbiB0cmVlIGdlbiBlcnJvcjoiLCBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZ2VvbWV0cmllcyA9IFtdLCBtYXRlcmlhbHMgPSBbXTsKICAgICAgICAgICAgbW9kZWwudHJhdmVyc2UoYyA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYy5pc01lc2gpIHsKICAgICAgICAgICAgICAgICAgICBnZW9tZXRyaWVzLnB1c2goYy5nZW9tZXRyeSk7CiAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWxzLnB1c2gobmV3IFRIUkVFLk1lc2hCYXNpY01hdGVyaWFsKHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBjLm1hdGVyaWFsLm1hcCB8fCBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogYy5tYXRlcmlhbC5tYXAgPyAweGZmZmZmZiA6IChjLm1hdGVyaWFsLmNvbG9yIHx8IDB4MmQ1YTI3KSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNwYXJlbnQ6IGMubWF0ZXJpYWwudHJhbnNwYXJlbnQgfHwgZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhVGVzdDogYy5tYXRlcmlhbC5hbHBoYVRlc3QgfHwgMCwKICAgICAgICAgICAgICAgICAgICAgICAgc2lkZTogYy5tYXRlcmlhbC5zaWRlIHx8IFRIUkVFLkZyb250U2lkZQogICAgICAgICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjaHVua01hbmFnZXIudHJlZUdlb21ldHJpZXMgPSBnZW9tZXRyaWVzOwogICAgICAgICAgICBjaHVua01hbmFnZXIudHJlZU1hdGVyaWFscyA9IG1hdGVyaWFsczsKICAgICAgICAgICAgY2h1bmtNYW5hZ2VyLnJlZ2lzdGVyVHJlZURhdGEoaW5zdGFuY2VzKTsKICAgICAgICAgICAgY29uc29sZS5sb2coIvCfjLIgVHJlZXMgbG9hZGVkOiIsIGluc3RhbmNlcy5sZW5ndGgpOwogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgfSwgdW5kZWZpbmVkLCBlID0+IHsgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOyBjb25zb2xlLmVycm9yKCJUcmVlIGxvYWQgZXJyb3I6IiwgZSk7IHJlc29sdmUoKTsgfSk7CiAgICB9KTsKfQoKLy8gSW5pdApmdW5jdGlvbiBpbml0KCkgewogICAgY29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dhbWUtY29udGFpbmVyJyk7CiAgICAKICAgIHNjZW5lID0gbmV3IFRIUkVFLlNjZW5lKCk7CiAgICBjYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoNzUsIHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0LCAxMCwgNDAwMCk7CiAgICAKICAgIHJlbmRlcmVyID0gbmV3IFRIUkVFLldlYkdMUmVuZGVyZXIoeyBhbnRpYWxpYXM6IGZhbHNlLCBwb3dlclByZWZlcmVuY2U6ICJoaWdoLXBlcmZvcm1hbmNlIiwgc3RlbmNpbDogZmFsc2UsIGRlcHRoOiB0cnVlLCBhbHBoYTogZmFsc2UgfSk7CiAgICByZW5kZXJlci5zZXRTaXplKE1hdGguZmxvb3Iod2luZG93LmlubmVyV2lkdGggLyBSRU5ERVJfU0NBTEUpLCBNYXRoLmZsb29yKHdpbmRvdy5pbm5lckhlaWdodCAvIFJFTkRFUl9TQ0FMRSksIGZhbHNlKTsKICAgIHJlbmRlcmVyLnNldFBpeGVsUmF0aW8oMSk7CiAgICByZW5kZXJlci5kb21FbGVtZW50LnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgcmVuZGVyZXIuZG9tRWxlbWVudC5zdHlsZS5oZWlnaHQgPSAnMTAwJSc7CiAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQocmVuZGVyZXIuZG9tRWxlbWVudCk7CgogICAgY29udHJvbHMgPSBuZXcgUG9pbnRlckxvY2tDb250cm9scyhjYW1lcmEsIGRvY3VtZW50LmJvZHkpOwogICAgCiAgICBjb25zdCBpbnN0cnVjdGlvbnMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5zdHJ1Y3Rpb25zJyk7CiAgICBpZiAoIWlzTW9iaWxlKSB7CiAgICAgICAgaW5zdHJ1Y3Rpb25zLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4geyBpZiAoIWN1dHNjZW5lQWN0aXZlKSBjb250cm9scy5sb2NrKCk7IH0pOwogICAgICAgIGNvbnRyb2xzLmFkZEV2ZW50TGlzdGVuZXIoJ2xvY2snLCAoKSA9PiBpbnN0cnVjdGlvbnMuc3R5bGUuZGlzcGxheSA9ICdub25lJyk7CiAgICAgICAgY29udHJvbHMuYWRkRXZlbnRMaXN0ZW5lcigndW5sb2NrJywgKCkgPT4geyBpZiAoIWN1dHNjZW5lQWN0aXZlKSBpbnN0cnVjdGlvbnMuc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2JpbGUtY29udHJvbHMnKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICBzZXR1cE1vYmlsZUNvbnRyb2xzKCk7CiAgICB9CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGUgPT4gewogICAgICAgIGlmIChlLmNvZGUgPT09ICdTcGFjZScpIHsKICAgICAgICAgICAgaWYgKGN1dHNjZW5lQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAvLyBTa2lwIGRpc2FibGVkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaXNHcm91bmRlZCkgeyBwbGF5ZXJWZWxvY2l0eS55ID0gUExBWUVSX0pVTVA7IGlzR3JvdW5kZWQgPSBmYWxzZTsgfQogICAgICAgIH0KICAgICAgICBpZiAoZS5jb2RlID09PSAnS2V5RScpIHsKICAgICAgICAgICAgaWYgKGNhbkV4aXRDYXIgJiYgIWV4aXRDYXJCdXR0b25IaWRkZW4pIHsKICAgICAgICAgICAgICAgIGVuZEN1dHNjZW5lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoIWN1dHNjZW5lQWN0aXZlKSB7CiAgICAgICAgICAgICAgICBjaGVja0ZyaWRnZUludGVyYWN0aW9uKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIENoZWNrIHN0b3ZlIGludGVyYWN0aW9uCiAgICAgICAgICAgICAgICBjb25zdCByYXljYXN0ZXIgPSBuZXcgVEhSRUUuUmF5Y2FzdGVyKCk7CiAgICAgICAgICAgICAgICByYXljYXN0ZXIuc2V0RnJvbUNhbWVyYShuZXcgVEhSRUUuVmVjdG9yMigwLCAwKSwgY2FtZXJhKTsKICAgICAgICAgICAgICAgIGNvbnN0IGludGVyc2VjdHMgPSByYXljYXN0ZXIuaW50ZXJzZWN0T2JqZWN0cyhzY2VuZS5jaGlsZHJlbiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW50ZXJzZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcnNlY3RzW2ldLmRpc3RhbmNlID4gMTUwKSBicmVhazsKICAgICAgICAgICAgICAgICAgICBsZXQgb2JqID0gaW50ZXJzZWN0c1tpXS5vYmplY3Q7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUob2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmoudXNlckRhdGEuY2FuQ29vaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhcnJ5aW5nTWVhdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlTWVhdE9uUGFuKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Nvb2tlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVhdE1lYXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gb2JqLnBhcmVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGUuY29kZSA9PT0gJ0tleVcnICYmICFjdXRzY2VuZUFjdGl2ZSAmJiB3aWZlU3RhdGUgPT09IFdJRkVfU1RBVEUuU0lUVElOR19DQVIpIHsKICAgICAgICAgICAgLy8gVyBrZXkgY2FuIGFsc28gdHJpZ2dlciB3aWZlIHdhbGtpbmcKICAgICAgICAgICAgc3RhcnRXaWZlV2Fsa2luZygpOwogICAgICAgIH0KICAgICAgICBpZiAoZS5jb2RlID09PSAnS2V5UCcpIHRvZ2dsZURlYnVnTW9kZSgpOwogICAgICAgIG9uS2V5RG93bihlKTsKICAgIH0pOwogICAgCiAgICAvLyBFeGl0IGNhciBidXR0b24gY2xpY2sgaGFuZGxlcgogICAgY29uc3QgaW50ZXJhY3Rpb25Qcm9tcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW50ZXJhY3Rpb24tcHJvbXB0Jyk7CiAgICBpbnRlcmFjdGlvblByb21wdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYgKGNhbkV4aXRDYXIgJiYgIWV4aXRDYXJCdXR0b25IaWRkZW4pIHsKICAgICAgICAgICAgZW5kQ3V0c2NlbmUoKTsKICAgICAgICB9IGVsc2UgaWYgKGludGVyYWN0aW9uUHJvbXB0LmNsYXNzTGlzdC5jb250YWlucygndmlzaWJsZScpKSB7CiAgICAgICAgICAgICBpZiAoaW50ZXJhY3Rpb25Qcm9tcHQuaW5uZXJUZXh0LmluY2x1ZGVzKCdDb3ppbmhhcicpICYmIGNhcnJ5aW5nTWVhdCkgewogICAgICAgICAgICAgICAgcGxhY2VNZWF0T25QYW4oKTsKICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW50ZXJhY3Rpb25Qcm9tcHQuaW5uZXJUZXh0LmluY2x1ZGVzKCdDb21lcicpICYmIGlzQ29va2VkKSB7CiAgICAgICAgICAgICAgICBlYXRNZWF0KCk7CiAgICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CiAgICAKICAgIGludGVyYWN0aW9uUHJvbXB0LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBpZiAoY2FuRXhpdENhciAmJiAhZXhpdENhckJ1dHRvbkhpZGRlbikgewogICAgICAgICAgICBlbmRDdXRzY2VuZSgpOwogICAgICAgIH0gZWxzZSBpZiAoaW50ZXJhY3Rpb25Qcm9tcHQuY2xhc3NMaXN0LmNvbnRhaW5zKCd2aXNpYmxlJykpIHsKICAgICAgICAgICAgIGlmIChpbnRlcmFjdGlvblByb21wdC5pbm5lclRleHQuaW5jbHVkZXMoJ0NvemluaGFyJykgJiYgY2FycnlpbmdNZWF0KSB7CiAgICAgICAgICAgICAgICBwbGFjZU1lYXRPblBhbigpOwogICAgICAgICAgICAgfSBlbHNlIGlmIChpbnRlcmFjdGlvblByb21wdC5pbm5lclRleHQuaW5jbHVkZXMoJ0NvbWVyJykgJiYgaXNDb29rZWQpIHsKICAgICAgICAgICAgICAgIGVhdE1lYXQoKTsKICAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KTsKICAgIAogICAgLy8gRnJpZGdlIGJ1dHRvbiBjbGljayBoYW5kbGVyCiAgICBjb25zdCBmcmlkZ2VQcm9tcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZnJpZGdlLXByb21wdCcpOwogICAgZnJpZGdlUHJvbXB0LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBjaGVja0ZyaWRnZUludGVyYWN0aW9uKCk7CiAgICB9KTsKICAgIAogICAgZnJpZGdlUHJvbXB0LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBjaGVja0ZyaWRnZUludGVyYWN0aW9uKCk7CiAgICB9KTsKICAgIAogICAgCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIG9uS2V5VXApOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIG9uV2luZG93UmVzaXplKTsKICAgIAogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZSA9PiB7CiAgICAgICAgaWYgKGN1dHNjZW5lQWN0aXZlICYmIGRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCkgewogICAgICAgICAgICBjdXRzY2VuZUNhbWVyYVlhdyAtPSBlLm1vdmVtZW50WCAqIDAuMDAyOwogICAgICAgICAgICBjdXRzY2VuZUNhbWVyYVBpdGNoIC09IGUubW92ZW1lbnRZICogMC4wMDI7CiAgICAgICAgICAgIGxhc3RQbGF5ZXJJbnB1dCA9IGF1dG9Mb29rVGltZTsKICAgICAgICB9CiAgICB9KTsKICAgIAogICAgc3RhcnRHYW1lKCk7Cn0KCmFzeW5jIGZ1bmN0aW9uIHN0YXJ0R2FtZSgpIHsKICAgIGNvbnN0IGJhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nLWJhcicpOwogICAgY29uc3QgdGV4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nLXRleHQnKTsKICAgIGNvbnN0IGxvYWRpbmdTY3JlZW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZycpOwogICAgY29uc3QgY2hhcHRlclNjcmVlbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjaGFwdGVyLXNjcmVlbicpOwogICAgCiAgICBsZXQgcHJvZ3Jlc3MgPSAwOwogICAgY29uc3QgaW50ZXJ2YWwxID0gc2V0SW50ZXJ2YWwoKCkgPT4geyBwcm9ncmVzcyA9IE1hdGgubWluKHByb2dyZXNzICsgTWF0aC5yYW5kb20oKSAqIDUsIDMwKTsgYmFyLnN0eWxlLndpZHRoID0gcHJvZ3Jlc3MgKyAnJSc7IH0sIDEwMCk7CgogICAgdGV4dC5pbm5lclRleHQgPSAiSW5pdGlhbGl6aW5nIFB5dGhvbiBXQVNNLi4uIjsKICAgIGF3YWl0IHdhaXRGb3JQeXRob24oKTsKICAgIHRleHQuaW5uZXJUZXh0ID0gIlB5dGhvbiBSZWFkeSEgQnVpbGRpbmcgd29ybGQuLi4iOwogICAgYmFyLnN0eWxlLndpZHRoID0gJzQwJSc7CiAgICBjbGVhckludGVydmFsKGludGVydmFsMSk7CiAgICAKICAgIGNvbnN0IGludGVydmFsMiA9IHNldEludGVydmFsKCgpID0+IHsgcHJvZ3Jlc3MgPSBNYXRoLm1pbihwcm9ncmVzcyArIE1hdGgucmFuZG9tKCkgKiA4LCA5MCk7IGJhci5zdHlsZS53aWR0aCA9IHByb2dyZXNzICsgJyUnOyB9LCAxMDApOwogICAgCiAgICB0cnkgeyBhd2FpdCBidWlsZEZvcmVzdExldmVsKCk7IH0gY2F0Y2ggKGUpIHsgY29uc29sZS5lcnJvcigiTGV2ZWwgYnVpbGQgZXJyb3I6IiwgZSk7IH0KICAgIAogICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbDIpOwogICAgYmFyLnN0eWxlLndpZHRoID0gJzEwMCUnOwogICAgdGV4dC5pbm5lclRleHQgPSAiUHJvbnRvISI7CiAgICAKICAgIGNhbWVyYS5wb3NpdGlvbi5zZXQoLTQwLCAxMDAsIDIwMDApOwogICAgY2FtZXJhLmxvb2tBdCgwLCAxMDAsIDE4MDApOwogICAgCiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBjb25zdCBzdGF0dXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHl0aG9uLXN0YXR1cycpOwogICAgICAgIGlmIChzdGF0dXMgJiYgcHlDb2xsaXNpb25FbmdpbmUpIHsKICAgICAgICAgICAgc3RhdHVzLmlubmVySFRNTCA9IGDwn5CNIFNtYXJ0IEVuZ2luZSB2My4xOiAke3B5Q29sbGlzaW9uRW5naW5lLmdldF9jb2xsaWRlcl9jb3VudCgpfSBjb2xsaWRlcnNgOwogICAgICAgICAgICBzdGF0dXMuc3R5bGUuY29sb3IgPSAiIzAwZmYwMCI7CiAgICAgICAgICAgIHN0YXR1cy5zdHlsZS5ib3JkZXJDb2xvciA9ICIjMDBmZjAwIjsKICAgICAgICB9CiAgICB9LCAxMDAwKTsKICAgIAogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgY29uc3Qgc3RhdHVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3B5dGhvbi1zdGF0dXMnKTsKICAgICAgICBpZiAoc3RhdHVzKSB7IHN0YXR1cy5zdHlsZS5vcGFjaXR5ID0gJzAnOyBzZXRUaW1lb3V0KCgpID0+IHN0YXR1cy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnLCA1MDApOyB9CiAgICB9LCA1MDAwKTsKICAgIAogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgbG9hZGluZ1NjcmVlbi5zdHlsZS5vcGFjaXR5ID0gJzAnOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBsb2FkaW5nU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGNoYXB0ZXJTY3JlZW4uc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBjaGFwdGVyU2NyZWVuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpLCA1MCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgY2hhcHRlclNjcmVlbi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyBjaGFwdGVyU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IHN0YXJ0Q3V0c2NlbmUoKTsgYW5pbWF0ZSgpOyB9LCAxNTAwKTsKICAgICAgICAgICAgfSwgMjUwMCk7CiAgICAgICAgfSwgNTAwKTsKICAgIH0sIDUwMCk7Cn0KCmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiB7CiAgICBpZiAoZS50YXJnZXQuaWQgPT09ICdpbnRlcmFjdGlvbi1wcm9tcHQnIHx8IGUudGFyZ2V0LmlkID09PSAnd2lmZS13YWxraW5nLXByb21wdCcpIHJldHVybjsKICAgIGlmIChjdXRzY2VuZUFjdGl2ZSAmJiAhaXNNb2JpbGUgJiYgIWRvY3VtZW50LnBvaW50ZXJMb2NrRWxlbWVudCkgewogICAgICAgIGRvY3VtZW50LmJvZHkucmVxdWVzdFBvaW50ZXJMb2NrKCk7CiAgICAgICAgaWYgKGF1ZGlvQ3R4LnN0YXRlID09PSAnc3VzcGVuZGVkJykgYXVkaW9DdHgucmVzdW1lKCk7CiAgICB9Cn0pOwoKZnVuY3Rpb24gb25LZXlEb3duKGUpIHsKICAgIGlmIChjdXRzY2VuZUFjdGl2ZSkgcmV0dXJuOwogICAgc3dpdGNoIChlLmNvZGUpIHsKICAgICAgICBjYXNlICdLZXlXJzogY2FzZSAnQXJyb3dVcCc6IGlucHV0LmZvcndhcmQgPSB0cnVlOyBicmVhazsKICAgICAgICBjYXNlICdLZXlTJzogY2FzZSAnQXJyb3dEb3duJzogaW5wdXQuYmFja3dhcmQgPSB0cnVlOyBicmVhazsKICAgICAgICBjYXNlICdLZXlBJzogY2FzZSAnQXJyb3dMZWZ0JzogaW5wdXQubGVmdCA9IHRydWU7IGJyZWFrOwogICAgICAgIGNhc2UgJ0tleUQnOiBjYXNlICdBcnJvd1JpZ2h0JzogaW5wdXQucmlnaHQgPSB0cnVlOyBicmVhazsKICAgIH0KfQoKZnVuY3Rpb24gb25LZXlVcChlKSB7CiAgICBzd2l0Y2ggKGUuY29kZSkgewogICAgICAgIGNhc2UgJ0tleVcnOiBjYXNlICdBcnJvd1VwJzogaW5wdXQuZm9yd2FyZCA9IGZhbHNlOyBicmVhazsKICAgICAgICBjYXNlICdLZXlTJzogY2FzZSAnQXJyb3dEb3duJzogaW5wdXQuYmFja3dhcmQgPSBmYWxzZTsgYnJlYWs7CiAgICAgICAgY2FzZSAnS2V5QSc6IGNhc2UgJ0Fycm93TGVmdCc6IGlucHV0LmxlZnQgPSBmYWxzZTsgYnJlYWs7CiAgICAgICAgY2FzZSAnS2V5RCc6IGNhc2UgJ0Fycm93UmlnaHQnOiBpbnB1dC5yaWdodCA9IGZhbHNlOyBicmVhazsKICAgIH0KfQoKZnVuY3Rpb24gc2V0dXBNb2JpbGVDb250cm9scygpIHsKICAgIGNvbnN0IHpvbmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnam95c3RpY2snKTsKICAgIGNvbnN0IGtub2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgna25vYicpOwogICAgbGV0IHRvdWNoSWQgPSBudWxsLCBzdGFydFgsIHN0YXJ0WTsKCiAgICB6b25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBlID0+IHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYgKHRvdWNoSWQgIT09IG51bGwpIHJldHVybjsKICAgICAgICBjb25zdCB0ID0gZS5jaGFuZ2VkVG91Y2hlc1swXTsKICAgICAgICB0b3VjaElkID0gdC5pZGVudGlmaWVyOyBzdGFydFggPSB0LmNsaWVudFg7IHN0YXJ0WSA9IHQuY2xpZW50WTsKICAgICAgICBqb3lzdGljay5hY3RpdmUgPSB0cnVlOwogICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICB6b25lLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGUgPT4gewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBpZiAoIWpveXN0aWNrLmFjdGl2ZSkgcmV0dXJuOwogICAgICAgIGxldCB0ID0gbnVsbDsKICAgICAgICBmb3IgKGxldCB0b3VjaCBvZiBlLmNoYW5nZWRUb3VjaGVzKSBpZiAodG91Y2guaWRlbnRpZmllciA9PT0gdG91Y2hJZCkgeyB0ID0gdG91Y2g7IGJyZWFrOyB9CiAgICAgICAgaWYgKCF0KSByZXR1cm47CiAgICAgICAgbGV0IGR4ID0gdC5jbGllbnRYIC0gc3RhcnRYLCBkeSA9IHQuY2xpZW50WSAtIHN0YXJ0WTsKICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5zcXJ0KGR4KmR4ICsgZHkqZHkpOwogICAgICAgIGlmIChkaXN0ID4gNDApIHsgZHggPSBkeC9kaXN0ICogNDA7IGR5ID0gZHkvZGlzdCAqIDQwOyB9CiAgICAgICAga25vYi5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlKGNhbGMoLTUwJSArICR7ZHh9cHgpLCBjYWxjKC01MCUgKyAke2R5fXB4KSlgOwogICAgICAgIGpveXN0aWNrLnggPSBkeCAvIDQwOyBqb3lzdGljay55ID0gZHkgLyA0MDsKICAgIH0sIHsgcGFzc2l2ZTogZmFsc2UgfSk7CgogICAgY29uc3QgZW5kID0gZSA9PiB7CiAgICAgICAgZm9yIChsZXQgdCBvZiBlLmNoYW5nZWRUb3VjaGVzKSB7CiAgICAgICAgICAgIGlmICh0LmlkZW50aWZpZXIgPT09IHRvdWNoSWQpIHsKICAgICAgICAgICAgICAgIGpveXN0aWNrLmFjdGl2ZSA9IGZhbHNlOyBqb3lzdGljay54ID0gam95c3RpY2sueSA9IDA7CiAgICAgICAgICAgICAgICBrbm9iLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoLTUwJSwgLTUwJSknOwogICAgICAgICAgICAgICAgdG91Y2hJZCA9IG51bGw7IGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIHpvbmUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBlbmQpOwogICAgem9uZS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGVuZCk7CgogICAgbGV0IGxvb2tUb3VjaElkID0gbnVsbCwgbG9va1N0YXJ0WCwgbG9va1N0YXJ0WTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBlID0+IHsKICAgICAgICBpZiAobG9va1RvdWNoSWQgIT09IG51bGwpIHJldHVybjsKICAgICAgICBmb3IgKGxldCB0IG9mIGUuY2hhbmdlZFRvdWNoZXMpIHsKICAgICAgICAgICAgaWYgKHQuaWRlbnRpZmllciAhPT0gdG91Y2hJZCkgeyBsb29rVG91Y2hJZCA9IHQuaWRlbnRpZmllcjsgbG9va1N0YXJ0WCA9IHQuY2xpZW50WDsgbG9va1N0YXJ0WSA9IHQuY2xpZW50WTsgYnJlYWs7IH0KICAgICAgICB9CiAgICB9LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGUgPT4gewogICAgICAgIGlmIChsb29rVG91Y2hJZCA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIGZvciAobGV0IHQgb2YgZS5jaGFuZ2VkVG91Y2hlcykgewogICAgICAgICAgICBpZiAodC5pZGVudGlmaWVyID09PSBsb29rVG91Y2hJZCkgewogICAgICAgICAgICAgICAgY29uc3QgZHggPSB0LmNsaWVudFggLSBsb29rU3RhcnRYLCBkeSA9IHQuY2xpZW50WSAtIGxvb2tTdGFydFk7CiAgICAgICAgICAgICAgICBpZiAoY3V0c2NlbmVBY3RpdmUpIHsgY3V0c2NlbmVDYW1lcmFZYXcgLT0gZHggKiAwLjAwNDsgY3V0c2NlbmVDYW1lcmFQaXRjaCAtPSBkeSAqIDAuMDA0OyBsYXN0UGxheWVySW5wdXQgPSBhdXRvTG9va1RpbWU7IH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIF9ldWxlci5zZXRGcm9tUXVhdGVybmlvbihjYW1lcmEucXVhdGVybmlvbik7CiAgICAgICAgICAgICAgICAgICAgX2V1bGVyLnkgLT0gZHggKiAwLjAwNDsgX2V1bGVyLnggLT0gZHkgKiAwLjAwNDsKICAgICAgICAgICAgICAgICAgICBfZXVsZXIueCA9IE1hdGgubWF4KC1NYXRoLlBJLzIgKyAwLjEsIE1hdGgubWluKE1hdGguUEkvMiAtIDAuMSwgX2V1bGVyLngpKTsKICAgICAgICAgICAgICAgICAgICBjYW1lcmEucXVhdGVybmlvbi5zZXRGcm9tRXVsZXIoX2V1bGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxvb2tTdGFydFggPSB0LmNsaWVudFg7IGxvb2tTdGFydFkgPSB0LmNsaWVudFk7IGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKCiAgICBjb25zdCBlbmRMb29rID0gZSA9PiB7IGZvciAobGV0IHQgb2YgZS5jaGFuZ2VkVG91Y2hlcykgaWYgKHQuaWRlbnRpZmllciA9PT0gbG9va1RvdWNoSWQpIHsgbG9va1RvdWNoSWQgPSBudWxsOyBicmVhazsgfSB9OwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBlbmRMb29rKTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgZW5kTG9vayk7CiAgICAKICAgIGxldCBsYXN0VGFwID0gMDsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgKGUpID0+IHsKICAgICAgICBpZiAoZS50YXJnZXQuaWQgPT09ICdpbnRlcmFjdGlvbi1wcm9tcHQnIHx8IGUudGFyZ2V0LmlkID09PSAnd2lmZS13YWxraW5nLXByb21wdCcpIHJldHVybjsKICAgICAgICAKICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgICAgIGlmIChub3cgLSBsYXN0VGFwIDwgMzAwKSB7CiAgICAgICAgICAgIGlmIChjdXRzY2VuZUFjdGl2ZSAmJiBjYW5FeGl0Q2FyICYmICFleGl0Q2FyQnV0dG9uSGlkZGVuKSBlbmRDdXRzY2VuZSgpOwogICAgICAgICAgICBlbHNlIGlmICghY3V0c2NlbmVBY3RpdmUpIHsKICAgICAgICAgICAgICAgIGNoZWNrRnJpZGdlSW50ZXJhY3Rpb24oKTsKICAgICAgICAgICAgICAgIC8vIENoZWNrIHN0b3ZlIGludGVyYWN0aW9uIGZvciB0YXAKICAgICAgICAgICAgICAgIGlmIChjYXJyeWluZ01lYXQgfHwgaXNDb29rZWQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByYXljYXN0ZXIgPSBuZXcgVEhSRUUuUmF5Y2FzdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmF5Y2FzdGVyLnNldEZyb21DYW1lcmEobmV3IFRIUkVFLlZlY3RvcjIoMCwgMCksIGNhbWVyYSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJzZWN0cyA9IHJheWNhc3Rlci5pbnRlcnNlY3RPYmplY3RzKHNjZW5lLmNoaWxkcmVuLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGludGVyc2VjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGludGVyc2VjdHNbaV0uZGlzdGFuY2UgPiAxNTApIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgb2JqID0gaW50ZXJzZWN0c1tpXS5vYmplY3Q7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKG9iaikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iai51c2VyRGF0YS5jYW5Db29rKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhcnJ5aW5nTWVhdCkgcGxhY2VNZWF0T25QYW4oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc0Nvb2tlZCkgZWF0TWVhdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iaiA9IG9iai5wYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGFzdFRhcCA9IG5vdzsKICAgIH0pOwp9CgpmdW5jdGlvbiBvbldpbmRvd1Jlc2l6ZSgpIHsKICAgIGNhbWVyYS5hc3BlY3QgPSB3aW5kb3cuaW5uZXJXaWR0aCAvIHdpbmRvdy5pbm5lckhlaWdodDsKICAgIGNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CiAgICByZW5kZXJlci5zZXRTaXplKE1hdGguZmxvb3Iod2luZG93LmlubmVyV2lkdGggLyBSRU5ERVJfU0NBTEUpLCBNYXRoLmZsb29yKHdpbmRvdy5pbm5lckhlaWdodCAvIFJFTkRFUl9TQ0FMRSksIGZhbHNlKTsKfQoKbGV0IGxhc3RDaHVua1VwZGF0ZSA9IDA7CgpmdW5jdGlvbiBhbmltYXRlKCkgewogICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpOwoKICAgIGNvbnN0IG5vdyA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgZnJhbWVDb3VudCsrOwogICAgCiAgICBpZiAobm93IC0gbGFzdFRpbWVGUFMgPj0gMTAwMCkgewogICAgICAgIGZwc0VsZW1lbnQuaW5uZXJIVE1MID0gYEZQUzogJHtmcmFtZUNvdW50fTxicj5DaHVua3M6ICR7Y2h1bmtNYW5hZ2VyLmFjdGl2ZUNodW5rc308YnI+WDogJHtjYW1lcmEucG9zaXRpb24ueC50b0ZpeGVkKDApfSBZOiAke2NhbWVyYS5wb3NpdGlvbi55LnRvRml4ZWQoMCl9IFo6ICR7Y2FtZXJhLnBvc2l0aW9uLnoudG9GaXhlZCgwKX1gOwogICAgICAgIGZyYW1lQ291bnQgPSAwOyBsYXN0VGltZUZQUyA9IG5vdzsKICAgIH0KCiAgICBjb25zdCBkZWx0YSA9IE1hdGgubWluKChub3cgLSBwcmV2VGltZSkgLyAxMDAwLCAwLjEpOwogICAgcHJldlRpbWUgPSBub3c7CgogICAgaWYgKGN1dHNjZW5lQWN0aXZlKSB7CiAgICAgICAgdXBkYXRlQ3V0c2NlbmUoZGVsdGEpOwogICAgICAgIGlmIChub3cgLSBsYXN0Q2h1bmtVcGRhdGUgPiA1MDAgJiYgY2FyT2JqZWN0KSB7IGNodW5rTWFuYWdlci51cGRhdGUoY2FyT2JqZWN0LnBvc2l0aW9uLngsIGNhck9iamVjdC5wb3NpdGlvbi56KTsgbGFzdENodW5rVXBkYXRlID0gbm93OyB9CiAgICB9IGVsc2UgaWYgKGNvbnRyb2xzLmlzTG9ja2VkIHx8IGlzTW9iaWxlKSB7CiAgICAgICAgdXBkYXRlUGxheWVyKGRlbHRhKTsKICAgICAgICB1cGRhdGVXaWZlV2Fsa2luZyhkZWx0YSk7CiAgICAgICAgCiAgICAgICAgLy8gV2lmZSBDaGFzZSBMb2dpYwogICAgICAgIGlmICh3aWZlU3RhdGUgPT09IFdJRkVfU1RBVEUuQ0hBU0lORyAmJiBnaXJsV2Fsa2luZ09iamVjdCkgewogICAgICAgICAgICBjb25zdCBwbGF5ZXJQb3MgPSBjYW1lcmEucG9zaXRpb247CiAgICAgICAgICAgIGNvbnN0IHdpZmVQb3MgPSBnaXJsV2Fsa2luZ09iamVjdC5wb3NpdGlvbjsKICAgICAgICAgICAgY29uc3QgZHggPSBwbGF5ZXJQb3MueCAtIHdpZmVQb3MueDsKICAgICAgICAgICAgY29uc3QgZHogPSBwbGF5ZXJQb3MueiAtIHdpZmVQb3MuejsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IE1hdGguc3FydChkeCpkeCArIGR6KmR6KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIENoYXNlIHBoeXNpY3MKICAgICAgICAgICAgaWYgKGRpc3QgPiAzMCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSAyODAgKiBkZWx0YTsgLy8gRmFzdCB3YWxrL3J1biBzcGVlZAogICAgICAgICAgICAgICAgZ2lybFdhbGtpbmdPYmplY3QucG9zaXRpb24ueCArPSAoZHgvZGlzdCkgKiBzcGVlZDsKICAgICAgICAgICAgICAgIGdpcmxXYWxraW5nT2JqZWN0LnBvc2l0aW9uLnogKz0gKGR6L2Rpc3QpICogc3BlZWQ7CiAgICAgICAgICAgICAgICBnaXJsV2Fsa2luZ09iamVjdC5yb3RhdGlvbi55ID0gTWF0aC5hdGFuMihkeCwgZHopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDb2xsaXNpb24vRW5kaW5nCiAgICAgICAgICAgIGlmIChkaXN0IDwgNTApIHsgLy8gQ2F1Z2h0CiAgICAgICAgICAgICAgICB0cmlnZ2VyRW5kaW5nKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNoZWNrRnJpZGdlUHJveGltaXR5KCk7CiAgICAgICAgaWYgKGNhcnJ5aW5nTWVhdCkgdXBkYXRlQ2FycmllZE1lYXQoKTsKICAgICAgICAKICAgICAgICAvLyBSYXljYXN0aW5nIGZvciBnZW5lcmFsIGludGVyYWN0aW9uIHByb21wdHMgKGxpa2UgY29va2luZykKICAgICAgICBpZiAoIWN1dHNjZW5lQWN0aXZlICYmIChjYXJyeWluZ01lYXQgfHwgaXNDb29rZWQpKSB7CiAgICAgICAgICAgIGNvbnN0IHJheWNhc3RlciA9IG5ldyBUSFJFRS5SYXljYXN0ZXIoKTsKICAgICAgICAgICAgcmF5Y2FzdGVyLnNldEZyb21DYW1lcmEobmV3IFRIUkVFLlZlY3RvcjIoMCwgMCksIGNhbWVyYSk7CiAgICAgICAgICAgIGNvbnN0IGludGVyc2VjdHMgPSByYXljYXN0ZXIuaW50ZXJzZWN0T2JqZWN0cyhzY2VuZS5jaGlsZHJlbiwgdHJ1ZSk7CiAgICAgICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnRlcnNlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaW50ZXJzZWN0c1tpXS5kaXN0YW5jZSA+IDE1MCkgYnJlYWs7CiAgICAgICAgICAgICAgICBsZXQgb2JqID0gaW50ZXJzZWN0c1tpXS5vYmplY3Q7CiAgICAgICAgICAgICAgICB3aGlsZShvYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnVzZXJEYXRhLmNhbkNvb2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9tcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW50ZXJhY3Rpb24tcHJvbXB0Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb21wdC5jbGFzc0xpc3QuYWRkKCd2aXNpYmxlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYXJyeWluZ01lYXQpIHByb21wdC5pbm5lclRleHQgPSAiUHJlc3Npb25lIEUgcGFyYSBDb3ppbmhhciI7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGlzQ29va2VkKSBwcm9tcHQuaW5uZXJUZXh0ID0gIlByZXNzaW9uZSBFIHBhcmEgQ29tZXIiOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgb2JqID0gb2JqLnBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGZvdW5kKSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighZm91bmQgJiYgIWNhbkV4aXRDYXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHByb21wdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnRlcmFjdGlvbi1wcm9tcHQnKTsKICAgICAgICAgICAgICAgIGlmIChwcm9tcHQuaW5uZXJUZXh0LmluY2x1ZGVzKCdDb3ppbmhhcicpIHx8IHByb21wdC5pbm5lclRleHQuaW5jbHVkZXMoJ0NvbWVyJykpIHByb21wdC5jbGFzc0xpc3QucmVtb3ZlKCd2aXNpYmxlJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKG5vdyAtIGxhc3RDaHVua1VwZGF0ZSA+IDUwMCkgeyBjaHVua01hbmFnZXIudXBkYXRlKGNhbWVyYS5wb3NpdGlvbi54LCBjYW1lcmEucG9zaXRpb24ueik7IGxhc3RDaHVua1VwZGF0ZSA9IG5vdzsgfQogICAgfQogICAgCiAgICBmb3IgKGNvbnN0IG1peGVyIG9mIG1peGVycykgbWl4ZXIudXBkYXRlKGRlbHRhKTsKICAgIAogICAgaWYgKHdpbmRvdy5ncmFzc1VuaWZvcm1zKSB7CiAgICAgICAgd2luZG93LmdyYXNzVW5pZm9ybXMudGltZS52YWx1ZSA9IG5vdyAqIDAuMDAxOwogICAgICAgIHdpbmRvdy5ncmFzc1VuaWZvcm1zLnBsYXllclBvcy52YWx1ZS5jb3B5KGNhbWVyYS5wb3NpdGlvbik7CiAgICB9CgogICAgcmVuZGVyZXIucmVuZGVyKHNjZW5lLCBjYW1lcmEpOwp9CgpmdW5jdGlvbiB1cGRhdGVQbGF5ZXIoZGVsdGEpIHsKICAgIGxldCBtb3ZlWiA9IE51bWJlcihpbnB1dC5mb3J3YXJkKSAtIE51bWJlcihpbnB1dC5iYWNrd2FyZCk7CiAgICBsZXQgbW92ZVggPSBOdW1iZXIoaW5wdXQucmlnaHQpIC0gTnVtYmVyKGlucHV0LmxlZnQpOwogICAgCiAgICBpZiAoaXNNb2JpbGUgJiYgam95c3RpY2suYWN0aXZlKSB7IG1vdmVaID0gLWpveXN0aWNrLnk7IG1vdmVYID0gam95c3RpY2sueDsgfQoKICAgIHBsYXllclZlbG9jaXR5LnkgLT0gR1JBVklUWSAqIGRlbHRhOwoKICAgIGlmIChtb3ZlWiAhPT0gMCB8fCBtb3ZlWCAhPT0gMCkgewogICAgICAgIF9mb3J3YXJkLnNldCgwLCAwLCAtMSkuYXBwbHlRdWF0ZXJuaW9uKGNhbWVyYS5xdWF0ZXJuaW9uKTsgX2ZvcndhcmQueSA9IDA7IF9mb3J3YXJkLm5vcm1hbGl6ZSgpOwogICAgICAgIF9yaWdodC5zZXQoMSwgMCwgMCkuYXBwbHlRdWF0ZXJuaW9uKGNhbWVyYS5xdWF0ZXJuaW9uKTsgX3JpZ2h0LnkgPSAwOyBfcmlnaHQubm9ybWFsaXplKCk7CiAgICAgICAgX21vdmVWZWMuc2V0KDAsIDAsIDApLmFkZFNjYWxlZFZlY3RvcihfZm9yd2FyZCwgbW92ZVopLmFkZFNjYWxlZFZlY3RvcihfcmlnaHQsIG1vdmVYKS5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhcihQTEFZRVJfU1BFRUQgKiBkZWx0YSk7CiAgICAgICAgY2FtZXJhLnBvc2l0aW9uLmFkZChfbW92ZVZlYyk7CiAgICB9CgogICAgY2FtZXJhLnBvc2l0aW9uLnkgKz0gcGxheWVyVmVsb2NpdHkueSAqIGRlbHRhOwoKICAgIGlmIChjYW1lcmEucG9zaXRpb24ueSA8PSBQTEFZRVJfSEVJR0hUKSB7CiAgICAgICAgY2FtZXJhLnBvc2l0aW9uLnkgPSBQTEFZRVJfSEVJR0hUOwogICAgICAgIHBsYXllclZlbG9jaXR5LnkgPSAwOwogICAgICAgIGlzR3JvdW5kZWQgPSB0cnVlOwogICAgfQoKICAgIGhhbmRsZUNvbGxpc2lvblB5dGhvbihjYW1lcmEucG9zaXRpb24pOwoKICAgIGlmIChjYW1lcmEucG9zaXRpb24ueSA8IC01MDApIHsKICAgICAgICBjYW1lcmEucG9zaXRpb24uc2V0KFBMQVlFUl9TUEFXTl9YLCBQTEFZRVJfSEVJR0hULCBQTEFZRVJfU1BBV05fWik7CiAgICAgICAgcGxheWVyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgfQp9Cgppbml0KCk7Cjwvc2NyaXB0Pgo8L2JvZHk+CjwvaHRtbD4=";
    
    forestContainer.appendChild(iframe);
    document.body.appendChild(forestContainer);
    
    // Add back button
    const backBtn = document.createElement('button');
    backBtn.innerHTML = '‚Üê VOLTAR';
    backBtn.style.cssText = 'position:fixed;top:20px;left:20px;z-index:1001;padding:12px 24px;background:rgba(0,0,0,0.9);border:2px solid #8faac8;color:#8faac8;font-family:"Special Elite",cursive;font-size:16px;cursor:pointer;border-radius:8px;backdrop-filter:blur(8px);transition:all 0.3s;';
    backBtn.onmouseover = () => {
        backBtn.style.background = 'rgba(143,170,200,0.2)';
        backBtn.style.borderColor = '#fff';
        backBtn.style.color = '#fff';
    };
    backBtn.onmouseout = () => {
        backBtn.style.background = 'rgba(0,0,0,0.9)';
        backBtn.style.borderColor = '#8faac8';
        backBtn.style.color = '#8faac8';
    };
    backBtn.onclick = () => {
        document.body.removeChild(forestContainer);
        if (mainContainer) mainContainer.style.display = 'block';
        if (fpsCounter) fpsCounter.style.display = 'block';
        if (questBox) questBox.style.display = 'block';
        if (crosshair) crosshair.style.display = 'block';
    };
    forestContainer.appendChild(backBtn);
    
    console.log("‚úÖ Complete forest module loaded in iframe!");
}
